---
layout: layout
title: My Account
---

<script type="module">
    import { 
        auth, 
        db, 
        onAuthStateChanged, 
        doc, 
        getDoc, 
        collection, 
        query, 
        where, 
        getDocs,
        signOut
    // FIX: Corrected import path to include /src/ directory
    } from '/src/firebase-loader.js';
    // FIX: Removed unnecessary import of 'logout' from a file that doesn't exist
    // import { logout } from '/src/auth.js'; 

    // --- State ---
    let currentUser = null;
    let isAdmin = false;

    // --- DOM Elements ---
    const accountLoader = document.getElementById('account-loader');
    const accountContent = document.getElementById('account-content');
    const profileNameDisplay = document.getElementById('profile-name-display');
    const profileEmailDisplay = document.getElementById('profile-email-display');
    const ordersTableBody = document.getElementById('orders-table-body');
    const ordersMessage = document.getElementById('orders-message');
    const adminPanelLink = document.getElementById('admin-panel-link');
    const logoutButton = document.getElementById('logout-button');
    const totalOrdersCount = document.getElementById('total-orders-count');
    const lastOrderDateDisplay = document.getElementById('last-order-date');

    // --- Utility Functions ---

    function formatDate(timestamp) {
        if (!timestamp || !timestamp.toDate) return 'N/A';
        return timestamp.toDate().toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
    }

    function getStatusClasses(status) {
        switch (status) {
            case 'Paid':
                return 'bg-green-100 text-green-800';
            case 'Shipped':
                return 'bg-blue-100 text-blue-800';
            case 'Pending':
                return 'bg-yellow-100 text-yellow-800';
            case 'Cancelled':
                return 'bg-red-100 text-red-800';
            default:
                return 'bg-gray-100 text-gray-800';
        }
    }

    // --- Core Logic ---

    /**
     * Fetches the user's profile and populates the dashboard.
     */
    async function fetchUserProfile(user) {
        try {
            const userDocRef = doc(db, 'users', user.uid);
            const docSnap = await getDoc(userDocRef);

            let firstName = 'Customer'; 
            let lastName = '';
            
            if (docSnap.exists()) {
                const profile = docSnap.data();
                firstName = profile.firstName || 'Customer';
                lastName = profile.lastName || '';
            }

            profileNameDisplay.textContent = `${firstName} ${lastName}`;
            profileEmailDisplay.textContent = user.email;

            // Check if user is an Admin
            const adminDocRef = doc(db, 'admins', user.uid);
            const adminDocSnap = await getDoc(adminDocRef);
            isAdmin = adminDocSnap.exists();

            if (isAdmin) {
                // Admin link is already /admin.html as that page explicitly uses .html (no change needed here)
                adminPanelLink.classList.remove('hidden');
            }

            // After profile, fetch orders
            await fetchUserOrders(user.uid);

        } catch (error) {
            console.error("Error fetching user profile:", error);
            // Non-critical, but inform the user
            profileNameDisplay.textContent = 'Profile Load Error';
        }
    }

    /**
     * Fetches and displays the user's order history.
     */
    async function fetchUserOrders(userId) {
        ordersMessage.textContent = 'Loading your order history...';
        ordersMessage.classList.remove('hidden');
        ordersTableBody.innerHTML = '';

        try {
            const ordersRef = collection(db, 'orders');
            // Query orders where the 'userId' field matches the current user's UID
            const q = query(ordersRef, where('userId', '==', userId)); 
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                ordersMessage.textContent = 'You have no past orders associated with this account.';
                ordersMessage.classList.remove('hidden');
                totalOrdersCount.textContent = 0;
                lastOrderDateDisplay.textContent = 'N/A';
                return;
            }

            let orders = [];
            querySnapshot.forEach(doc => {
                const order = doc.data();
                order.id = doc.id;
                orders.push(order);
            });

            // CRITICAL FIX: Ensure safe sorting using optional chaining and default date for robust client-side sort
            orders.sort((a, b) => (b.createdAt?.toDate() || new Date(0)) - (a.createdAt?.toDate() || new Date(0)));
            
            totalOrdersCount.textContent = orders.length;
            lastOrderDateDisplay.textContent = formatDate(orders[0].createdAt);
            ordersMessage.classList.add('hidden');
            
            renderOrdersTable(orders);

        } catch (error) {
            console.error("Error fetching user orders:", error);
            ordersMessage.textContent = 'Error fetching order history. Please try again later.';
            ordersMessage.classList.remove('hidden', 'text-stone');
            ordersMessage.classList.add('text-red-600');
        }
    }

    /**
     * Renders the order table rows.
     */
    function renderOrdersTable(orders) {
        ordersTableBody.innerHTML = '';
        
        orders.forEach(order => {
            const orderIdDisplay = order.id.slice(-6);
            const statusClasses = getStatusClasses(order.status);
            const formattedDate = formatDate(order.createdAt);
            // FIX: Use optional chaining for safety when accessing deeply nested totals
            const total = order.totals?.total ? order.totals.total.toFixed(2) : 'N/A';

            const row = document.createElement('tr');
            row.className = 'hover:bg-parchment/50 transition duration-150';
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-charcoal">
                    ...${orderIdDisplay}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-stone">
                    ${formattedDate}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-charcoal">
                    $${total}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClasses}">
                        ${order.status}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <a href="/order-confirmation/?orderId=${order.id}" class="text-burnt-orange hover:text-stone transition duration-150">
                        View Details
                    </a>
                </td>
            `;
            ordersTableBody.appendChild(row);
        });
    }

    /**
     * Redirects unauthenticated users and initializes the page for authenticated users.
     */
    function initializeAccountPage() {
        // Authentication State Listener (Security Guard)
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                // Fetch profile and orders
                fetchUserProfile(user).then(() => {
                    accountLoader.classList.add('hidden');
                    accountContent.classList.remove('hidden');
                });
            } else {
                // If not logged in, redirect to login page
                // CRITICAL FIX: Redirect to clean URL
                window.location.href = '/login/';
            }
        });
    }

    // --- Initialization & Event Listeners ---
    document.addEventListener('DOMContentLoaded', () => {
        // CRITICAL FIX: Removed initializeAccountPage() wrapper, 
        // as the auth listener should be started immediately on module load.
        // The core logic below achieves the same goal safely. 
        // The initializeAccountPage function definition remains but is not manually called within DOMContentLoaded.
        
        // --- Execute the core initialization (Auth State Listener) immediately on module load ---
        // This pattern is safer for single-page application style initialization.
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                // Fetch profile and orders
                fetchUserProfile(user).then(() => {
                    accountLoader.classList.add('hidden');
                    accountContent.classList.remove('hidden');
                });
            } else {
                // If not logged in, redirect to login page
                window.location.href = '/login/';
            }
        });


        if (logoutButton) {
            logoutButton.addEventListener('click', (e) => {
                e.preventDefault();
                // FIX: Use the imported signOut function
                signOut(auth).then(() => {
                    // CRITICAL FIX: Redirect to clean URL
                    window.location.href = '/login/';
                }).catch(error => {
                    console.error("Logout failed:", error);
                    alert("Logout failed. Please try again.");
                });
            });
        }
    });

; // DEFENSIVE SEMICOLON: Added to absorb potential file truncation errors.
</script>

<main class="container mx-auto px-4 py-12 min-h-screen">
    
    <div id="account-loader" class="flex justify-center items-center h-96">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-burnt-orange"></div>
    </div>

    <div id="account-content" class="hidden max-w-5xl mx-auto">
        
        <h1 class="text-4xl font-playfair text-charcoal mb-8 border-b pb-4">Welcome Back, <span id="profile-name-display">Customer</span></h1>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="lg:col-span-1">
                <div class="bg-parchment p-6 rounded-lg shadow-md sticky top-6">
                    <h2 class="text-2xl font-playfair text-charcoal mb-4 border-b pb-2">Account Details</h2>
                    
                    <p class="text-sm font-medium text-stone uppercase tracking-wider">Email</p>
                    <p id="profile-email-display" class="text-charcoal mb-4">loading@email.com</p>
                    
                    <p class="text-sm font-medium text-stone uppercase tracking-wider">Total Orders</p>
                    <p id="total-orders-count" class="text-charcoal mb-4 font-semibold">--</p>
                    
                    <p class="text-sm font-medium text-stone uppercase tracking-wider">Last Order Date</p>
                    <p id="last-order-date" class="text-charcoal mb-6">--</p>
                    
                    <div class="space-y-3 pt-4 border-t">
                        <a id="admin-panel-link" href="/admin/" class="hidden w-full block text-center px-4 py-2 bg-stone text-parchment font-bold rounded-lg hover:bg-charcoal transition duration-300">
                            Admin Panel
                        </a>
                        
                        <button class="w-full px-4 py-2 text-charcoal border border-stone/30 rounded-lg hover:bg-stone/10 transition duration-300">
                            Edit Profile & Address
                        </button>

                        <button id="logout-button" class="w-full px-4 py-2 text-red-600 border border-red-300 rounded-lg hover:bg-red-50 transition duration-300">
                            Log Out
                        </button>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2">
                
                <h2 class="text-3xl font-playfair text-charcoal mb-6 border-b pb-2">Order History</h2>
                
                <p id="orders-message" class="text-stone mb-4"></p>
                
                <div class="overflow-x-auto bg-white rounded-lg shadow-md">
                    <table class="min-w-full divide-y divide-stone/30">
                        <thead>
                            <tr class="text-left text-sm font-medium text-charcoal uppercase tracking-wider bg-parchment">
                                <th class="px-6 py-3">Order #</th>
                                <th class="px-6 py-3">Date</th>
                                <th class="px-6 py-3">Total</th>
                                <th class="px-6 py-3">Status</th>
                                <th class="px-6 py-3">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="orders-table-body" class="bg-white divide-y divide-stone/20">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="mt-12 pt-8 border-t border-stone/20">
            <h2 class="text-3xl font-playfair text-charcoal mb-6">My Subscriptions</h2>
            <div class="p-6 bg-parchment rounded-lg border-l-4 border-burnt-orange/50">
                <p class="text-stone">Subscription management is coming soon! You will be able to view, pause, or update your recurring scent deliveries here.</p>
                <a href="/subscriptions/" class="text-burnt-orange font-semibold hover:underline mt-2 inline-block">Learn about our Subscription Program &rarr;</a>
            </div>
        </div>
    </div>
</main>