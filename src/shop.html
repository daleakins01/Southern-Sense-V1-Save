---
layout: layout
title: Shop All Candles & Melts
---

<script type="module">
    // CRITICAL FIX: Corrected import path to include /src/ directory and ensured all required Firestore functions are imported
    import { 
        db, 
        collection, 
        query, 
        where, 
        getDocs, 
        orderBy 
    } from '/src/firebase-loader.js';
    import { addToCart, updateCartDisplay } from '/src/cart.js'; // Ensure updateCartDisplay is available

    // --- DOM Elements ---
    const shopHeading = document.getElementById('shop-heading');
    const shopIntro = document.getElementById('shop-intro');
    const productGrid = document.getElementById('product-grid');
    const shopLoader = document.getElementById('shop-loader');
    const filterMessage = document.getElementById('filter-message');

    // --- State ---
    let allProducts = [];
    
    // --- Utility Functions ---

    /**
     * Extracts the scentFamily filter from the URL query parameters.
     * @returns {string|null} The scent family to filter by, or null.
     */
    function getFilterFromUrl() {
        const params = new URLSearchParams(window.location.search);
        return params.get('family');
    }

    /**
     * Capitalizes the first letter of each word in a string (for display).
     * @param {string} str - The input string (e.g., "fruity-sweet").
     * @returns {string} The formatted string (e.g., "Fruity Sweet").
     */
    function formatScentFamily(str) {
        if (!str) return 'All Products';
        return str
            .split('-')
            .map(word => word.charAt(0).toUpperCase() + word.slice(1))
            .join(' ');
    }

    /**
     * Renders a single product card HTML.
     * @param {Object} product - The product data.
     * @returns {string} The product card HTML string.
     */
    function renderProductCard(product) {
        const isOutOfStock = product.stock <= 0;
        // CRITICAL CHECK: Ensure price is treated as a float and formatted.
        const price = parseFloat(product.price).toFixed(2); 
        
        // Stock status elements
        const stockStatusHtml = isOutOfStock
            ? `<p class="text-sm font-semibold text-red-600">SOLD OUT</p>`
            : `<p class="text-sm font-semibold text-charcoal">In Stock</p>`;
            
        // Button or Link
        const actionButtonHtml = isOutOfStock
            // Out of Stock: Redirect to detail page (where they can sign up for alerts)
            ? `<a href="/product/?id=${product.id}" class="w-full px-4 py-2 bg-stone/50 text-parchment font-bold rounded-lg text-center cursor-not-allowed">View Details</a>`
            // In Stock: Add to Cart button with data attributes
            : `<button data-id="${product.id}" 
                      data-name="${product.name}"
                      data-price="${price}"
                      data-image="${product.imageUrl}"
                      class="add-to-cart-button w-full px-4 py-2 bg-burnt-orange text-parchment font-bold rounded-lg hover:bg-burnt-orange/80 transition duration-300">
                Add to Cart
              </button>`;
        
        return `
            <div class="product-card bg-white rounded-lg shadow-xl overflow-hidden hover:shadow-2xl transition duration-300 transform hover:-translate-y-1">
                <a href="/product/?id=${product.id}" class="block relative">
                    <img src="/src/${product.imageUrl || 'logo.webp'}" alt="${product.name}" class="w-full h-72 object-cover">
                    ${product.featured ? '<span class="absolute top-3 left-3 px-3 py-1 text-xs bg-burnt-orange text-parchment rounded-full font-bold shadow-md">FEATURED</span>' : ''}
                </a>
                <div class="p-5">
                    <h3 class="text-xl font-playfair text-charcoal mb-1">${product.name}</h3>
                    <p class="text-sm text-stone mb-3">${formatScentFamily(product.scentFamily)}</p>
                    <div class="flex justify-between items-center mb-4">
                        <p class="text-lg font-bold text-burnt-orange">$${price}</p>
                        ${stockStatusHtml}
                    </div>
                    ${actionButtonHtml}
                </div>
            </div>
        `;
    }

    // --- Main Logic ---
    
    /**
     * Attaches click listeners to all new "Add to Cart" buttons.
     */
    function attachCartListeners() {
        document.querySelectorAll('.add-to-cart-button').forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                const { id, name, price, image } = e.currentTarget.dataset;
                
                // Construct the product object as expected by cart.js
                const product = {
                    id: id,
                    name: name,
                    price: price, // Passed as string from data-attribute, parseFloat is handled in cart.js
                    imageUrl: image
                };
                
                addToCart(product, 1); // Add one item
                updateCartDisplay(); // Update the cart count in the header
                
                // Provide visual feedback
                e.currentTarget.textContent = 'Added!';
                setTimeout(() => {
                    e.currentTarget.textContent = 'Add to Cart';
                }, 1000);
            });
        });
    }

    /**
     * Filters the global product list and renders the grid.
     * @param {string|null} filterFamily - The scent family to filter by.
     */
    function renderProductGrid(filterFamily) {
        let filteredProducts = allProducts;
        let displayedCount = 0;

        // Set heading and introductory text based on filter
        shopHeading.textContent = formatScentFamily(filterFamily);
        if (filterFamily) {
            filteredProducts = allProducts.filter(p => p.scentFamily === filterFamily);
            shopIntro.textContent = `Browse our collection of products featuring the delightful notes of the ${formatScentFamily(filterFamily)} family.`;
        } else {
            shopIntro.textContent = `Explore our entire collection of hand-poured candles and luxurious wax melts.`;
        }


        productGrid.innerHTML = '';
        
        if (filteredProducts.length === 0) {
            productGrid.innerHTML = `<p class="text-lg text-stone col-span-full text-center py-10">No products found matching your criteria. <a href="/shop/" class="text-burnt-orange hover:underline">View All Products</a></p>`;
            filterMessage.textContent = `0 products found.`;
            return;
        }

        // Sort: Featured first, then by stock (in-stock first), then by name
        filteredProducts.sort((a, b) => {
            // Featured priority
            if (a.featured && !b.featured) return -1;
            if (!a.featured && b.featured) return 1;
            
            // Stock priority (higher stock comes first)
            if (a.stock > 0 && b.stock <= 0) return -1;
            if (a.stock <= 0 && b.stock > 0) return 1;

            // Alphabetical fallback
            return a.name.localeCompare(b.name);
        });

        filteredProducts.forEach(product => {
            productGrid.innerHTML += renderProductCard(product);
            displayedCount++;
        });

        // Update total count message
        filterMessage.textContent = `${displayedCount} ${filterFamily ? formatScentFamily(filterFamily) : 'Total'} products found.`;

        attachCartListeners();
    }


    /**
     * Initializes the shop page by fetching all products.
     */
    async function initializeShop() {
        shopLoader.classList.remove('hidden');
        productGrid.innerHTML = '';
        
        const filterFamily = getFilterFromUrl();
        shopHeading.textContent = formatScentFamily(filterFamily); // Set initial heading

        try {
            const productsRef = collection(db, 'products');
            // Use query without orderBy for initial fetch, sorting is done client-side
            const q = query(productsRef); 
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                shopIntro.textContent = "We're currently stocking our shelves. Please check back soon!";
                shopLoader.classList.add('hidden');
                return;
            }

            // Map all documents and store them in the global state
            allProducts = querySnapshot.docs.map(doc => {
                const data = doc.data();
                return {
                    id: doc.id,
                    ...data,
                    // CRITICAL: Ensure price and stock are correctly read and parsed
                    price: parseFloat(data.price), 
                    stock: parseInt(data.stock, 10) || 0, // Ensure stock is an integer
                    featured: data.featured === true // Ensure boolean type is maintained
                };
            });

            // Render the grid with or without the URL filter
            renderProductGrid(filterFamily);

        } catch (error) {
            console.error("CRITICAL ERROR: Error fetching products:", error);
            shopIntro.innerHTML = `<p class="text-red-600 font-bold">Error loading products. Check Firebase configuration and database connection.</p>`;
        } finally {
            shopLoader.classList.add('hidden');
        }
    }

    // --- Initialization Trigger ---
    document.addEventListener('DOMContentLoaded', initializeShop);

</script>

<main class="container mx-auto px-4 py-12 min-h-screen">
    
    <header class="max-w-4xl mx-auto text-center mb-12">
        <p class="text-sm font-semibold uppercase tracking-wider text-burnt-orange mb-3">Shop Our Collection</p>
        <h1 id="shop-heading" class="text-5xl font-playfair text-charcoal mb-4">
            All Products
        </h1>
        <p id="shop-intro" class="text-lg text-stone leading-relaxed">
            </p>
    </header>

    <div id="filter-message" class="text-center text-sm font-medium text-stone mb-6">
        </div>
    
    <div id="shop-loader" class="flex justify-center items-center h-48">
        <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-burnt-orange"></div>
    </div>

    <div id="product-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
        </div>

</main>