<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Southern Sense</title>

    <!-- === PERFORMANCE OPTIMIZATION (START) === -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Roboto:wght@400;500&family=Great+Vibes&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    <noscript><link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Roboto:wght@400;500&family=Great+Vibes&display=swap" rel="stylesheet"></noscript>
    <link href="output.css" rel="stylesheet">
    <!-- === PERFORMANCE OPTIMIZATION (END) === -->
    
    <!-- Link to Admin Guide (Added) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" xintegrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- NO main.js needed for admin panel -->
    <style>
        body { background-color: #FBF9F6; background-image: url('background-parchment.webp'); background-size: cover; background-position: center center; background-attachment: fixed; visibility: hidden; /* Hide page until auth check is complete */ }
        .content-wrapper { background: rgba(251, 249, 246, 0.85); backdrop-filter: blur(10px); }
        .hero-bg { background-image: url('candles-header.webp'); }
        /* Tab Styles */
        .tab-btn { transition: all 0.3s ease; }
        .tab-btn.active { background-color: #D97706; color: white; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); }
        .tab-btn.inactive { background-color: #FBF9F6; color: #78716C; border: 1px solid #D1D5DB; } /* Added border for inactive */
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }
        /* Modal Styles */
        .modal { display: none; position: fixed; inset: 0; background-color: rgba(0, 0, 0, 0.5); z-index: 50; align-items: center; justify-content: center; padding: 1rem; }
        .modal.active { display: flex; }
        .modal-content { background-color: #FBF9F6; border-radius: 0.5rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); width: 100%; max-width: 42rem; /* Adjusted max-width */ max-height: 90vh; overflow-y: auto; }
        /* Accordion Chevron */
        .accordion-chevron { transition: transform 0.3s ease; }
        /* V1.1 FIX: Added 'sticky' and 'top-0' for better usability on long lists */
        .admin-header { position: sticky; top: 0; z-index: 40; /* Lower than modal */ }
        /* V1.1 FIX: Added styles for new "Update Stock" button */
        .stock-update-btn {
            background-color: #3D352E; /* charcoal */
            color: white;
            padding: 0.25rem 0.75rem;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: 0.375rem;
            transition: background-color 0.2s;
        }
        .stock-update-btn:hover {
            background-color: #574d47; /* lighter charcoal */
        }
        /* Dashboard Stats Grid - Make it wrap better on medium screens */
        #stats-grid {
             grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }
        /* Search Input Style */
        .admin-search-input {
            width: 100%;
            max-width: 400px; /* Limit width */
            padding: 0.5rem 1rem;
            border: 1px solid #78716C; /* stone */
            border-radius: 0.375rem;
            background-color: rgba(255, 255, 255, 0.7);
            transition: all 0.2s ease-in-out;
        }
        .admin-search-input:focus {
            outline: none;
            border-color: #D97706; /* burnt-orange */
            box-shadow: 0 0 0 2px rgba(217, 119, 6, 0.3); /* burnt-orange focus ring */
        }
         /* Style for the Guide Link */
        .admin-guide-link {
             color: #FBF9F6; /* parchment */
             font-size: 0.9rem;
             margin-left: 1rem;
             transition: color 0.2s;
             vertical-align: middle; /* Align icon and text */
        }
        .admin-guide-link:hover {
             color: #D97706; /* burnt-orange */
        }
        .admin-guide-link i { /* Style for Font Awesome icon */
            margin-right: 0.3rem;
        }
        /* Ensure table header is sticky */
        #panel-orders thead {
            position: sticky;
            top: 0; /* Adjust if header height changes */
            z-index: 10;
        }
    </style>
</head>
<body class="font-roboto text-charcoal bg-parchment">
    
    <!-- Header (Admin-specific, no main.js injection) -->
    <header class="bg-charcoal text-white shadow-md py-4 admin-header">
        <div class="container mx-auto px-4 sm:px-6 flex justify-between items-center">
            <a href="index.html" class="flex items-center space-x-2">
                <img src="logo.webp" alt="Southern Sense Logo" class="h-12 w-12 rounded-full shadow-sm">
                <span class="font-southern text-4xl text-parchment -mt-2">Southern Sense</span>
            </a>
            <!-- MODIFIED: Added container div and Guide Link -->
            <div class="flex items-center">
                 <span class="font-playfair text-2xl text-white">Admin Dashboard</span>
                 <a href="AdminPageFunctionsGuide.html" target="_blank" class="admin-guide-link" title="Open Admin Guide">
                    <i class="fas fa-book-open"></i> View Guide
                 </a>
            </div>
            <button id="sign-out-btn" class="bg-burnt-orange text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-amber-700 transition-all">
                Sign Out
            </button>
        </div>
    </header>

    <!-- Main Admin Content -->
    <main class="py-12">
        <div class="container mx-auto px-4">

            <!-- Tab Navigation -->
            <div class="flex flex-wrap justify-center gap-2 sm:gap-4 mb-8">
                <button id="tab-dashboard" class="tab-btn active font-bold py-3 px-6 rounded-lg shadow-sm" data-tab="dashboard">Dashboard</button>
                <button id="tab-products" class="tab-btn inactive font-bold py-3 px-6 rounded-lg shadow-sm border" data-tab="products">Products</button>
                <button id="tab-orders" class="tab-btn inactive font-bold py-3 px-6 rounded-lg shadow-sm border" data-tab="orders">Orders</button>
                <button id="tab-reviews" class="tab-btn inactive font-bold py-3 px-6 rounded-lg shadow-sm border" data-tab="reviews">Reviews</button>
                <button id="tab-content" class="tab-btn inactive font-bold py-3 px-6 rounded-lg shadow-sm border" data-tab="content">Site Content</button>
            </div>

            <!-- Tab Panels -->
            <div>
                <!-- === Dashboard Panel === -->
                <div id="panel-dashboard" class="tab-panel active content-wrapper p-6 md:p-12 rounded-lg shadow-2xl">
                    <h2 class="font-playfair text-3xl font-bold text-charcoal border-b border-stone/20 pb-4">Dashboard</h2>
                    <div id="stats-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 mt-6">
                        <!-- Stat Card 1: Total Sales -->
                        <div class="bg-white/60 p-6 rounded-lg shadow-lg text-center">
                            <h3 class="font-playfair text-xl font-bold text-charcoal">Total Revenue</h3>
                            <p id="stat-total-revenue" class="font-roboto text-4xl font-bold text-burnt-orange mt-2">$0.00</p>
                        </div>
                        <!-- Stat Card 2: Total Orders -->
                        <div class="bg-white/60 p-6 rounded-lg shadow-lg text-center">
                            <h3 class="font-playfair text-xl font-bold text-charcoal">Total Orders</h3>
                            <p id="stat-total-orders" class="font-roboto text-4xl font-bold text-burnt-orange mt-2">0</p>
                        </div>
                        <!-- NEW Stat Card 3: Average Order Value -->
                        <div class="bg-white/60 p-6 rounded-lg shadow-lg text-center">
                            <h3 class="font-playfair text-xl font-bold text-charcoal">Avg. Order Value</h3>
                            <p id="stat-avg-order-value" class="font-roboto text-4xl font-bold text-burnt-orange mt-2">$0.00</p>
                        </div>
                         <!-- NEW Stat Card 4: Total Products -->
                        <div class="bg-white/60 p-6 rounded-lg shadow-lg text-center">
                            <h3 class="font-playfair text-xl font-bold text-charcoal">Total Products</h3>
                            <p id="stat-total-products" class="font-roboto text-4xl font-bold text-burnt-orange mt-2">0</p>
                        </div>
                        <!-- NEW Stat Card 5: Products Out of Stock -->
                        <div class="bg-white/60 p-6 rounded-lg shadow-lg text-center">
                            <h3 class="font-playfair text-xl font-bold text-charcoal">Out of Stock</h3>
                            <p id="stat-out-of-stock" class="font-roboto text-4xl font-bold text-burnt-orange mt-2">0</p>
                        </div>
                        <!-- Stat Card 6: Pending Reviews -->
                        <div class="bg-white/60 p-6 rounded-lg shadow-lg text-center">
                            <h3 class="font-playfair text-xl font-bold text-charcoal">Pending Reviews</h3>
                            <p id="stat-pending-reviews" class="font-roboto text-4xl font-bold text-burnt-orange mt-2">0</p>
                        </div>
                         <!-- NEW Stat Card 7: Approved Reviews -->
                        <div class="bg-white/60 p-6 rounded-lg shadow-lg text-center">
                            <h3 class="font-playfair text-xl font-bold text-charcoal">Approved Reviews</h3>
                            <p id="stat-approved-reviews" class="font-roboto text-4xl font-bold text-burnt-orange mt-2">0</p>
                        </div>
                    </div>
                </div>

                <!-- === Products Panel === -->
                <div id="panel-products" class="tab-panel content-wrapper p-6 md:p-12 rounded-lg shadow-2xl">
                    <div class="flex flex-col sm:flex-row justify-between items-center border-b border-stone/20 pb-4">
                        <h2 class="font-playfair text-3xl font-bold text-charcoal">Manage Products</h2>
                        <button id="add-product-btn" class="mt-4 sm:mt-0 bg-burnt-orange text-white font-bold py-2 px-6 rounded-lg shadow-md hover:bg-amber-700 transition-all">
                            Add New Product
                        </button>
                    </div>

                    <!-- NEW: Search Input for Products -->
                    <div class="my-6">
                        <label for="product-search-input" class="sr-only">Search Products</label>
                        <input type="text" id="product-search-input" placeholder="Search by name or ID..." class="admin-search-input">
                    </div>

                    <!-- V1.1 FIX: Product Data Tools -->
                    <div class="my-6 p-4 bg-white/60 rounded-lg shadow-inner">
                        <h3 class="font-playfair text-xl font-bold text-charcoal">Product Data Tools</h3>
                        <div class="flex flex-wrap gap-4 mt-4">
                            <!-- NEW: Export Products -->
                            <button id="export-products-btn" class="bg-charcoal text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-stone transition-colors">
                                Export All Products (JSON)
                            </button>
                            <!-- V1.1 FIX: Export/Import CSV -->
                            <button id="export-csv-btn" class="bg-charcoal text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-stone transition-colors">
                                Export All (CSV)
                            </button>
                            <div class="flex flex-col">
                                <label for="csv-file-input" class="text-sm font-medium text-stone">Import CSV to update products:</label>
                                <input type="file" id="csv-file-input" accept=".csv" class="mt-1 text-sm text-stone file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-bold file:bg-white/50 file:text-burnt-orange hover:file:bg-white/80">
                                <button id="import-csv-btn" class="mt-2 bg-burnt-orange text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-amber-700 transition-colors">
                                    Import & Update
                                </button>
                            </div>
                        </div>
                         <p id="csv-message" class="text-sm mt-2 hidden"></p> <!-- Corrected class -->
                    </div>
                    
                    <div id="product-list-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-6">
                        <!-- Product cards will be injected here -->
                    </div>
                    <p id="products-loading" class="text-center text-stone text-lg mt-6">Loading products...</p>
                    <p id="products-no-results" class="text-center text-stone text-lg mt-6 hidden">No products match your search.</p>
                </div>

                <!-- === Orders Panel === -->
                <div id="panel-orders" class="tab-panel content-wrapper p-6 md:p-12 rounded-lg shadow-2xl">
                    <h2 class="font-playfair text-3xl font-bold text-charcoal border-b border-stone/20 pb-4">Manage Orders</h2>
                    
                    <!-- NEW: Search Input for Orders -->
                     <div class="my-6">
                         <label for="order-search-input" class="sr-only">Search Orders</label>
                         <input type="text" id="order-search-input" placeholder="Search by Order ID, Name, or Email..." class="admin-search-input">
                     </div>

                    <div class="overflow-x-auto mt-6">
                        <table class="min-w-full bg-white/60 rounded-lg shadow-lg">
                            <thead class="bg-charcoal/80 text-white">
                                <tr>
                                    <th class="text-left py-3 px-4 font-playfair">Order ID</th>
                                    <th class="text-left py-3 px-4 font-playfair">Date</th>
                                    <th class="text-left py-3 px-4 font-playfair">Customer</th>
                                    <th class="text-left py-3 px-4 font-playfair">Total</th>
                                    <th class="text-left py-3 px-4 font-playfair">Status</th>
                                    <th class="text-left py-3 px-4 font-playfair">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="order-list-body" class="divide-y divide-stone/20">
                                <!-- Order rows will be injected here -->
                            </tbody>
                        </table>
                         <p id="orders-loading" class="text-center text-stone text-lg mt-6">Loading orders...</p>
                         <p id="orders-no-results" class="text-center text-stone text-lg mt-6 hidden">No orders match your search.</p>
                    </div>
                </div>

                <!-- === Reviews Panel === -->
                <div id="panel-reviews" class="tab-panel content-wrapper p-6 md:p-12 rounded-lg shadow-2xl">
                    <h2 class="font-playfair text-3xl font-bold text-charcoal border-b border-stone/20 pb-4">Manage Reviews</h2>
                    
                     <!-- NEW: Search Input for Reviews -->
                     <div class="my-6">
                         <label for="review-search-input" class="sr-only">Search Reviews</label>
                         <input type="text" id="review-search-input" placeholder="Search by Product Name, Reviewer, or Text..." class="admin-search-input">
                     </div>

                    <div id="review-list-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-6">
                        <!-- Review cards will be injected here -->
                    </div>
                     <p id="reviews-loading" class="text-center text-stone text-lg mt-6">Loading pending reviews...</p>
                     <p id="no-pending-reviews" class="text-center text-stone text-lg mt-6 hidden">No pending reviews found.</p>
                     <p id="reviews-no-results" class="text-center text-stone text-lg mt-6 hidden">No reviews match your search.</p>
                </div>

                <!-- === Site Content Panel === -->
                <div id="panel-content" class="tab-panel content-wrapper p-6 md:p-12 rounded-lg shadow-2xl">
                    <h2 class="font-playfair text-3xl font-bold text-charcoal border-b border-stone/20 pb-4">Site Content Editor</h2>
                    
                    <form id="site-content-form" class="mt-6 space-y-8">
                        <!-- Homepage Section -->
                        <div class="p-6 bg-white/60 rounded-lg shadow-inner">
                            <div id="homepage-toggle" class="flex justify-between items-center cursor-pointer">
                                <h3 class="font-playfair text-2xl font-bold text-charcoal">Homepage</h3>
                                <svg id="homepage-chevron" class="w-6 h-6 text-charcoal accordion-chevron -rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                            <div id="homepage-body" class="mt-4 space-y-4 hidden">
                                <div>
                                    <label for="content-heroTitle" class="block text-stone font-bold mb-2">Hero Title</label>
                                    <input type="text" id="content-heroTitle" class="w-full px-4 py-2 border border-stone/30 rounded-lg bg-white/50 focus:ring-burnt-orange focus:border-burnt-orange transition-colors">
                                </div>
                                <div>
                                    <label for="content-heroSubtitle" class="block text-stone font-bold mb-2">Hero Subtitle</label>
                                    <input type="text" id="content-heroSubtitle" class="w-full px-4 py-2 border border-stone/30 rounded-lg bg-white/50 focus:ring-burnt-orange focus:border-burnt-orange transition-colors">
                                </div>
                                <div>
                                    <label for="content-featuredProductId" class="block text-stone font-bold mb-2">Featured Product ID</label>
                                    <input type="text" id="content-featuredProductId" class="w-full px-4 py-2 border border-stone/30 rounded-lg bg-white/50 focus:ring-burnt-orange focus:border-burnt-orange transition-colors" placeholder="e.g., aloha-luxe-candle">
                                </div>
                            </div>
                        </div>

                        <!-- About Us Section -->
                        <div class="p-6 bg-white/60 rounded-lg shadow-inner">
                            <div id="about-toggle" class="flex justify-between items-center cursor-pointer">
                                <h3 class="font-playfair text-2xl font-bold text-charcoal">About Us Page</h3>
                                <svg id="about-chevron" class="w-6 h-6 text-charcoal accordion-chevron -rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                            <div id="about-body" class="mt-4 space-y-4 hidden">
                                <div>
                                    <label for="content-aboutTitle" class="block text-stone font-bold mb-2">Page Title</label>
                                    <input type="text" id="content-aboutTitle" class="w-full px-4 py-2 border border-stone/30 rounded-lg bg-white/50 focus:ring-burnt-orange focus:border-burnt-orange transition-colors">
                                </div>
                                <div>
                                    <label for="content-aboutParagraph1" class="block text-stone font-bold mb-2">First Paragraph</label>
                                    <textarea id="content-aboutParagraph1" rows="3" class="w-full px-4 py-2 border border-stone/30 rounded-lg bg-white/50 focus:ring-burnt-orange focus:border-burnt-orange transition-colors"></textarea>
                                </div>
                                <div>
                                    <label for="content-aboutParagraph2" class="block text-stone font-bold mb-2">Second Paragraph</label>
                                    <textarea id="content-aboutParagraph2" rows="3" class="w-full px-4 py-2 border border-stone/30 rounded-lg bg-white/50 focus:ring-burnt-orange focus:border-burnt-orange transition-colors"></textarea>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Refill Program Section -->
                        <div class="p-6 bg-white/60 rounded-lg shadow-inner">
                            <div id="refill-toggle" class="flex justify-between items-center cursor-pointer">
                                <h3 class="font-playfair text-2xl font-bold text-charcoal">Refill Program Page</h3>
                                <svg id="refill-chevron" class="w-6 h-6 text-charcoal accordion-chevron -rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                            <div id="refill-body" class="mt-4 space-y-4 hidden">
                                <div><label for="content-refillTitle" class="block text-stone font-bold mb-2">Page Title</label><input type="text" id="content-refillTitle" class="w-full px-4 py-2 border border-stone/30 rounded-lg bg-white/50"></div>
                                <div><label for="content-refillSubtitle" class="block text-stone font-bold mb-2">Page Subtitle</label><textarea id="content-refillSubtitle" rows="2" class="w-full px-4 py-2 border border-stone/30 rounded-lg bg-white/50"></textarea></div>
                                <div><label for="content-refillStep1Text" class="block text-stone font-bold mb-2">Step 1 Text</label><textarea id="content-refillStep1Text" rows="2" class="w-full px-4 py-2 border border-stone/30 rounded-lg bg-white/50"></textarea></div>
                                <div><label for="content-refillStep2Text" class="block text-stone font-bold mb-2">Step 2 Text</label><textarea id="content-refillStep2Text" rows="2" class="w-full px-4 py-2 border border-stone/30 rounded-lg bg-white/50"></textarea></div>
                                <div><label for="content-refillStep3Text" class="block text-stone font-bold mb-2">Step 3 Text</label><textarea id="content-refillStep3Text" rows="2" class="w-full px-4 py-2 border border-stone/30 rounded-lg bg-white/50"></textarea></div>
                                <div><label for="content-refillPolicyTitle" class="block text-stone font-bold mb-2">Policy Section Title</label><input type="text" id="content-refillPolicyTitle" class="w-full px-4 py-2 border border-stone/30 rounded-lg bg-white/50"></div>
                                <div><label for="content-refillPolicy1Text" class="block text-stone font-bold mb-2">Policy 1 Text</label><textarea id="content-refillPolicy1Text" rows="2" class="w-full px-4 py-2 border border-stone/30 rounded-lg bg-white/50"></textarea></div>
                                <div><label for="content-refillPolicy2Text" class="block text-stone font-bold mb-2">Policy 2 Text</label><textarea id="content-refillPolicy2Text" rows="2" class="w-full px-4 py-2 border border-stone/30 rounded-lg bg-white/50"></textarea></div>
                            </div>
                        </div>

                        <!-- Save Button -->
                        <div class="text-center mt-8">
                            <button type="submit" class="bg-burnt-orange text-white font-bold text-lg py-3 px-12 rounded-lg shadow-md hover:bg-amber-700 transition-all">
                                Save All Content
                            </button>
                            <p id="content-save-message" class="text-green-600 mt-4 text-lg hidden">Content saved successfully!</p>
                             <!-- Added Error Message -->
                            <p id="content-save-error" class="text-red-600 mt-4 text-lg hidden">Error saving content. Please try again.</p> 
                        </div>
                    </form>
                </div>

            </div> <!-- /end tab panels -->
            
        </div>
    </main>

    <!-- Modal: Add/Edit Product -->
    <div id="product-modal" class="modal fixed inset-0 bg-black/50 z-30 items-center justify-center p-4">
        <div class="modal-content bg-parchment content-wrapper rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <form id="product-form" class="p-6 md:p-8">
                <div class="flex justify-between items-center border-b border-stone/20 pb-4">
                    <h3 id="modal-title" class="font-playfair text-2xl font-bold text-charcoal">Add New Product</h3>
                    <button type="button" id="modal-close-btn" class="text-stone hover:text-burnt-orange text-3xl leading-none">&times;</button> <!-- Improved Close Button -->
                </div>
                
                <input type="hidden" id="product-id">
                
                <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="product-name" class="block text-stone font-bold mb-2">Product Name</label>
                        <input type="text" id="product-name" required class="w-full px-4 py-2 border border-stone/30 rounded-lg bg-white/50 focus:ring-burnt-orange focus:border-burnt-orange transition-colors">
                    </div>
                    <div>
                        <label for="product-price" class="block text-stone font-bold mb-2">Price</label>
                        <input type="text" id="product-price" required class="w-full px-4 py-2 border border-stone/30 rounded-lg bg-white/50 focus:ring-burnt-orange focus:border-burnt-orange transition-colors" placeholder="e.g., 20.00">
                    </div>
                    <div>
                        <label for="product-stock" class="block text-stone font-bold mb-2">Stock</label>
                        <input type="number" id="product-stock" required min="0" class="w-full px-4 py-2 border border-stone/30 rounded-lg bg-white/50 focus:ring-burnt-orange focus:border-burnt-orange transition-colors" placeholder="e.g., 50"> <!-- Added min=0 -->
                    </div>
                    <div>
                        <label for="product-imageUrl" class="block text-stone font-bold mb-2">Image URL</label>
                        <input type="text" id="product-imageUrl" required class="w-full px-4 py-2 border border-stone/30 rounded-lg bg-white/50 focus:ring-burnt-orange focus:border-burnt-orange transition-colors" placeholder="e.g., aloha-luxe-candle.webp">
                    </div>
                    <div>
                        <label for="product-category" class="block text-stone font-bold mb-2">Category</label>
                        <select id="product-category" required class="w-full px-4 py-2 border border-stone/30 rounded-lg bg-white/50 focus:ring-burnt-orange focus:border-burnt-orange transition-colors">
                            <option value="candle">Candle</option>
                            <option value="wax-melt">Wax Melt</option>
                        </select>
                    </div>
                    <div>
                        <label for="product-scentFamily" class="block text-stone font-bold mb-2">Scent Family</label>
                        <select id="product-scentFamily" required class="w-full px-4 py-2 border border-stone/30 rounded-lg bg-white/50 focus:ring-burnt-orange focus:border-burnt-orange transition-colors">
                            <option value="fruity-sweet">Fruity & Sweet</option>
                            <option value="earthy-woody">Earthy & Woody</option>
                            <option value="floral-fresh">Floral & Fresh</option>
                        </select>
                    </div>
                </div>
                
                <div class="mt-6">
                    <label for="product-scentNotes" class="block text-stone font-bold mb-2">Scent Notes</label>
                    <input type="text" id="product-scentNotes" class="w-full px-4 py-2 border border-stone/30 rounded-lg bg-white/50 focus:ring-burnt-orange focus:border-burnt-orange transition-colors" placeholder="e.g., Ripe Peach, Black Tea, Sugar Cane">
                </div>
                <div class="mt-6">
                    <label for="product-shortDescription" class="block text-stone font-bold mb-2">Short Description (for Shop page)</label>
                    <textarea id="product-shortDescription" rows="2" class="w-full px-4 py-2 border border-stone/30 rounded-lg bg-white/50 focus:ring-burnt-orange focus:border-burnt-orange transition-colors"></textarea>
                </div>
                <div class="mt-6">
                    <label for="product-longDescription" class="block text-stone font-bold mb-2">Long Description (for Product page)</label>
                    <textarea id="product-longDescription" rows="5" class="w-full px-4 py-2 border border-stone/30 rounded-lg bg-white/50 focus:ring-burnt-orange focus:border-burnt-orange transition-colors" placeholder="Use <p> tags for paragraphs."></textarea>
                </div>

                <div class="flex justify-end mt-8">
                    <button type="submit" class="bg-burnt-orange text-white font-bold py-3 px-8 rounded-lg shadow-md hover:bg-amber-700 transition-all">
                        Save Product
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal: View Order Details -->
    <div id="order-modal" class="modal fixed inset-0 bg-black/50 z-30 items-center justify-center p-4">
        <div class="modal-content bg-parchment content-wrapper rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="p-6 md:p-8">
                <div class="flex justify-between items-center border-b border-stone/20 pb-4">
                    <h3 class="font-playfair text-2xl font-bold text-charcoal">Order Details</h3>
                    <button type="button" id="order-modal-close-btn" class="text-stone hover:text-burnt-orange text-3xl leading-none">&times;</button> <!-- Improved Close Button -->
                </div>
                <div id="order-details-content" class="mt-6">
                    <!-- Order details will be injected here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Firebase Imports -->
    <script type="module">
        import { db, auth } from './firebase-loader.js';
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
        import { 
            doc, getDoc, getDocs, collection, addDoc, setDoc, updateDoc, deleteDoc, 
            query, where, serverTimestamp, writeBatch 
        } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

        // === DOM Elements ===
        const signOutBtn = document.getElementById('sign-out-btn');
        const addProductBtn = document.getElementById('add-product-btn');
        const tabButtons = document.querySelectorAll('.tab-btn');
        const tabPanels = document.querySelectorAll('.tab-panel');
        
        // Product Modal
        const productModal = document.getElementById('product-modal');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const productForm = document.getElementById('product-form');
        const modalTitle = document.getElementById('modal-title');
        
        // Product Panel
        const productListGrid = document.getElementById('product-list-grid');
        const productsLoading = document.getElementById('products-loading');
        const productSearchInput = document.getElementById('product-search-input'); 
        const productsNoResults = document.getElementById('products-no-results'); 
        
        // Order Panel
        const orderListBody = document.getElementById('order-list-body');
        const ordersLoading = document.getElementById('orders-loading');
        const orderSearchInput = document.getElementById('order-search-input'); 
        const ordersNoResults = document.getElementById('orders-no-results'); 
        
        // Order Modal
        const orderModal = document.getElementById('order-modal');
        const orderModalCloseBtn = document.getElementById('order-modal-close-btn');
        const orderDetailsContent = document.getElementById('order-details-content');

        // Review Panel
        const reviewListGrid = document.getElementById('review-list-grid');
        const reviewsLoading = document.getElementById('reviews-loading');
        const noPendingReviews = document.getElementById('no-pending-reviews');
        const reviewSearchInput = document.getElementById('review-search-input'); 
        const reviewsNoResults = document.getElementById('reviews-no-results'); 
        
        // Dashboard Stats
        const statTotalRevenue = document.getElementById('stat-total-revenue');
        const statTotalOrders = document.getElementById('stat-total-orders');
        const statPendingReviews = document.getElementById('stat-pending-reviews');
        const statAvgOrderValue = document.getElementById('stat-avg-order-value');
        const statTotalProducts = document.getElementById('stat-total-products');
        const statOutOfStock = document.getElementById('stat-out-of-stock');
        const statApprovedReviews = document.getElementById('stat-approved-reviews');


        // Site Content
        const siteContentForm = document.getElementById('site-content-form');
        const contentSaveMessage = document.getElementById('content-save-message');
        const contentSaveError = document.getElementById('content-save-error'); 
        const accordionToggles = document.querySelectorAll('[id$="-toggle"]');
        
        // CSV & Data Tools
        const exportCsvBtn = document.getElementById('export-csv-btn');
        const importCsvBtn = document.getElementById('import-csv-btn');
        const csvFileInput = document.getElementById('csv-file-input');
        const csvMessage = document.getElementById('csv-message');
        const exportProductsBtn = document.getElementById('export-products-btn'); 

        // Data Caches
        let allProducts = []; 
        let allOrders = []; 
        let pendingReviews = []; 

        // === Tab Switching Logic ===
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetTab = button.dataset.tab;

                tabButtons.forEach(btn => {
                    btn.classList.replace('active', 'inactive');
                    btn.classList.remove('border'); // Ensure inactive doesn't always have border
                    if(btn.classList.contains('inactive')) {
                         btn.classList.add('border'); // Re-add border only if inactive
                    }
                });
                button.classList.replace('inactive', 'active');
                button.classList.remove('border'); // Active button shouldn't have border

                tabPanels.forEach(panel => {
                    panel.classList.toggle('active', panel.id === `panel-${targetTab}`);
                });
            });
        });

        // === Product Management ===
        
        // *** FIX: Removed duplicate declaration ***
        // async function loadProducts() { ... } // Duplicate removed

        async function loadProducts() {
            productsLoading.classList.remove('hidden');
            productsNoResults.classList.add('hidden'); // Hide no results message
            productListGrid.innerHTML = '';
            allProducts = []; // Clear cache

            try {
                const querySnapshot = await getDocs(collection(db, "products"));
                querySnapshot.forEach((doc) => {
                    allProducts.push({ id: doc.id, ...doc.data() });
                });
                
                allProducts.sort((a, b) => (a.name || '').localeCompare(b.name || '')); // Safer sort
                renderProducts(allProducts); // Render full list initially
                updateProductStats(); // Update stats based on loaded products
                
            } catch (error) {
                console.error("Error loading products: ", error); // Log specific error
                productsLoading.textContent = "Error loading products. Check console."; // Inform user
                productListGrid.innerHTML = `<p class="text-red-600 text-center col-span-full">Could not load products. Please try again later.</p>`;
            } finally {
                 productsLoading.classList.add('hidden'); // Hide loading message even on error
            }
        }
        
        function renderProducts(productsToRender) {
             try {
                productListGrid.innerHTML = '';
                productsNoResults.classList.add('hidden'); 

                if (productsToRender.length === 0) {
                     if (productSearchInput.value) { 
                         productsNoResults.classList.remove('hidden');
                     } else {
                         productListGrid.innerHTML = `<p class="text-stone text-center col-span-full">No products found.</p>`;
                     }
                    return;
                }

                productsToRender.forEach(product => {
                    try { 
                        const card = document.createElement('div');
                        card.className = "bg-white/60 p-5 rounded-lg shadow-lg flex flex-col";
                        const stock = product.stock ?? 0; 
                        const stockColor = stock > 10 ? 'text-green-600' : (stock > 0 ? 'text-amber-600' : 'text-red-600');
                        
                        const productName = product.name || 'Unnamed Product';
                        const productPrice = product.price || '0.00';
                        const productCategory = product.category || 'N/A';
                        const productScentFamily = product.scentFamily || 'N/A';
                        const productImageUrl = product.imageUrl || 'placeholder.webp'; 
                        const productId = product.id || ''; 

                        card.innerHTML = `
                            <img src="${productImageUrl}" alt="${productName}" class="w-full h-48 object-cover rounded-md shadow-sm" onerror="this.src='https://placehold.co/400x400/FBF9F6/3D352E?text=Image+Not+Found'; this.onerror=null;">
                            <h3 class="font-playfair text-xl font-bold text-charcoal mt-4">${productName}</h3>
                            <p class="font-bold text-lg text-burnt-orange mt-1">$${productPrice}</p>
                            <p class="text-sm text-stone mt-1">Category: ${productCategory}</p>
                            <p class="text-sm text-stone">Family: ${productScentFamily}</p>
                            <p class="text-sm font-bold mt-2 ${stockColor}">Stock: ${stock}</p> 
                            <div class="mt-4 pt-4 border-t border-stone/20 flex-grow flex items-end justify-between gap-2">
                                <button class="stock-update-btn" data-id="${productId}" data-name="${productName}">
                                    Update Stock
                                </button>
                                <button class="edit-product-btn bg-charcoal text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-stone transition-colors" data-id="${productId}">
                                    Edit
                                </button>
                                <button class="delete-product-btn bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-red-800 transition-colors" data-id="${productId}" data-name="${productName}">
                                    Delete
                                </button>
                            </div>
                        `;
                        productListGrid.appendChild(card);
                    } catch (cardError) {
                        console.error("Error rendering product card:", product?.id, cardError); 
                        const errorCard = document.createElement('div');
                        errorCard.className = "bg-red-100 p-5 rounded-lg shadow-lg text-red-700";
                        errorCard.innerHTML = `<p>Error displaying product (ID: ${product?.id || 'unknown'}). Check console.</p>`;
                        productListGrid.appendChild(errorCard);
                    }
                });
            } catch (renderError) {
                 console.error("Critical error in renderProducts:", renderError);
                 productListGrid.innerHTML = `<p class="text-red-600 text-center col-span-full">Error displaying products. Check console.</p>`;
            }
        }
        
        productSearchInput.addEventListener('input', () => {
            try { 
                const searchTerm = productSearchInput.value.toLowerCase();
                const filteredProducts = allProducts.filter(product => 
                     (product.name && product.name.toLowerCase().includes(searchTerm)) ||
                     (product.id && product.id.toLowerCase().includes(searchTerm)) 
                );
                renderProducts(filteredProducts);
            } catch (error) {
                 console.error("Error during product search filter:", error); 
            }
        });

        productListGrid.addEventListener('click', async (e) => {
            const button = e.target.closest('.stock-update-btn');
            if (button) {
                 const id = button.dataset.id;
                 const name = button.dataset.name;
                 const productToUpdate = allProducts.find(p => p.id === id); 
                 const currentStock = productToUpdate ? (productToUpdate.stock ?? 0) : 0; 
                 const newStock = prompt(`Enter new stock for "${name}":`, currentStock); 

                 if (newStock !== null && !isNaN(newStock) && newStock >= 0) {
                     const stockVal = parseInt(newStock, 10);
                     try {
                         const productRef = doc(db, "products", id);
                         await updateDoc(productRef, { stock: stockVal });
                         if (productToUpdate) {
                             productToUpdate.stock = stockVal; 
                             const searchTerm = productSearchInput.value.toLowerCase();
                             const filteredProducts = allProducts.filter(product => 
                                 (product.name && product.name.toLowerCase().includes(searchTerm)) ||
                                 (product.id && product.id.toLowerCase().includes(searchTerm)) 
                             );
                             renderProducts(filteredProducts); 
                             updateProductStats(); 
                         }
                     } catch (error) {
                         console.error("Error updating stock:", error);
                         alert("Error updating stock.");
                     }
                 } else if (newStock !== null) {
                     alert("Please enter a valid number (0 or greater).");
                 }
            }
        });

         function openProductModal(productId = null) {
            try { 
                productForm.reset();
                document.getElementById('product-id').value = '';
                
                if (productId) {
                    modalTitle.textContent = "Edit Product";
                    const product = allProducts.find(p => p.id === productId); 
                    if (product) {
                        document.getElementById('product-id').value = product.id || '';
                        document.getElementById('product-name').value = product.name || '';
                        document.getElementById('product-price').value = product.price || '';
                        document.getElementById('product-stock').value = product.stock ?? ''; 
                        document.getElementById('product-imageUrl').value = product.imageUrl || '';
                        document.getElementById('product-category').value = product.category || 'candle'; 
                        document.getElementById('product-scentFamily').value = product.scentFamily || 'fruity-sweet'; 
                        document.getElementById('product-scentNotes').value = product.scentNotes || '';
                        document.getElementById('product-shortDescription').value = product.shortDescription || '';
                        document.getElementById('product-longDescription').value = product.longDescription || '';
                    } else {
                         console.error("Product not found in cache for editing:", productId);
                         alert("Error: Could not find product data to edit.");
                         return; 
                    }
                } else {
                    modalTitle.textContent = "Add New Product";
                }
                productModal.classList.add('active');
            } catch (error) {
                 console.error("Error opening product modal:", error);
                 alert("Could not open product form.");
            }
        }
        
        function closeProductModal() {
            productModal.classList.remove('active');
        }
        
        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const productId = document.getElementById('product-id').value;
             let priceValue = document.getElementById('product-price').value.trim();
             if (!/^\d+(\.\d{1,2})?$/.test(priceValue)) {
                 alert('Invalid price format. Use numbers like 20 or 20.00');
                 return;
             }
             priceValue = parseFloat(priceValue).toFixed(2);
             const stockValue = parseInt(document.getElementById('product-stock').value, 10);
              if (isNaN(stockValue) || stockValue < 0) {
                   alert('Invalid stock value. Must be 0 or greater.');
                   return;
              }
            
            const productData = { 
                name: document.getElementById('product-name').value,
                price: priceValue, 
                stock: stockValue, 
                imageUrl: document.getElementById('product-imageUrl').value,
                category: document.getElementById('product-category').value,
                scentFamily: document.getElementById('product-scentFamily').value,
                scentNotes: document.getElementById('product-scentNotes').value,
                shortDescription: document.getElementById('product-shortDescription').value,
                longDescription: document.getElementById('product-longDescription').value,
            };

            try {
                if (productId) {
                    const docRef = doc(db, "products", productId);
                    await setDoc(docRef, productData, { merge: true }); 
                } else {
                     const generatedId = productData.name.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
                     if (!generatedId) {
                         alert("Product name must contain letters or numbers to generate an ID.");
                         return;
                     }
                    const newDocRef = doc(db, "products", generatedId);
                     const docSnap = await getDoc(newDocRef);
                     if (docSnap.exists()) {
                         alert(`Error: A product with ID '${generatedId}' already exists. Choose a different name.`);
                         return;
                     }
                    await setDoc(newDocRef, productData);
                }
                closeProductModal();
                loadProducts(); 
            } catch (error) {
                console.error("Error saving product: ", error);
                alert("Error saving product. See console for details.");
            }
        });
        
        productListGrid.addEventListener('click', async (e) => {
             const button = e.target.closest('.delete-product-btn');
             if (button) {
                 const id = button.dataset.id;
                 const name = button.dataset.name;
                 if (confirm(`Are you sure you want to delete "${name}"? This cannot be undone.`)) {
                     try {
                         await deleteDoc(doc(db, "products", id));
                         loadProducts(); 
                     } catch (error) {
                         console.error("Error deleting product: ", error);
                         alert("Error deleting product. See console for details.");
                     }
                 }
             }
        });
        
        productListGrid.addEventListener('click', (e) => {
             const button = e.target.closest('.edit-product-btn');
             if (button) {
                 openProductModal(button.dataset.id);
             }
        });

        // === Order Management ===
        async function loadOrders() {
            ordersLoading.classList.remove('hidden');
            ordersNoResults.classList.add('hidden'); 
            orderListBody.innerHTML = '';
            allOrders = []; 
            let totalRevenue = 0; 
            let totalOrders = 0; 
            
            try {
                const querySnapshot = await getDocs(collection(db, "orders"));
                totalOrders = querySnapshot.size; 

                querySnapshot.forEach((doc) => {
                    const orderData = doc.data();
                    const amountValue = orderData?.purchase_units?.[0]?.amount?.value;
                    if (amountValue && !isNaN(parseFloat(amountValue))) {
                         totalRevenue += parseFloat(amountValue);
                    }
                    allOrders.push({ id: doc.id, ...orderData });
                });

                allOrders.sort((a, b) => { 
                    const dateA = a.create_time ? new Date(a.create_time).getTime() : 0; 
                    const dateB = b.create_time ? new Date(b.create_time).getTime() : 0;
                    return dateB - dateA; 
                });
                
                renderOrders(allOrders); 
                updateOrderStats(totalRevenue, totalOrders); 

            } catch (error) {
                console.error("Error loading orders: ", error); 
                ordersLoading.textContent = "Error loading orders. Check console."; 
                updateOrderStats(0, 0); 
                orderListBody.innerHTML = `<tr><td colspan="6" class="text-red-600 text-center py-4">Could not load orders. Please try again later.</td></tr>`;
            } finally {
                 ordersLoading.classList.add('hidden'); 
            }
        }

        orderSearchInput.addEventListener('input', () => {
             try { 
                 const searchTerm = orderSearchInput.value.toLowerCase();
                 const filteredOrders = allOrders.filter(order => {
                     const customerName = `${order?.payer?.name?.given_name || ''} ${order?.payer?.name?.surname || ''}`.toLowerCase();
                     const email = order?.payer?.email_address?.toLowerCase() || '';
                     const orderId = order?.id?.toLowerCase() || '';
                     return orderId.includes(searchTerm) || customerName.includes(searchTerm) || email.includes(searchTerm);
                 });
                 renderOrders(filteredOrders);
             } catch (error) {
                  console.error("Error during order search filter:", error); 
             }
        });
        
        function renderOrders(ordersToRender) {
             try { 
                 orderListBody.innerHTML = ''; 
                 ordersNoResults.classList.add('hidden'); 

                 if (ordersToRender.length === 0) {
                     if (orderSearchInput.value) { 
                         ordersNoResults.classList.remove('hidden');
                     } else {
                         orderListBody.innerHTML = `<tr><td colspan="6" class="text-center text-stone py-4">No orders found.</td></tr>`;
                     }
                     return;
                 }

                ordersToRender.forEach(order => {
                    try { 
                        const row = document.createElement('tr');
                         const orderId = order.id || 'N/A';
                         const orderDate = order.create_time ? new Date(order.create_time).toLocaleDateString() : 'N/A';
                         const customerName = `${order?.payer?.name?.given_name || ''} ${order?.payer?.name?.surname || ''}`.trim() || 'N/A';
                         const total = order?.purchase_units?.[0]?.amount?.value || '0.00';
                         const status = order.status || "NEW"; 
                        
                        row.innerHTML = `
                            <td class="py-3 px-4">${orderId}</td>
                            <td class="py-3 px-4">${orderDate}</td>
                            <td class="py-3 px-4">${customerName}</td>
                            <td class="py-3 px-4">$${total}</td>
                            <td class="py-3 px-4">
                                <select class="order-status-select border border-stone/30 rounded-lg" data-id="${orderId}">
                                    <option value="NEW" ${status === 'NEW' ? 'selected' : ''}>New</option>
                                    <option value="PROCESSING" ${status === 'PROCESSING' ? 'selected' : ''}>Processing</option>
                                    <option value="SHIPPED" ${status === 'SHIPPED' ? 'selected' : ''}>Shipped</option>
                                    <option value="COMPLETED" ${status === 'COMPLETED' ? 'selected' : ''}>Completed</option>
                                    <option value="CANCELLED" ${status === 'CANCELLED' ? 'selected' : ''}>Cancelled</option>
                                </select>
                            </td>
                            <td class="py-3 px-4">
                                <button class="view-order-btn bg-charcoal text-white font-bold py-1 px-3 rounded-lg text-sm hover:bg-stone" data-id="${orderId}">View</button>
                            </td>
                        `;
                        orderListBody.appendChild(row);
                    } catch (rowError) {
                        console.error("Error rendering order row:", order?.id, rowError); 
                         const errorRow = document.createElement('tr');
                         errorRow.innerHTML = `<td colspan="6" class="text-red-600 text-center py-4">Error displaying order (ID: ${order?.id || 'unknown'}). Check console.</td>`;
                         orderListBody.appendChild(errorRow);
                    }
                });
             } catch (renderError) {
                  console.error("Critical error in renderOrders:", renderError);
                  orderListBody.innerHTML = `<tr><td colspan="6" class="text-red-600 text-center py-4">Error displaying orders. Check console.</td></tr>`;
             }
        }
        
        orderListBody.addEventListener('click', async (e) => {
             const button = e.target.closest('.view-order-btn');
             if (button) {
                 const orderId = button.dataset.id;
                 let order = allOrders.find(o => o.id === orderId);
                 if (order) {
                     renderOrderDetails(order); 
                     orderModal.classList.add('active');
                 } else {
                     try { 
                         const docRef = doc(db, "orders", orderId);
                         const docSnap = await getDoc(docRef);
                         if (docSnap.exists()) {
                             order = { id: docSnap.id, ...docSnap.data() };
                             renderOrderDetails(order);
                             orderModal.classList.add('active');
                         } else {
                              alert("Order details not found.");
                         }
                     } catch (error) {
                         console.error("Error fetching order details:", error);
                         alert("Could not load order details.");
                     }
                 }
             }
        });

        orderListBody.addEventListener('change', async (e) => {
            const select = e.target.closest('.order-status-select');
            if (select) { 
                const orderId = select.dataset.id;
                const newStatus = select.value;
                try {
                    const docRef = doc(db, "orders", orderId);
                    await updateDoc(docRef, { status: newStatus });
                    const orderInCache = allOrders.find(o => o.id === orderId);
                    if (orderInCache) {
                         orderInCache.status = newStatus;
                    }
                } catch (error) {
                    console.error("Error updating order status:", error);
                    alert("Could not update status.");
                }
             }
        });
        
        function renderOrderDetails(order) {
            try {
                 const customerName = `${order?.payer?.name?.given_name || ''} ${order?.payer?.name?.surname || ''}`.trim() || 'N/A';
                 const email = order?.payer?.email_address || 'N/A';
                 const shipping = order?.purchase_units?.[0]?.shipping;
                 const items = order?.purchase_units?.[0]?.items || []; 
                 
                 let itemsHtml = items.map(item => {
                      const itemName = item?.name || 'Unknown Item';
                      const itemQty = item?.quantity || 1;
                      const itemAmount = item?.unit_amount?.value || '0.00';
                     return `
                         <li class="flex justify-between py-2 border-b border-stone/20">
                             <span>${itemName} (Qty: ${itemQty})</span>
                             <span>$${itemAmount}</span>
                         </li>
                     `;
                 }).join('');

                 let shippingHtml = 'N/A';
                 if (shipping?.address) {
                      shippingHtml = `
                          ${shipping.name?.full_name || ''}<br>
                          ${shipping.address.address_line_1 || ''}<br>
                          ${shipping.address.admin_area_2 || ''}, ${shipping.address.admin_area_1 || ''} ${shipping.address.postal_code || ''}<br>
                          ${shipping.address.country_code || ''}
                      `.trim(); 
                      if (shippingHtml === '<br><br>,') shippingHtml = 'N/A'; 
                 }

                 const subtotal = order?.purchase_units?.[0]?.amount?.breakdown?.item_total?.value || '0.00';
                 const shippingCost = order?.purchase_units?.[0]?.amount?.breakdown?.shipping?.value || '0.00';
                 const totalPaid = order?.purchase_units?.[0]?.amount?.value || '0.00';
                 const currencyCode = order?.purchase_units?.[0]?.amount?.currency_code || '';

                orderDetailsContent.innerHTML = `
                    <p class="mb-2"><strong>Order ID:</strong> ${order.id || 'N/A'}</p>
                    <p class="mb-2"><strong>Customer:</strong> ${customerName}</p>
                    <p class="mb-4"><strong>Email:</strong> ${email}</p>
                    
                    <h4 class="font-playfair text-lg font-bold text-charcoal mb-2">Shipping Address</h4>
                    <div class="text-stone mb-4">${shippingHtml || 'N/A'}</div> 
                    
                    <h4 class="font-playfair text-lg font-bold text-charcoal mb-2">Items</h4>
                    <ul class="mb-4">${itemsHtml.length > 0 ? itemsHtml : '<li>No items found in order data.</li>'}</ul>
                    
                    <h4 class="font-playfair text-lg font-bold text-charcoal mb-2">Totals</h4>
                    <p class="text-stone"><strong>Subtotal:</strong> $${subtotal}</p>
                    <p class="text-stone"><strong>Shipping:</strong> $${shippingCost}</p>
                    <p class="font-bold text-charcoal mt-2"><strong>Total Paid:</strong> $${totalPaid} ${currencyCode}</p>
                `;
            } catch (error) {
                 console.error("Error rendering order details:", order?.id, error);
                 orderDetailsContent.innerHTML = `<p class="text-red-600">Could not display order details. Check console.</p>`;
            }
        }


        // === Review Management ===
        async function loadPendingReviews() {
            reviewsLoading.classList.remove('hidden');
            noPendingReviews.classList.add('hidden');
            reviewsNoResults.classList.add('hidden'); 
            reviewListGrid.innerHTML = '';
            pendingReviews = []; 
            let pendingReviewsCount = 0; 
            
            try {
                const q = query(collection(db, "reviews"), where("approved", "==", false));
                const querySnapshot = await getDocs(q);
                pendingReviewsCount = querySnapshot.size; 

                querySnapshot.forEach((doc) => {
                    pendingReviews.push({ id: doc.id, ...doc.data() });
                });

                pendingReviews.sort((a, b) => { 
                    const dateA = a.submitdate?.toDate ? a.submitdate.toDate().getTime() : 0; 
                    const dateB = b.submitdate?.toDate ? b.submitdate.toDate().getTime() : 0;
                    return dateA - dateB; 
                });
                
                renderPendingReviews(pendingReviews); 
                updateReviewStats(pendingReviewsCount); 

            } catch (error) {
                console.error("Error loading reviews: ", error); 
                reviewsLoading.textContent = "Error loading reviews. Check console."; 
                 updateReviewStats(0); 
                 reviewListGrid.innerHTML = `<p class="text-red-600 text-center col-span-full">Could not load reviews. Please try again later.</p>`;
            } finally {
                 reviewsLoading.classList.add('hidden'); 
            }
        }

        reviewSearchInput.addEventListener('input', () => {
             try { 
                 const searchTerm = reviewSearchInput.value.toLowerCase();
                 const filteredReviews = pendingReviews.filter(review => {
                     const productName = review?.productName?.toLowerCase() || '';
                     const reviewerName = (review?.name || review?.reviewerName || '').toLowerCase(); 
                     const reviewText = review?.text?.toLowerCase() || '';
                     return productName.includes(searchTerm) || reviewerName.includes(searchTerm) || reviewText.includes(searchTerm);
                 });
                 renderPendingReviews(filteredReviews);
             } catch (error) {
                  console.error("Error during review search filter:", error); 
             }
        });

        function renderPendingReviews(reviewsToRender) {
             try { 
                 reviewListGrid.innerHTML = ''; 
                 reviewsNoResults.classList.add('hidden'); 
                 noPendingReviews.classList.add('hidden'); 

                if (reviewsToRender.length === 0) {
                     if (reviewSearchInput.value) { 
                         reviewsNoResults.classList.remove('hidden');
                     } else {
                         noPendingReviews.classList.remove('hidden');
                     }
                     return;
                 }
                    
                reviewsToRender.forEach(review => {
                    try { 
                        const card = document.createElement('div');
                        card.id = `review-${review.id}`;
                        card.className = "bg-white/60 p-5 rounded-lg shadow-lg flex flex-col";
                        const reviewDate = review.submitdate?.toDate ? review.submitdate.toDate().toLocaleDateString() : 'No date'; 
                         const reviewerName = review.name || review.reviewerName || 'Anonymous'; 

                        const rating = (typeof review.rating === 'number' && review.rating >= 0 && review.rating <= 5) ? review.rating : 0;
                        const starsHTML = ''.repeat(rating) + ''.repeat(5 - rating);
                        
                         const productName = review.productName || 'Unknown Product';
                         const reviewText = review.text || 'No text provided.';
                         const reviewId = review.id || ''; 

                        card.innerHTML = `
                            <h3 class="font-playfair text-lg font-bold text-charcoal">${productName}</h3>
                            <p class="text-sm text-stone mb-2">By ${reviewerName} on ${reviewDate}</p>
                            <div class="review-stars text-amber-600 text-xl" aria-label="Rating: ${rating} out of 5 stars">
                                ${starsHTML}
                            </div>
                            <p class="text-stone my-3 flex-grow">${reviewText}</p>
                            <div class="mt-4 pt-4 border-t border-stone/20 flex justify-between gap-2">
                                <button class="approve-review-btn bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 transition-colors" data-id="${reviewId}">
                                    Approve
                                </button>
                                <button class="delete-review-btn bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-red-800 transition-colors" data-id="${reviewId}">
                                    Delete
                                </button>
                            </div>
                        `;
                        reviewListGrid.appendChild(card);
                    } catch (cardError) {
                         console.error("Error rendering review card:", review?.id, cardError); 
                         const errorCard = document.createElement('div');
                         errorCard.className = "bg-red-100 p-5 rounded-lg shadow-lg text-red-700";
                         errorCard.innerHTML = `<p>Error displaying review (ID: ${review?.id || 'unknown'}). Check console.</p>`;
                         reviewListGrid.appendChild(errorCard);
                    }
                });
             } catch (renderError) {
                  console.error("Critical error in renderPendingReviews:", renderError);
                  reviewListGrid.innerHTML = `<p class="text-red-600 text-center col-span-full">Error displaying reviews. Check console.</p>`;
             }
        }
        
        reviewListGrid.addEventListener('click', async (e) => {
             const button = e.target.closest('.approve-review-btn');
             if (button) {
                 const id = button.dataset.id;
                 try {
                     const docRef = doc(db, "reviews", id);
                     await updateDoc(docRef, { approved: true });
                     pendingReviews = pendingReviews.filter(review => review.id !== id);
                     const searchTerm = reviewSearchInput.value.toLowerCase();
                     const filteredReviews = pendingReviews.filter(review => {
                         const productName = review?.productName?.toLowerCase() || '';
                         const reviewerName = (review?.name || review?.reviewerName || '').toLowerCase();
                         const reviewText = review?.text?.toLowerCase() || '';
                         return productName.includes(searchTerm) || reviewerName.includes(searchTerm) || reviewText.includes(searchTerm);
                     });
                     renderPendingReviews(filteredReviews);
                     const currentPending = parseInt(statPendingReviews.textContent || '1', 10);
                     updateReviewStats(currentPending - 1);
                     loadApprovedReviewCount(); 
                 } catch (error) {
                     console.error("Error approving review:", error);
                     alert("Error approving review."); 
                 }
             }
        });

        reviewListGrid.addEventListener('click', async (e) => {
             const button = e.target.closest('.delete-review-btn');
             if (button) {
                 const id = button.dataset.id;
                 if (confirm("Are you sure you want to delete this review?")) {
                     try {
                         await deleteDoc(doc(db, "reviews", id));
                         pendingReviews = pendingReviews.filter(review => review.id !== id);
                         const searchTerm = reviewSearchInput.value.toLowerCase();
                         const filteredReviews = pendingReviews.filter(review => {
                             const productName = review?.productName?.toLowerCase() || '';
                             const reviewerName = (review?.name || review?.reviewerName || '').toLowerCase();
                             const reviewText = review?.text?.toLowerCase() || '';
                             return productName.includes(searchTerm) || reviewerName.includes(searchTerm) || reviewText.includes(searchTerm);
                         });
                         renderPendingReviews(filteredReviews);
                         const currentPending = parseInt(statPendingReviews.textContent || '1', 10);
                         updateReviewStats(currentPending - 1);
                     } catch (error) {
                         console.error("Error deleting review:", error);
                         alert("Error deleting review."); 
                     }
                 }
             }
        });
        
        // --- Dashboard Stats Logic ---
        function updateProductStats() {
            try { 
                let outOfStockCount = 0;
                if (Array.isArray(allProducts)) {
                    allProducts.forEach(p => {
                        if ((p?.stock ?? 0) <= 0) { 
                            outOfStockCount++;
                        }
                    });
                    statTotalProducts.textContent = allProducts.length;
                    statOutOfStock.textContent = outOfStockCount;
                } else {
                     console.warn("updateProductStats called before allProducts was loaded or is not an array.");
                     statTotalProducts.textContent = 'N/A';
                     statOutOfStock.textContent = 'N/A';
                }
            } catch (error) {
                 console.error("Error updating product stats:", error);
                 statTotalProducts.textContent = 'Err';
                 statOutOfStock.textContent = 'Err';
            }
        }

        function updateOrderStats(totalRevenue, totalOrders) {
             try { 
                 statTotalRevenue.textContent = `$${(totalRevenue || 0).toFixed(2)}`;
                 statTotalOrders.textContent = totalOrders || 0;
                 const avgValue = totalOrders > 0 ? (totalRevenue / totalOrders) : 0;
                 statAvgOrderValue.textContent = `$${avgValue.toFixed(2)}`;
            } catch (error) {
                 console.error("Error updating order stats:", error);
                 statTotalRevenue.textContent = '$Err';
                 statTotalOrders.textContent = 'Err';
                 statAvgOrderValue.textContent = '$Err';
            }
        }

        function updateReviewStats(pendingCount) {
             try { 
                 statPendingReviews.textContent = pendingCount >= 0 ? pendingCount : 0; 
             } catch (error) {
                  console.error("Error updating pending review stat:", error);
                  statPendingReviews.textContent = 'Err';
             }
        }
        
         async function loadApprovedReviewCount() {
            try { 
                const q = query(collection(db, "reviews"), where("approved", "==", true));
                const querySnapshot = await getDocs(q);
                statApprovedReviews.textContent = querySnapshot.size;
            } catch (error) {
                console.error("Error loading approved review count:", error);
                statApprovedReviews.textContent = 'Error';
            }
        }
        
        // === Site Content Management === 
        async function loadSiteContent() {
            try { 
                const homepageRef = doc(db, "siteContent", "homepage");
                const homepageSnap = await getDoc(homepageRef);
                if (homepageSnap.exists()) {
                    const data = homepageSnap.data();
                    document.getElementById('content-heroTitle').value = data.heroTitle || '';
                    document.getElementById('content-heroSubtitle').value = data.heroSubtitle || '';
                    document.getElementById('content-featuredProductId').value = data.featuredProductId || '';
                }
                
                const aboutRef = doc(db, "siteContent", "about");
                const aboutSnap = await getDoc(aboutRef);
                if (aboutSnap.exists()) {
                    const data = aboutSnap.data();
                    document.getElementById('content-aboutTitle').value = data.aboutTitle || '';
                    document.getElementById('content-aboutParagraph1').value = data.aboutParagraph1 || '';
                    document.getElementById('content-aboutParagraph2').value = data.aboutParagraph2 || '';
                }

                const refillRef = doc(db, "siteContent", "refillProgram");
                const refillSnap = await getDoc(refillRef);
                if (refillSnap.exists()) {
                    const data = refillSnap.data();
                    document.getElementById('content-refillTitle').value = data.refillTitle || '';
                    document.getElementById('content-refillSubtitle').value = data.refillSubtitle || '';
                    document.getElementById('content-refillStep1Text').value = data.refillStep1Text || '';
                    document.getElementById('content-refillStep2Text').value = data.refillStep2Text || '';
                    document.getElementById('content-refillStep3Text').value = data.refillStep3Text || '';
                    document.getElementById('content-refillPolicyTitle').value = data.refillPolicyTitle || '';
                    document.getElementById('content-refillPolicy1Text').value = data.refillPolicy1Text || '';
                    document.getElementById('content-refillPolicy2Text').value = data.refillPolicy2Text || '';
                }

            } catch (error) {
                console.error("Error loading site content:", error);
            }
        }
        
        async function handleSiteContentSubmit(e) {
             e.preventDefault();
             contentSaveMessage.classList.add('hidden'); 
             contentSaveError.classList.add('hidden');
             console.log("DEBUG: Site Content - Save button clicked."); 

            try { 
                const homepageData = {
                    heroTitle: document.getElementById('content-heroTitle').value,
                    heroSubtitle: document.getElementById('content-heroSubtitle').value,
                    featuredProductId: document.getElementById('content-featuredProductId').value
                };
                 console.log("DEBUG: Site Content - Homepage data to save:", homepageData); 
                
                const aboutData = {
                    aboutTitle: document.getElementById('content-aboutTitle').value,
                    aboutParagraph1: document.getElementById('content-aboutParagraph1').value,
                    aboutParagraph2: document.getElementById('content-aboutParagraph2').value
                };
                 console.log("DEBUG: Site Content - About Us data to save:", aboutData); 

                const refillData = {
                    refillTitle: document.getElementById('content-refillTitle').value,
                    refillSubtitle: document.getElementById('content-refillSubtitle').value,
                    refillStep1Text: document.getElementById('content-refillStep1Text').value,
                    refillStep2Text: document.getElementById('content-refillStep2Text').value,
                    refillStep3Text: document.getElementById('content-refillStep3Text').value,
                    refillPolicyTitle: document.getElementById('content-refillPolicyTitle').value,
                    refillPolicy1Text: document.getElementById('content-refillPolicy1Text').value,
                    refillPolicy2Text: document.getElementById('content-refillPolicy2Text').value
                };
                 console.log("DEBUG: Site Content - Refill Program data to save:", refillData); 

                 console.log("DEBUG: Site Content - Creating Firestore batch..."); 
                const batch = writeBatch(db);
                batch.set(doc(db, "siteContent", "homepage"), homepageData, { merge: true });
                batch.set(doc(db, "siteContent", "about"), aboutData, { merge: true });
                batch.set(doc(db, "siteContent", "refillProgram"), refillData, { merge: true });
                
                 console.log("DEBUG: Site Content - Committing batch..."); 
                await batch.commit();
                console.log("DEBUG: Site Content - Batch commit successful."); 

                contentSaveMessage.classList.remove('hidden');
                setTimeout(() => {
                    contentSaveMessage.classList.add('hidden');
                }, 3000);

            } catch (error) {
                console.error("Error saving site content:", error); 
                 contentSaveError.classList.remove('hidden'); 
                 setTimeout(() => {
                    contentSaveError.classList.add('hidden');
                }, 5000); 
            }
        }
        

        // === Data Export/Import ===
        exportProductsBtn.addEventListener('click', () => {
            if (!Array.isArray(allProducts) || allProducts.length === 0) { // Safer check
                alert("No products loaded to export. Try refreshing.");
                return;
            }
            try {
                const jsonString = JSON.stringify(allProducts, null, 2); 
                const blob = new Blob([jsonString], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'southernsense_products_export.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (error) {
                console.error("Error exporting JSON:", error);
                alert("An error occurred during the JSON export.");
            }
        });

        exportCsvBtn.addEventListener('click', () => {
             if (!Array.isArray(allProducts) || allProducts.length === 0) { // Safer check
                alert("No products loaded to export. Try refreshing.");
                return;
            }
            
            const headers = [
                'id', 'name', 'price', 'stock', 'imageUrl', 'category', 
                'scentFamily', 'scentNotes', 'shortDescription', 'longDescription'
            ];
            
            try { // Add try...catch around CSV generation
                let csvContent = headers.join(",") + "\n"; // Start with headers

                allProducts.forEach(product => {
                    const row = headers.map(header => {
                        let value = product ? product[header] : ''; // Safer access
                        if (value === null || value === undefined) {
                            return "";
                        }
                        if (typeof value === 'string') {
                            // Escape double quotes and wrap in double quotes if it contains comma, newline or double quote
                            if (value.includes(',') || value.includes('\n') || value.includes('"')) {
                                value = `"${value.replace(/"/g, '""')}"`; 
                            }
                        }
                        return value;
                    });
                    csvContent += row.join(",") + "\n";
                });

                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }); // Use Blob for better handling
                const link = document.createElement("a");
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "southernsense_products.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);

            } catch (error) {
                 console.error("Error generating or downloading CSV:", error);
                 alert("An error occurred during the CSV export.");
            }
        });

        importCsvBtn.addEventListener('click', () => {
            const file = csvFileInput.files[0];
            if (!file) {
                alert("Please select a CSV file to import.");
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                const text = e.target.result;
                // Basic split, needs improvement for robust CSV parsing
                const lines = text.split('\n').filter(line => line.trim() !== ''); 
                
                if (lines.length <= 1) {
                    alert("CSV file is empty or only contains headers.");
                    return;
                }
                
                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, '')); 
                
                const requiredHeaders = ['id', 'name', 'price', 'stock', 'category', 'scentFamily'];
                let missingHeaders = [];
                for (const req of requiredHeaders) {
                    if (!headers.includes(req)) {
                        missingHeaders.push(req);
                    }
                }
                if (missingHeaders.length > 0) {
                    alert(`Import failed. CSV is missing required columns: ${missingHeaders.join(', ')}`);
                    return;
                }
                
                csvMessage.textContent = `Importing ${lines.length - 1} products...`;
                csvMessage.classList.remove('hidden', 'text-red-600', 'text-green-600');
                csvMessage.classList.add('text-stone');

                try {
                    const batch = writeBatch(db);
                    let importedCount = 0;

                    for (let i = 1; i < lines.length; i++) {
                        // TODO: Use a proper CSV parsing library for robustness
                        const values = lines[i].split(','); // Simple split - fragile
                        
                        let product = {};
                        let productId = null; // Store ID separately

                        headers.forEach((header, index) => {
                            let value = values[index];
                            if (value !== undefined) { // Check if value exists
                                value = value.trim().replace(/^"|"$/g, '').replace(/""/g, '"'); 
                            } else {
                                value = ''; // Default to empty string if undefined
                            }
                            
                            if (header === 'id' && value) {
                                productId = value; // Store the ID
                            } else if (header === 'stock') {
                                product[header] = parseInt(value, 10) || 0;
                            } else if (value) { 
                                product[header] = value;
                            }
                        });

                        // We must have an ID to update a product
                        if (productId) {
                            const docRef = doc(db, "products", productId);
                            batch.set(docRef, product, { merge: true }); 
                            importedCount++;
                        } else {
                             console.warn("Skipping row in CSV import due to missing ID:", lines[i]);
                        }
                    }

                    await batch.commit();
                    
                    csvMessage.textContent = `Successfully imported and updated ${importedCount} products. Refreshing list...`;
                    csvMessage.classList.replace('text-stone', 'text-green-600');
                    loadProducts(); 

                } catch (error) {
                    console.error("Error importing CSV:", error);
                    csvMessage.textContent = `Error importing CSV: ${error.message}`;
                    csvMessage.classList.replace('text-stone', 'text-red-600');
                } finally {
                     csvFileInput.value = ''; 
                }
            };
            reader.onerror = () => {
                 csvMessage.textContent = 'Error reading the selected file.';
                 csvMessage.classList.remove('hidden', 'text-green-600', 'text-stone');
                 csvMessage.classList.add('text-red-600');
                 csvFileInput.value = ''; 
            };
            reader.readAsText(file);
        });

        // === General Setup ===
        
        async function loadAllData() {
            console.log("DEBUG: Admin - Starting loadAllData..."); 
            const results = await Promise.allSettled([
                loadOrders(),
                loadProducts(),
                loadPendingReviews(),
                loadApprovedReviewCount(),
                loadSiteContent()
            ]);
             console.log("DEBUG: Admin - loadAllData results:", results); 

            results.forEach((result, index) => {
                if (result.status === 'rejected') {
                    const section = ['Orders', 'Products', 'Pending Reviews', 'Approved Review Count', 'Site Content'][index];
                    console.error(`Failed to load ${section}:`, result.reason);
                }
            });
             console.log("DEBUG: Admin - Finished loadAllData."); 
        }

        // Add listeners for modal close buttons
        modalCloseBtn.addEventListener('click', closeProductModal);
        orderModalCloseBtn.addEventListener('click', () => orderModal.classList.remove('active'));
        
        // Add listeners for accordion toggles
        accordionToggles.forEach(toggle => {
             toggle.addEventListener('click', () => {
                 const body = document.getElementById(toggle.id.replace('-toggle', '-body'));
                 const chevron = toggle.querySelector('svg');
                 if (body && chevron) {
                     body.classList.toggle('hidden');
                     chevron.classList.toggle('-rotate-90'); 
                 }
             });
         });

        // === INITIALIZATION ===
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log("DEBUG: Admin - Auth state changed: User authenticated.");
                document.body.style.visibility = 'visible'; // Show page
                signOutBtn.addEventListener('click', () => signOut(auth).catch(e => console.error("Sign out error", e)));
                addProductBtn.addEventListener('click', () => openProductModal());
                siteContentForm.addEventListener('submit', handleSiteContentSubmit);
                loadAllData(); // Load all data needed for the dashboard and other tabs
            } else {
                console.log("DEBUG: Admin - Auth state changed: User NOT authenticated, redirecting.");
                window.location.replace('admin-login.html');
            }
        });

    </script>
</body>
</html>

