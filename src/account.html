---
layout: layout.html
title: My Account
---

<header class="relative w-full h-48 bg-cover bg-center" style="background-image: url('/src/candles-header.webp');">
    <div class="absolute inset-0 bg-charcoal/40 flex items-center justify-center">
        <h1 class="font-playfair text-5xl font-extrabold text-parchment drop-shadow-lg">My Account</h1>
    </div>
</header>

<main class="container mx-auto p-4 lg:p-8 py-12">
    <div id="loading-message" class="text-center p-12 bg-parchment rounded-xl shadow-lg border border-stone/10">
        <p class="font-playfair text-2xl text-stone">Verifying account access...</p>
        <div class="mt-4 animate-spin rounded-full h-8 w-8 border-b-2 border-burnt-orange mx-auto"></div>
    </div>

    <div id="account-dashboard" class="max-w-4xl mx-auto space-y-10 hidden">
        
        <div class="bg-white p-8 rounded-xl shadow-2xl border border-stone/10">
            <h2 class="font-playfair text-4xl font-bold text-charcoal mb-4">Welcome Back, <span id="user-first-name" class="text-burnt-orange">User</span>!</h2>
            <p class="text-stone">Manage your profile, view order history, and control your subscriptions.</p>
        </div>

        <div class="grid md:grid-cols-2 gap-8">
            <div class="bg-parchment p-6 rounded-xl shadow-lg border border-stone/10 space-y-4">
                <h3 class="font-playfair text-2xl font-bold text-charcoal border-b pb-2">Profile Details</h3>
                <div class="space-y-3">
                    <p class="font-roboto text-sm"><strong class="font-bold text-charcoal">Name:</strong> <span id="profile-name">Loading...</span></p>
                    <p class="font-roboto text-sm"><strong class="font-bold text-charcoal">Email:</strong> <span id="profile-email">Loading...</span></p>
                    <p class="font-roboto text-sm"><strong class="font-bold text-charcoal">Member Since:</strong> <span id="member-since">Loading...</span></p>
                </div>
                <button class="w-full py-2 bg-stone/10 text-charcoal font-semibold rounded-lg hover:bg-stone/20 transition duration-150">Edit Profile</button>
            </div>

            <div class="bg-parchment p-6 rounded-xl shadow-lg border border-stone/10 space-y-4">
                <h3 class="font-playfair text-2xl font-bold text-charcoal border-b pb-2">Quick Actions</h3>
                <nav class="space-y-2">
                    <a href="/order-history/" class="block text-burnt-orange hover:text-charcoal transition duration-150">View Order History &rarr;</a>
                    <a href="/subscriptions/" class="block text-burnt-orange hover:text-charcoal transition duration-150">Manage Subscriptions &rarr;</a>
                    <a href="/address-book/" class="block text-burnt-orange hover:text-charcoal transition duration-150">Update Shipping Addresses &rarr;</a>
                    <button id="logout-button-local" class="text-red-500 hover:text-red-700 transition duration-150 pt-2">Sign Out</button>
                </nav>
            </div>
        </div>
        
        <div class="bg-white p-8 rounded-xl shadow-2xl border border-stone/10">
            <h3 class="font-playfair text-3xl font-bold text-charcoal mb-4">Recent Orders (Placeholder)</h3>
            <p class="text-stone">Order history loading...</p>
        </div>
    </div>
</main>

<script type="module">
    // FIX: Corrected import path to include /src/ directory
    import { auth, onAuthStateChanged, signOut, db, doc, getDoc } from '/src/firebase-loader.js'; 

    // --- DOM Elements ---
    const loadingMessage = document.getElementById('loading-message');
    const dashboard = document.getElementById('account-dashboard');
    const userFirstNameElement = document.getElementById('user-first-name');
    const profileNameElement = document.getElementById('profile-name');
    const profileEmailElement = document.getElementById('profile-email');
    const memberSinceElement = document.getElementById('member-since');
    const logoutButtonLocal = document.getElementById('logout-button-local');


    /**
     * Fetches user data from Firestore and populates the dashboard.
     * @param {string} uid - The authenticated user's UID.
     */
    async function loadUserData(uid) {
        try {
            const userRef = doc(db, "users", uid);
            const docSnap = await getDoc(userRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                
                // Populate Profile Details
                const fullName = `${data.firstName || ''} ${data.lastName || ''}`;
                userFirstNameElement.textContent = data.firstName || 'User';
                profileNameElement.textContent = fullName.trim() || 'N/A';
                profileEmailElement.textContent = data.email || 'N/A';
                
                // Handle creation date if available (Firestore timestamp)
                if (data.createdAt && data.createdAt.toDate) {
                    memberSinceElement.textContent = data.createdAt.toDate().toLocaleDateString();
                } else {
                    memberSinceElement.textContent = 'Unknown';
                }

                // Show Dashboard
                loadingMessage.classList.add('hidden');
                dashboard.classList.remove('hidden');
            } else {
                // Should not happen if user successfully registered, but handles missing profile doc
                alert("User profile data not found. Please contact support.");
                signOut(auth); // Force log out
            }
        } catch (error) {
            console.error("Error loading user data:", error);
            // Fallback for loading error
            loadingMessage.innerHTML = `<p class="font-playfair text-2xl text-red-600">Error loading data. <a href="/login/" class="text-burnt-orange hover:underline">Try logging in again.</a></p>`;
            loadingMessage.classList.remove('hidden');
            dashboard.classList.add('hidden');
        }
    }


    /**
     * Initializes the account page, guarding access with Firebase Auth.
     */
    function initializeAccountPage() {
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is logged in, load their data
                loadUserData(user.uid);
            } else {
                // User is NOT logged in, redirect to login page
                alert("You must be logged in to view your account.");
                window.location.href = '/login/';
            }
        });

        // Local logout button listener (in case user clicks this one instead of the header one)
        if (logoutButtonLocal) {
            logoutButtonLocal.addEventListener('click', (e) => {
                e.preventDefault();
                signOut(auth).then(() => {
                    window.location.href = '/login/';
                }).catch(error => {
                    console.error("Logout failed:", error);
                    alert("Logout failed. Please try again.");
                });
            });
        }
    }

    document.addEventListener('DOMContentLoaded', initializeAccountPage);
</script>