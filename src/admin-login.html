---
layout: layout
title: Admin Login
---

<script type="module">
    import { 
        auth, 
        db, 
        signInWithEmailAndPassword, 
        doc, 
        getDoc,
        onAuthStateChanged,
        signOut 
    // FIX: Corrected import path to include /src/ directory
    } from '/src/firebase-loader.js'; 

    // --- DOM Elements ---
    const adminLoginForm = document.getElementById('admin-login-form');
    const emailInput = document.getElementById('email-input');
    const passwordInput = document.getElementById('password-input');
    const loginMessage = document.getElementById('login-message');

    // --- Core Logic ---

    /**
     * Handles the Admin login form submission.
     */
    async function handleAdminLogin(e) {
        e.preventDefault();
        
        const email = emailInput.value.trim();
        const password = passwordInput.value.trim();
        const submitButton = e.submitter;
        
        if (!email || !password) {
            showMessage("Please enter both email and password.", 'error');
            return;
        }

        submitButton.disabled = true;
        submitButton.textContent = 'Authenticating...';
        showMessage("Attempting to log in...", 'info');

        try {
            // 1. Authenticate user using standard login
            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;
            
            // 2. CRITICAL STEP: Check if the authenticated user is listed as an admin in Firestore
            const adminDocRef = doc(db, 'admins', user.uid);
            const adminDocSnap = await getDoc(adminDocRef);

            if (adminDocSnap.exists()) {
                showMessage("Admin Login successful! Redirecting to dashboard...", 'success');
                // Success: Redirect to the main admin panel
                // CRITICAL FIX: Use clean URL for redirect consistency
                window.location.href = '/admin/';
            } else {
                // Failure: User is authenticated but is NOT an admin.
                // Log them out immediately for security and proper session management.
                await signOut(auth);
                showMessage("Login failed. Your account is not authorized as an administrator.", 'error');
            }

        } catch (error) {
            console.error("Admin Login Error:", error);
            let message = "Login failed. Invalid credentials or no user found.";

            if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                message = "Invalid email or password. Please try again.";
            } else if (error.code === 'auth/too-many-requests') {
                 message = "Access temporarily blocked due to too many attempts.";
            }

            showMessage(message, 'error');

        } finally {
            submitButton.disabled = false;
            submitButton.textContent = 'Login as Admin';
        }
    }

    /**
     * Displays a message to the user.
     * @param {string} message - The message content.
     * @param {string} type - 'success', 'error', or 'info'.
     */
    function showMessage(message, type) {
        loginMessage.textContent = message;
        // FIX: Ensure correct classes are toggled
        loginMessage.classList.remove('hidden', 'text-green-600', 'text-red-600', 'text-stone', 'bg-red-100', 'bg-green-100', 'bg-amber-100', 'border-red-400', 'border-green-400', 'border-amber-300');
        
        loginMessage.classList.add('border', 'text-sm', 'p-3', 'rounded-lg');
        
        if (type === 'success') {
            loginMessage.classList.add('text-green-700', 'bg-green-100', 'border-green-400');
        } else if (type === 'error') {
            loginMessage.classList.add('text-red-700', 'bg-red-100', 'border-red-400');
        } else {
            loginMessage.classList.add('text-amber-700', 'bg-amber-100', 'border-amber-300');
        }
        loginMessage.classList.remove('hidden');
    }

    // --- Initialization ---

    document.addEventListener('DOMContentLoaded', () => {
        adminLoginForm.addEventListener('submit', handleAdminLogin);
        
        // Security Check: If a user is already logged in, check their admin status and redirect
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                try {
                    const adminDocRef = doc(db, 'admins', user.uid);
                    const adminDocSnap = await getDoc(adminDocRef);
                    
                    if (adminDocSnap.exists()) {
                        // CRITICAL FIX: Use clean URL for redirect consistency
                        window.location.href = '/admin/'; // Redirect existing admin
                    } else {
                        // Log out non-admin users who land on this page while authenticated
                        await signOut(auth);
                    }
                } catch (error) {
                    console.error("Admin Login Pre-check Failed:", error);
                    // Continue to allow manual login attempt if the check fails silently
                }
            }
        });
    });

; // DEFENSIVE SEMICOLON: Added to absorb potential file truncation errors.
</script>

<main class="container mx-auto px-4 py-12 min-h-screen flex items-start justify-center">
    
    <div class="max-w-6xl mx-auto bg-white p-8 lg:p-12 rounded-xl shadow-2xl border border-stone/10">

        <div class="w-full max-w-md mx-auto">
            <h1 class="text-4xl font-playfair text-charcoal mb-6 text-center">Admin Access</h1>
            <p class="text-stone text-center mb-6">Enter credentials to access the Southern Sense dashboard.</p>
            
            <form id="admin-login-form" class="space-y-6">
                
                <div>
                    <label for="email-input" class="block text-sm font-medium text-stone mb-1">Email Address</label>
                    <input type="email" id="email-input" required class="w-full p-3 border border-stone/30 rounded-lg text-charcoal focus:border-burnt-orange focus:ring-1 focus:ring-burnt-orange">
                </div>

                <div>
                    <label for="password-input" class="block text-sm font-medium text-stone mb-1">Password</label>
                    <input type="password" id="password-input" required class="w-full p-3 border border-stone/30 rounded-lg text-charcoal focus:border-burnt-orange focus:ring-1 focus:ring-burnt-orange">
                </div>
                
                <div id="login-message" class="hidden text-sm font-medium p-3 rounded-lg"></div>

                <button type="submit" class="w-full px-4 py-4 bg-stone text-parchment font-bold rounded-lg shadow-xl hover:bg-charcoal transition duration-300">
                    Login as Admin
                </button>
                
                <div class="text-center pt-4 border-t">
                    <p class="text-sm text-stone">Looking for the customer login?</p>
                    <a href="/login/" class="text-burnt-orange font-semibold hover:underline transition">Go to Customer Login</a>
                </div>
                
            </form>
        </div>
        
    </div> </main>