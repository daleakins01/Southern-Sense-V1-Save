<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Discover hand-poured candles and aroma melts from Southern Sense. Explore detailed scent notes, candle care tips, and find your perfect fragrance.">
    <!-- Title will be set dynamically -->
    <title>Product Details - Southern Sense</title>

    <!-- === PERFORMANCE OPTIMIZATION (START) === -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Roboto:wght@400;500&family=Great+Vibes&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    <noscript><link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Roboto:wght@400;500&family=Great+Vibes&display=swap" rel="stylesheet"></noscript>
    <link href="output.css" rel="stylesheet">
    <!-- === PERFORMANCE OPTIMIZATION (END) === -->
    
    <script src="firebase-loader.js" type="module"></script>
    
    <!-- === CART LOGIC === -->
    <!-- We must load cart.js as a module -->
    <script src="cart.js" type="module"></script>
    
    <!-- === START FIX: ADD AUTH SCRIPT === -->
    <!-- Added auth.js here to ensure reliable loading -->
    <script src="auth.js" type="module"></script>
    <!-- === END FIX === -->

    <!-- === SHARED HEADER/FOOTER === -->
    <!-- MODIFICATION: Changed 'defer' to 'type="module"' because main.js now uses imports -->
    <script src="main.js" type="module"></script>

    <style>
        /* Specific styles for the star rating */
            @apply bg-stone/30 text-stone/70 cursor-not-allowed;
        }
        /* (Pillar 2) Basic styles for star ratings */
        .star-rating {
            color: #D97706; /* burnt-orange */
        }
    </style>
</head>
<body class="font-roboto text-charcoal bg-parchment">
    
    <!-- Header: Injected by main.js -->
    <div id="header-placeholder"></div>

    <!-- Mobile Menu: Injected by main.js -->
    <div id="mobile-menu-placeholder"></div>

    <main>
        <!-- Product Details Section -->
        <section class="py-16 sm:py-24">
            <div class="container mx-auto px-4">
                
                <!-- Loading Skeleton -->
                <div id="product-loading" class="animate-pulse">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-12 lg:gap-16">
                        <!-- Image Skeleton -->
                        <div class="bg-stone/20 rounded-lg w-full h-96 md:h-auto md:aspect-w-1 md:aspect-h-1"></div>
                        
                        <!-- Details Skeleton -->
                        <div>
                            <div class="h-12 bg-stone/20 rounded-md w-3/4"></div>
                            <div class="h-8 bg-stone/20 rounded-md w-1/4 mt-6"></div>
                            <div class="h-6 bg-stone/20 rounded-md w-full mt-8"></div>
                            <div class="h-6 bg-stone/20 rounded-md w-5/6 mt-4"></div>
                            <div class="h-8 bg-stone/20 rounded-md w-1/3 mt-8"></div>
                            <div class="h-8 bg-stone/20 rounded-md w-1/2 mt-8"></div>
                            <div class="h-14 bg-stone/20 rounded-lg w-full mt-8"></div>
                        </div>
                    </div>
                </div>

                <!-- Product Content (Injected by JS) -->
                <div id="product-content" class="hidden">
                    <!-- Content injected here -->
                </div>
                
                <!-- Error Message -->
                <div id="product-error" class="hidden text-center">
                    <h2 class="font-playfair text-3xl font-bold text-red-600">Product Not Found</h2>
                    <p class="mt-4 text-lg text-stone">Sorry, we couldn't find the product you were looking for.</p>
                    <a href="shop.html" class="mt-8 inline-block bg-burnt-orange text-white font-bold py-3 px-8 rounded-lg shadow-md hover:bg-amber-700 transition-all">
                        Back to Shop
                    </a>
                </div>

            </div>
        </section>

        <!-- (Pillar 2) Product Reviews Section - (CURRENTLY BUGGY - NEEDS PILLAR 2 FIX) -->
        <section id="reviews-section" class="py-16 sm:py-24 bg-white/50 backdrop-blur-sm">
            <div class="container mx-auto px-4 max-w-4xl">
                <h2 class="font-playfair text-4xl font-bold text-charcoal">Customer Reviews</h2>
                <div class="flex items-center mt-4">
                    <!-- Placeholder: Add overall rating here -->
                    <span class="font-bold text-lg text-stone mr-2">(No reviews yet)</span>
                    <div class="star-rating text-2xl text-stone/30">
                        <span>★</span><span>★</span><span>★</span><span>★</span><span>★</span>
                    </div>
                </div>

                <!-- Write Review Form -->
                <div class="mt-8">
                    <h3 classs="font-playfair text-2xl font-bold text-charcoal">Leave a Review</h3>
                    <!-- (Pillar 2 Fix): This form needs to be hidden if user is not logged in -->
                    <form id="review-form" class="mt-6 space-y-4">
                        <p id="review-form-auth-message" class="text-stone">You must be <a href="login.html" class="font-bold text-burnt-orange underline">logged in</a> to leave a review.</p>
                        <!-- (Pillar 2 Fix): This fieldset should be hidden by default -->
                        <fieldset id="review-form-fieldset" class="space-y-4">
                            <!-- Name (Read-only, prepopulated) -->
                            <div>
                                <label for="review-name" class="block text-stone font-bold mb-2">Name</label>
                                <input type="text" id="review-name" name="name" class="w-full px-4 py-2 border border-stone/30 rounded-lg bg-stone/10" readonly>
                            </div>
                            <!-- Rating -->
                            <div>
                                <label class="block text-stone font-bold mb-2">Rating</label>
                                <div class="flex text-3xl text-stone/50">
                                    <!-- (Pillar 2): This needs JS to be interactive -->
                                    <span>★</span><span>★</span><span>★</span><span>★</span><span>★</span>
                                </div>
                            </div>
                            <!-- Review -->
                            <div>
                                <label for="review-text" class="block text-stone font-bold mb-2">Review</label>
                                <textarea id="review-text" name="review" rows="4" class="w-full px-4 py-2 border border-stone/30 rounded-lg bg-white/50 focus:ring-burnt-orange focus:border-burnt-orange transition-colors" required></textarea>
                            </div>
                            <!-- Submit -->
                            <div>
                                <button type="submit" class="bg-burnt-orange text-white font-bold text-lg py-3 px-8 rounded-lg shadow-md hover:bg-amber-700 transition-all">
                                    Submit Review
                                </button>
                            </div>
                        </fieldset>
                    </form>
                    <p id="review-submit-message" class="hidden mt-4 font-bold"></p>
                </div>

                <!-- Existing Reviews -->
                <div id="reviews-list" class="mt-12 space-y-8">
                    <!-- (Pillar 2): Reviews will be loaded here. -->
                    <p id="reviews-loading" class="text-stone">Loading reviews...</p>
                    <p id="reviews-empty" class="hidden text-stone">Be the first to review this product!</p>
                </div>
            </div>
        </section>

        <!-- (Pillar 2) Recommendations Section -->
        <section id="recommendations-section" class="py-16 sm:py-24">
             <div class="container mx-auto px-4">
                 <h2 class="font-playfair text-4xl font-bold text-charcoal text-center">You Might Also Like</h2>
                 <div id="recommendations-grid" class="mt-12 grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-4 gap-4 md:gap-8">
                     <!-- Recommendations will be injected here by JavaScript -->
                 </div>
             </div>
        </section>

    </main>
    
    <!-- Footer: Injected by main.js -->
    <div id="footer-placeholder"></div>

    <!-- Page-Specific JavaScript -->
    <script type="module">
        // Import Firebase and Cart functions
        import { db } from './firebase-loader.js';
        import { doc, getDoc, collection, getDocs, query, where, limit } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";
        import { addToCart } from './cart.js';
        // (Pillar 2) We will need these for reviews
        // import { auth } from './firebase-loader.js';
        // import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
        // import { addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";


        // --- DOM Elements ---
        const productLoading = document.getElementById('product-loading');
        const productContent = document.getElementById('product-content');
        const productError = document.getElementById('product-error');
        // (Pillar 2) Review Elements
        const reviewsSection = document.getElementById('reviews-section');
        const reviewsLoading = document.getElementById('reviews-loading');
        const reviewsEmpty = document.getElementById('reviews-empty');
        const reviewsList = document.getElementById('reviews-list');
        const reviewFormAuthMessage = document.getElementById('review-form-auth-message');
        const reviewFormFieldset = document.getElementById('review-form-fieldset');
        
        let currentProduct = null; // Store the loaded product data

        /**
         * Fetches and displays the product details.
         */
        async function loadProduct() {
            // 1. Get product ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');

            if (!productId) {
                showError("No product selected.");
                return;
            }
            
            try {
                // 2. Fetch product from Firestore
                const docRef = doc(db, "products", productId);
                const docSnap = await getDoc(docRef);

                if (!docSnap.exists()) {
                    showError(`Product with ID '${productId}' not found.`);
                    return;
                }

                currentProduct = { id: docSnap.id, ...docSnap.data() };

                // 3. Render Product & Set Meta
                renderProduct(currentProduct);
                document.title = `${currentProduct.name} - Southern Sense`;
                // (Pillar 2): Start loading reviews and recommendations *after* product is loaded
                loadReviews(productId);
                loadRecommendations(productId, currentProduct.scentFamily);


            } catch (error) {
                console.error("Error loading product:", error);
                showError("Could not load product details. Please try again.");
            }
        }

        /**
         * Renders the product data into the page.
         * @param {object} product - The product data object.
         */
        function renderProduct(product) {
            // Destructure product data
            const { id, name, price, longDescription, imageUrl, stock, scentNotes, scentFamily, pairing, strength } = product;

            // Determine stock status
            const isOutOfStock = stock <= 0;
            const buttonClass = isOutOfStock
                ? 'disabled-btn' // Defined in <style>
                : 'bg-burnt-orange text-white hover:bg-amber-700';
            const buttonText = isOutOfStock ? 'Out of Stock' : 'Add to Cart';
            const buttonDisabled = isOutOfStock ? 'disabled' : '';

            // Map scent family to a readable name
            const scentFamilyMap = {
                'fruity-sweet': 'Fruity & Sweet',
                'earthy-woody': 'Earthy & Woody',
                'floral-fresh': 'Floral & Fresh'
            };

            // Generate strength icons
            const strengthIcons = '★'.repeat(strength) + '<span class="text-stone/30">' + '★'.repeat(5 - strength) + '</span>';

            // Inject HTML
            productContent.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-12 lg:gap-16">
                    <!-- Product Image -->
                    <div class="relative">
                        <img src="${imageUrl}" alt="${name}" class="w-full rounded-lg shadow-2xl" onerror="this.src='https://placehold.co/600x600/FBF9F6/3D352E?text=Image+Not+Found'; this.onerror=null;">
                        ${isOutOfStock ? '<span class="absolute top-4 left-4 bg-charcoal/80 text-white text-xs font-bold px-3 py-1 rounded-full">SOLD OUT</span>' : ''}
                    </div>
                    
                    <!-- Product Details -->
                    <div>
                        <h1 class="font-playfair text-4xl sm:text-5xl font-bold text-charcoal">${name}</h1>
                        <p class="font-playfair text-3xl font-bold text-burnt-orange mt-4">$${price}</p>
                        
                        <!-- Product Description -->
                        <div classid="product-long-description" class="prose max-w-none text-stone mt-6">
                            ${longDescription}
                        </div>

                        <!-- Scent Details Table -->
                        <div class="mt-8 border-t border-stone/20 pt-8">
                            <h3 class="font-playfair text-2xl font-bold text-charcoal">Scent Profile</h3>
                            <div class="grid grid-cols-2 gap-4 mt-4 text-stone">
                                <div><strong>Scent Family:</strong></div>
                                <div>${scentFamilyMap[scentFamily] || 'Special Blend'}</div>
                                
                                <div><strong>Key Notes:</strong></div>
                                <div>${scentNotes}</div>

                                <div><strong>Strength:</strong></div>
                                <div class="star-rating">${strengthIcons}</div>
                                
                                <div><strong>Best For:</strong></div>
                                <div>${pairing}</div>
                            </div>
                        </div>

                        <!-- Add to Cart -->
                        <div class="mt-10">
                            <!-- Quantity Selector -->
                            <div class="flex items-center space-x-4 mb-6">
                                <label for="quantity" class="font-bold text-stone">Quantity:</label>
                                <input type="number" id="quantity" name="quantity" value="1" min="1" 
                                       class="w-20 px-3 py-2 border border-stone/30 rounded-lg text-center bg-white/50 focus:ring-burnt-orange focus:border-burnt-orange" ${buttonDisabled}>
                            </div>

                            <button id="add-to-cart-btn" 
                                    class="w-full text-lg font-bold py-4 px-8 rounded-lg shadow-md transition-all ${buttonClass}"
                                    ${buttonDisabled}>
                                ${buttonText}
                            </button>
                            <p id="add-to-cart-error" class="text-red-600 font-bold text-center mt-2"></p>
                        </div>
                    </div>
                </div>
            `;
            
            // 4. Show content, hide loading
            productLoading.classList.add('hidden');
            productContent.classList.remove('hidden');

            // 5. Add event listener for the new "Add to Cart" button
            document.getElementById('add-to-cart-btn').addEventListener('click', () => {
                const quantityInput = document.getElementById('quantity');
                const errorEl = document.getElementById('add-to-cart-error');
                let quantity = parseInt(quantityInput.value, 10);
                
                if (isNaN(quantity) || quantity < 1) {
                    quantity = 1;
                    quantityInput.value = '1';
                }

                // Check against stock (from the product object, not the cart)
                if (quantity > currentProduct.stock) {
                    errorEl.textContent = "We don't have that many in stock!";
                    return;
                }
                
                // Use the imported addToCart function
                addToCart(currentProduct, quantity);
            });
        }

        /**
         * Shows a generic error message.
         * @param {string} message - The error message to log (optional).
         */
        function showError(message) {
            if (message) console.error(message);
            productLoading.classList.add('hidden');
            productError.classList.remove('hidden');
            // (Pillar 2): Hide reviews and recommendations if product fails
             reviewsSection.classList.add('hidden');
             const recommendationsSection = document.getElementById('recommendations-section');
             if(recommendationsSection) recommendationsSection.classList.add('hidden');
        }


        // --- (PILLAR 2) REVIEW FUNCTIONS ---
        // These are placeholders/stubs for now, to be fixed in Pillar 2.
        
        async function loadReviews(productId) {
            console.log("DEBUG: Reviews - Starting to load reviews for", productId);
            // (Pillar 2 Fix): This logic is currently insecure and incomplete.
            // It just shows a 'loading' message and then 'empty'.
            
            // This is just a placeholder, remove loading
            setTimeout(() => {
                reviewsLoading.classList.add('hidden');
                reviewsEmpty.classList.remove('hidden');
                // (Pillar 2 Fix): Here we would actually query and render reviews.
            }, 1000);
            
             // (Pillar 2 Fix): Stub for auth state check
             // For now, we'll just show the "must be logged in" message and hide the form fields.
             reviewFormAuthMessage.classList.remove('hidden');
             reviewFormFieldset.classList.add('hidden');
        }

        
        // --- (PILLAR 2) RECOMMENDATIONS FUNCTION ---
        async function loadRecommendations(currentProductId, currentScentFamily) {
             console.log("DEBUG: Recommendations - Loading recommendations for", currentProductId, "in family", currentScentFamily);
             const recommendationsSection = document.getElementById('recommendations-section');
             const recommendationsGrid = document.getElementById('recommendations-grid');

             if (!recommendationsSection || !recommendationsGrid) {
                 console.error("DEBUG: Recommendations - Could not find HTML elements.");
                 return;
             }

            try {
                // Query for 4 other products in the same scent family
                const productsRef = collection(db, "products");
                const q = query(
                    productsRef,
                    where("scentFamily", "==", currentScentFamily),
                    where("id", "!=", currentProductId), // Exclude the current product
                    limit(4)
                );
                
                const querySnapshot = await getDocs(q);
                
                // (V1.1 FIX): Check if query returned *any* documents
                if (querySnapshot.docs.length > 0) {
                     console.log(`DEBUG: Recommendations - Found ${querySnapshot.docs.length} recommendations.`);
                     recommendationsGrid.innerHTML = ''; // Clear any loading spinners
                    
                    querySnapshot.forEach(doc => {
                        const product = doc.data();
                        const card = document.createElement('a'); // Make the whole card a link
                        card.href = `product.html?id=${doc.id}`;
                        card.className = "bg-white/60 backdrop-blur-sm rounded-lg shadow-lg overflow-hidden flex flex-col group transition-shadow duration-300 hover:shadow-2xl";
                        card.innerHTML = `
                            <div class="block overflow-hidden">
                                <img src="${product.imageUrl}" alt="${product.name}" class="w-full h-48 object-cover group-hover:scale-105 transition-transform duration-300" onerror="this.src='https://placehold.co/400x400/FBF9F6/3D352E?text=Image+Not+Found'; this.onerror=null;">
                            </div>
                            <div class="p-4 flex-grow flex flex-col">
                                <h3 class="font-playfair text-xl font-bold text-charcoal">${product.name}</h3>
                                <p class="font-bold text-lg text-burnt-orange mt-2">$${product.price}</p>
                            </div>
                        `;
                        recommendationsGrid.appendChild(card);
                    });
                } else {
                     console.log("DEBUG: Recommendations - Condition FALSE, hiding recommendations section.");
                    recommendationsSection.classList.add('hidden'); 
                }
            } catch (error) {
                console.error("Error loading recommendations:", error);
                 recommendationsSection.classList.add('hidden'); 
            }
        }


        // --- INITIALIZATION ---
        loadProduct();
    </script>
</body>
</html>

