---
layout: layout.html
title: "Register"
---

<main class="container mx-auto px-4 py-16 min-h-[70vh]">
  <div class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-xl">
    <h1
      class="font-playfair text-3xl font-semibold text-charcoal text-center mb-6">
      Create Account
    </h1>

    <!-- Error Message Container -->
    <div id="error-message"
      class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md mb-4"
      role="alert">
      <span class="block sm:inline" id="error-text"></span>
    </div>

    <!-- Register Form -->
    <form id="register-form" class="space-y-6">
      <!-- Full Name -->
      <div>
        <label for="name"
          class="block text-sm font-medium text-charcoal mb-1">Full
          Name</label>
        <input type="text" id="name" name="name" required
          autocomplete="name"
          class="w-full px-4 py-3 border border-stone/30 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-burnt-orange focus:border-transparent" />
      </div>

      <!-- Email -->
      <div>
        <label for="email"
          class="block text-sm font-medium text-charcoal mb-1">Email</label>
        <input type="email" id="email" name="email" required
          autocomplete="email"
          class="w-full px-4 py-3 border border-stone/30 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-burnt-orange focus:border-transparent" />
      </div>

      <!-- Password -->
      <div>
        <label for="password"
          class="block text-sm font-medium text-charcoal mb-1">Password</label>
        <input type="password" id="password" name="password" required
          autocomplete="new-password"
          placeholder="At least 6 characters"
          class="w-full px-4 py-3 border border-stone/30 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-burnt-orange focus:border-transparent" />
      </div>

      <!-- Submit Button -->
      <div>
        <button type="submit" id="register-button"
          class="w-full bg-burnt-orange text-white font-roboto px-6 py-3 rounded-md shadow-lg hover:bg-opacity-90 transition-all duration-300 flex items-center justify-center">
          <svg id="button-spinner"
            class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden"
            xmlns="http://www.w3.org/2000/svg" fill="none"
            viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10"
              stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
            </path>
          </svg>
          <span id="button-text">Create Account</span>
        </button>
      </div>
    </form>

    <!-- Login Link -->
    <p class="mt-8 text-center text-stone">
      Already have an account?
      <a href="/login.html"
        class="font-medium text-burnt-orange hover:text-opacity-80">
        Sign in
      </a>
    </p>
  </div>
</main>

<script type="module">
  import {
    auth,
    db,
    doc,
    setDoc,
    createUserWithEmailAndPassword,
    updateProfile,
    onAuthStateChanged,
  } from "/src/firebase-loader.js";
  import { mergeLocalCartWithFirestore } from "/src/cart.js";

  const registerForm = document.getElementById("register-form");
  const nameInput = document.getElementById("name");
  const emailInput = document.getElementById("email");
  const passwordInput = document.getElementById("password");
  const errorMessage = document.getElementById("error-message");
  const errorText = document.getElementById("error-text");
  const registerButton = document.getElementById("register-button");
  const buttonSpinner = document.getElementById("button-spinner");
  const buttonText = document.getElementById("button-text");

  // Check if user is already logged in
  onAuthStateChanged(auth, (user) => {
    if (user) {
      console.log("User already signed in. Redirecting to account.");
      window.location.href = "/account.html";
    }
  });

  // Show error message
  function showAuthError(message) {
    let friendlyMessage = message;
    console.warn("Auth Error:", message);

    if (message.includes("auth/email-already-in-use")) {
      friendlyMessage =
        "An account with this email already exists. Please sign in.";
    } else if (message.includes("auth/weak-password")) {
      friendlyMessage = "Password is too weak. Must be at least 6 characters.";
    } else {
      friendlyMessage =
        "An unexpected error occurred. Please try again later.";
    }

    errorText.textContent = friendlyMessage;
    errorMessage.style.display = "block";
  }

  // Handle form submission
  registerForm.addEventListener("submit", async (e) => {
    e.preventDefault();

    // Show loading state
    registerButton.disabled = true;
    buttonSpinner.style.display = "inline-block";
    buttonText.textContent = "Creating Account...";
    errorMessage.style.display = "none";

    const displayName = nameInput.value;
    const email = emailInput.value;
    const password = passwordInput.value;

    try {
      // 1. Create the user in Firebase Auth
      const userCredential = await createUserWithEmailAndPassword(
        auth,
        email,
        password
      );
      const user = userCredential.user;
      console.log("User created in Auth:", user.uid);

      // 2. Update the user's Auth profile (name)
      await updateProfile(user, {
        displayName: displayName,
      });
      console.log("Auth profile updated with display name.");

      // 3. Create the user document in Firestore
      // (Pillar 1 Fix): This creates the /users/{userId} doc
      const userDocRef = doc(db, "users", user.uid);
      await setDoc(userDocRef, {
        uid: user.uid,
        displayName: displayName,
        email: email,
        createdAt: new Date(), // Use serverTimestamp() in production
      });
      console.log("Firestore user document created.");

      // 4. Merge local guest cart with new user's Firestore cart
      await mergeLocalCartWithFirestore(user.uid);

      // 5. Redirect to the account page
      window.location.href = "/account.html";
    } catch (error) {
      showAuthError(error.message);
      // Hide loading state
      registerButton.disabled = false;
      buttonSpinner.style.display = "none";
      buttonText.textContent = "Create Account";
    }
  });
</script>
