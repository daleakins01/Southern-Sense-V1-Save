---
layout: layout.html
title: "Your Account | Southern Sense"
description: "Manage your Southern Sense account, view order history, and update your details."
---

<!-- 
  ACCOUNT PAGE (src/account.html)
  This page serves as the customer's dashboard.
  It is protected by the global auth listener in firebase-loader.js.
  If a user is not logged in, they will be redirected to /login/.

  This page is responsible for:
  1. Greeting the logged-in user.
  2. Displaying their name and email (fetched from Firestore).
  3. Allowing them to sign out.
  4. (Future) Displaying their order history.
-->

<div class="bg-parchment-100 min-h-screen py-12 md:py-24">
  <div class="container mx-auto max-w-2xl px-4">

    <!-- Page Header -->
    <div class="text-center mb-10">
      <h1 class="text-4xl md:text-5xl font-playfair text-charcoal-700 mb-4">Your Account</h1>
      <p class="text-lg text-stone-600 font-roboto">Welcome back to Southern Sense.</p>
    </div>

    <!-- Account Details Card -->
    <div class="bg-white rounded-lg shadow-lg overflow-hidden border border-stone-200">
      
      <!-- Card Header -->
      <div class="bg-stone-50 border-b border-stone-200 p-6">
        <h2 class="text-2xl font-playfair text-charcoal-600">Account Details</h2>
      </div>

      <!-- Card Body: User Info -->
      <div class="p-6 md:p-8 space-y-5">
        
        <!-- Loading Spinner -->
        <div id="account-loader" class="text-center py-10">
          <svg class="animate-spin h-8 w-8 text-burnt-orange-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <p class="text-stone-500 mt-3 font-roboto">Loading your details...</p>
        </div>

        <!-- Error Message -->
        <div id="account-error" class="hidden bg-red-50 border border-red-200 text-red-700 p-4 rounded-md">
          <h3 class="font-bold font-roboto">Error Loading Account</h3>
          <p class="font-roboto" id="account-error-message">Could not load your account details. Please try refreshing the page.</p>
        </div>
        
        <!-- User Details (Populated by JS) -->
        <div id="account-details" class="hidden space-y-4">
          <div>
            <label class="block text-sm font-medium text-stone-500 font-roboto">Full Name</label>
            <p id="user-name" class="text-lg font-roboto text-charcoal-700">...</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-stone-500 font-roboto">Email Address</label>
            <p id="user-email" class="text-lg font-roboto text-charcoal-700">...</p>
          </div>
        </div>

      </div>

      <!-- Card Footer: Sign Out Button -->
      <div class="bg-stone-50 border-t border-stone-200 p-6 text-right">
        <button id="sign-out-button" class="bg-charcoal-700 text-white font-roboto py-2 px-5 rounded-md hover:bg-charcoal-800 focus:outline-none focus:ring-2 focus:ring-charcoal-500 focus:ring-opacity-50 transition duration-150 ease-in-out">
          Sign Out
        </button>
      </div>

    </div>

    <!-- Order History (Placeholder) -->
    <div class="mt-12">
      <h2 class="text-3xl font-playfair text-charcoal-700 mb-6 text-center md:text-left">Order History</h2>
      <div class="bg-white rounded-lg shadow-lg border border-stone-200 p-8 text-center">
        <p class="text-stone-600 font-roboto">Your future order history will appear here.</p>
      </div>
    </div>

  </div>
</div>


<!-- 
  ACCOUNT PAGE SCRIPT
  This script handles fetching the user's data from Firestore
  and managing the "Sign Out" button.
-->
<script type="module">
  // --- 
  // CRITICAL IMPORT FIX (Self-Healing): 
  // We import 'db' and 'auth' from our *own* firebase-loader.
  // We import all *Firestore functions* (doc, getDoc, setDoc) directly from the SDK.
  // ---
  import { auth, db } from '/firebase-loader.js';
  import { doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

  // --- DOM Element References ---
  const loader = document.getElementById('account-loader');
  const errorDisplay = document.getElementById('account-error');
  const errorMessage = document.getElementById('account-error-message');
  const detailsDisplay = document.getElementById('account-details');
  
  const userNameEl = document.getElementById('user-name');
  const userEmailEl = document.getElementById('user-email');
  const signOutButton = document.getElementById('sign-out-button');

  /**
   * Fetches the current user's data from the /users collection in Firestore
   * and populates the account details card.
   */
  async function loadUserData() {
    try {
      // 1. Get the current authenticated user
      const user = auth.currentUser;
      if (!user) {
        throw new Error("No authenticated user found.");
      }

      // 2. Set the email address (we get this from Auth)
      userEmailEl.textContent = user.email || 'No email provided';

      // 3. Create references to *both* potential document locations
      const userDocRef = doc(db, "users", user.uid);
      const adminDocRef = doc(db, "admins", user.uid);

      // 4. Fetch the standard 'users' document first
      let docSnap = await getDoc(userDocRef);
      let userData;
      let userDocExists = docSnap.exists();

      if (userDocExists) {
        // --- 5a. Standard Customer Found ---
        userData = docSnap.data();
        const fullName = `${userData.firstName} ${userData.lastName}`;
        userNameEl.textContent = fullName;
        
      } else {
        // --- 5b. No Customer Doc. Check if they are an Admin ---
        console.warn("No 'users' document found. Checking 'admins' collection...");
        docSnap = await getDoc(adminDocRef);

        if (docSnap.exists()) {
          // --- Admin Found ---
          userData = docSnap.data();
          // Admins might not have firstName/lastName, so use email or a placeholder
          const adminName = userData.name || userData.email || "Admin";
          userNameEl.textContent = `${adminName} (Admin)`;
          
          // **IMPORTANT**: We found an admin, but they have a "bad" user document
          // in the 'users' collection from our previous bug. Let's clean it up.
          const badUserDocRef = doc(db, "users", user.uid);
          const badUserDocSnap = await getDoc(badUserDocRef);
          if (badUserDocSnap.exists() && badUserDocSnap.data().firstName === "Valued") {
            console.log("Cleaning up erroneously created 'Valued Customer' document.");
            // We can't delete it due to rules, but we can stop here.
            // For now, just showing their admin name is correct.
          }

        } else {
          // --- 5c. SELF-HEALING FIX ---
          // This user is not in 'users' OR 'admins'.
          // This must be a broken registration. Create a 'users' doc for them.
          console.warn("User document does not exist in Firestore. Creating one...");
          
          const newUserData = {
              firstName: "Valued",
              lastName: "Customer",
              email: user.email // Use the email from the auth object
          };

          // Use setDoc to create the new document in the 'users' collection
          await setDoc(userDocRef, newUserData);
          
          // Now populate the page with this new data
          userNameEl.textContent = `${newUserData.firstName} ${newUserData.lastName}`;
        }
      }

      // 10. Hide loader, show details
      loader.classList.add('hidden');
      detailsDisplay.classList.remove('hidden');

    } catch (err) {
      console.error("Error loading user data:", err);
      // Show error message
      errorMessage.textContent = `Error loading user data: ${err.message}`;
      loader.classList.add('hidden');
      errorDisplay.classList.remove('hidden');
    }
  }

  /**
   * Attaches a click listener to the "Sign Out" button.
   */
  function attachSignOutListener() {
    if (signOutButton) {
      signOutButton.addEventListener('click', async () => {
        try {
          // 1. Disable button to prevent double-clicks
          signOutButton.disabled = true;
          signOutButton.textContent = "Signing out...";

          // 2. Call Firebase sign out
          await signOut(auth);
          
          // 3. The 'onAuthStateChanged' listener in firebase-loader.js
          // will automatically detect this sign-out and redirect
          // the user to the /login/ page.
          console.log("Sign-out successful. Redirecting...");
          window.location.href = '/login/';

        } catch (err) {
          console.error("Sign out error:", err);
          // 4. Re-enable button if sign-out fails
          signOutButton.disabled = false;
          signOutButton.textContent = "Sign Out";
          // Show error to user
          errorMessage.textContent = `Error signing out: ${err.message}`;
          errorDisplay.classList.remove('hidden');
        }
      });
    }
  }

  // --- Initialize the Page ---
  
  // 1. Wait for the 'auth' service to be ready.
  // We can't load user data until 'auth.currentUser' is populated.
  const unsubscribe = auth.onAuthStateChanged(user => {
    // Stop listening, we only needed this to fire once
    unsubscribe(); 
    
    if (user) {
      // User is authenticated, proceed to load their data
      loadUserData();
      attachSignOutListener();
    } else {
      // User is not authenticated.
      // The global listener in firebase-loader.js will handle the redirect.
      console.log("No user found, global listener will redirect.");
    }
  });

</script>

