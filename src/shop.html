---
layout: layout.html
title: Shop All Candles
---

<div class="container mx-auto p-4 lg:p-8 py-16">
    
    <div class="text-center pt-10 pb-12">
        <h1 id="shop-title" class="font-playfair text-5xl font-extrabold text-charcoal mb-4">Our Full Collection</h1>
        <p class="font-roboto text-xl text-stone max-w-3xl mx-auto">
            Browse our entire collection of hand-poured candles and wax melts, crafted with southern elegance.
        </p>
    </div>
    
    <div id="loading-spinner" class="text-center py-20">
        <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-burnt-orange mx-auto"></div>
        <p class="mt-4 text-lg font-roboto text-stone">Loading products...</p>
    </div>

    <div id="no-results" class="hidden text-center py-20 bg-parchment border border-stone/20 text-charcoal px-4 py-3 rounded relative max-w-lg mx-auto" role="alert">
        <strong class="font-bold block text-2xl mb-2">No Products Found</strong>
        <p class="sm:inline" id="no-results-text">We couldn't find any products matching your selection. Try a different filter!</p>
        <a href="/shop/" class="block mt-4 text-sm underline text-burnt-orange hover:text-burnt-orange/80">View All Products</a>
    </div>

    <div id="product-grid" class="hidden grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
        </div>
</div>

<script type="module">
    // --- Firestore Imports ---
    import { db } from '/firebase-loader.js';
    import { 
        collection, 
        getDocs, 
        query, 
        orderBy, 
        where 
    } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

    // --- DOM Elements ---
    const loadingSpinner = document.getElementById('loading-spinner');
    const productGrid = document.getElementById('product-grid');
    const noResults = document.getElementById('no-results');
    const shopTitle = document.getElementById('shop-title');

    /**
     * Extracts query parameters (like 'family') from the URL.
     * @returns {Object} An object containing the URL parameters.
     */
    function getUrlParameters() {
        const params = new URLSearchParams(window.location.search);
        return {
            family: params.get('family') // e.g., 'fruity-sweet'
        };
    }

    /**
     * Formats a slug (e.g., 'fruity-sweet') to a display name (e.g., 'Fruity Sweet').
     * @param {string} slug - The scentFamily slug.
     * @returns {string} The formatted name.
     */
    function formatScentFamilyName(slug) {
        if (!slug) return '';
        return slug.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
    }

    /**
     * Renders a single product card.
     * @param {Object} product - The product data object.
     * @returns {string} The HTML string for the product card.
     */
    function renderProductCard(product) {
        const isOutOfStock = product.stock <= 0;
        const stockBadge = isOutOfStock 
            ? `<div class="absolute top-4 left-4 bg-stone text-parchment px-3 py-1 text-xs font-bold rounded-full shadow-md">Sold Out</div>`
            : '';
        const linkClass = isOutOfStock 
            ? 'opacity-60' 
            : 'hover:shadow-xl hover:scale-[1.02] transition duration-300';
            
        return `
            <a href="/product/?id=${product.id}" class="block bg-parchment rounded-lg shadow-md overflow-hidden ${linkClass}">
                <div class="relative">
                    <img src="/${product.imageUrl}" alt="${product.name}" class="w-full h-48 object-cover">
                    ${stockBadge}
                </div>
                <div class="p-4 space-y-1">
                    <h3 class="font-playfair text-xl font-bold text-charcoal">${product.name}</h3>
                    <p class="font-roboto text-sm text-stone">${product.shortDescription}</p>
                    <p class="font-roboto text-lg font-semibold text-burnt-orange">$${product.price}</p>
                </div>
            </a>
        `;
    }

    /**
     * Fetches and renders products based on URL filters.
     */
    async function loadProducts() {
        loadingSpinner.classList.remove('hidden');
        productGrid.classList.add('hidden');
        noResults.classList.add('hidden');
        
        const params = getUrlParameters();

        try {
            const productsCol = collection(db, 'products');
            let q = query(productsCol, orderBy('name', 'asc'));

            // === FILTER LOGIC (NEW) ===
            if (params.family) {
                // If a scent family filter is present, apply it
                q = query(q, where('scentFamily', '==', params.family));
                
                // Update the page title to reflect the filter
                shopTitle.textContent = `${formatScentFamilyName(params.family)} Collection`;
                shopTitle.classList.add('text-burnt-orange', 'border-b-4', 'border-burnt-orange/50', 'inline-block', 'px-4', 'pb-1');
            } else {
                 // Reset title if no filter is active
                shopTitle.textContent = 'Our Full Collection';
                shopTitle.classList.remove('text-burnt-orange', 'border-b-4', 'border-burnt-orange/50', 'inline-block', 'px-4', 'pb-1');
            }
            // ==========================

            const querySnapshot = await getDocs(q);
            const products = [];
            querySnapshot.forEach(doc => {
                const productData = doc.data();
                productData.id = doc.id;
                products.push(productData);
            });

            loadingSpinner.classList.add('hidden');
            
            if (products.length > 0) {
                productGrid.innerHTML = products.map(renderProductCard).join('');
                productGrid.classList.remove('hidden');
            } else {
                // Show a clear message if no products match the filter
                if (params.family) {
                    document.getElementById('no-results-text').textContent = `We couldn't find any products in the "${formatScentFamilyName(params.family)}" family. Try a different one!`;
                }
                noResults.classList.remove('hidden');
            }

        } catch (error) {
            console.error("Error loading products:", error);
            loadingSpinner.classList.add('hidden');
            document.getElementById('no-results-text').textContent = `An error occurred while loading the products: ${error.message}`;
            noResults.classList.remove('hidden');
        }
    }

    // --- Main Initialization ---
    
    // FIX (Race Condition): Wait for firebase-loader.js to dispatch its signal
    document.addEventListener('firebase-ready', loadProducts);

</script>