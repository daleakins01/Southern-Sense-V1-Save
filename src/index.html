---
layout: layout
title: Southern Sense - Hand-Poured Luxury Candles
---

<script type="module">
    // Consolidation: All dependencies for CMS and Featured Products are now here.
    import { 
        db, 
        collection, 
        query, 
        where, 
        getDocs, 
        doc, 
        getDoc,
        limit 
    } from '/src/firebase-loader.js';
    import { addToCart, updateCartDisplay } from '/src/cart.js'; 

    // --- DOM Elements (CMS Content) ---
    const heroTitleEl = document.getElementById('hero-title');
    const heroSubtitleEl = document.getElementById('hero-subtitle');
    const diffWaxTextEl = document.getElementById('diff-wax-text');
    const diffOilsTextEl = document.getElementById('diff-oils-text');
    
    // --- DOM Elements (Products) ---
    const featuredProductsGrid = document.getElementById('featured-products-grid');
    const featuredLoader = document.getElementById('featured-loader');
    const featuredProductTitleEl = document.getElementById('featured-product-title');

    // --- CMS Logic (Consolidated from src/js/index.js) ---

    /**
     * Loads dynamic content for the Hero and Features sections from the 'siteContent/homepage' document.
     * @returns {Promise<string|null>} Returns the featuredProductId from CMS or null.
     */
    async function loadHomepageCMS() {
        let featuredId = null;
        try {
            const docRef = doc(db, "siteContent", "homepage");
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                
                // 1. Hero Section
                if (heroTitleEl) heroTitleEl.textContent = data.heroTitle || "Southern Sense";
                if (heroSubtitleEl) heroSubtitleEl.textContent = data.heroSubtitle || "Experience the warmth and charm of the South...";
                
                // 2. Our Difference Section (Optimized DOM assignment)
                // Using nested structure in Firestore to fetch these:
                const aboutRef = doc(db, "siteContent", "about");
                const aboutSnap = await getDoc(aboutRef);

                if(aboutSnap.exists()) {
                    const aboutData = aboutSnap.data();
                    if (diffWaxTextEl) diffWaxTextEl.textContent = aboutData.diffWax || "We use a premium soy-coconut wax blend that ensures a clean, slow, and even burn every time.";
                    if (diffOilsTextEl) diffOilsTextEl.textContent = aboutData.diffOils || "Our oils are 100% phthalate-free and safe, providing a rich scent throw without harmful chemicals.";
                }
                
                // 3. Featured Product ID
                featuredId = data.featuredProductId || null;
            } else {
                console.warn("Homepage CMS document not found. Using defaults.");
            }
        } catch (error) {
            console.error("Error fetching homepage CMS content:", error);
        }
        return featuredId;
    }


    // --- Product Logic (Optimized) ---
    
    /**
     * Renders a single product card HTML specifically for the homepage layout.
     * @param {Object} product - The product data.
     * @returns {string} The product card HTML string.
     */
    function renderProductCard(product) {
        const isOutOfStock = product.stock <= 0;
        const price = parseFloat(product.price).toFixed(2); 
        const scentFamily = product.scentFamily ? product.scentFamily.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ') : 'Scent';

        // Button or Link
        const actionButtonHtml = isOutOfStock
            ? `<a href="/product/?id=${product.id}" class="w-full block text-center px-4 py-2 border border-stone/30 text-stone rounded-lg cursor-not-allowed">View Details</a>`
            : `<button data-id="${product.id}" 
                      data-name="${product.name}"
                      data-price="${price}"
                      data-image="${product.imageUrl}"
                      class="add-to-cart-button w-full px-4 py-2 bg-burnt-orange text-parchment font-bold rounded-lg hover:bg-burnt-orange/80 transition duration-300">
                Add to Cart
              </button>`;
        
        return `
            <div class="product-card bg-white rounded-lg shadow-xl overflow-hidden hover:shadow-2xl transition duration-300 transform hover:-translate-y-1">
                <a href="/product/?id=${product.id}" class="block">
                    <img src="/src/${product.imageUrl || 'logo.webp'}" alt="${product.name}" class="w-full h-72 object-cover">
                </a>
                <div class="p-5">
                    <p class="text-sm font-medium text-stone mb-1">${scentFamily}</p>
                    <h3 class="text-xl font-playfair text-charcoal mb-3 truncate">${product.name}</h3>
                    <div class="flex justify-between items-center mb-4">
                        <p class="text-lg font-bold text-burnt-orange">$${price}</p>
                        ${isOutOfStock ? '<p class="text-sm font-semibold text-red-600">SOLD OUT</p>' : ''}
                    </div>
                    ${actionButtonHtml}
                </div>
            </div>
        `;
    }

    /**
     * Attaches click listeners to all new "Add to Cart" buttons.
     */
    function attachCartListeners() {
        document.querySelectorAll('.add-to-cart-button').forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                const { id, name, price, image } = e.currentTarget.dataset;
                
                const product = { id, name, price, imageUrl: image };
                
                addToCart(product, 1); 
                updateCartDisplay(); 
                
                e.currentTarget.textContent = 'Added!';
                setTimeout(() => {
                    e.currentTarget.textContent = 'Add to Cart';
                }, 1000);
            });
        });
    }

    /**
     * Fetches featured products from Firestore and renders them.
     * Prioritizes the product ID specified in the CMS, then defaults to 4 featured products.
     */
    async function fetchFeaturedProducts(featuredId) {
        featuredLoader.classList.remove('hidden');
        featuredProductsGrid.innerHTML = '';
        featuredProductTitleEl.textContent = 'Featured Scents';

        try {
            const productsRef = collection(db, 'products');
            let productsToRender = [];
            
            if (featuredId) {
                // 1. Attempt to fetch the specific featured product
                const docSnap = await getDoc(doc(productsRef, featuredId));
                if (docSnap.exists() && docSnap.data().stock > 0) {
                    productsToRender.push({ id: docSnap.id, ...docSnap.data() });
                }
            }

            // 2. Fallback or fill remaining spots (get up to 4 other stocked, featured items)
            if (productsToRender.length < 4) {
                const q = query(productsRef, 
                                where('featured', '==', true), 
                                where('stock', '>', 0),
                                limit(4)
                            );
                const querySnapshot = await getDocs(q);
                
                querySnapshot.docs.forEach(doc => {
                    const productData = { id: doc.id, ...doc.data() };
                    // Avoid duplicates if the featuredId item was already fetched
                    if (!productsToRender.some(p => p.id === productData.id)) {
                        productsToRender.push(productData);
                    }
                });
            }
            
            // 3. Final Fallback: If less than 4, grab any other stocked item to fill the grid (for UX completeness)
            if (productsToRender.length === 0) {
                 const fallbackQ = query(productsRef, where('stock', '>', 0), limit(4));
                 const fallbackSnapshot = await getDocs(fallbackQ);
                 productsToRender = fallbackSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                 if (productsToRender.length > 0) {
                     featuredProductTitleEl.textContent = 'Popular Scents';
                 }
            }
            
            // Render the products
            if (productsToRender.length === 0) {
                featuredProductsGrid.innerHTML = '<p class="text-lg text-stone col-span-full text-center py-10">No products available at this time. Please check back later.</p>';
            } else {
                productsToRender.slice(0, 4).forEach(data => {
                    const product = { 
                        id: data.id, 
                        ...data, 
                        // Ensure numerical safety
                        price: parseFloat(data.price),
                        stock: parseInt(data.stock, 10) || 0
                    };
                    featuredProductsGrid.innerHTML += renderProductCard(product);
                });
                attachCartListeners();
            }

        } catch (error) {
            console.error("Error fetching featured products:", error);
            featuredProductsGrid.innerHTML = `<p class="text-red-600 col-span-full text-center py-10">Failed to load products. Connection error.</p>`;
        } finally {
            featuredLoader.classList.add('hidden');
        }
    }
    
    /**
     * Main initialization function
     */
    async function initializeHomepage() {
        const featuredId = await loadHomepageCMS();
        await fetchFeaturedProducts(featuredId);
    }

    // --- Initialization Trigger ---
    document.addEventListener('DOMContentLoaded', initializeHomepage);
</script>

<main class="min-h-screen">
    
    <div class="relative w-full bg-parchment py-24 md:py-32">
        <div class="container mx-auto px-4 text-center">
            <p class="font-great-vibes text-4xl text-burnt-orange mb-4">Welcome Home</p>
            <h1 id="hero-title" class="text-7xl md:text-8xl font-playfair text-charcoal font-bold mb-6 drop-shadow-lg">
                Southern Sense
            </h1>
            <p id="hero-subtitle" class="text-xl text-stone max-w-2xl mx-auto mb-8">
                Experience the warmth and charm of the South with our hand-poured, luxury soy-blend candles. Clean, comforting, and crafted for your home.
            </p>
            <a href="/shop.html" class="px-10 py-4 bg-burnt-orange text-parchment text-lg font-bold rounded-lg shadow-xl hover:bg-burnt-orange/80 transition duration-300">
                Shop Our Scents
            </a>
        </div>
    </div>
    
    <section class="container mx-auto px-4 py-20">
        <h2 id="featured-product-title" class="text-4xl font-playfair text-charcoal text-center mb-12">Featured Scents</h2>
        
        <div id="featured-loader" class="flex justify-center items-center h-48">
            <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-burnt-orange"></div>
        </div>

        <div id="featured-products-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
            </div>

        <div class="text-center mt-12">
            <a href="/shop.html" class="px-8 py-3 border border-stone/30 text-charcoal font-bold rounded-lg hover:bg-parchment/70 transition duration-300">
                View All Candles & Melts
            </a>
        </div>
    </section>

    <section class="bg-parchment py-20 border-t border-b border-stone/10">
        <div class="container mx-auto px-4">
            <h2 class="text-4xl font-playfair text-charcoal text-center mb-12">The Southern Sense Promise</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-10 text-center">
                <div class="p-6 bg-white rounded-lg shadow-md">
                    <img src="/src/finest-wax.webp" alt="Finest Wax" class="w-20 h-20 mx-auto mb-4">
                    <h3 class="text-2xl font-playfair text-charcoal mb-2">Finest Wax Blends</h3>
                    <p id="diff-wax-text" class="text-stone">We use a premium soy-coconut wax blend that ensures a clean, slow, and even burn every time.</p>
                </div>
                <div class="p-6 bg-white rounded-lg shadow-md">
                    <img src="/src/clean-oils.webp" alt="Clean Oils" class="w-20 h-20 mx-auto mb-4">
                    <h3 class="text-2xl font-playfair text-charcoal mb-2">Clean Fragrance Oils</h3>
                    <p id="diff-oils-text" class="text-stone">Our oils are 100% phthalate-free and safe, providing a rich scent throw without harmful chemicals.</p>
                </div>
                <div class="p-6 bg-white rounded-lg shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-burnt-orange mx-auto mb-4" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 2a8 8 0 100 16 8 8 0 000-16zM6.293 8.293a1 1 0 011.414 0L10 10.586l2.293-2.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    <h3 class="text-2xl font-playfair text-charcoal mb-2">Hand-Poured Quality</h3>
                    <p class="text-stone">Each candle is hand-poured in small batches in the South, guaranteeing attention to detail and superior quality.</p>
                </div>
            </div>
        </div>
    </section>

    <section class="container mx-auto px-4 py-20 text-center">
        <h2 class="text-4xl font-playfair text-charcoal mb-4">Can't Decide? Try Our Scent Quiz!</h2>
        <p class="text-lg text-stone max-w-xl mx-auto mb-8">Answer a few quick questions and we'll match you with the perfect Southern Sense fragrance for your home and mood.</p>
        <a href="/scent-quiz.html" class="px-8 py-3 bg-stone text-parchment font-bold rounded-lg shadow-lg hover:bg-charcoal transition duration-300">
            Take the Quiz Now
        </a>
    </section>
</main>