---
layout: layout.html
title: Shop All Products
---

<header class="relative w-full h-80 bg-cover bg-center" style="background-image: url('/src/candles-header.webp');">
    <div class="absolute inset-0 bg-charcoal/40 flex items-center justify-center">
        <h1 class="font-playfair text-6xl font-extrabold text-parchment drop-shadow-lg">Our Collection</h1>
    </div>
</header>

<main class="container mx-auto p-4 lg:p-8 py-16">
    <div class="text-center mb-12">
        <p class="font-roboto text-lg text-stone max-w-3xl mx-auto">
            Explore our full range of handcrafted luxury candles, wax melts, and home fragrances. Every item is made with a clean-burning coconut-soy blend and the finest essential oils.
        </p>
    </div>

    <div class="flex flex-col md:flex-row justify-between items-center mb-12 space-y-4 md:space-y-0 bg-parchment p-6 rounded-xl shadow-inner border border-stone/10">
        <div class="w-full md:w-auto">
            <label for="sort-by" class="block font-roboto text-sm font-medium text-charcoal mb-1">Sort By</label>
            <select id="sort-by" class="w-full md:w-48 p-2 border border-stone/30 rounded-lg focus:ring-burnt-orange focus:border-burnt-orange font-roboto text-sm">
                <option value="name-asc">Name (A-Z)</option>
                <option value="price-asc">Price (Low to High)</option>
                <option value="price-desc">Price (High to Low)</option>
            </select>
        </div>

        <div class="w-full md:w-auto">
            <label for="filter-category" class="block font-roboto text-sm font-medium text-charcoal mb-1">Filter by Category</label>
            <select id="filter-category" class="w-full md:w-48 p-2 border border-stone/30 rounded-lg focus:ring-burnt-orange focus:border-burnt-orange font-roboto text-sm">
                <option value="all">All Products</option>
                <option value="candle">Candles</option>
                <option value="melt">Wax Melts</option>
                </select>
        </div>
        
        <div class="w-full md:w-auto">
            <label for="filter-scent" class="block font-roboto text-sm font-medium text-charcoal mb-1">Filter by Scent Family</label>
            <select id="filter-scent" class="w-full md:w-48 p-2 border border-stone/30 rounded-lg focus:ring-burnt-orange focus:border-burnt-orange font-roboto text-sm">
                <option value="all">All Scent Families</option>
                </select>
        </div>
    </div>

    <section id="product-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
        <div id="loading-indicator" class="col-span-full text-center p-12">
            <p class="font-playfair text-xl text-stone">Loading our collection, please wait...</p>
            <div class="mt-4 animate-spin rounded-full h-8 w-8 border-b-2 border-burnt-orange mx-auto"></div>
        </div>
    </section>

</main>

<script type="module">
    // FIX: Import all required Firestore functions from the central loader
    import { 
        db, 
        collection, 
        query, 
        where, 
        orderBy, 
        getDocs, 
        limit 
    } from '/src/firebase-loader.js'; 

    // --- State Management ---
    let allProducts = [];
    // Initialize currentFilter based on URL parameter (from quiz or direct link)
    const urlParams = new URLSearchParams(window.location.search);
    const initialScentFamily = urlParams.get('family') || 'all';

    let currentFilter = { 
        category: 'all', 
        scentFamily: initialScentFamily, 
        sortBy: 'name-asc' 
    };

    // --- DOM Elements ---
    const productGrid = document.getElementById('product-grid');
    const loadingIndicator = document.getElementById('loading-indicator');
    const sortBySelect = document.getElementById('sort-by');
    const filterCategorySelect = document.getElementById('filter-category');
    const filterScentSelect = document.getElementById('filter-scent');
    const scentFamilyMap = {}; // To build the scent family filter options

    // --- Core Functions ---

    /**
     * Fetches all products from the Firestore 'products' collection.
     */
    async function fetchAllProducts() {
        // Show loading state
        productGrid.innerHTML = '';
        loadingIndicator.classList.remove('hidden');

        try {
            const productsCollection = collection(db, "products");
            // Always fetch base data sorted by name
            const q = query(productsCollection, orderBy("name")); 

            const querySnapshot = await getDocs(q);
            
            allProducts = querySnapshot.docs.map(doc => {
                const data = doc.data();
                // Ensure data structure integrity for all products
                return {
                    id: doc.id,
                    name: data.name || 'Untitled Product',
                    shortDescription: data.shortDescription || 'A beautiful scent.',
                    // CRITICAL CHECK: Ensure price is correctly read and parsed
                    price: parseFloat(data.price) || 0.00, 
                    // CRITICAL CHECK: Ensure imageUrl uses the /src/ path for local serving
                    imageUrl: data.imageUrl ? `/src/${data.imageUrl}` : 'https://placehold.co/400x400/FBF9F6/3D352E?text=Image+Missing', 
                    category: data.category || 'other',
                    scentFamily: data.scentFamily || 'unclassified',
                    // FIX: Changed link generation to rely on Eleventy's directory structure (no .html extension)
                    url: `/product/?id=${doc.id}`
                };
            });
            
            // Build filter map after fetching all products
            buildScentFamilyMap(); 
            // Apply current filters to the fetched products
            applyFiltersAndSort(); 

        } catch (error) {
            console.error("Error fetching products:", error);
            // Display error message to the user
            productGrid.innerHTML = `
                <div class="col-span-full text-center p-12 bg-red-50 border border-red-200 rounded-lg">
                    <p class="font-playfair text-xl text-red-700">Failed to load products.</p>
                    <p class="font-roboto text-sm text-red-600 mt-2">There was an issue connecting to the database. Please verify the API keys in firebase-loader.js and try refreshing.</p>
                </div>
            `;
        } finally {
            loadingIndicator.classList.add('hidden');
        }
    }

    /**
     * Analyzes all products to build a unique list of scent families for the filter.
     */
    function buildScentFamilyMap() {
        const families = new Set();
        allProducts.forEach(p => {
            if (p.scentFamily && p.scentFamily !== 'unclassified') {
                families.add(p.scentFamily);
            }
        });

        // Clear and rebuild scent filter options
        filterScentSelect.innerHTML = '<option value="all">All Scent Families</option>';
        families.forEach(family => {
            const option = document.createElement('option');
            // Capitalize the first letter for display and replace hyphens
            option.value = family;
            option.textContent = family.charAt(0).toUpperCase() + family.slice(1).replace(/-/g, ' '); 
            filterScentSelect.appendChild(option);
        });
        
        // Restore selected filter if possible (used for quiz redirection)
        if (currentFilter.scentFamily !== 'all') {
            filterScentSelect.value = currentFilter.scentFamily;
        }
    }

    /**
     * Applies the current state of filters and sorting to the allProducts array.
     */
    function applyFiltersAndSort() {
        let filteredProducts = [...allProducts];

        // 1. Filtering
        if (currentFilter.category !== 'all') {
            filteredProducts = filteredProducts.filter(p => p.category === currentFilter.category);
        }
        if (currentFilter.scentFamily !== 'all') {
            filteredProducts = filteredProducts.filter(p => p.scentFamily === currentFilter.scentFamily);
        }

        // 2. Sorting
        filteredProducts.sort((a, b) => {
            switch (currentFilter.sortBy) {
                case 'name-asc':
                    return a.name.localeCompare(b.name);
                case 'price-asc':
                    return a.price - b.price;
                case 'price-desc':
                    return b.price - a.price;
                default:
                    return 0;
            }
        });

        renderProducts(filteredProducts);
    }

    /**
     * Renders the given array of products into the grid.
     * @param {Array} products - The array of products to display.
     */
    function renderProducts(products) {
        productGrid.innerHTML = ''; // Clear existing content

        if (products.length === 0) {
            productGrid.innerHTML = `
                <div class="col-span-full text-center p-12">
                    <p class="font-playfair text-2xl text-stone">No products found matching your filters.</p>
                    <p class="font-roboto text-sm text-stone mt-2">Try adjusting your category or scent family selections.</p>
                </div>
            `;
            return;
        }

        products.forEach(product => {
            // Use the pre-processed URL with /src/ path included
            const validImageUrl = product.imageUrl; 
            
            const productCard = document.createElement('a');
            productCard.href = product.url; // Use the generated URL
            productCard.className = 'block group bg-white/70 backdrop-blur-sm rounded-xl shadow-lg hover:shadow-2xl transition-all duration-300 overflow-hidden border border-stone/10';
            
            productCard.innerHTML = `
                <div class="overflow-hidden">
                    <img src="${validImageUrl}" alt="${product.name}" class="w-full h-64 object-cover object-center transition-transform duration-500 group-hover:scale-105" onerror="this.src='https://placehold.co/400x400/FBF9F6/3D352E?text=Image+Error'; this.onerror=null;">
                </div>
                <div class="p-4 text-center">
                    <h3 class="font-playfair text-xl font-bold text-charcoal group-hover:text-burnt-orange transition-colors duration-200">${product.name}</h3>
                    <p class="font-roboto text-sm text-stone mt-1">${product.shortDescription}</p>
                    <p class="font-playfair text-2xl text-burnt-orange font-extrabold mt-3">$${product.price.toFixed(2)}</p>
                </div>
            `;
            productGrid.appendChild(productCard);
        });
    }

    // --- Event Listeners and Initialization ---

    function initializeShopPage() {
        // Event listeners for filters and sorting
        sortBySelect.addEventListener('change', (e) => {
            currentFilter.sortBy = e.target.value;
            applyFiltersAndSort();
        });

        filterCategorySelect.addEventListener('change', (e) => {
            currentFilter.category = e.target.value;
            applyFiltersAndSort();
        });

        filterScentSelect.addEventListener('change', (e) => {
            currentFilter.scentFamily = e.target.value;
            applyFiltersAndSort();
        });

        // Initial data fetch
        fetchAllProducts();
    }

    document.addEventListener('DOMContentLoaded', initializeShopPage);
</script>