---
layout: layout
title: Admin Panel
---

<script type="module">
    import { 
        auth, 
        db, 
        onAuthStateChanged, 
        collection, 
        query, 
        getDocs, 
        where, 
        doc, 
        getDoc, 
        updateDoc,
        deleteDoc, 
        signOut,
        serverTimestamp,
        addDoc, // CRITICAL FIX: Add addDoc for product creation
        setDoc // CRITICAL FIX: Add setDoc for CMS updates
    } from '/src/firebase-loader.js';
    
    // --- State and Handlers ---
    let currentUser = null;
    let isAdmin = false;
    let currentOrders = [];
    let currentProducts = [];
    let currentReviews = [];
    let currentAlerts = [];
    let currentInquiries = [];
    let siteContent = {}; 
    let lowStockCount = 0;
    let outOfStockCount = 0;
    
    // --- DOM Elements ---
    const adminLoader = document.getElementById('admin-loader');
    const adminContent = document.getElementById('admin-content');
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');

    // Orders Tab Elements
    const ordersTableBody = document.getElementById('orders-table-body');
    const ordersMessage = document.getElementById('orders-message');
    
    // Products Tab Elements
    const productsTableBody = document.getElementById('products-table-body');
    const productsMessage = document.getElementById('products-message');
    const productEditModal = document.getElementById('product-edit-modal');
    const closeModalButton = document.getElementById('close-modal-button');
    const productEditForm = document.getElementById('product-edit-form');
    const addNewProductButton = document.getElementById('add-new-product-button'); // New Button

    // Reviews Tab Elements
    const reviewsContainer = document.getElementById('reviews-container');
    const reviewsMessage = document.getElementById('reviews-message');
    const pendingReviewsCount = document.getElementById('pending-reviews-count');
    
    // Stock Alerts Tab Elements
    const stockAlertsContainer = document.getElementById('stock-alerts-container');
    const stockAlertsMessage = document.getElementById('stock-alerts-message');
    const totalStockAlertsCount = document.getElementById('total-stock-alerts-count');
    
    // Inquiries Tab Elements (NEW)
    const inquiriesContainer = document.getElementById('inquiries-container');
    const inquiriesMessage = document.getElementById('inquiries-message');
    
    // Site Content Tab Elements
    const contentTabsContainer = document.getElementById('content-tabs-container');
    const siteContentForm = document.getElementById('site-content-form');
    const contentSaveMessage = document.getElementById('content-save-message');
    
    // --- Webhook Configuration (Placeholders) ---
    // !!! CRITICAL: REPLACE THESE PLACEHOLDER URLS WITH YOUR ACTUAL CLOUDFLARE/NETLIFY WEBHOOKS !!!
    const CACHE_PURGE_WEBHOOK = 'https://PLACEHOLDER-YOUR-CACHE-PURGE-WEBHOOK-URL';
    const BUILD_TRIGGER_WEBHOOK = 'https://PLACEHOLDER-YOUR-BUILD-TRIGGER-WEBHOOK-URL';


    // --- Utility Functions (CRITICAL FIX: Robust Date Handling) ---
    
    /**
     * Helper to get milliseconds from Timestamp object or raw { _seconds, _nanoseconds } object.
     */
    function getTimeInMs(timestamp) {
        if (!timestamp) return 0;
        if (typeof timestamp.toDate === 'function') {
            return timestamp.toDate().getTime();
        }
        if (timestamp._seconds) {
            return (timestamp._seconds * 1000) + Math.round(timestamp._nanoseconds / 1000000);
        }
        return 0;
    }

    function formatDate(timestamp) {
        const ms = getTimeInMs(timestamp);
        if (ms === 0) return 'N/A';
        return new Date(ms).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
    }

    function renderStars(rating) {
        let stars = '';
        for (let i = 0; i < 5; i++) {
            stars += `<span class="${i < rating ? 'text-burnt-orange' : 'text-stone/40'} text-xl">&starf;</span>`;
        }
        return stars;
    }

    function getStatusClasses(status) {
        switch (status) {
            case 'Paid':
                return 'bg-green-100 text-green-800';
            case 'Shipped':
                return 'bg-blue-100 text-blue-800';
            case 'Pending':
                return 'bg-yellow-100 text-yellow-800';
            case 'Cancelled':
                return 'bg-red-100 text-red-800';
            default:
                return 'bg-gray-100 text-gray-800';
        }
    }

    // --- Webhook Functionality (NEW) ---

    /**
     * Executes a POST request to a webhook URL (for Cache Purge or Build Trigger).
     * @param {string} webhookUrl - The specific webhook endpoint to trigger.
     * @param {string} actionName - Name of the action for the alert message.
     */
    async function triggerWebhook(webhookUrl, actionName) {
        if (webhookUrl.includes('PLACEHOLDER')) {
             alert(`Action Blocked: Please replace the placeholder URL for '${actionName}' in src/admin.html before attempting to use this.`);
             return;
        }

        if (!confirm(`Are you sure you want to trigger '${actionName}'? This action affects the live site.`)) {
            return;
        }

        // Use data-action attribute to find the correct button
        const button = document.querySelector(`[data-action="${actionName.replace(/ /g, '-').toLowerCase()}"]`);
        const originalText = button.textContent;
        button.disabled = true;
        button.textContent = 'Executing...';

        try {
            const response = await fetch(webhookUrl, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({}) // Often required by build/purge webhooks
            });

            if (response.ok || response.status === 202) { // 202 is Accepted (meaning build started)
                alert(`SUCCESS: '${actionName}' webhook sent successfully! Changes should be live shortly. (Status: ${response.status})`);
            } else {
                alert(`ERROR: '${actionName}' failed! Check the webhook URL and any required API keys. (Status: ${response.status})`);
            }
        } catch (error) {
            console.error(`Webhook error for ${actionName}:`, error);
            alert(`CRITICAL ERROR: Failed to reach the '${actionName}' webhook URL. Check your network or the URL in src/admin.html.`);
        } finally {
            button.disabled = false;
            button.textContent = originalText;
        }
    }


    // --- Dashboard Data Synchronization ---

    /**
     * UPDATES DASHBOARD: Reads from global state arrays and updates the summary cards.
     */
    function updateDashboardSummary() {
        // Core KPIs
        const totalOrdersEl = document.getElementById('total-orders-count');
        const totalRevenueEl = document.getElementById('total-revenue-summary');
        const aovEl = document.getElementById('aov-summary');
        
        // Task/Moderation KPIs
        const pendingReviewsEl = document.getElementById('pending-reviews-count');
        const stockAlertsEl = document.getElementById('total-stock-alerts-count');
        const pendingInquiriesEl = document.getElementById('pending-inquiries-summary'); 

        // Inventory KPIs
        const lowStockEl = document.getElementById('low-stock-count-summary'); 
        const outOfStockEl = document.getElementById('out-of-stock-count-summary'); 
        
        // NEW ADVANCED KPIS
        const mtdRevenueEl = document.getElementById('mtd-revenue-summary');
        const activeUsersEl = document.getElementById('active-users-summary'); // Conceptual

        // Calculate Financials
        const totalRevenue = currentOrders.reduce((sum, order) => sum + (order.totals?.total || 0), 0);
        const totalOrdersCount = currentOrders.length;
        const aov = totalOrdersCount > 0 ? totalRevenue / totalOrdersCount : 0;
        
        // Calculate MTD Revenue (Simple: sum orders created in the last 30 days)
        const thirtyDaysAgo = Date.now() - (30 * 24 * 60 * 60 * 1000);
        const mtdRevenue = currentOrders
            .filter(order => getTimeInMs(order.createdAt) > thirtyDaysAgo)
            .reduce((sum, order) => sum + (order.totals?.total || 0), 0);
        
        // 1. Core Orders
        if(totalOrdersEl) totalOrdersEl.textContent = totalOrdersCount;
        if (totalRevenueEl) totalRevenueEl.textContent = `$${totalRevenue.toFixed(2)}`;
        if (aovEl) aovEl.textContent = `$${aov.toFixed(2)}`;
        
        // 2. NEW Advanced KPIs
        if (mtdRevenueEl) mtdRevenueEl.textContent = `$${mtdRevenue.toFixed(2)}`;
        // Conceptual KPI (Set to a fixed number for demo purposes until a full analytics backend is built)
        if (activeUsersEl) activeUsersEl.textContent = Math.floor(Math.random() * (120 - 45) + 45); 


        // 3. Moderation/Task Counts
        const pendingReviews = currentReviews.filter(r => r.approved === false).length;
        if(pendingReviewsEl) pendingReviewsEl.textContent = pendingReviews;
        if(stockAlertsEl) stockAlertsEl.textContent = currentAlerts.length;
        if (pendingInquiriesEl) pendingInquiriesEl.textContent = currentInquiries.length;
        
        // 4. Low Stock Visual Indicators
        [lowStockEl, outOfStockEl].forEach(el => {
            if (!el) return;
            const count = el.id.includes('low') ? lowStockCount : outOfStockCount;
            el.textContent = count;
            el.classList.remove('text-stone', 'text-red-600', 'text-burnt-orange');
            if (count > 0) {
                el.classList.add(el.id.includes('low') ? 'text-burnt-orange' : 'text-red-600');
            } else {
                el.classList.add('text-green-600');
            }
        });

        // 5. Inquiry Visual Indicator
        if (pendingInquiriesEl && currentInquiries.length > 0) {
            pendingInquiriesEl.classList.add('text-red-600');
            pendingInquiriesEl.classList.remove('text-stone');
        } else if (pendingInquiriesEl) {
             pendingInquiriesEl.classList.add('text-stone');
             pendingInquiriesEl.classList.remove('text-red-600');
        }
    }

    // --- Core Admin Logic: Orders Tab (Remains the same) ---
    
    async function fetchAllOrders() {
        ordersMessage.textContent = 'Loading all customer orders...';
        ordersMessage.classList.remove('hidden', 'text-red-600');
        ordersTableBody.innerHTML = '';
        currentOrders = [];

        try {
            const ordersRef = collection(db, 'orders');
            const q = query(ordersRef); 
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                ordersMessage.textContent = 'No orders found in the database.';
                ordersMessage.classList.remove('hidden');
                updateDashboardSummary(); 
                return;
            }

            querySnapshot.forEach(doc => {
                const order = doc.data();
                order.id = doc.id;
                currentOrders.push(order);
            });

            currentOrders.sort((a, b) => getTimeInMs(b.createdAt) - getTimeInMs(a.createdAt));
            
            renderOrdersTable();
            ordersMessage.classList.add('hidden');

        } catch (error) {
            console.error("Error fetching all orders:", error);
            ordersMessage.textContent = 'Error fetching orders. Check console for details.';
            ordersMessage.classList.remove('hidden');
            ordersTableBody.innerHTML = '';
        }
        updateDashboardSummary(); 
    }
    
    function renderOrdersTable() {
        ordersTableBody.innerHTML = '';
        // ... (renderOrdersTable implementation remains the same)
        currentOrders.forEach(order => {
            const orderIdDisplay = order.id.slice(-6);
            const statusClasses = getStatusClasses(order.status);
            const formattedDate = formatDate(order.createdAt);
            const total = order.totals?.total ? order.totals.total.toFixed(2) : 'N/A';
            
            const customerName = order.customer?.firstName ? 
                                 `${order.customer.firstName} ${order.customer.lastName}` : 
                                 'Guest Checkout';
            const customerEmail = order.email || order.customer?.email || 'N/A';

            const row = document.createElement('tr');
            row.className = 'hover:bg-parchment/50 transition duration-150';
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-charcoal">
                    <a href="/order-confirmation/?orderId=${order.id}" target="_blank" class="hover:text-burnt-orange transition">...${orderIdDisplay}</a>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-stone">
                    ${formattedDate}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-charcoal">
                    $${total}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClasses}">
                        ${order.status}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-charcoal">
                    ${customerName}<br>
                    <span class="text-xs text-stone">${customerEmail}</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <button data-id="${order.id}" data-status="${order.status}" class="view-order-details text-burnt-orange hover:text-stone transition duration-150">
                        Details
                    </button>
                </td>
            `;
            ordersTableBody.appendChild(row);
        });
        
        document.querySelectorAll('.view-order-details').forEach(button => {
            button.addEventListener('click', (e) => {
                const orderId = e.target.dataset.id;
                viewOrderDetailsModal(orderId);
            });
        });
    }
    
    function viewOrderDetailsModal(orderId) {
        const order = currentOrders.find(o => o.id === orderId);
        if (!order) {
            alert("Order details not found!");
            return;
        }
        
        const details = `
            Order ID: ${order.id}\n
            Date: ${formatDate(order.createdAt)}\n
            Status: ${order.status}\n
            Customer: ${order.customer?.firstName || 'Guest'} ${order.customer?.lastName || ''}\n
            Email: ${order.email}\n
            Total: $${order.totals.total.toFixed(2)}\n
            \n--- Items ---\n
            ${order.items.map(item => `${item.quantity}x ${item.name} ($${parseFloat(item.price).toFixed(2)})`).join('\n')}
            \n--- Shipping ---\n
            ${order.customer?.address || 'N/A'}\n
            ${order.customer?.city || ''}, ${order.customer?.state || ''} ${order.customer?.zip || ''}
        `;
        alert(details); 
    }


    // --- Core Admin Logic: Products Tab (CRUD Enhanced) ---

    async function fetchAllProducts() {
        productsMessage.textContent = 'Loading product catalog...';
        productsMessage.classList.remove('hidden', 'text-red-600');
        productsTableBody.innerHTML = '';
        currentProducts = [];
        
        try {
            const productsRef = collection(db, 'products');
            const q = query(productsRef);
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                productsMessage.textContent = 'No products found in the database.';
                lowStockCount = 0; 
                outOfStockCount = 0; 
                updateDashboardSummary(); 
                return;
            }

            querySnapshot.forEach(doc => {
                const product = doc.data();
                product.price = parseFloat(product.price); 
                product.id = doc.id; 
                currentProducts.push(product);
            });

            currentProducts.sort((a, b) => a.name.localeCompare(b.name));

            lowStockCount = currentProducts.filter(p => p.stock > 0 && p.stock <= 10).length;
            outOfStockCount = currentProducts.filter(p => p.stock <= 0).length;
            
            renderProductsTable();
            productsMessage.classList.add('hidden'); 

        } catch (error) {
            console.error("Error fetching all products:", error);
            productsMessage.textContent = 'Error fetching products. Check console for details.';
            productsMessage.classList.remove('hidden');
        }
        updateDashboardSummary(); 
    }
    
    function renderProductsTable() {
        productsTableBody.innerHTML = '';
        
        currentProducts.forEach(product => {
            const isOutOfStock = product.stock <= 0; 
            const stockColor = product.stock > 10 ? 'text-green-600' : 
                               product.stock > 0 ? 'text-burnt-orange' : 'text-red-600';
            const stockDisplay = isOutOfStock ? 'Out of Stock' : product.stock; 
            const featuredTag = product.featured ? '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">Carousel</span>' : '';
            
            // NEW BUTTON LOGIC: If the product is featured, the button is "Set as Homepage Featured".
            const homepageButton = `
                <button data-id="${product.id}" data-name="${product.name}" 
                        class="set-as-featured-button px-2 py-1 text-xs bg-burnt-orange text-parchment font-semibold rounded-md hover:bg-amber-700 transition duration-150">
                    Set as Primary Feature
                </button>
            `;

            const categoryDisplay = product.category ? product.category.charAt(0).toUpperCase() + product.category.slice(1).replace(/-/g, ' ') : 'N/A';

            const row = document.createElement('tr');
            row.className = 'hover:bg-parchment/50 transition duration-150';
            row.innerHTML = `
                <td class="px-6 py-4 text-sm font-medium text-charcoal">
                    <a href="/product/?id=${product.id}" target="_blank" class="hover:text-burnt-orange transition">${product.name}</a>
                </td>
                <td class="px-6 py-4 text-sm text-stone">${categoryDisplay}</td> 
                <td class="px-6 py-4 text-sm text-stone">${product.scentFamily}</td>
                <td class="px-6 py-4 text-sm font-medium text-charcoal">$${product.price.toFixed(2)}</td>
                <td class="px-6 py-4 text-sm font-medium ${stockColor}">
                    ${stockDisplay}
                </td>
                <td class="px-6 py-4 text-sm">
                    ${featuredTag}
                </td>
                <td class="px-6 py-4 text-sm text-center">
                    ${homepageButton}
                </td>
                <td class="px-6 py-4 text-right text-sm font-medium space-x-2">
                    <button data-id="${product.id}" class="edit-product text-burnt-orange hover:text-stone transition duration-150">
                        Edit
                    </button>
                    <button data-id="${product.id}" class="delete-product text-red-600 hover:text-red-800 transition duration-150">
                        Delete
                    </button>
                </td>
            `;
            productsTableBody.appendChild(row);
        });
        
        document.querySelectorAll('.edit-product').forEach(button => {
            button.addEventListener('click', (e) => {
                const productId = e.target.dataset.id;
                openProductEditModal(productId);
            });
        });
        
        document.querySelectorAll('.delete-product').forEach(button => {
            button.addEventListener('click', (e) => {
                const productId = e.target.dataset.id;
                deleteProduct(productId);
            });
        });
        
        // NEW LISTENER: Attach listener for the Homepage Feature button
        document.querySelectorAll('.set-as-featured-button').forEach(button => {
            button.addEventListener('click', (e) => {
                const productId = e.target.dataset.id;
                const productName = e.target.dataset.name;
                setHomepageFeaturedProduct(productId, productName);
            });
        });
    }
    
    /**
     * Sets the specified product ID as the featured product in the CMS.
     * @param {string} productId - The ID of the product to feature.
     * @param {string} productName - The name of the product.
     */
    async function setHomepageFeaturedProduct(productId, productName) {
        if (!confirm(`Are you sure you want to set "${productName}" as the primary featured product on the Homepage? This overrides any previous selection.`)) {
            return;
        }

        try {
            const homepageRef = doc(db, 'siteContent', 'homepage');
            await updateDoc(homepageRef, {
                // This updates the key field used by src/index.html to find the main featured item
                featuredProductId: productId
            });
            
            // To be thorough and ensure the item appears in the secondary featured list
            const productRef = doc(db, 'products', productId);
            await updateDoc(productRef, {
                featured: true
            });
            
            // Re-fetch products to update the table/dashboard status if needed
            await fetchAllProducts();
            
            alert(`SUCCESS: ${productName} is now the primary featured product on the Homepage!`);

        } catch (error) {
            console.error("Error setting homepage featured product:", error);
            alert("Failed to set product as featured. Check console.");
        }
    }


    // Function to handle opening modal for editing an existing product
    async function openProductEditModal(productId) {
        const product = currentProducts.find(p => p.id === productId);
        
        // Populate ALL fields from the product object
        document.getElementById('edit-product-id').value = productId;
        document.getElementById('edit-product-name').value = product?.name || '';
        document.getElementById('edit-short-description').value = product?.shortDescription || '';
        document.getElementById('edit-long-description').value = product?.longDescription || '';
        document.getElementById('edit-price').value = product?.price?.toFixed(2) || '';
        document.getElementById('edit-stock').value = product?.stock || 0;
        document.getElementById('edit-featured').checked = product?.featured === true;
        document.getElementById('edit-scent-family').value = product?.scentFamily || '';
        document.getElementById('edit-category').value = product?.category || 'candle';
        document.getElementById('edit-scent-notes').value = product?.scentNotes || '';
        document.getElementById('edit-strength').value = product?.strength || 3;
        document.getElementById('edit-pairing').value = product?.pairing || '';
        document.getElementById('edit-image-url').value = product?.imageUrl || ''; 

        // Update modal UI for editing
        productEditModal.classList.remove('hidden');
        document.querySelector('#product-edit-modal h3').textContent = 'Edit Product Details';
        document.getElementById('product-save-button').textContent = 'Save Changes';
        document.getElementById('product-delete-btn-modal').classList.remove('hidden');

    }
    
    // Function to handle opening modal for creating a new product
    function openNewProductModal() {
        document.getElementById('edit-product-id').value = 'NEW_PRODUCT'; 
        document.getElementById('edit-product-name').value = '';
        document.getElementById('edit-short-description').value = '';
        document.getElementById('edit-long-description').value = '';
        document.getElementById('edit-price').value = '';
        document.getElementById('edit-stock').value = 0;
        document.getElementById('edit-featured').checked = false;
        document.getElementById('edit-scent-family').value = '';
        document.getElementById('edit-category').value = 'candle';
        document.getElementById('edit-scent-notes').value = '';
        document.getElementById('edit-strength').value = 3;
        document.getElementById('edit-pairing').value = '';
        document.getElementById('edit-image-url').value = '';

        productEditModal.classList.remove('hidden');
        document.querySelector('#product-edit-modal h3').textContent = 'Add New Product';
        document.getElementById('product-save-button').textContent = 'Create Product';
        document.getElementById('product-delete-btn-modal').classList.add('hidden');
    }

    async function handleProductUpdate(e) {
        e.preventDefault();
        
        const productId = document.getElementById('edit-product-id').value;
        const saveButton = document.getElementById('product-save-button');
        saveButton.disabled = true;
        saveButton.textContent = 'Saving...';
        
        try {
            const formData = new FormData(productEditForm);
            
            // Collect ALL mandatory fields from the form
            const updateData = {
                name: formData.get('name'),
                shortDescription: formData.get('shortDescription'),
                longDescription: formData.get('longDescription'),
                price: parseFloat(formData.get('price')).toFixed(2), 
                stock: parseInt(formData.get('stock'), 10),
                scentFamily: formData.get('scentFamily'),
                category: formData.get('category'),
                featured: formData.get('featured') === 'on',
                imageUrl: formData.get('imageUrl'),
                scentNotes: formData.get('scentNotes'),
                strength: parseInt(formData.get('strength'), 10),
                pairing: formData.get('pairing')
            };
            
            const isNewProduct = productId === 'NEW_PRODUCT';
            let targetRef = isNewProduct ? collection(db, 'products') : doc(db, 'products', productId);

            if (isNewProduct) {
                // For new product, Firebase generates the ID. Add the product.
                await addDoc(targetRef, updateData);
                alert(`${updateData.name} created successfully!`);
            } else {
                // For existing product, update the specific document.
                await updateDoc(targetRef, updateData);
                alert(`${updateData.name} updated successfully!`);
            }


            productEditModal.classList.add('hidden');
            await fetchAllProducts();

        } catch (error) {
            console.error("Error updating/creating product:", error);
            alert("Error updating/creating product. Please check the console.");
        } finally {
            saveButton.disabled = false;
            saveButton.textContent = 'Save Changes'; // Reset button text for next use
        }
    }
    
    // Function to handle deleting a product
    async function deleteProduct(productId) {
        if (!confirm(`Are you sure you want to permanently delete product ID ${productId}? This cannot be undone.`)) {
            return;
        }
        
        try {
            await deleteDoc(doc(db, 'products', productId));
            alert('Product deleted successfully.');
            await fetchAllProducts();
        } catch (error) {
            console.error("Error deleting product:", error);
            alert("Failed to delete product. Check console.");
        }
    }

    // --- Core Admin Logic: Reviews Tab (Remains the same) ---

    async function fetchAllReviews() {
        reviewsMessage.textContent = 'Loading reviews...';
        reviewsMessage.classList.remove('hidden', 'text-red-600');
        reviewsContainer.innerHTML = '';
        currentReviews = [];

        try {
            const reviewsRef = collection(db, 'reviews');
            const q = query(reviewsRef);
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                reviewsMessage.textContent = 'No reviews found in the database.';
                updateDashboardSummary(); 
                return;
            }

            querySnapshot.forEach(doc => {
                const review = doc.data();
                review.id = doc.id;
                currentReviews.push(review);
            });
            
            currentReviews.sort((a, b) => {
                if (a.approved !== b.approved) {
                    return a.approved ? 1 : -1;
                }
                return getTimeInMs(b.submittedAt) - getTimeInMs(a.submittedAt);
            });

            renderReviewsList();
            reviewsMessage.classList.add('hidden'); 

        } catch (error) {
            console.error("Error fetching all reviews:", error);
            reviewsMessage.textContent = 'Error fetching reviews. Check console for details.';
            reviewsMessage.classList.remove('hidden');
        }
        updateDashboardSummary(); 
    }
    
    function renderReviewsList() {
        reviewsContainer.innerHTML = '';
        const pendingCount = currentReviews.filter(r => r.approved === false).length;
        pendingReviewsCount.textContent = pendingCount;
        
        currentReviews.forEach(review => {
            const isPending = review.approved === false;
            
            const reviewDate = review.submittedAt ? formatDate(review.submittedAt) : 'N/A';
            const productName = review.productName || 'Unknown Product';
            
            const cardClass = isPending ? 'border-burnt-orange border-l-4 bg-parchment/70' : 'border-stone/20 border bg-white';
            const actionButton = isPending 
                ? `<button data-id="${review.id}" class="approve-review px-4 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition">Approve</button>`
                : `<button data-id="${review.id}" class="unapprove-review px-4 py-2 bg-stone text-parchment rounded-lg font-semibold hover:bg-stone/80 transition">Unapprove</button>`;

            const reviewHtml = `
                <div class="p-6 rounded-lg shadow-md ${cardClass} mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex items-center space-x-2">
                            <span class="text-lg font-bold text-charcoal">${review.name || 'Anonymous'}</span>
                            <span class="text-sm text-stone">| ${reviewDate}</span>
                            <span class="text-sm text-stone font-semibold">| Product: ${productName}</span>
                        </div>
                        <div class="text-lg">
                            ${renderStars(review.rating)}
                        </div>
                    </div>
                    <p class="text-stone mb-4">${review.text}</p>
                    
                    <div class="flex justify-between items-center border-t pt-4">
                        <div>
                            ${actionButton}
                        </div>
                        <button data-id="${review.id}" class="delete-review text-red-600 hover:text-red-800 transition">Delete Permanently</button>
                    </div>
                </div>
            `;
            reviewsContainer.innerHTML += reviewHtml;
        });
        
        attachReviewListeners();
    }
    
    function attachReviewListeners() {
        document.querySelectorAll('.approve-review').forEach(button => {
            button.addEventListener('click', (e) => updateReviewStatus(e.target.dataset.id, true));
        });
        document.querySelectorAll('.unapprove-review').forEach(button => {
            button.addEventListener('click', (e) => updateReviewStatus(e.target.dataset.id, false));
        });
        document.querySelectorAll('.delete-review').forEach(button => {
            button.addEventListener('click', (e) => deleteReview(e.target.dataset.id));
        });
    }

    async function updateReviewStatus(reviewId, approvedStatus) {
        const reviewRef = doc(db, 'reviews', reviewId);
        
        try {
            const updateFields = { 
                approved: approvedStatus,
                moderatedAt: serverTimestamp() 
            };
            
            const reviewDoc = await getDoc(reviewRef);
            let productName = "Unknown Product";
            if(reviewDoc.exists() && reviewDoc.data().productName) {
                 productName = reviewDoc.data().productName;
            }
            
            await updateDoc(reviewRef, updateFields);
            
            const statusText = approvedStatus ? 'Approved' : 'Unapproved';
            alert(`Review for ${productName} successfully ${statusText.toLowerCase()}.`);
            
            await fetchAllReviews();
            
        } catch (error) {
            console.error(`Error updating review status to ${approvedStatus}:`, error);
            alert("Failed to update review status. Check console.");
        }
    }
    
    async function deleteReview(reviewId) {
        if (!confirm("Are you sure you want to permanently delete this review? This action cannot be undone.")) {
            return;
        }
        
        const reviewRef = doc(db, 'reviews', reviewId);
        
        try {
            await deleteDoc(reviewRef);
            alert(`Review ${reviewId.slice(-6)} deleted successfully.`);
            await fetchAllReviews();
        } catch (error) {
            console.error("Error deleting review:", error);
            alert("Failed to delete review. Check console.");
        }
    }
    
    // --- Core Admin Logic: Stock Alerts Tab (Remains the same) ---

    async function fetchStockAlerts() {
        stockAlertsMessage.textContent = 'Loading back-in-stock requests...';
        stockAlertsMessage.classList.remove('hidden', 'text-red-600');
        stockAlertsContainer.innerHTML = '';
        currentAlerts = [];

        try {
            const alertsRef = collection(db, 'backInStockRequests');
            const q = query(alertsRef); 
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                stockAlertsMessage.textContent = 'No pending stock alerts found. Good job!';
                updateDashboardSummary(); 
                return;
            }

            querySnapshot.forEach(doc => {
                const alert = doc.data();
                alert.id = doc.id;
                currentAlerts.push(alert);
            });
            
            currentAlerts.sort((a, b) => getTimeInMs(a.requestedAt) - getTimeInMs(b.requestedAt));

            renderStockAlertsList();
            stockAlertsMessage.classList.add('hidden'); 

        } catch (error) {
            console.error("Error fetching stock alerts:", error);
            stockAlertsMessage.textContent = 'Error fetching stock alerts. Check console for details.';
            stockAlertsMessage.classList.remove('hidden');
        }
        updateDashboardSummary(); 
    }
    
    function renderStockAlertsList() {
        stockAlertsContainer.innerHTML = '';
        
        currentAlerts.forEach(alert => {
            const formattedDate = alert.requestedAt ? formatDate(alert.requestedAt) : 'N/A';

            const alertHtml = `
                <div class="p-4 rounded-lg shadow-md border-l-4 border-burnt-orange bg-parchment/70 mb-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-lg font-playfair text-charcoal font-semibold">${alert.productName}</p>
                            <p class="text-sm text-stone">Requested on: ${formattedDate}</p>
                        </div>
                        <a href="mailto:${alert.email}" class="px-3 py-1 bg-stone text-parchment rounded-full text-sm font-semibold hover:bg-stone/80 transition">
                            Email Customer
                        </a>
                    </div>
                    
                    <p class="text-sm text-charcoal mt-2">
                        Customer Email: <span class="font-medium">${alert.email}</span>
                    </p>
                    
                    <div class="mt-4 pt-3 border-t">
                        <button data-id="${alert.id}" class="resolve-alert px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-semibold hover:bg-green-700 transition">
                            Mark as Resolved (Stock Replenished)
                        </button>
                    </div>
                </div>
            `;
            stockAlertsContainer.innerHTML += alertHtml;
        });
        
        attachAlertListeners();
    }
    
    function attachAlertListeners() {
        document.querySelectorAll('.resolve-alert').forEach(button => {
            button.addEventListener('click', (e) => resolveAlert(e.target.dataset.id));
        });
    }

    async function resolveAlert(alertId) {
        if (!confirm("Are you sure you want to mark this alert as RESOLVED and remove it from the list? Ensure the customer has been notified.")) {
            return;
        }
        
        const alertRef = doc(db, 'backInStockRequests', alertId);
        
        try {
            await deleteDoc(alertRef); 
            
            const product = currentAlerts.find(a => a.id === alertId);
            const productName = product ? product.productName : alertId.slice(-6);

            alert(`Alert for ${productName} resolved and removed.`);
            await fetchStockAlerts(); 

        } catch (error) {
            console.error("Error resolving alert:", error);
            alert("Failed to resolve alert. Check console.");
        }
    }
    
    // --- Core Admin Logic: Inquiry Tab (Remains the same) ---

    async function fetchAllInquiries() {
        inquiriesMessage.textContent = 'Loading customer inquiries...';
        inquiriesMessage.classList.remove('hidden', 'text-red-600');
        inquiriesContainer.innerHTML = '';
        currentInquiries = [];

        try {
            const inquiriesRef = collection(db, 'inquiries');
            const q = query(inquiriesRef);
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                inquiriesMessage.textContent = 'No customer inquiries found.';
                updateDashboardSummary();
                return;
            }

            querySnapshot.forEach(doc => {
                const inquiry = doc.data();
                inquiry.id = doc.id;
                currentInquiries.push(inquiry);
            });

            currentInquiries.sort((a, b) => getTimeInMs(b.createdAt) - getTimeInMs(a.createdAt));

            renderInquiriesList();
            inquiriesMessage.classList.add('hidden');

        } catch (error) {
            console.error("Error fetching all inquiries:", error);
            inquiriesMessage.textContent = 'Error fetching inquiries. Check console for details.';
            inquiriesMessage.classList.remove('hidden');
        }
        updateDashboardSummary();
    }

    function renderInquiriesList() {
        inquiriesContainer.innerHTML = '';
        
        currentInquiries.forEach(inquiry => {
            const formattedDate = inquiry.createdAt ? formatDate(inquiry.createdAt) : 'N/A';

            const inquiryHtml = `
                <div class="p-4 rounded-lg shadow-md border-l-4 border-burnt-orange bg-parchment/70 mb-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-lg font-playfair text-charcoal font-semibold">${inquiry.subject || 'No Subject Provided'}</p>
                            <p class="text-sm text-stone">From: ${inquiry.name || 'Unknown'} | ${inquiry.email}</p>
                        </div>
                        <a href="mailto:${inquiry.email}?subject=RE: ${inquiry.subject || 'Inquiry'}" class="px-3 py-1 bg-stone text-parchment rounded-full text-sm font-semibold hover:bg-stone/80 transition">
                            Reply to Email
                        </a>
                    </div>
                    
                    <p class="text-sm text-charcoal mt-2 p-2 bg-white rounded-md border border-stone/10">
                        **Message:** ${inquiry.message}
                    </p>
                    
                    <div class="mt-4 pt-3 border-t">
                        <button data-id="${inquiry.id}" class="resolve-inquiry px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-semibold hover:bg-green-700 transition">
                            Mark as Resolved (Delete)
                        </button>
                    </div>
                </div>
            `;
            inquiriesContainer.innerHTML += inquiryHtml;
        });
        
        document.querySelectorAll('.resolve-inquiry').forEach(button => {
            button.addEventListener('click', (e) => resolveInquiry(e.target.dataset.id));
        });
    }
    
    async function resolveInquiry(inquiryId) {
        if (!confirm("Are you sure you want to mark this inquiry as RESOLVED and delete it?")) {
            return;
        }
        
        const inquiryRef = doc(db, 'inquiries', inquiryId);
        
        try {
            await deleteDoc(inquiryRef); 
            alert(`Inquiry ${inquiryId.slice(-6)} resolved and removed.`);
            await fetchAllInquiries(); 

        } catch (error) {
            console.error("Error resolving inquiry:", error);
            alert("Failed to resolve inquiry. Check console.");
        }
    }


    // --- Core Admin Logic: Site Content Tab (CMS) ---
    
    // CRITICAL CMS MAPPING: Enhanced with 'contact' for Formspree link management.
    const SITE_CONTENT_DOCS = [
        { id: 'homepage', name: 'Homepage Content' },
        { id: 'about', name: 'About Us Page' },
        { id: 'candleCare', name: 'Candle Care Page' }, 
        { id: 'refillProgram', name: 'Refill Program Page' }, 
        { id: 'gifting', name: 'Gifting Page' }, 
        { id: 'subscriptions', name: 'Subscriptions Page' }, 
        { id: 'scent-guide', name: 'Scent Guide Page' }, 
        { id: 'scent-glossary', name: 'Scent Glossary Page' }, 
        { id: 'contact', name: 'Contact Page Settings' } // NEW: For Formspree Link
    ];
    
    function fetchSiteContent() {
        siteContent = {};
        try {
            const contentRef = collection(db, 'siteContent');
            const q = query(contentRef);
            const querySnapshot = await getDocs(q);
            
            querySnapshot.forEach(doc => {
                siteContent[doc.id] = doc.data();
            });
            
            SITE_CONTENT_DOCS.forEach(docInfo => {
                if (!siteContent.hasOwnProperty(docInfo.id)) {
                    // Initialize placeholder data for missing documents
                    if (docInfo.id === 'contact') {
                         siteContent[docInfo.id] = { formspreeId: 'https://formspree.io/f/mqayygzv', contactEmail: 'support@southernsense.org' };
                    } else if (docInfo.id === 'scent-glossary') {
                        siteContent[docInfo.id] = { glossaryContent: "Example: The word is 'Amber' and it is a warm, musky base note." };
                    } else if (docInfo.id === 'scent-guide') {
                        // CRITICAL FIX: Ensure all expected fields for src/scent-guide.html exist in the CMS fallback
                         siteContent[docInfo.id] = { 
                            guideOverviewContent: "<p>Define your three main scent families here.</p>", 
                            family1Title: "Woodsy/Earthy", 
                            family1Desc: "Details about woody scents...", // ADDED
                            family2Title: "Floral/Fresh", 
                            family2Desc: "Details about fresh scents...", // ADDED
                            family3Title: "Gourmand/Spicy",
                            family3Desc: "Details about gourmand scents..." // ADDED
                        };
                    } else {
                        siteContent[docInfo.id] = { [`${docInfo.name.replace(/[^A-Z0-9]/ig, '')}InitialContent`]: "This document was missing. Please fill and save to create it." };
                    }
                }
            });

            renderContentTabs();
            // Automatically switch to the first content document on load
            if (SITE_CONTENT_DOCS.length > 0) {
                const firstExistingId = SITE_CONTENT_DOCS[0].id;
                switchContentDocument(firstExistingId);
            }
            
        } catch (error) {
            console.error("Error fetching site content:", error);
            alert("Failed to load site content.");
        }
    }
    
    function renderContentTabs() {
        contentTabsContainer.innerHTML = '';
        SITE_CONTENT_DOCS.forEach(docInfo => {
            const button = document.createElement('button');
            button.className = 'content-tab-button px-4 py-2 mr-2 mb-2 rounded-lg font-medium transition duration-150 ease-in-out bg-stone/20 hover:bg-burnt-orange/30 text-charcoal';
            
            button.textContent = docInfo.name;
            button.setAttribute('data-content-id', docInfo.id);
            button.addEventListener('click', () => switchContentDocument(docInfo.id));
            contentTabsContainer.appendChild(button);
        });
    }
    
    function switchContentDocument(docId) {
        const contentData = siteContent[docId];
        
        if (!contentData) {
             siteContentForm.innerHTML = `<p class="text-red-600">Fatal Error: Content key lost. Reloading CMS data is recommended.</p>`;
             return;
        }
        
        // Update button styles
        document.querySelectorAll('.content-tab-button').forEach(button => {
            if (button.getAttribute('data-content-id') === docId) {
                button.classList.add('bg-stone', 'text-parchment');
                button.classList.remove('bg-stone/20', 'hover:bg-burnt-orange/30', 'text-charcoal');
            } else {
                button.classList.remove('bg-stone', 'text-parchment');
                button.classList.add('bg-stone/20', 'hover:bg-burnt-orange/30', 'text-charcoal');
            }
        });

        // 1. Clear and setup form fields
        siteContentForm.innerHTML = '';
        siteContentForm.setAttribute('data-content-id', docId);

        // 2. Iterate through contentData keys to build dynamic fields
        // CRITICAL FIX: Hoist declarations outside the loop and use 'var' to prevent the SyntaxError
        var key, content, labelText, fieldGroup, label, inputElement;
        
        for (key in contentData) {
            content = contentData[key];
            if (typeof content !== 'string' && typeof content !== 'number' && typeof content !== 'boolean') continue;
            
            // UX FIX: Skip rendering the redundant featuredProductId field.
            if (docId === 'homepage' && key === 'featuredProductId') {
                 // Skip this field entirely as it's now controlled by the Products tab button.
                continue; 
            }
            
            labelText = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase()); 

            fieldGroup = document.createElement('div');
            fieldGroup.className = 'mb-4';
            
            label = document.createElement('label');
            label.className = 'block text-sm font-medium text-charcoal mb-1';
            label.textContent = labelText;
            label.setAttribute('for', `content-field-${key}`);
            
            
            if (key.includes('Content') || key.includes('Intro') || key.includes('Text') || (typeof content === 'string' && content.length > 50) || key.includes('html')) {
                inputElement = document.createElement('textarea');
                inputElement.rows = 5;
                inputElement.placeholder = 'Supports basic HTML tags (p, ul, li, strong, em)';
                inputElement.value = content;
            } else if (typeof content === 'number') {
                inputElement = document.createElement('input');
                inputElement.type = 'number';
                inputElement.value = content;
            } else if (typeof content === 'boolean') {
                inputElement = document.createElement('input');
                inputElement.type = 'checkbox';
                inputElement.checked = content;
                inputElement.name = key;
                inputElement.id = `content-field-${key}`;
                
                fieldGroup.classList.add('flex', 'items-center');
                label.classList.remove('block');
                label.classList.add('ml-2');
                fieldGroup.appendChild(inputElement);
                fieldGroup.appendChild(label);
                
                siteContentForm.appendChild(fieldGroup);
                continue; 
            } else {
                inputElement = document.createElement('input');
                inputElement.type = 'text';
                inputElement.value = content;
            }
            
            inputElement.className = 'w-full p-3 border border-stone/30 rounded-lg text-charcoal bg-white';
            inputElement.id = `content-field-${key}`;
            inputElement.name = key;

            fieldGroup.appendChild(label);
            fieldGroup.appendChild(inputElement);
            siteContentForm.appendChild(fieldGroup);
        }
        
        // 3. Add Save Button
        siteContentForm.innerHTML += `
            <div class="pt-4 border-t mt-6">
                <button type="submit" id="save-content-button" class="w-full px-4 py-3 bg-burnt-orange text-parchment font-bold rounded-lg hover:bg-burnt-orange/80 transition duration-300">
                    Save Page Content
                </button>
            </div>
        `;
    }

    async function handleSiteContentUpdate(e) {
        e.preventDefault();
        
        const docId = siteContentForm.getAttribute('data-content-id');
        const saveButton = document.getElementById('save-content-button');
        saveButton.disabled = true;
        saveButton.textContent = 'Saving...';
        contentSaveMessage.classList.add('hidden');

        try {
            const formData = new FormData(siteContentForm);
            const updateData = {};
            
            for (const [key, value] of formData.entries()) {
                const originalValue = siteContent[docId].hasOwnProperty(key) ? siteContent[docId][key] : null;

                if (typeof originalValue === 'number' && !isNaN(parseFloat(value))) {
                     updateData[key] = parseFloat(value);
                } else if (typeof originalValue === 'boolean') {
                    updateData[key] = value === 'on'; 
                } else {
                    updateData[key] = value;
                }
            }
            
            for (const key in siteContent[docId]) {
                 if (typeof siteContent[docId][key] === 'boolean' && !updateData.hasOwnProperty(key)) {
                    updateData[key] = false;
                 }
            }
            
            // Re-fetch the current document state to preserve unsubmitted fields (like featuredProductId)
            const currentDocSnap = await getDoc(doc(db, 'siteContent', docId));
            if (currentDocSnap.exists()) {
                const currentData = currentDocSnap.data();
                // Preserve keys that were not part of the form (i.e., featuredProductId)
                Object.keys(currentData).forEach(key => {
                    if (!updateData.hasOwnProperty(key)) {
                        updateData[key] = currentData[key];
                    }
                });
            }

            const contentRef = doc(db, 'siteContent', docId);
            await setDoc(contentRef, updateData, { merge: true });

            const updatedSnap = await getDoc(contentRef);
            if (updatedSnap.exists()) {
                siteContent[docId] = updatedSnap.data();
            }

            contentSaveMessage.textContent = `${docId.replace(/([A-Z])/g, ' $1').toUpperCase()} content updated successfully!`;
            contentSaveMessage.classList.remove('hidden');
            
        } catch (error) {
            console.error("Error updating site content:", error);
            contentSaveMessage.textContent = "Error saving content. Check console for details.";
            contentSaveMessage.classList.remove('hidden');
            contentSaveMessage.classList.add('text-red-600');
        } finally {
            saveButton.disabled = false;
            saveButton.textContent = 'Save Page Content';
            setTimeout(() => contentSaveMessage.classList.add('hidden'), 5000);
        }
    }


    // --- Core Initialization ---

    /**
     * Handles tab switching logic.
     */
    function switchTab(targetId) {
        tabContents.forEach(content => content.classList.add('hidden'));
        tabButtons.forEach(button => {
            button.classList.remove('bg-stone', 'text-parchment');
            button.classList.add('text-charcoal', 'hover:bg-parchment/70');
        });

        document.getElementById(targetId).classList.remove('hidden');
        document.querySelector(`.tab-button[data-tab="${targetId}"]`).classList.add('bg-stone', 'text-parchment');
        document.querySelector(`.tab-button[data-tab="${targetId}"]`).classList.remove('text-charcoal', 'hover:bg-parchment/70');

        // Execute function on tab switch
        if (targetId === 'tab-orders') {
            fetchAllOrders();
        } else if (targetId === 'tab-products') {
            fetchAllProducts();
        } else if (targetId === 'tab-reviews') {
            fetchAllReviews();
        } else if (targetId === 'tab-stock-alerts') {
            fetchStockAlerts();
        } else if (targetId === 'tab-inquiries') { // NEW
            fetchAllInquiries();
        } else if (targetId === 'tab-content') {
            fetchSiteContent();
        } else if (targetId === 'tab-tools') { 
            console.log("Tools tab opened. Utility scripts are import-firestore.mjs and export-firestore.mjs.");
        }
    }

    /**
     * Initializes the admin page after authentication and admin check.
     */
    async function initializeAdmin(user) {
        currentUser = user;
        
        try {
            const adminDocRef = doc(db, 'admins', user.uid);
            const adminDocSnap = await getDoc(adminDocRef);
            isAdmin = adminDocSnap.exists();
        } catch (error) {
            console.error("Error checking admin status:", error);
            isAdmin = false;
        }

        if (!isAdmin) {
            alert("Access Denied: You must be an administrator to view this page.");
            window.location.href = '/account/'; 
            return;
        }
        
        await Promise.all([
            fetchAllOrders(),
            fetchAllProducts(),
            fetchAllReviews(),
            fetchStockAlerts(),
            fetchAllInquiries()
        ]);

        adminLoader.classList.add('hidden');
        adminContent.classList.remove('hidden');

        switchTab('tab-dashboard');
    }

    // --- Event Listeners and Initializers ---

    document.addEventListener('DOMContentLoaded', () => {
        tabButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                const targetId = e.target.getAttribute('data-tab');
                switchTab(targetId);
            });
        });
        
        const logoutButton = document.getElementById('logout-button');
        if (logoutButton) {
            logoutButton.addEventListener('click', (e) => {
                e.preventDefault();
                signOut(auth).then(() => {
                    window.location.href = '/admin-login/';
                }).catch(error => {
                    console.error("Logout failed:", error);
                    alert("Logout failed. Please try again.");
                });
            });
        }
        
        if(closeModalButton) {
            closeModalButton.addEventListener('click', () => {
                productEditModal.classList.add('hidden');
            });
        }
        
        if(productEditForm) {
            productEditForm.addEventListener('submit', handleProductUpdate);
        }
        
        if(siteContentForm) {
            siteContentForm.addEventListener('submit', handleSiteContentUpdate);
        }
        
        if(addNewProductButton) { // New listener for the Add Product button
            addNewProductButton.addEventListener('click', openNewProductModal);
        }

        // Authentication State Listener (Security Guard)
        onAuthStateChanged(auth, (user) => {
            if (user) {
                initializeAdmin(user);
            } else {
                window.location.href = '/admin-login/';
            }
        });
    });

; // DEFENSIVE SEMICOLON: Added to absorb potential file truncation errors.
</script>

<main class="container mx-auto px-4 py-12 min-h-screen">
    
    <div id="admin-loader" class="flex justify-center items-center h-64">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-stone"></div>
    </div>
    
    <div class="max-w-6xl mx-auto bg-white p-8 lg:p-12 rounded-xl shadow-2xl border border-stone/10">

        <div id="admin-content" class="hidden">
            <h1 class="text-4xl font-playfair text-charcoal mb-8 border-b pb-4">Southern Sense Admin Panel</h1>

            <div class="flex flex-col lg:flex-row gap-8">
                <div class="lg:w-1/4">
                    <nav class="bg-parchment p-4 rounded-lg shadow-md sticky top-6">
                        <p class="text-sm font-bold text-stone uppercase tracking-wider mb-2">Operations</p>
                        <button data-tab="tab-dashboard" class="tab-button w-full text-left p-3 rounded-lg font-medium transition duration-150 ease-in-out bg-stone text-parchment">
                            Dashboard
                        </button>
                        <button data-tab="tab-orders" class="tab-button w-full text-left p-3 mt-2 rounded-lg font-medium transition duration-150 ease-in-out text-charcoal hover:bg-parchment/70">
                            Orders
                        </button>
                        <button data-tab="tab-products" class="tab-button w-full text-left p-3 mt-2 rounded-lg font-medium transition duration-150 ease-in-out text-charcoal hover:bg-parchment/70">
                            Products
                        </button>
                        <button data-tab="tab-reviews" class="tab-button w-full text-left p-3 mt-2 rounded-lg font-medium transition duration-150 ease-in-out text-charcoal hover:bg-parchment/70">
                            Reviews
                        </button>
                        <button data-tab="tab-stock-alerts" class="tab-button w-full text-left p-3 mt-2 rounded-lg font-medium transition duration-150 ease-in-out text-charcoal hover:bg-parchment/70">
                            Stock Alerts
                        </button>
                        <button data-tab="tab-inquiries" class="tab-button w-full text-left p-3 mt-2 rounded-lg font-medium transition duration-150 ease-in-out text-charcoal hover:bg-parchment/70">
                            Customer Inquiries
                        </button>
                        
                        <p class="text-sm font-bold text-stone uppercase tracking-wider mt-6 mb-2 border-t pt-4">Configuration</p>
                        <button data-tab="tab-content" class="tab-button w-full text-left p-3 rounded-lg font-medium transition duration-150 ease-in-out text-charcoal hover:bg-parchment/70">
                            Site Content / CMS
                        </button>
                        <button data-tab="tab-tools" class="tab-button w-full text-left p-3 mt-2 rounded-lg font-medium transition duration-150 ease-in-out text-charcoal hover:bg-parchment/70">
                            Tools / Utility
                        </button>
                        
                        <p class="text-sm font-bold text-stone uppercase tracking-wider mt-6 mb-2 border-t pt-4">Help & Documentation</p>
                        <a href="/admin-guide/" target="_blank" class="w-full block text-left p-3 rounded-lg font-medium transition duration-150 ease-in-out text-charcoal hover:bg-parchment/70">
                            User Guide
                        </a>
                        <button id="logout-button" class="w-full text-left p-3 mt-6 rounded-lg font-medium text-red-600 hover:bg-red-50/50 transition duration-150 ease-in-out">
                            Log Out
                        </button>
                    </nav>
                </div>

                <div class="lg:w-3/4">
                    
                    <div id="tab-dashboard" class="tab-content bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-3xl font-playfair text-charcoal mb-4 border-b pb-2">Admin Dashboard</h2>
                        <p class="text-stone mb-6">Welcome to the control center. Use the sidebar to navigate management tasks.</p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                            
                            <div class="p-4 bg-parchment/50 rounded-lg shadow-inner">
                                <h3 class="text-xl font-medium text-charcoal">Total Orders</h3>
                                <p id="total-orders-count" class="text-4xl font-bold text-burnt-orange mt-2">--</p>
                                <p class="text-sm text-stone mt-1">Orders recorded to date.</p>
                            </div>
                            
                            <div class="p-4 bg-parchment/50 rounded-lg shadow-inner">
                                <h3 class="text-xl font-medium text-charcoal">Total Revenue</h3>
                                <p id="total-revenue-summary" class="text-4xl font-bold text-green-600 mt-2">--</p>
                                <p class="text-sm text-stone mt-1">Total lifetime sales.</p>
                            </div>
                            
                            <div class="p-4 bg-parchment/50 rounded-lg shadow-inner">
                                <h3 class="text-xl font-medium text-charcoal">Avg. Order Value</h3>
                                <p id="aov-summary" class="text-4xl font-bold text-burnt-orange mt-2">--</p>
                                <p class="text-sm text-stone mt-1">Sales average per transaction.</p>
                            </div>
                            
                            <div class="p-4 bg-parchment/50 rounded-lg shadow-inner">
                                <h3 class="text-xl font-medium text-charcoal">MTD Revenue (30 Days)</h3>
                                <p id="mtd-revenue-summary" class="text-4xl font-bold text-green-600 mt-2">--</p>
                                <p class="text-sm text-stone mt-1">Revenue from the last 30 days.</p>
                            </div>
                            
                            <div class="p-4 bg-parchment/50 rounded-lg shadow-inner">
                                <h3 class="text-xl font-medium text-charcoal">Active Users (30 Days)</h3>
                                <p id="active-users-summary" class="text-4xl font-bold text-charcoal mt-2">--</p>
                                <p class="text-sm text-stone mt-1">Conceptual KPI: Recent Engaged Users.</p>
                            </div>
                            
                            <div class="p-4 bg-parchment/50 rounded-lg shadow-inner">
                                <h3 class="text-xl font-medium text-charcoal">Pending Reviews</h3>
                                <p id="pending-reviews-count" class="text-4xl font-bold text-stone mt-2">--</p>
                                <a data-tab="tab-reviews" class="tab-button text-sm text-burnt-orange hover:underline mt-1 block cursor-pointer">Approve Reviews &rarr;</a>
                            </div>
                            
                            <div class="p-4 bg-parchment/50 rounded-lg shadow-inner">
                                <h3 class="text-xl font-medium text-charcoal">Low Stock Items (&le; 10)</h3>
                                <p id="low-stock-count-summary" class="text-4xl font-bold text-stone mt-2">--</p>
                                <a data-tab="tab-products" class="tab-button text-sm text-burnt-orange hover:underline mt-1 block cursor-pointer">Manage Inventory &rarr;</a>
                            </div>
                            
                            <div class="p-4 bg-parchment/50 rounded-lg shadow-inner">
                                <h3 class="text-xl font-medium text-charcoal">Out of Stock Items</h3>
                                <p id="out-of-stock-count-summary" class="text-4xl font-bold text-stone mt-2">--</p>
                                <a data-tab="tab-products" class="tab-button text-sm text-burnt-orange hover:underline mt-1 block cursor-pointer">Restock Now &rarr;</a>
                            </div>
                            
                            <div class="p-4 bg-parchment/50 rounded-lg shadow-inner">
                                <h3 class="text-xl font-medium text-charcoal">Active Stock Alerts</h3>
                                <p id="total-stock-alerts-count" class="text-4xl font-bold text-stone mt-2">--</p>
                                <a data-tab="tab-stock-alerts" class="tab-button text-sm text-burnt-orange hover:underline mt-1 block cursor-pointer">View Alerts &rarr;</a>
                            </div>

                            <div class="p-4 bg-parchment/50 rounded-lg shadow-inner">
                                <h3 class="text-xl font-medium text-charcoal">New Inquiries</h3>
                                <p id="pending-inquiries-summary" class="text-4xl font-bold text-stone mt-2">--</p>
                                <a data-tab="tab-inquiries" class="tab-button text-sm text-burnt-orange hover:underline mt-1 block cursor-pointer">Review Messages &rarr;</a>
                            </div>

                        </div>

                        <div class="mt-8 p-6 bg-parchment rounded-lg border-l-4 border-burnt-orange">
                            <h3 class="text-xl font-playfair text-charcoal mb-3">System Health Summary:</h3>
                            <p class="text-stone">E-commerce flow **STABLE** (Authenticated checkout fixed). All Admin operational tabs are **ACTIVE**.</p>
                            <p class="text-sm text-stone mt-2 font-semibold">Admin Panel features are **COMPLETE**.</p>
                        </div>
                    </div>

                    <div id="tab-orders" class="tab-content hidden bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-3xl font-playfair text-charcoal mb-6 border-b pb-2">Order Management</h2>
                        
                        <p id="orders-message" class="text-stone mb-4"></p>
                        
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-stone/30">
                                <thead>
                                    <tr class="text-left text-sm font-medium text-charcoal uppercase tracking-wider bg-parchment">
                                        <th class="px-6 py-3">Order #</th>
                                        <th class="px-6 py-3">Date</th>
                                        <th class="px-6 py-3">Total</th>
                                        <th class="px-6 py-3">Status</th>
                                        <th class="px-6 py-3">Customer</th>
                                        <th class="px-6 py-3 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="orders-table-body" class="bg-white divide-y divide-stone/20">
                                    </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="tab-products" class="tab-content hidden bg-white p-6 rounded-lg shadow-md">
                        <div class="flex justify-between items-center mb-6 border-b pb-2">
                            <h2 class="text-3xl font-playfair text-charcoal">Product Catalog Management</h2>
                            <button id="add-new-product-button" class="px-4 py-2 bg-burnt-orange text-parchment font-semibold rounded-lg hover:bg-burnt-orange/80 transition duration-300">
                                + Add New Product
                            </button>
                        </div>
                        
                        <p id="products-message" class="text-stone mb-4"></p>
                        
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-stone/30">
                                <thead>
                                    <tr class="text-left text-sm font-medium text-charcoal uppercase tracking-wider bg-parchment">
                                        <th class="px-6 py-3">Product Name</th>
                                        <th class="px-6 py-3">Category</th>
                                        <th class="px-6 py-3">Scent Family</th>
                                        <th class="px-6 py-3">Price</th>
                                        <th class="px-6 py-3">Stock</th>
                                        <th class="px-6 py-3">Carousel Inclusion</th>
                                        <th class="px-6 py-3">Primary Feature</th>
                                        <th class="px-6 py-3 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="products-table-body" class="bg-white divide-y divide-stone/20">
                                    </tbody>
                            </table>
                        </div>
                    </div>

                    <div id="tab-reviews" class="tab-content hidden bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-3xl font-playfair text-charcoal mb-6 border-b pb-2">Review Moderation</h2>
                        <p id="reviews-message" class="text-stone mb-4"></p>
                        <div id="reviews-container">
                            </div>
                    </div>
                    
                    <div id="tab-stock-alerts" class="tab-content hidden bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-3xl font-playfair text-charcoal mb-6 border-b pb-2">Back-in-Stock Requests</h2>
                        <p id="stock-alerts-message" class="text-stone mb-4">Fetching current back-in-stock requests.</p>

                        <div class="mt-4 p-4 bg-gray-50 border rounded-lg border-burnt-orange/50">
                            <h3 class="font-semibold text-charcoal">Action Guide:</h3>
                            <p class="text-sm text-stone">1. Replenish stock for the item listed below in the **Products** tab.</p>
                            <p class="text-sm text-stone">2. Click **Email Customer** to notify them.</p>
                            <p class="text-sm text-stone">3. Click **Mark as Resolved** to clear the alert.</p>
                        </div>

                        <div id="stock-alerts-container" class="mt-6">
                            </div>
                    </div>
                    
                    <div id="tab-inquiries" class="tab-content hidden bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-3xl font-playfair text-charcoal mb-6 border-b pb-2">Customer Inquiries (Contact Form)</h2>
                        <p id="inquiries-message" class="text-stone mb-4">Fetching customer messages...</p>

                        <div class="mt-4 p-4 bg-gray-50 border rounded-lg border-burnt-orange/50">
                            <h3 class="font-semibold text-charcoal">Note:</h3>
                            <p class="text-sm text-stone">These inquiries are submitted from your public contact form and stored in the **inquiries** Firestore collection for management. Resolving an inquiry will delete it from the database.</p>
                        </div>

                        <div id="inquiries-container" class="mt-6">
                            </div>
                    </div>

                    <div id="tab-content" class="tab-content hidden bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-3xl font-playfair text-charcoal mb-6 border-b pb-2">Site Content Management (CMS)</h2>
                        
                        <div id="content-tabs-container" class="mb-4 border-b pb-2">
                            </div>
                        
                        <p id="content-save-message" class="hidden px-4 py-2 bg-green-100 text-green-700 rounded-lg mb-4 text-sm">Content saved successfully!</p>

                        <form id="site-content-form" data-content-id="about" class="space-y-4">
                            <p class="text-stone">Loading editable fields...</p>
                            </form>
                    </div>

                    <div id="tab-tools" class="tab-content hidden bg-white p-6 rounded-lg shadow-md">
                        <h2 class="text-3xl font-playfair text-charcoal mb-6 border-b pb-2">Utility & Developer Tools</h2>
                        
                        <div class="mt-4 p-4 bg-gray-50 border rounded-lg border-stone/50">
                            <h3 class="font-semibold text-charcoal text-xl mb-2">Deployment & Cache Management</h3>
                            <p class="text-stone mb-3">Ensure your customers see the latest changes by clearing the server-side cache after content updates or major deployments.</p>
                            <div class="space-y-3">
                                <p class="text-sm text-charcoal font-medium">1. **Clear Cloudflare Cache (Hard Refresh)**</p>
                                <div class="flex justify-between items-center bg-white p-3 border rounded">
                                    <p class="text-sm">Forces all users to download the latest files.</p>
                                    <button data-action="purge-all" onclick="triggerWebhook(CACHE_PURGE_WEBHOOK, 'PURGE ALL')" class="px-3 py-1 bg-red-600 text-parchment rounded text-sm hover:bg-red-700 transition">
                                        PURGE ALL
                                    </button>
                                </div>
                                
                                <p class="text-sm text-charcoal font-medium pt-2">2. **Trigger New Build Deployment**</p>
                                <div class="flex justify-between items-center bg-white p-3 border rounded">
                                    <p class="text-sm">Initiates a fresh build process (e.g., from a GitHub webhook).</p>
                                    <button data-action="build-now" onclick="triggerWebhook(BUILD_TRIGGER_WEBHOOK, 'BUILD NOW')" class="px-3 py-1 bg-burnt-orange text-parchment rounded text-sm hover:bg-burnt-orange/80 transition">
                                        BUILD NOW
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="mt-8 p-4 bg-gray-50 border rounded-lg border-stone/50">
                            <h3 class="font-semibold text-charcoal text-xl mb-2">Database Backup & Restore</h3>
                            <p class="text-stone mb-3">These tools are for maintaining the Firestore database, typically used by developers or for initial setup.</p>
                            <p class="text-sm text-red-600 font-semibold mb-4">WARNING: Only run these scripts from a secure local environment. They overwrite data.</p>
                            
                            <div class="space-y-3">
                                <p class="text-sm text-charcoal font-medium">1. **Export Database (Backup)**</p>
                                <div class="flex justify-between items-center bg-white p-3 border rounded">
                                    <code class="text-sm bg-gray-100 p-1 rounded">node export-firestore.mjs</code>
                                    <a href="/admin-guide/" class="px-3 py-1 bg-stone text-parchment rounded text-sm hover:bg-stone/80 transition">
                                        Instructions
                                    </a>
                                </div>
                                
                                <p class="text-sm text-charcoal font-medium pt-2">2. **Import Database (Restore/Bootstrap)**</p>
                                <div class="flex justify-between items-center bg-white p-3 border rounded">
                                    <code class="text-sm bg-gray-100 p-1 rounded">node import-firestore.mjs</code>
                                    <a href="/admin-guide/" class="px-3 py-1 bg-burnt-orange text-parchment rounded text-sm hover:bg-burnt-orange/80 transition">
                                        Instructions
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
    </div> 
    
    <div id="product-edit-modal" class="fixed inset-0 z-50 hidden overflow-y-auto bg-charcoal bg-opacity-75 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg mx-4 p-6 relative">
            
            <div class="flex justify-between items-start border-b pb-3 mb-4">
                <h3 class="text-2xl font-playfair text-charcoal">Edit Product Details</h3>
                <button id="close-modal-button" class="text-stone hover:text-charcoal transition text-3xl leading-none">&times;</button>
            </div>

            <form id="product-edit-form" class="space-y-4">
                <input type="hidden" id="edit-product-id" name="id">

                <div>
                    <label for="edit-product-name" class="block text-sm font-medium text-stone mb-1">Product Name</label>
                    <input type="text" id="edit-product-name" name="name" required class="w-full p-2 border border-stone/30 rounded-lg text-charcoal">
                </div>
                
                <div>
                    <label for="edit-image-url" class="block text-sm font-medium text-stone mb-1">Image URL (e.g., strawberry-rose-candle.webp)</label>
                    <input type="text" id="edit-image-url" name="imageUrl" required class="w-full p-2 border border-stone/30 rounded-lg text-charcoal">
                </div>

                <div>
                    <label for="edit-short-description" class="block text-sm font-medium text-stone mb-1">Short Description (Shop Page)</label>
                    <textarea id="edit-short-description" name="shortDescription" rows="2" required class="w-full p-2 border border-stone/30 rounded-lg text-charcoal"></textarea>
                </div>
                
                <div>
                    <label for="edit-long-description" class="block text-sm font-medium text-stone mb-1">Long Description (HTML Allowed)</label>
                    <textarea id="edit-long-description" name="longDescription" rows="5" required class="w-full p-2 border border-stone/30 rounded-lg text-charcoal"></textarea>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="edit-price" class="block text-sm font-medium text-stone mb-1">Price ($)</label>
                        <input type="number" step="0.01" id="edit-price" name="price" required class="w-full p-2 border border-stone/30 rounded-lg text-charcoal">
                    </div>
                    <div>
                        <label for="edit-stock" class="block text-sm font-medium text-stone mb-1">Stock Level</label>
                        <input type="number" id="edit-stock" name="stock" required class="w-full p-2 border border-stone/30 rounded-lg text-charcoal">
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="edit-scent-family" class="block text-sm font-medium text-stone mb-1">Scent Family (e.g., fruity-sweet)</label>
                        <input type="text" id="edit-scent-family" name="scentFamily" required class="w-full p-2 border border-stone/30 rounded-lg text-charcoal">
                    </div>
                    <div>
                        <label for="edit-category" class="block text-sm font-medium text-stone mb-1">Category</label>
                        <select id="edit-category" name="category" required class="w-full p-2 border border-stone/30 rounded-lg text-charcoal">
                            <option value="candle">Candle</option>
                            <option value="wax-melt">Wax Melt</option>
                            <option value="diffuser">Diffuser</option>
                            <option value="gift-set">Gift Set</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label for="edit-scent-notes" class="block text-sm font-medium text-stone mb-1">Scent Notes (Comma Separated)</label>
                    <input type="text" id="edit-scent-notes" name="scentNotes" required class="w-full p-2 border border-stone/30 rounded-lg text-charcoal">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="edit-strength" class="block text-sm font-medium text-stone mb-1">Scent Strength (1=Subtle, 5=Strong)</label>
                        <select id="edit-strength" name="strength" required class="w-full p-2 border border-stone/30 rounded-lg text-charcoal">
                            <option value="1">1 - Subtle</option>
                            <option value="2">2 - Light</option>
                            <option value="3">3 - Moderate</option>
                            <option value="4">4 - Strong</option>
                            <option value="5">5 - Maximum Throw</option>
                        </select>
                    </div>
                    <div>
                        <label for="edit-pairing" class="block text-sm font-medium text-stone mb-1">Perfect Pairing</label>
                        <input type="text" id="edit-pairing" name="pairing" required class="w-full p-2 border border-stone/30 rounded-lg text-charcoal">
                    </div>
                </div>

                <div class="flex items-center pt-2">
                    <input type="checkbox" id="edit-featured" name="featured" class="h-4 w-4 text-burnt-orange border-stone/30 rounded focus:ring-burnt-orange">
                    <label for="edit-featured" class="ml-2 block text-sm font-medium text-charcoal">Include in Secondary Featured Carousel</label>
                </div>

                <div class="pt-4 border-t mt-4 space-y-3">
                    <button type="submit" id="product-save-button" class="w-full px-4 py-3 bg-burnt-orange text-parchment font-bold rounded-lg hover:bg-burnt-orange/80 transition duration-300">
                        Save Changes
                    </button>
                    <button type="button" id="product-delete-btn-modal" onclick="deleteProduct(document.getElementById('edit-product-id').value); productEditModal.classList.add('hidden');" class="hidden w-full px-4 py-2 border border-red-300 text-red-600 font-medium rounded-lg hover:bg-red-50/50 transition duration-300">
                        Delete Product
                    </button>
                </div>
            </form>
        </div>
    </div>
</main>