---
layout: layout.html
title: My Account
---

<div class="container mx-auto p-4 lg:p-8 py-16">
    <div class="max-w-4xl mx-auto">

        <div id="loading-spinner" class="text-center py-20">
            <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-burnt-orange mx-auto"></div>
            <p class="mt-4 text-lg font-roboto text-stone">Loading Account Data...</p>
        </div>

        <div id="not-logged-in" class="hidden text-center py-20 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative max-w-lg mx-auto" role="alert">
            <strong class="font-bold block">Access Denied</strong>
            <span class="block sm:inline">You must be logged in to view your account dashboard.</span>
            <div class="mt-4 flex justify-center space-x-4">
                <a href="/login/" class="text-sm underline text-red-700 hover:text-red-900 font-bold">Log In</a>
                <a href="/register/" class="text-sm underline text-red-700 hover:text-red-900">Register</a>
            </div>
        </div>
        
        <div id="account-dashboard" class="hidden">
            
            <h1 class="font-playfair text-4xl font-extrabold text-charcoal mb-2">Welcome, <span id="user-name-display"></span></h1>
            <p class="font-roboto text-lg text-stone mb-6" id="user-email-display"></p>
            
            <nav class="flex space-x-2 border-b border-stone/20 mb-8">
                <button class="tab-button py-2 px-4 font-roboto font-semibold text-charcoal border-b-2 border-transparent hover:border-burnt-orange transition-colors duration-150" 
                        data-target="profile-section" id="profile-tab">Profile</button>
                <button class="tab-button py-2 px-4 font-roboto font-semibold text-charcoal border-b-2 border-transparent hover:border-burnt-orange transition-colors duration-150" 
                        data-target="orders-section" id="orders-tab">Order History</button>
            </nav>

            <div id="tab-content">
                
                <div id="profile-section" class="tab-content-item space-y-8">
                    <h2 class="font-playfair text-3xl font-bold text-charcoal border-b pb-2">Your Details</h2>
                    
                    <div class="bg-parchment p-6 rounded-xl shadow-lg border border-stone/10 max-w-lg">
                        <div class="space-y-4">
                            <div>
                                <p class="font-roboto text-sm uppercase tracking-wider text-stone">Full Name</p>
                                <p class="font-playfair text-xl font-bold text-charcoal" id="profile-name"></p>
                            </div>
                            <div>
                                <p class="font-roboto text-sm uppercase tracking-wider text-stone">Email Address</p>
                                <p class="font-playfair text-xl font-bold text-charcoal" id="profile-email"></p>
                            </div>
                            <div>
                                <p class="font-roboto text-sm uppercase tracking-wider text-stone">Account Role</p>
                                <p class="font-playfair text-xl font-bold text-charcoal" id="profile-role">Customer</p>
                                <div id="admin-link-placeholder"></div>
                            </div>
                        </div>
                    </div>

                    <p class="font-roboto text-sm text-stone/80 italic">To update your name or password, please contact support.</p>
                    
                    <button id="logout-button" class="mt-8 py-2 px-6 border border-red-500 text-red-500 font-roboto rounded-lg hover:bg-red-500 hover:text-parchment transition duration-150">
                        Log Out
                    </button>
                </div>

                <div id="orders-section" class="tab-content-item hidden space-y-6">
                    <h2 class="font-playfair text-3xl font-bold text-charcoal border-b pb-2">Past Orders</h2>
                    <div id="orders-list" class="space-y-4">
                        <p id="no-orders-message" class="hidden font-roboto text-stone italic py-4">You have not placed any orders yet. Time to shop!</p>
                        <p id="orders-loading" class="font-roboto text-stone">Loading your order history...</p>
                    </div>
                </div>

            </div> </div> </div>
</div>

<script type="module">
    // --- Firebase Imports ---
    import { db, auth } from '/firebase-loader.js';
    import { 
        getAuth, 
        onAuthStateChanged 
    } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
    import { 
        doc, 
        getDoc, 
        collection, 
        query, 
        where, 
        getDocs, 
        orderBy 
    } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
    import { signOut } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
    
    // --- DOM Elements ---
    const loadingSpinner = document.getElementById('loading-spinner');
    const notLoggedIn = document.getElementById('not-logged-in');
    const dashboard = document.getElementById('account-dashboard');
    const ordersList = document.getElementById('orders-list');
    const profileTab = document.getElementById('profile-tab');
    
    let currentUserId = null;

    // --- Utility Functions ---

    /**
     * Helper to render the appropriate color badge for order status.
     * @param {string} status - The order status string.
     * @returns {string} HTML for a styled badge.
     */
    function renderStatusBadge(status) {
        let colorClass;
        let iconClass;
        switch (status) {
            case 'Paid':
                colorClass = 'bg-green-100 text-green-800';
                iconClass = 'fa-check-circle';
                break;
            case 'Shipped':
                colorClass = 'bg-blue-100 text-blue-800';
                iconClass = 'fa-shipping-fast';
                break;
            case 'Pending':
                colorClass = 'bg-yellow-100 text-yellow-800';
                iconClass = 'fa-clock';
                break;
            case 'Cancelled':
                colorClass = 'bg-red-100 text-red-800';
                iconClass = 'fa-times-circle';
                break;
            default:
                colorClass = 'bg-stone/10 text-stone';
                iconClass = 'fa-question-circle';
        }
        return `<span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium ${colorClass}"><i class="fas ${iconClass} mr-1"></i>${status}</span>`;
    }

    /**
     * Initializes the tabbed navigation functionality.
     */
    function initializeTabs() {
        const tabs = document.querySelectorAll('.tab-button');
        const contents = document.querySelectorAll('.tab-content-item');
        
        // Initial setup for the default active tab
        profileTab.classList.add('border-burnt-orange');
        profileTab.classList.remove('border-transparent');
        
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const targetId = tab.getAttribute('data-target');
                
                // Deactivate all tabs and hide all content
                tabs.forEach(t => {
                    t.classList.remove('border-burnt-orange');
                    t.classList.add('border-transparent');
                });
                contents.forEach(c => c.classList.add('hidden'));
                
                // Activate the clicked tab and show its content
                tab.classList.add('border-burnt-orange');
                tab.classList.remove('border-transparent');
                document.getElementById(targetId).classList.remove('hidden');

                // Special: If Order History tab is clicked, ensure data is loaded
                if (targetId === 'orders-section' && currentUserId) {
                    loadOrderHistory(currentUserId);
                }
            });
        });
        
        // Ensure profile section is visible by default
        document.getElementById('profile-section').classList.remove('hidden');
    }

    // --- Profile Logic (CRITICAL FIX: Ensure robust data fetching) ---
    
    /**
     * Loads user profile data (name, role) from the /users collection.
     * @param {Object} user - The Firebase Auth user object.
     */
    async function loadUserProfile(user) {
        const uid = user.uid;
        const defaultName = user.displayName || 'Customer';
        const defaultEmail = user.email || 'N/A';
        
        // Set defaults immediately
        document.getElementById('user-name-display').textContent = defaultName;
        document.getElementById('user-email-display').textContent = defaultEmail;
        document.getElementById('profile-name').textContent = defaultName;
        document.getElementById('profile-email').textContent = defaultEmail;
        document.getElementById('profile-role').textContent = 'Customer';
        document.getElementById('admin-link-placeholder').innerHTML = ''; // Clear previous admin link

        try {
            // 1. Check /users collection for custom profile data
            const userRef = doc(db, 'users', uid);
            const userSnap = await getDoc(userRef);

            if (userSnap.exists()) {
                const userData = userSnap.data();
                const firestoreName = userData.name || defaultName; 
                document.getElementById('user-name-display').textContent = firestoreName;
                document.getElementById('profile-name').textContent = firestoreName;

                // 2. Check /admins collection for role
                const adminRef = doc(db, 'admins', uid);
                const adminSnap = await getDoc(adminRef);

                if (adminSnap.exists()) {
                    document.getElementById('profile-role').textContent = 'Administrator';
                    document.getElementById('profile-role').classList.add('text-burnt-orange', 'font-extrabold');
                    document.getElementById('admin-link-placeholder').innerHTML = 
                        `<a href="/admin.html" class="block text-sm font-roboto underline text-burnt-orange hover:text-charcoal mt-1">Go to Admin Panel</a>`;
                }
            } else {
                 console.warn("User document not found in /users collection.");
            }
            
            // Show the dashboard once all data attempts are complete
            loadingSpinner.classList.add('hidden');
            dashboard.classList.remove('hidden');

        } catch (error) {
            console.error("Error loading user profile or admin status:", error);
            
            // CRITICAL: Handle the failure gracefully by showing defaults and hiding the spinner
            document.getElementById('profile-role').textContent = 'Customer (Data Error)';
            loadingSpinner.classList.add('hidden');
            dashboard.classList.remove('hidden');
        }
    }

    /**
     * Attaches the logout listener.
     */
    function initializeLogout() {
        document.getElementById('logout-button').addEventListener('click', async () => {
            try {
                await signOut(getAuth());
                // After sign out, the onAuthStateChanged observer will redirect to /login/
            } catch (error) {
                console.error("Logout error:", error);
            }
        });
    }

    // --- Order History Logic ---

    /**
     * Loads the authenticated user's order history from the /orders collection.
     */
    async function loadOrderHistory(userId) {
        document.getElementById('orders-loading').classList.remove('hidden');
        ordersList.innerHTML = '';
        document.getElementById('no-orders-message').classList.add('hidden');

        try {
            const ordersRef = collection(db, 'orders');
            const q = query(
                ordersRef,
                where('userId', '==', userId),
                orderBy('date', 'desc')
            );
            
            const querySnapshot = await getDocs(q);
            const orders = [];
            
            querySnapshot.forEach((doc) => {
                const orderData = doc.data();
                orderData.id = doc.id;
                orders.push(orderData);
            });

            document.getElementById('orders-loading').classList.add('hidden');
            
            if (orders.length === 0) {
                document.getElementById('no-orders-message').classList.remove('hidden');
                return;
            }

            let ordersHtml = '';
            orders.forEach(order => {
                // Ensure date conversion is safe
                const date = order.date && order.date.seconds ? new Date(order.date.seconds * 1000).toLocaleDateString() : 'N/A';
                const total = order.total ? parseFloat(order.total).toFixed(2) : 'N/A';
                const statusBadge = renderStatusBadge(order.status || 'Pending');

                ordersHtml += `
                    <div class="p-4 bg-white rounded-lg shadow-md border border-stone/10">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center border-b pb-2 mb-2">
                            <p class="font-playfair text-xl font-bold text-charcoal">Order #${order.id.substring(0, 8).toUpperCase()}</p>
                            ${statusBadge}
                        </div>
                        <div class="font-roboto text-sm text-stone space-y-1">
                            <p>Date Placed: <span class="text-charcoal">${date}</span></p>
                            <p>Order Total: <span class="font-bold text-burnt-orange">$${total}</span></p>
                            <p>Items: ${order.items ? order.items.length : 0}</p>
                        </div>
                        <a href="/order-confirmation/?id=${order.id}" class="mt-3 inline-block text-burnt-orange hover:underline font-semibold text-sm">View Details &rarr;</a>
                    </div>
                `;
            });
            
            ordersList.innerHTML = ordersHtml;

        } catch (error) {
            console.error("Error loading order history:", error);
            document.getElementById('orders-loading').textContent = `Error loading history: ${error.message}`;
        }
    }


    // --- Main Initialization ---

    /**
     * Initializes the page after Firebase is ready and authentication state is resolved.
     */
    function initializeAccountPage() {
        // Ensure tabs are initialized before observer runs
        initializeTabs();
        initializeLogout();
        
        onAuthStateChanged(getAuth(), (user) => {
            
            if (user) {
                currentUserId = user.uid;
                notLoggedIn.classList.add('hidden');
                
                // Load profile data (and handle spinner removal there)
                loadUserProfile(user);
                
            } else {
                // If not logged in, ensure we redirect to the login page immediately.
                // NOTE: A general app-wide guard may already handle this, but for robustness:
                loadingSpinner.classList.add('hidden');
                dashboard.classList.add('hidden');
                notLoggedIn.classList.remove('hidden');
            }
        });
    }

    // CRITICAL: We rely on the firebase-ready event to ensure imports are safe.
    document.addEventListener('firebase-ready', initializeAccountPage);
</script>