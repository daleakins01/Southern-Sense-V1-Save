---
layout: layout.html
title: Product Detail
---
<div id="product-page-container" class="container mx-auto p-4 lg:p-8">
    
    <!-- Loading State -->
    <div id="loading-spinner" class="text-center py-20">
        <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-burnt-orange mx-auto"></div>
        <p class="mt-4 text-lg font-roboto text-stone">Loading Product Details...</p>
    </div>

    <!-- Error State -->
    <div id="error-message" class="hidden text-center py-20 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
        <strong class="font-bold block">Product Not Found</strong>
        <span class="block sm:inline" id="error-text">We couldn't find the product you were looking for.</span>
        <a href="/shop/" class="block mt-4 text-sm underline text-red-700 hover:text-red-900">Return to Shop</a>
    </div>

    <!-- Product Detail Content (Hidden until loaded) -->
    <div id="product-details" class="hidden lg:grid lg:grid-cols-2 gap-8 lg:gap-12 bg-parchment p-6 rounded-lg shadow-xl">
        
        <!-- Left Column: Image -->
        <div class="lg:sticky lg:top-8 h-fit">
            <img id="product-image" src="" alt="Product Image" class="w-full h-auto object-cover rounded-lg shadow-lg border border-stone/20">
            
            <div id="out-of-stock-badge" class="hidden absolute top-4 left-4 bg-burnt-orange text-parchment px-4 py-1 rounded-full font-roboto font-bold text-sm shadow-md">
                OUT OF STOCK
            </div>
        </div>

        <!-- Right Column: Details & CTA -->
        <div class="space-y-6">
            <p id="product-category" class="font-roboto text-sm uppercase tracking-widest text-stone"></p>
            <h1 id="product-name" class="font-playfair text-4xl lg:text-5xl font-extrabold text-charcoal"></h1>
            <p id="product-price" class="font-roboto text-3xl font-bold text-burnt-orange"></p>
            
            <p id="product-short-description" class="font-roboto text-lg text-stone"></p>

            <hr class="border-stone/10">

            <!-- Scent Details Card -->
            <div class="bg-stone/5 p-4 rounded-lg space-y-3">
                <h2 class="font-playfair text-xl font-bold text-charcoal">Scent Profile</h2>
                <div class="flex flex-col sm:flex-row sm:space-x-4 space-y-3 sm:space-y-0 text-sm">
                    <p class="font-roboto text-stone"><strong class="text-charcoal">Family:</strong> <span id="scent-family"></span></p>
                    <p class="font-roboto text-stone"><strong class="text-charcoal">Strength:</strong> <span id="scent-strength"></span></p>
                </div>
                <p class="font-roboto text-stone"><strong class="text-charcoal">Notes:</strong> <span id="scent-notes"></span></p>
            </div>

            <!-- Add to Cart Form -->
            <form id="add-to-cart-form" class="space-y-4">
                <input type="hidden" id="product-id-input" value="">
                <input type="hidden" id="product-name-input" value="">
                <input type="hidden" id="product-price-input" value="">
                <input type="hidden" id="product-image-input" value="">

                <label for="quantity" class="block font-roboto text-sm font-medium text-charcoal">Quantity</label>
                <input type="number" id="quantity" name="quantity" min="1" value="1" class="w-24 p-2 border border-stone/30 rounded-lg font-roboto text-charcoal focus:ring-burnt-orange focus:border-burnt-orange">
                
                <button type="submit" id="add-to-cart-button" class="w-full py-3 px-4 bg-burnt-orange text-parchment font-playfair text-lg font-bold rounded-lg shadow-md hover:bg-opacity-90 transition duration-150 disabled:bg-stone disabled:cursor-not-allowed">
                    Add to Cart
                </button>
            </form>

            <!-- Full Description -->
            <div id="product-long-description" class="font-roboto text-stone space-y-4 pt-4">
                <h2 class="font-playfair text-2xl font-bold text-charcoal border-b pb-2 border-stone/10">The Full Story</h2>
                <!-- Content inserted here by JavaScript -->
            </div>

        </div>
    </div>
</div>

<script type="module">
    // --- Firestore Imports ---
    import { db } from '/firebase-loader.js';
    import { doc, getDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

    // --- Local Cart Logic Import (from /cart.js) ---
    import { addToCart } from '/cart.js'; 

    // --- Utility Functions ---
    
    /**
     * Extracts the product ID from the URL's query string.
     * @returns {string | null} The product ID or null if not found.
     */
    function getProductIdFromUrl() {
        const params = new URLSearchParams(window.location.search);
        return params.get('id');
    }

    /**
     * Handles the display of the product details on the page.
     * @param {Object} productData - The data retrieved from Firestore.
     */
    function renderProduct(productData) {
        document.getElementById('product-name').textContent = productData.name;
        document.getElementById('product-category').textContent = productData.category.replace(/-/g, ' ');
        document.getElementById('product-price').textContent = `$${productData.price}`;
        document.getElementById('product-short-description').textContent = productData.shortDescription;
        document.getElementById('scent-family').textContent = productData.scentFamily.replace(/-/g, ' ');
        document.getElementById('scent-notes').textContent = productData.scentNotes;
        document.getElementById('scent-strength').textContent = `${productData.strength}/5`; // Display as X/5
        document.getElementById('product-image').src = `/${productData.imageUrl}`;
        document.getElementById('product-image').alt = productData.name;

        // Render long description (which can contain HTML paragraphs)
        document.getElementById('product-long-description').insertAdjacentHTML('beforeend', productData.longDescription);

        // Populate hidden form fields for cart
        document.getElementById('product-id-input').value = productData.id;
        document.getElementById('product-name-input').value = productData.name;
        document.getElementById('product-price-input').value = productData.price;
        document.getElementById('product-image-input').value = productData.imageUrl;
        
        const addToCartButton = document.getElementById('add-to-cart-button');

        // Handle Stock Status
        if (productData.stock <= 0) {
            addToCartButton.disabled = true;
            addToCartButton.textContent = "Out of Stock";
            document.getElementById('out-of-stock-badge').classList.remove('hidden');
        } else {
            addToCartButton.textContent = "Add to Cart";
        }
        
        // Show the content and hide loading/error states
        document.getElementById('loading-spinner').classList.add('hidden');
        document.getElementById('product-details').classList.remove('hidden');
    }

    /**
     * Fetches the product data from Firestore.
     * @param {string} productId - The ID of the product to fetch.
     */
    async function loadProduct(productId) {
        if (!productId) {
            document.getElementById('loading-spinner').classList.add('hidden');
            document.getElementById('error-text').textContent = "No product ID was provided in the URL.";
            document.getElementById('error-message').classList.remove('hidden');
            return;
        }

        try {
            const productRef = doc(db, 'products', productId);
            const docSnap = await getDoc(productRef);

            if (docSnap.exists()) {
                const productData = docSnap.data();
                // Store the ID separately as it's not in .data()
                productData.id = docSnap.id; 
                renderProduct(productData);
            } else {
                // Product document does not exist
                document.getElementById('loading-spinner').classList.add('hidden');
                document.getElementById('error-text').textContent = `Product with ID "${productId}" not found.`;
                document.getElementById('error-message').classList.remove('hidden');
            }

        } catch (error) {
            console.error("Error loading product:", error);
            document.getElementById('loading-spinner').classList.add('hidden');
            document.getElementById('error-text').textContent = `An error occurred: ${error.message}`;
            document.getElementById('error-message').classList.remove('hidden');
        }
    }
    
    /**
     * Initializes the "Add to Cart" form listener.
     */
    function initializeCartListener() {
        const form = document.getElementById('add-to-cart-form');
        form.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const productId = document.getElementById('product-id-input').value;
            const name = document.getElementById('product-name-input').value;
            const price = document.getElementById('product-price-input').value;
            const imageUrl = document.getElementById('product-image-input').value;
            const quantity = parseInt(document.getElementById('quantity').value, 10);
            
            // Validate quantity
            if (quantity > 0) {
                addToCart({
                    id: productId,
                    name: name,
                    price: parseFloat(price),
                    imageUrl: imageUrl,
                    quantity: quantity
                });
                
                // Optional: Provide visual feedback (e.g., button change)
                const button = document.getElementById('add-to-cart-button');
                button.textContent = 'Added!';
                setTimeout(() => {
                    button.textContent = 'Add to Cart';
                }, 1000);
            }
        });
    }

    // --- Main Initialization ---
    
    // FIX (Race Condition): Wait for firebase-loader.js to dispatch its signal
    document.addEventListener('firebase-ready', () => {
        const productId = getProductIdFromUrl();
        // 1. Load the product data from Firestore
        loadProduct(productId);
        // 2. Attach the cart listener
        initializeCartListener();
    });

</script>
