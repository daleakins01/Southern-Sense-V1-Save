---
layout: layout.html
title: Account
---

<section class="max-w-4xl mx-auto mt-10 px-4 text-gray-800">
  <h1 class="text-3xl font-bold mb-6">Your Account</h1>

  <div id="profile-section" class="mb-10">
    <p id="loading-profile">Loading profile...</p>
    <div id="profile-content" class="hidden space-y-2">
      <p><strong>Name:</strong> <span id="user-name"></span></p>
      <p><strong>Email:</strong> <span id="user-email"></span></p>
      <p><strong>Role:</strong> <span id="user-role"></span></p>
      <button id="logout-btn" class="bg-red-500 text-white px-4 py-2 rounded mt-4">Sign Out</button>
    </div>
  </div>

  <hr class="my-8" />

  <div id="orders-section">
    <h2 class="text-2xl font-semibold mb-4">Your Orders</h2>
    <p id="loading-orders">Loading your orders...</p>
    <div id="orders-list" class="hidden space-y-4"></div>
  </div>
</section>

<script type="module">
  import { getFirestore, doc, getDoc, collection, getDocs, query, where } from "/firebase-loader.js";
  import { onAuthStateChanged, signOut } from "/firebase-loader.js";

  const db = window.firebaseDB || getFirestore();
  const auth = window.firebaseAuth;

  const nameEl = document.getElementById("user-name");
  const emailEl = document.getElementById("user-email");
  const roleEl = document.getElementById("user-role");
  const profileContent = document.getElementById("profile-content");
  const loadingProfile = document.getElementById("loading-profile");
  const loadingOrders = document.getElementById("loading-orders");
  const ordersList = document.getElementById("orders-list");
  const logoutBtn = document.getElementById("logout-btn");

  async function loadProfile(user) {
    try {
      const userDocRef = doc(db, "users", user.uid);
      const userSnap = await getDoc(userDocRef);
      if (userSnap.exists()) {
        const data = userSnap.data();
        // Handle either 'name' or 'firstName' + 'lastName'
        const fullName = data.name || [data.firstName, data.lastName].filter(Boolean).join(" ") || "Valued Customer";
        nameEl.textContent = fullName;
        emailEl.textContent = data.email || user.email || "Unknown";
        roleEl.textContent = data.isAdmin ? "Admin" : "Customer";
      } else {
        nameEl.textContent = "Valued Customer";
        emailEl.textContent = user.email || "Unknown";
        roleEl.textContent = "Customer";
      }
      loadingProfile.classList.add("hidden");
      profileContent.classList.remove("hidden");
    } catch (err) {
      console.error("[Account] Failed to load profile:", err);
      loadingProfile.textContent = "Error loading profile.";
    }
  }

  async function loadOrders(user) {
    try {
      const ordersRef = collection(db, "orders");
      const q = query(ordersRef, where("userId", "==", user.uid));
      const querySnap = await getDocs(q);

      loadingOrders.classList.add("hidden");

      if (querySnap.empty) {
        const noOrdersMsg = document.createElement("p");
        noOrdersMsg.textContent = "You have no orders yet.";
        ordersList.appendChild(noOrdersMsg);
        ordersList.classList.remove("hidden");
        return;
      }

      querySnap.forEach((docSnap) => {
        const order = docSnap.data();
        const card = document.createElement("div");
        card.className = "border p-4 rounded shadow-sm";
        const date = order.date || (order.createdAt && order.createdAt.toDate ? order.createdAt.toDate().toLocaleDateString() : "Unknown date");
        const total = order.total ? `$${order.total.toFixed(2)}` : "Unknown total";
        card.innerHTML = `
          <p><strong>Order ID:</strong> ${docSnap.id}</p>
          <p><strong>Date:</strong> ${date}</p>
          <p><strong>Total:</strong> ${total}</p>
          <p><strong>Status:</strong> ${order.status || "Processing"}</p>
        `;
        ordersList.appendChild(card);
      });

      ordersList.classList.remove("hidden");
    } catch (err) {
      console.error("[Account] Failed to load orders:", err);
      loadingOrders.textContent = "Error loading orders.";
    }
  }

  async function initAccount() {
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        loadingProfile.textContent = "Please log in to view your account.";
        return;
      }
      console.log("[Account] Auth detected:", user.email);
      await loadProfile(user);
      await loadOrders(user);
    });
  }

  logoutBtn.addEventListener("click", async () => {
    await signOut(auth);
    window.location.href = "/";
  });

  // Initialize after Firebase is ready
  if (window._southernsense_firebase_init) {
    initAccount();
  } else {
    window.addEventListener("firebase-ready", initAccount);
  }
</script>
