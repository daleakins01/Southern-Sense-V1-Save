<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-M" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Login - Southern Sense</title>
    <link rel="stylesheet" href="/output.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Roboto:wght@300;400;500&display=swap"
      rel="stylesheet"
    />
    <!-- 
      NOTE: This is a standalone app. 
      It does NOT use Eleventy layouts.
    -->
  </head>
  <body class="bg-parchment font-roboto text-charcoal">
    <main
      class="flex items-center justify-center min-h-screen px-4 py-12"
    >
      <div class="w-full max-w-md bg-white p-8 rounded-lg shadow-2xl">
        <div class="text-center mb-8">
          <img
            src="/src/logo.webp"
            alt="Southern Sense Logo"
            class="w-24 h-24 mx-auto"
          />
          <h1
            class="mt-4 font-playfair text-3xl font-semibold text-charcoal"
          >
            Admin Portal
          </h1>
        </div>

        <!-- Error Message Container -->
        <div
          id="error-message"
          class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-md mb-4"
          role="alert"
        >
          <span class="block sm:inline" id="error-text"></span>
        </div>

        <!-- Login Form -->
        <form id="admin-login-form" class="space-y-6">
          <!-- Email -->
          <div>
            <label
              for="email"
              class="block text-sm font-medium text-charcoal mb-1"
              >Email</label
            >
            <input
              type="email"
              id="email"
              name="email"
              required
              autocomplete="email"
              class="w-full px-4 py-3 border border-stone/30 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-burnt-orange focus:border-transparent"
            />
          </div>

          <!-- Password -->
          <div>
            <label
              for="password"
              class="block text-sm font-medium text-charcoal mb-1"
              >Password</label
            >
            <input
              type="password"
              id="password"
              name="password"
              required
              autocomplete="current-password"
              class="w-full px-4 py-3 border border-stone/30 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-burnt-orange focus:border-transparent"
            />
          </div>

          <!-- Submit Button -->
          <div>
            <button
              type="submit"
              id="login-button"
              class="w-full bg-charcoal text-white font-roboto px-6 py-3 rounded-md shadow-lg hover:bg-stone transition-all duration-300 flex items-center justify-center"
            >
              <svg
                id="button-spinner"
                class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
              >
                <circle
                  class="opacity-25"
                  cx="12"
                  cy="12"
                  r="10"
                  stroke="currentColor"
                  stroke-width="4"
                ></circle>
                <path
                  class="opacity-75"
                  fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                ></path>
              </svg>
              <span id="button-text">Sign In</span>
            </button>
          </div>
        </form>
      </div>
    </main>

    <script type="module">
      import {
        auth,
        db,
        doc,
        getDoc,
        signInWithEmailAndPassword,
        onAuthStateChanged
      } from "/src/firebase-loader.js";

      const loginForm = document.getElementById("admin-login-form");
      const emailInput = document.getElementById("email");
      const passwordInput = document.getElementById("password");
      const errorMessage = document.getElementById("error-message");
      const errorText = document.getElementById("error-text");
      const loginButton = document.getElementById("login-button");
      const buttonSpinner = document.getElementById("button-spinner");
      const buttonText = document.getElementById("button-text");

      // Check if user is already logged in and an admin
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          // User is logged in, check if they are an admin
          const adminDocRef = doc(db, "admins", user.uid);
          const adminDocSnap = await getDoc(adminDocRef);
          
          if (adminDocSnap.exists()) {
            console.log("Admin already signed in. Redirecting to dashboard.");
            window.location.href = "/admin.html";
          } else {
            // Not an admin, sign them out of this context
            console.log("User is not an admin, but is signed in. No redirect.");
          }
        }
      });

      // Show error message
      function showAuthError(message) {
        let friendlyMessage = message;
        console.warn("Admin Auth Error:", message);

        if (
          message.includes("auth/user-not-found") ||
          message.includes("auth/wrong-password") ||
          message.includes("auth/invalid-credential")
        ) {
          friendlyMessage = "Invalid email or password. Please try again.";
        } else {
          friendlyMessage = "An unexpected error occurred. Please try again later.";
        }

        errorText.textContent = friendlyMessage;
        errorMessage.style.display = "block";
      }

      // Handle form submission
      loginForm.addEventListener("submit", async (e) => {
        e.preventDefault();

        // Show loading state
        loginButton.disabled = true;
        buttonSpinner.style.display = "inline-block";
        buttonText.textContent = "Signing In...";
        errorMessage.style.display = "none";

        const email = emailInput.value;
        const password = passwordInput.value;

        try {
          // 1. Sign in the user
          const userCredential = await signInWithEmailAndPassword(
            auth,
            email,
            password
          );
          const user = userCredential.user;

          // 2. Check if they are in the 'admins' collection
          const adminDocRef = doc(db, "admins", user.uid);
          const adminDocSnap = await getDoc(adminDocRef);

          if (adminDocSnap.exists()) {
            // SUCCESS: User is an admin
            console.log("Admin login successful:", user.uid);
            window.location.href = "/admin.html";
          } else {
            // FAILURE: User is not an admin
            console.warn("User authenticated but is not an admin:", user.uid);
            showAuthError("You do not have permission to access this page.");
            // Sign them out to prevent confusion
            await auth.signOut();
            loginButton.disabled = false;
            buttonSpinner.style.display = "none";
            buttonText.textContent = "Sign In";
          }
        } catch (error) {
          showAuthError(error.message);
          // Hide loading state
          loginButton.disabled = false;
          buttonSpinner.style.display = "none";
          buttonText.textContent = "Sign In";
        }
      });
    </script>
  </body>
</html>
