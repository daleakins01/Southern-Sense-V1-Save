---
layout: layout
title: Shop All Candles & Melts
---

{% include "page-header.html" with pageTitle: title, shortTitle: "Our Shop" %}

<main class="container mx-auto px-4 py-12 min-h-screen">
    
    <div class="max-w-6xl mx-auto bg-white p-8 lg:p-12 rounded-xl shadow-2xl border border-stone/10">

        <header class="max-w-4xl mx-auto text-center mb-12">
            <p class="text-sm font-semibold uppercase tracking-wider text-burnt-orange mb-3">Shop Our Collection</p>
            <h1 id="shop-heading" class="text-5xl font-playfair text-charcoal mb-4">
                All Products
            </h1>
            <p id="shop-intro" class="text-lg text-stone leading-relaxed">
                </p>
            <div id="filter-message" class="text-center text-sm font-medium text-stone mt-4">
            </div>
        </header>

        <div class="flex flex-col lg:flex-row gap-8">
            
            <aside class="lg:w-1/4 h-min">
                <div class="bg-parchment p-6 rounded-lg shadow-md border border-stone/10 mb-8 sticky top-24">
                    <h3 class="text-xl font-playfair text-charcoal mb-4 border-b pb-2">Quick Search</h3>
                    <div class="relative">
                        <input type="search" id="search-input" placeholder="Search by scent name..." 
                               class="w-full p-3 border border-stone/30 rounded-lg text-charcoal focus:border-burnt-orange focus:ring-1 focus:ring-burnt-orange">
                        <div id="autocomplete-results" class="absolute w-full mt-1 bg-white rounded-lg shadow-xl max-h-48 overflow-y-auto z-10 border border-stone/20 hidden">
                            </div>
                    </div>
                </div>
                
                <div class="bg-parchment p-6 rounded-lg shadow-md border border-stone/10 h-min">
                    <h3 class="text-xl font-playfair text-charcoal mb-4 border-b pb-2">Refine Your Scents</h3>
                    
                    <form id="product-filter-form" class="space-y-6">
                        
                        <div>
                            <label for="category-filter" class="block text-sm font-medium text-charcoal mb-2">Product Type</label>
                            <select id="category-filter" name="category" class="w-full p-2 border border-stone/30 rounded-lg text-charcoal bg-white">
                                <option value="">All Types</option>
                                </select>
                        </div>

                        <div>
                            <label for="family-filter" class="block text-sm font-medium text-charcoal mb-2">Scent Family</label>
                            <select id="family-filter" name="family" class="w-full p-2 border border-stone/30 rounded-lg text-charcoal bg-white">
                                <option value="">All Families</option>
                                </select>
                        </div>

                        <button type="submit" id="apply-filters-button" class="w-full px-4 py-3 bg-stone text-parchment font-bold rounded-lg hover:bg-charcoal transition duration-300">
                            Apply Filters
                        </button>
                        <button type="button" id="clear-filters-button" class="w-full px-4 py-2 border border-stone/30 text-charcoal font-medium rounded-lg hover:bg-parchment/70 transition duration-300">
                            Clear Filters
                        </button>

                    </form>
                </div>
            </aside>

            <div class="lg:w-3/4">
                <div id="shop-loader" class="flex justify-center items-center h-48">
                    <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-burnt-orange"></div>
                </div>

                <div id="product-grid" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-8">
                </div>
            </div>

        </div>

    </div>
</main>

<script type="module">
    import { 
        db, 
        collection, 
        query, 
        where, 
        getDocs, 
        orderBy 
    } from '/src/firebase-loader.js';

    // --- Global Element Declarations (Initial fetch is defensive, final fetch is local in initializeShop) ---
    const shopLoader = document.getElementById('shop-loader');
    const searchInput = document.getElementById('search-input');
    const autocompleteResults = document.getElementById('autocomplete-results');

    let allProducts = [];
    let productNames = [];
    let activeSearchTerm = '';
    
    // --- Utility Functions ---

    /**
     * Extracts all filters from the URL query parameters.
     */
    function getFiltersFromUrl() {
        const params = new URLSearchParams(window.location.search);
        return {
            family: params.get('family'),
            category: params.get('category'),
            // CRITICAL FIX: Add search term support from URL for persistent filtering
            search: params.get('search')
        };
    }

    /**
     * Capitalizes the first letter of each word in a string (for display).
     */
    function formatText(str) {
        if (!str) return '';
        return str
            .toLowerCase()
            .split(/[-\s]+/)
            .map(word => word.charAt(0).toUpperCase() + word.slice(1))
            .join(' ');
    }

    /**
     * Renders a single product card HTML.
     */
    function renderProductCard(product) {
        const isOutOfStock = product.stock <= 0;
        const price = product.price.toFixed(2); 
        
        let stockStatusHtml = '';
        let buttonText = 'Add to Cart';
        let buttonClasses = 'bg-burnt-orange hover:bg-burnt-orange/80';
        let buttonDisabled = '';
        let buttonClickAction = '';
        
        // CRITICAL FIX 1: Robust Image Path Resolver to prevent 404 cascading errors
        let imageUrl = `/src/${product.imageUrl || 'logo.webp'}`;

        // Secondary check for known inconsistent image links in the DB (workaround for server 404s)
        if (product.imageUrl && product.imageUrl.endsWith('.webp') === false && product.category === 'candle') {
             if (product.imageUrl === 'autumn-velvet-candle.webp') {
                imageUrl = `/src/autumn-velvet-melt.webp`; // Correcting known DB inconsistency
             } else if (product.imageUrl === 'bleu-creme.webp') {
                 imageUrl = `/src/bleu-creme-luxe-candle.webp`;
             } else if (product.imageUrl === 'southern-charm.webp') {
                 imageUrl = `/src/southern-charm-candle-image.webp`;
             } else if (product.imageUrl === 'enchanted-kiss.webp') {
                 imageUrl = `/src/Enchanted-kiss-candle-image.webp`;
             }
        }

        if (isOutOfStock) {
            stockStatusHtml = `<p class="text-sm font-semibold text-red-600">SOLD OUT</p>`;
            buttonText = 'View Details';
            buttonClasses = 'bg-stone/50 hover:bg-stone/60 cursor-not-allowed';
            // CRITICAL FIX: Ensure out-of-stock buttons navigate to the PDP
            buttonClickAction = `onclick="window.location.href='/product/?id=${product.id}'"`; 
        } else {
            stockStatusHtml = `<p class="text-sm font-semibold text-green-600">In Stock</p>`;
            buttonClickAction = ``;
        }
            
        const actionButtonHtml = `
            <button ${buttonDisabled}
                    data-id="${product.id}" 
                    data-name="${product.name}"
                    data-price="${price}"
                    data-image="${product.imageUrl}"
                    class="add-to-cart-button w-full px-4 py-3 text-parchment font-bold rounded-lg shadow-md transition duration-300 ${buttonClasses}"
                    ${buttonClickAction}>
                ${buttonText}
            </button>
        `;
        
        return `
            <div class="product-card bg-white rounded-xl shadow-xl overflow-hidden hover:shadow-2xl transition duration-300 transform hover:-translate-y-1">
                <a href="/product/?id=${product.id}" class="block relative" aria-label="View product details for ${product.name}">
                    <img src="${imageUrl}" alt="${product.name}" class="w-full h-72 object-cover">
                    ${product.featured ? '<span class="absolute top-3 left-3 px-3 py-1 text-xs bg-burnt-orange text-parchment rounded-full font-bold shadow-md">FEATURED</span>' : ''}
                </a>
                <div class="p-5">
                    <h3 class="text-xl font-playfair text-charcoal mb-1">${product.name}</h3>
                    <p class="text-sm text-stone mb-3">${formatText(product.scentFamily)} | ${formatText(product.category)}</p>
                    <div class="flex justify-between items-center mb-4 border-b pb-4">
                        <p class="text-xl font-bold text-burnt-orange">$${price}</p>
                        ${stockStatusHtml}
                    </div>
                    ${actionButtonHtml}
                </div>
            </div>
        `;
    }

    // --- Filter Setup Logic ---

    function setupFilters(currentFilters) {
        const uniqueFamilies = new Set();
        const uniqueCategories = new Set();

        allProducts.forEach(p => {
            if (p.scentFamily) uniqueFamilies.add(p.scentFamily.toLowerCase());
            if (p.category) uniqueCategories.add(p.category.toLowerCase());
        });

        const categoryFilterSelect = document.getElementById('category-filter');
        const familyFilterSelect = document.getElementById('family-filter');

        if (categoryFilterSelect) {
            categoryFilterSelect.innerHTML = '<option value="">All Types</option>';
            [...uniqueCategories].sort().forEach(cat => {
                const selected = cat === currentFilters.category ? 'selected' : '';
                categoryFilterSelect.innerHTML += `<option value="${cat}" ${selected}>${formatText(cat)}</option>`;
            });
        }

        if (familyFilterSelect) {
            familyFilterSelect.innerHTML = '<option value="">All Families</option>';
            [...uniqueFamilies].sort().forEach(family => {
                const selected = family === currentFilters.family ? 'selected' : '';
                familyFilterSelect.innerHTML += `<option value="${family}" ${selected}>${formatText(family)}</option>`;
            });
        }
        
        // NEW: Pre-populate search input if present in URL
        if (searchInput && currentFilters.search) {
             searchInput.value = currentFilters.search;
             activeSearchTerm = currentFilters.search;
        }
    }

    function attachCartListeners() {
        // Only attach listeners to buttons that are NOT out of stock and rely on JS for action
        document.querySelectorAll('.add-to-cart-button:not([disabled])').forEach(button => {
            // Check if the button has an onclick attribute (i.e., it's a "View Details" button)
            if (!button.hasAttribute('onclick')) {
                 button.addEventListener('click', (e) => {
                    e.preventDefault();
                    const { id, name, price, image } = e.currentTarget.dataset;
                    
                    const product = { id: id, name: name, price: price, imageUrl: image };
                    
                    if (window.addToCart && window.updateCartDisplay) { 
                        window.addToCart(product, 1); 
                        window.updateCartDisplay(); 
                        
                        e.currentTarget.textContent = 'Added!';
                        setTimeout(() => {
                            e.currentTarget.textContent = 'Add to Cart';
                        }, 1000);
                    } else {
                        console.error("Cart functions (addToCart/updateCartDisplay) are not available.");
                    }
                });
            }
        });
    }
    
    // NEW FUNCTION: Handles the autocomplete logic
    function handleSearchAndAutocomplete() {
        const query = searchInput.value.toLowerCase().trim();
        activeSearchTerm = query; 

        if (query.length < 2) {
            autocompleteResults.classList.add('hidden');
            // If search is cleared, re-render the grid without the search filter
            if (query.length === 0) {
                 renderProductGrid(getFiltersFromUrl());
            }
            return;
        }

        const filteredNames = productNames
            .filter(name => name.toLowerCase().includes(query))
            .slice(0, 5); // Limit to 5 suggestions

        if (filteredNames.length > 0) {
            autocompleteResults.innerHTML = filteredNames.map(name => 
                `<div class="p-3 cursor-pointer hover:bg-stone/10 text-charcoal text-sm autocomplete-item" data-name="${name}">${name}</div>`
            ).join('');
            
            // Attach click handler to each suggestion
            document.querySelectorAll('.autocomplete-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    const selectedName = e.target.dataset.name;
                    searchInput.value = selectedName;
                    autocompleteResults.classList.add('hidden');
                    // Trigger full grid render immediately with selected term
                    renderProductGrid(getFiltersFromUrl(), selectedName); 
                });
            });

            autocompleteResults.classList.remove('hidden');
        } else {
            autocompleteResults.classList.add('hidden');
        }
        
        // Also trigger filtering on every input change, not just on click
        renderProductGrid(getFiltersFromUrl(), query);
    }
    
    // NEW FUNCTION: Sets up all search listeners
    function setupSearchListeners() {
         if (searchInput) {
            // Live search and autocomplete on input
            searchInput.addEventListener('input', handleSearchAndAutocomplete);
            
            // Handle focusing out
            searchInput.addEventListener('blur', () => {
                // Delay hiding to allow click event on autocomplete item to fire
                setTimeout(() => {
                    autocompleteResults.classList.add('hidden');
                }, 200);
            });
            
            // Handle focusing in (if query exists)
            searchInput.addEventListener('focus', () => {
                 if (searchInput.value.length > 1 && autocompleteResults.children.length > 0) {
                    autocompleteResults.classList.remove('hidden');
                 }
            });
         }
    }


    /**
     * Filters the global product list and renders the grid.
     * @param {Object} filters - URL-based filters (family, category).
     * @param {string} [searchTerm] - Optional text search term.
     */
    function renderProductGrid(filters, searchTerm = activeSearchTerm) {
        // 1. CRITICAL FIX: Re-declare critical DOM elements to ensure they are found AFTER the DOM is ready.
        const shopHeading = document.getElementById('shop-heading');
        const shopIntro = document.getElementById('shop-intro');
        const productGrid = document.getElementById('product-grid');
        const filterMessage = document.getElementById('filter-message');
        
        let filteredProducts = allProducts;
        let displayedCount = 0;
        let productHtmlArray = [];

        // 2. CRITICAL FIX: Immediate exit if rendering elements are missing
        if (!shopHeading || !shopIntro || !productGrid) {
            console.error("renderProductGrid aborted: Critical header/grid elements are null. DOM may be corrupted.");
            if(shopLoader) shopLoader.classList.add('hidden');
            return;
        }


        // 3. Apply Filters
        if (filters.family) {
            filteredProducts = filteredProducts.filter(p => p.scentFamily && p.scentFamily.toLowerCase() === filters.family.toLowerCase());
        }
        if (filters.category) {
            filteredProducts = filteredProducts.filter(p => p.category && p.category.toLowerCase() === filters.category.toLowerCase());
        }
        
        // NEW: Apply text search filter
        if (searchTerm && searchTerm.length > 1) {
            const searchLower = searchTerm.toLowerCase();
            filteredProducts = filteredProducts.filter(p => 
                p.name.toLowerCase().includes(searchLower) ||
                p.shortDescription.toLowerCase().includes(searchLower) ||
                p.scentNotes.toLowerCase().includes(searchLower)
            );
        }

        // 4. Update Header Text (No longer crashing here due to checks in step 2)
        const activeFilterNames = [
            filters.category ? formatText(filters.category) : null,
            filters.family ? formatText(filters.family) : null
        ].filter(n => n).join(' & ');
        
        let titleText = activeFilterNames || 'All Products';
        if (searchTerm && searchTerm.length > 1) {
             titleText = `Results for: "${searchTerm}"`;
        }

        shopHeading.textContent = titleText;
        shopIntro.textContent = activeFilterNames || `Explore our entire collection of hand-poured candles and luxurious wax melts.`;

        productGrid.innerHTML = '';
        
        if (filteredProducts.length === 0) {
            productGrid.innerHTML = `<p class="text-lg text-stone col-span-full text-center py-10">No products found matching your criteria. <a href="/shop/" class="text-burnt-orange hover:underline">Clear Filters</a></p>`;
            if (filterMessage) filterMessage.textContent = `0 products found.`;
            return;
        }

        filteredProducts.sort((a, b) => {
            if (a.stock > 0 && b.stock <= 0) return -1;
            if (a.stock <= 0 && b.stock > 0) return 1;
            return a.name.localeCompare(b.name);
        });

        // Use the array push method for performance
        filteredProducts.forEach(product => {
            productHtmlArray.push(renderProductCard(product));
            displayedCount++;
        });
        
        // Single, optimized DOM write
        productGrid.innerHTML = productHtmlArray.join('');


        if (filterMessage) filterMessage.textContent = `${displayedCount} ${titleText} products found.`;

        attachCartListeners();
    }

    function handleFilterSubmit(e) {
        e.preventDefault();
        const categoryFilterSelect = document.getElementById('category-filter');
        const familyFilterSelect = document.getElementById('family-filter');
        const category = categoryFilterSelect ? categoryFilterSelect.value : null;
        const family = familyFilterSelect ? familyFilterSelect.value : null;
        const search = searchInput ? searchInput.value.trim() : null;
        
        const newParams = new URLSearchParams();
        if (category) newParams.set('category', category);
        if (family) newParams.set('family', family);
        if (search) newParams.set('search', search); // NEW: Include search term in URL
        
        window.location.href = `/shop/?${newParams.toString()}`;
    }

    function handleClearFilters() {
        window.location.href = '/shop/';
    }


    async function initializeShop() {
        if (!shopLoader) {
             console.error("Loader element is missing. Cannot initialize.");
             return;
        }
        
        shopLoader.classList.remove('hidden');
        
        const currentFilters = getFiltersFromUrl();

        try {
            const productsRef = collection(db, 'products');
            const q = query(productsRef); 
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                const shopIntro = document.getElementById('shop-intro');
                if (shopIntro) shopIntro.textContent = "We're currently stocking our shelves. Please check back soon!";
                shopLoader.classList.add('hidden');
                return;
            }

            allProducts = querySnapshot.docs.map(doc => {
                const data = doc.data();
                return {
                    id: doc.id,
                    ...data,
                    price: parseFloat(data.price) || 0.00, 
                    stock: parseInt(data.stock, 10) || 0, 
                    featured: data.featured === true 
                };
            });
            
            // NEW: Populate the list of product names for autocomplete
            productNames = allProducts.map(p => p.name);

            setupFilters(currentFilters);
            renderProductGrid(currentFilters, currentFilters.search); // Pass search filter
            setupSearchListeners(); // Setup search listeners after initial render

        } catch (error) {
            console.error("CRITICAL ERROR: Error fetching products:", error);
            const shopIntro = document.getElementById('shop-intro');
            if (shopIntro) shopIntro.innerHTML = `<p class="text-red-600 font-bold">Error loading products. Please check the browser console for specific dependency or Firestore errors.</p>`;
        } finally {
            shopLoader.classList.add('hidden');
            if (window.updateCartDisplay) {
                window.updateCartDisplay();
            }
        }
    }
    
    // CRITICAL FIX: Use polling inside DOMContentLoaded to wait for global cart functions
    document.addEventListener('DOMContentLoaded', () => {
        const filterForm = document.getElementById('product-filter-form');
        const clearFiltersButton = document.getElementById('clear-filters-button');

        function waitForCartAndRun() {
            if (window.addToCart && window.updateCartDisplay) {
                initializeShop();
                
                // Attach form listeners AFTER initialization
                if (filterForm) {
                    filterForm.addEventListener('submit', handleFilterSubmit);
                }
                if (clearFiltersButton) {
                    clearFiltersButton.addEventListener('click', handleClearFilters);
                }
            } else {
                setTimeout(waitForCartAndRun, 50);
            }
        }
        waitForCartAndRun();
    });


; // DEFENSIVE SEMICOLON: Added to absorb potential file truncation errors.
</script>