---
layout: layout.html
title: "Product"
---

<main class="container mx-auto px-4 py-12">
  <!-- Loading Spinner -->
  <div id="loading-spinner" class="flex justify-center items-center h-screen text-stone">
    <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-burnt-orange" xmlns="http://www.w3.org/2000/svg" fill="none"
      viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor"
        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
      </path>
    </svg>
    <span class="text-2xl font-playfair">Loading Product...</span>
  </div>

  <!-- Product Content (Hidden by default) -->
  <div id="product-content" class="hidden">
    <!-- Main Product Section -->
    <section class="flex flex-col md:flex-row gap-8 md:gap-12">
      <!-- Product Image -->
      <div class="w-full md:w-1/2">
        <img id="product-image" src="" alt="Product image" class="w-full h-auto object-cover rounded-lg shadow-lg" />
      </div>

      <!-- Product Details -->
      <div class="w-full md:w-1/2">
        <h1 id="product-name" class="font-playfair text-4xl font-bold text-charcoal"></h1>
        <p id="product-price" class="text-3xl font-light text-burnt-orange mt-2"></p>
        <p id="product-short-desc" class="text-lg text-stone mt-4"></p>

        <!-- Scent Details -->
        <div class="mt-6 border-t border-b border-stone/20 py-4">
          <p class="text-charcoal">
            <strong class="text-stone font-medium">Scent Family:</strong>
            <span id="product-scent-family" class="ml-2 capitalize"></span>
          </p>
          <p class="text-charcoal mt-2">
            <strong class="text-stone font-medium">Scent Notes:</strong>
            <span id="product-scent-notes" class="ml-2"></span>
          </p>
        </div>

        <!-- Add to Cart -->
        <div class="mt-6">
          <button id="add-to-cart-btn"
            class="w-full bg-burnt-orange text-white font-roboto px-8 py-4 rounded-md shadow-lg hover:bg-opacity-90 transition-all duration-300 text-lg font-medium">
            Add to Cart
          </button>
          <p id="stock-message" class="text-red-600 text-center mt-4 text-sm hidden">
            Out of Stock
          </p>
        </div>

        <!-- Long Description (Accordion) -->
        <div class="mt-8 border-t border-stone/20">
          <div class="border-b border-stone/20 py-4">
            <h3 class="font-playfair text-xl font-semibold">Description</h3>
            <div id="product-long-desc" class="text-stone mt-2"></div>
          </div>
          <div class="border-b border-stone/20 py-4">
            <h3 class="font-playfair text-xl font-semibold">Pairs Well With</h3>
            <p id="product-pairing" class="text-stone mt-2"></p>
          </div>
        </div>
      </div>
    </section>

    <!-- Recommendations Section -->
    <section id="recommendations-section" class="mt-24">
      <h2 class="font-playfair text-3xl font-semibold text-charcoal text-center mb-8">
        You Might Also Like
      </h2>
      <div id="recommendations-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
        <!-- Recommendation cards will be injected here -->
      </div>
    </section>

    <!-- Reviews Section -->
    <section id="reviews-section" class="mt-24">
      <h2 class="font-playfair text-3xl font-semibold text-charcoal text-center mb-8">
        Customer Reviews
      </h2>

      <!-- (Pillar 2 Fix): This logic is currently insecure and incomplete.
           - We need to fetch ONLY `approved: true` reviews.
           - We need to submit new reviews to Firestore with `approved: false`.
           - The form should only be visible if the user is logged in.
      -->

      <!-- Add Review Form (Hidden by default, shown if logged in) -->
      <div id="add-review-form-container" class="hidden max-w-2xl mx-auto mb-12">
        <h3 class="font-playfair text-2xl font-semibold text-charcoal mb-4">
          Leave a Review
        </h3>
        <form id="add-review-form" class="bg-white p-6 rounded-lg shadow-md">
          <p class="text-stone mb-4">
            You must be logged in to leave a review.
          </p>
          <div class="mb-4">
            <label for="review-rating" class="block text-sm font-medium text-charcoal mb-1">Rating</label>
            <select id="review-rating" class="w-full px-3 py-2 border border-stone/30 rounded-lg" disabled>
              <option value="5">5 Stars</option>
              <option value="4">4 Stars</option>
              <option value="3">3 Stars</option>
              <option value="2">2 Stars</option>
              <option value="1">1 Star</option>
            </select>
          </div>
          <div class="mb-4">
            <label for="review-text" class="block text-sm font-medium text-charcoal mb-1">Review</label>
            <textarea id="review-text" rows="4" class="w-full px-3 py-2 border border-stone/30 rounded-lg"
              disabled></textarea>
          </div>
          <button type="submit" id="submit-review-btn"
            class="bg-burnt-orange text-white font-roboto px-6 py-2 rounded-md shadow-lg" disabled>
            Submit Review
          </button>
          <p id="review-form-message" class="text-green-600 mt-4 hidden"></p>
        </form>
      </div>

      <!-- Existing Reviews -->
      <div id="reviews-list" class="max-w-2xl mx-auto space-y-6">
        <p id="no-reviews-message" class="text-stone text-lg italic text-center">
          No reviews yet. Be the first!
        </p>
        <!-- Review cards will be injected here -->
      </div>
    </section>
  </div>
</main>

<script type="module">
  import {
    db,
    doc,
    getDoc,
    collection,
    getDocs,
    query,
    where,
    limit,
    auth,
    onAuthStateChanged,
    addDoc,
    Timestamp,
  } from "/src/firebase-loader.js";
  import { getCart, addToCart } from "/src/cart.js";

  // Get elements
  const loadingSpinner = document.getElementById("loading-spinner");
  const productContent = document.getElementById("product-content");
  const productNameEl = document.getElementById("product-name");
  const productPriceEl = document.getElementById("product-price");
  const productShortDescEl = document.getElementById("product-short-desc");
  const productScentFamilyEl = document.getElementById(
    "product-scent-family"
  );
  const productScentNotesEl = document.getElementById("product-scent-notes");
  const productLongDescEl = document.getElementById("product-long-desc");
  const productPairingEl = document.getElementById("product-pairing");
  const productImageEl = document.getElementById("product-image");
  const addToCartBtn = document.getElementById("add-to-cart-btn");
  const stockMessageEl = document.getElementById("stock-message");

  const recommendationsGrid = document.getElementById("recommendations-grid");
  const reviewsFormContainer = document.getElementById(
    "add-review-form-container"
  );
  const addReviewForm = document.getElementById("add-review-form");
  const reviewRatingEl = document.getElementById("review-rating");
  const reviewTextEl = document.getElementById("review-text");
  const submitReviewBtn = document.getElementById("submit-review-btn");
  const reviewFormMessage = document.getElementById("review-form-message");
  const reviewFormLoginMessage = document.querySelector(
    "#add-review-form p"
  );
  const reviewsList = document.getElementById("reviews-list");
  const noReviewsMessage = document.getElementById("no-reviews-message");

  let currentProduct = null;
  let currentUserId = null;
  let currentUserEmail = null;

  // Get product ID from URL
  const params = new URLSearchParams(window.location.search);
  const productId = params.get("id");

  if (!productId) {
    productContent.innerHTML =
      '<h1 class="text-center text-3xl font-playfair text-red-600">Product not found.</h1><p class="text-center text-stone mt-4">Please check the URL or go back to the shop.</p>';
    loadingSpinner.style.display = "none";
    productContent.style.display = "block";
  } else {
    // Load product and reviews
    loadProduct(productId);
    loadReviews(productId);

    // Listen for auth changes to unlock review form
    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUserId = user.uid;
        currentUserEmail = user.email; // Or user.displayName if you have it
        // Enable review form
        reviewRatingEl.disabled = false;
        reviewTextEl.disabled = false;
        submitReviewBtn.disabled = false;
        reviewFormLoginMessage.textContent = `You are logged in as ${currentUserEmail}.`;
        reviewFormLoginMessage.classList.add("text-green-600");
      } else {
        currentUserId = null;
        currentUserEmail = null;
        // Disable review form
        reviewRatingEl.disabled = true;
        reviewTextEl.disabled = true;
        submitReviewBtn.disabled = true;
        reviewFormLoginMessage.textContent = "You must be logged in to leave a review.";
        reviewFormLoginMessage.classList.remove("text-green-600");
      }
    });
  }

  // --- DATA LOADING FUNCTIONS ---

  // 1. Load Main Product
  async function loadProduct(id) {
    try {
      const docRef = doc(db, "products", id);
      const docSnap = await getDoc(docRef);

      if (docSnap.exists()) {
        currentProduct = { id: docSnap.id, ...docSnap.data() };
        displayProduct(currentProduct);
        await loadRecommendations(
          currentProduct.scentFamily,
          currentProduct.id
        );
        showProductContent();
      } else {
        showProductError();
      }
    } catch (error) {
      console.error("Error loading product:", error);
      showProductError();
    }
  }

  // 2. Load Recommendations
  async function loadRecommendations(scentFamily, currentProductId) {
    try {
      const q = query(
        collection(db, "products"),
        where("scentFamily", "==", scentFamily),
        where("stock", ">", 0),
        limit(5) // Get 5 products, one might be the current one
      );

      const querySnapshot = await getDocs(q);
      let recommendations = [];
      querySnapshot.forEach((doc) => {
        // Exclude the current product from its own recommendations
        if (doc.id !== currentProductId) {
          recommendations.push({ id: doc.id, ...doc.data() });
        }
      });

      // Ensure we only show 4
      recommendations = recommendations.slice(0, 4);

      if (recommendations.length > 0) {
        recommendationsGrid.innerHTML = ""; // Clear
        recommendations.forEach((prod) => {
          const card = createProductCard(prod);
          recommendationsGrid.appendChild(card);
        });
      } else {
        document.getElementById("recommendations-section").style.display =
          "none";
      }
    } catch (error) {
      console.error("Error loading recommendations:", error);
      document.getElementById("recommendations-section").style.display =
        "none";
    }
  }

  // 3. Load Approved Reviews
  async function loadReviews(id) {
    try {
      const q = query(
        collection(db, "reviews"),
        where("productId", "==", id),
        where("approved", "==", true)
      );

      const querySnapshot = await getDocs(q);
      reviewsList.innerHTML = ""; // Clear

      if (querySnapshot.empty) {
        noReviewsMessage.style.display = "block";
      } else {
        noReviewsMessage.style.display = "none";
        querySnapshot.forEach((doc) => {
          const review = doc.data();
          const reviewCard = createReviewCard(review);
          reviewsList.appendChild(reviewCard);
        });
      }
    } catch (error) {
      console.error("Error loading reviews:", error);
      noReviewsMessage.textContent = "Could not load reviews at this time.";
      noReviewsMessage.style.display = "block";
    }
  }

  // --- UI DISPLAY FUNCTIONS ---

  function displayProduct(prod) {
    productNameEl.textContent = prod.name;
    productPriceEl.textContent = `$${prod.price}`;
    productShortDescEl.textContent = prod.shortDescription;
    productScentFamilyEl.textContent = prod.scentFamily;
    productScentNotesEl.textContent = prod.scentNotes;
    productLongDescEl.innerHTML = prod.longDescription; // Assumes HTML content
    productPairingEl.textContent = prod.pairing;
    productImageEl.src = `/src/${prod.imageUrl}`;
    productImageEl.alt = prod.name;

    // Handle Stock
    if (prod.stock > 0) {
      stockMessageEl.classList.add("hidden");
      addToCartBtn.disabled = false;
      addToCartBtn.textContent = "Add to Cart";
    } else {
      stockMessageEl.classList.remove("hidden");
      addToCartBtn.disabled = true;
      addToCartBtn.textContent = "Out of Stock";
    }
  }

  function createProductCard(prod) {
    const card = document.createElement("a");
    card.href = `/product.html?id=${prod.id}`;
    card.className =
      "group bg-white rounded-lg shadow-lg overflow-hidden transform transition-all duration-300 hover:shadow-2xl";

    card.innerHTML = `
      <div class="relative w-full h-64">
        <img src="/src/${prod.imageUrl}" alt="${prod.name}" class="w-full h-full object-cover">
      </div>
      <div class="p-6">
        <h3 class="font-playfair text-2xl font-semibold text-charcoal group-hover:text-burnt-orange transition-colors">
          ${prod.name}
        </h3>
        <p class="text-stone mt-2">${prod.shortDescription}</p>
        <p class="text-burnt-orange text-xl font-medium mt-4">
          $${prod.price}
        </p>
      </div>
    `;
    return card;
  }

  function createReviewCard(review) {
    const card = document.createElement("div");
    card.className = "border-b border-stone/20 pb-6";

    // Create star rating
    let stars = "";
    for (let i = 0; i < 5; i++) {
      stars += `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ${
        i < review.rating ? "text-burnt-orange" : "text-stone/30"
      }" viewBox="0 0 20 20" fill="currentColor">
          <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.286 3.959a1 1 0 00.95.69h4.162c.969 0 1.371 1.24.588 1.81l-3.368 2.446a1 1 0 00-.364 1.118l1.286 3.959c.3.921-.755 1.688-1.54 1.118l-3.368-2.446a1 1 0 00-1.175 0l-3.368 2.446c-.784.57-1.838-.197-1.54-1.118l1.286-3.959a1 1 0 00-.364-1.118L2.07 9.386c-.783-.57-.38-1.81.588-1.81h4.162a1 1 0 00.95-.69l1.286-3.959z" />
        </svg>`;
    }

    const reviewDate = review.createdAt
      ? review.createdAt.toDate().toLocaleDateString()
      : "Recently";

    card.innerHTML = `
      <div class="flex items-center mb-2">
        <div class="flex">${stars}</div>
        <span class="ml-4 font-medium text-charcoal">${review.userName || "Anonymous"}</span>
      </div>
      <p class="text-stone italic">Reviewed on ${reviewDate}</p>
      <p class="text-charcoal text-lg mt-3">${review.text}</p>
    `;
    return card;
  }

  function showProductContent() {
    loadingSpinner.style.display = "none";
    productContent.style.display = "block";
    reviewsFormContainer.style.display = "block";
  }

  function showProductError() {
    loadingSpinner.style.display = "none";
    productContent.innerHTML =
      '<h1 class="text-center text-3xl font-playfair text-red-600">Product not found.</h1><p class="text-center text-stone mt-4">Please check the URL or go back to the shop.</p>';
    productContent.style.display = "block";
    reviewsFormContainer.style.display = "none";
  }

  // --- EVENT LISTENERS ---

  // Add to Cart
  addToCartBtn.addEventListener("click", () => {
    if (currentProduct) {
      addToCart(
        currentProduct.id,
        currentProduct.name,
        currentProduct.price,
        currentProduct.imageUrl
      );
      // Optional: Show a confirmation message
      addToCartBtn.textContent = "Added!";
      setTimeout(() => {
        addToCartBtn.textContent = "Add to Cart";
      }, 1500);
    }
  });

  // Submit Review
  addReviewForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    if (!currentUserId || !productId) {
      reviewFormMessage.textContent = "You must be logged in to submit.";
      reviewFormMessage.classList.add("text-red-600");
      reviewFormMessage.classList.remove("hidden");
      return;
    }

    submitReviewBtn.disabled = true;
    submitReviewBtn.textContent = "Submitting...";
    reviewFormMessage.classList.add("hidden");

    try {
      const reviewData = {
        productId: productId,
        productName: currentProduct.name,
        userId: currentUserId,
        userName: currentUserEmail, // Using email as name for now
        rating: parseInt(reviewRatingEl.value),
        text: reviewTextEl.value,
        createdAt: Timestamp.now(),
        approved: false, // All reviews must be approved by an admin
      };

      // Add to Firestore
      const docRef = await addDoc(collection(db, "reviews"), reviewData);

      reviewFormMessage.textContent =
        "Review submitted successfully! It will appear once approved by an admin.";
      reviewFormMessage.classList.add("text-green-600");
      reviewFormMessage.classList.remove("text-red-600", "hidden");
      addReviewForm.reset();
    } catch (error)_ {
      console.error("Error submitting review:", error);
      reviewFormMessage.textContent = "Error submitting review. Please try again.";
      reviewFormMessage.classList.add("text-red-600");
      reviewFormMessage.classList.remove("text-green-600", "hidden");
    } finally {
      submitReviewBtn.disabled = false;
      submitReviewBtn.textContent = "Submit Review";
    }
  });
</script>
