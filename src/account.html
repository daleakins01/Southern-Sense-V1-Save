---
layout: layout
title: My Account
---

<script type="module">
    import { 
        auth, 
        db, 
        onAuthStateChanged, 
        collection, 
        query, 
        where, 
        getDocs 
    } from '/firebase-loader.js';
    import { logout } from '/src/auth.js';

    // --- State and Handlers ---
    let currentUser = null;
    let isAdmin = false;
    let userProfile = null; // To store /users/ profile data

    // --- DOM Elements ---
    const accountLoader = document.getElementById('account-loader');
    const accountContent = document.getElementById('account-content');
    const userDisplayName = document.getElementById('user-display-name');
    const adminLink = document.getElementById('admin-link');
    const orderHistoryContainer = document.getElementById('order-history-container');
    const logoutButton = document.getElementById('logout-button');
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');

    // --- Utility Functions ---

    /**
     * Formats a Firebase Timestamp object into a readable date string.
     * @param {Object} timestamp - The Firestore Timestamp object.
     * @returns {string} The formatted date string.
     */
    function formatDate(timestamp) {
        if (!timestamp || !timestamp.toDate) return 'N/A';
        return timestamp.toDate().toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
    }

    // --- Core Logic ---

    /**
     * Fetches and renders the authenticated user's order history.
     * This is the critical function that relies on the 'userId' field
     * added in the updated src/cart.js.
     */
    async function loadOrderHistory() {
        if (!currentUser) return; // Should not happen if guard works, but as a safeguard

        orderHistoryContainer.innerHTML = '<p class="text-stone animate-pulse">Loading orders...</p>';

        try {
            // 1. Query orders collection where 'userId' matches the current user's UID
            const ordersRef = collection(db, 'orders');
            const q = query(ordersRef, where('userId', '==', currentUser.uid));
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                orderHistoryContainer.innerHTML = `
                    <p class="text-stone">You have not placed any orders yet.</p>
                    <a href="/shop/" class="mt-4 inline-block px-6 py-2 bg-burnt-orange text-parchment font-bold rounded-lg hover:bg-burnt-orange/80 transition duration-300">Start Shopping</a>
                `;
                return;
            }

            // 2. Build the orders list HTML
            let orderHtml = `
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-stone/30">
                        <thead>
                            <tr class="text-left text-sm font-medium text-charcoal uppercase tracking-wider">
                                <th class="px-6 py-3">Order #</th>
                                <th class="px-6 py-3">Date</th>
                                <th class="px-6 py-3 text-right">Total</th>
                                <th class="px-6 py-3">Status</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-stone/20">
            `;

            querySnapshot.forEach((doc) => {
                const order = doc.data();
                const orderId = doc.id;
                
                // Get display values
                const formattedDate = formatDate(order.createdAt);
                const total = order.totals.total.toFixed(2);
                const status = order.status; // e.g., 'Paid', 'Pending', 'Shipped'

                // Determine status color
                let statusColor = 'text-stone';
                if (status === 'Paid' || status === 'Shipped') {
                    statusColor = 'text-green-600';
                } else if (status === 'Pending') {
                    statusColor = 'text-burnt-orange';
                }

                orderHtml += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <a href="/order-confirmation/?orderId=${orderId}" class="text-charcoal hover:text-burnt-orange font-medium">...${orderId.slice(-6)}</a>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-stone">${formattedDate}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-charcoal font-semibold text-right">$${total}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-parchment ${statusColor}">
                                ${status}
                            </span>
                        </td>
                    </tr>
                `;
            });

            orderHtml += `
                        </tbody>
                    </table>
                </div>
            `;
            orderHistoryContainer.innerHTML = orderHtml;

        } catch (error) {
            console.error("Error loading order history:", error);
            orderHistoryContainer.innerHTML = '<p class="text-red-600">Could not load order history. Please try again.</p>';
        }
    }


    /**
     * Initializes the account page after authentication.
     * @param {Object} user - The Firebase Auth user object.
     */
    async function initializeAccount(user) {
        currentUser = user;

        // 1. Check Admin Status from the /admins collection
        const adminDoc = await getDocs(query(collection(db, 'admins'), where('__name__', '==', user.uid)));
        isAdmin = !adminDoc.empty;

        // 2. Fetch User Profile for display name
        const userDoc = await getDocs(query(collection(db, 'users'), where('__name__', '==', user.uid)));
        if (!userDoc.empty) {
            userProfile = userDoc.docs[0].data();
        }
        
        // 3. Update Display
        const name = userProfile?.firstName || 'Customer'; // Use firstName if available
        userDisplayName.textContent = `Welcome back, ${name}.`;

        if (isAdmin) {
            // Show Admin link
            adminLink.classList.remove('hidden');
        }

        // 4. Load Order History (The core feature fix)
        loadOrderHistory();

        // 5. Hide loader and show content
        accountLoader.classList.add('hidden');
        accountContent.classList.remove('hidden');
    }

    /**
     * Handles tab switching logic.
     * @param {string} targetId - The ID of the tab content to show.
     */
    function switchTab(targetId) {
        tabContents.forEach(content => {
            content.classList.add('hidden');
            if (content.id === targetId) {
                content.classList.remove('hidden');
            }
        });

        tabButtons.forEach(button => {
            button.classList.remove('bg-burnt-orange', 'text-parchment');
            button.classList.add('text-charcoal', 'hover:bg-parchment/70');
            if (button.getAttribute('data-tab') === targetId) {
                button.classList.add('bg-burnt-orange', 'text-parchment');
                button.classList.remove('text-charcoal', 'hover:bg-parchment/70');
            }
        });
    }

    // --- Event Listeners and Initializers ---

    document.addEventListener('DOMContentLoaded', () => {
        // Tab switching setup
        tabButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                const targetId = e.target.getAttribute('data-tab');
                switchTab(targetId);
            });
        });
        
        // Initial state: show the first tab (Dashboard)
        switchTab('tab-dashboard');

        // Logout listener
        if (logoutButton) {
            logoutButton.addEventListener('click', (e) => {
                e.preventDefault();
                logout().then(() => {
                    window.location.href = '/login/';
                }).catch(error => {
                    console.error("Logout failed:", error);
                    alert("Logout failed. Please try again.");
                });
            });
        }

        // Authentication State Listener (Security Guard)
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in. Proceed to initialize.
                initializeAccount(user);
            } else {
                // User is signed out. Redirect to login.
                window.location.href = '/login/';
            }
        });
    });

</script>

<main class="container mx-auto px-4 py-12 min-h-screen">
    <div id="account-loader" class="flex justify-center items-center h-64">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-charcoal"></div>
    </div>

    <div id="account-content" class="hidden">
        <h1 class="text-4xl font-playfair text-charcoal mb-8" id="user-display-name">Welcome back.</h1>

        <div class="flex flex-col lg:flex-row gap-8">
            <div class="lg:w-1/4">
                <nav class="bg-parchment p-4 rounded-lg shadow-md sticky top-6">
                    <button data-tab="tab-dashboard" class="tab-button w-full text-left p-3 rounded-lg font-medium transition duration-150 ease-in-out bg-burnt-orange text-parchment">
                        Account Dashboard
                    </button>
                    <button data-tab="tab-orders" class="tab-button w-full text-left p-3 mt-2 rounded-lg font-medium transition duration-150 ease-in-out text-charcoal hover:bg-parchment/70">
                        Order History
                    </button>
                    <button data-tab="tab-settings" class="tab-button w-full text-left p-3 mt-2 rounded-lg font-medium transition duration-150 ease-in-out text-charcoal hover:bg-parchment/70">
                        Account Settings
                    </button>
                    <a id="admin-link" href="/admin/" class="hidden w-full text-left p-3 mt-4 rounded-lg font-bold text-parchment bg-stone hover:bg-stone/80 transition duration-150 ease-in-out block">
                        Admin Panel Access &rarr;
                    </a>
                    <button id="logout-button" class="w-full text-left p-3 mt-4 rounded-lg font-medium text-red-600 hover:bg-red-50/50 transition duration-150 ease-in-out">
                        Log Out
                    </button>
                </nav>
            </div>

            <div class="lg:w-3/4 bg-white p-6 rounded-lg shadow-md">
                
                <div id="tab-dashboard" class="tab-content">
                    <h2 class="text-3xl font-playfair text-charcoal mb-4 border-b pb-2">Your Dashboard</h2>
                    <p class="text-stone mb-6">A quick overview of your account activity.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="p-4 bg-parchment/50 rounded-lg shadow-inner">
                            <h3 class="text-xl font-medium text-charcoal">Total Orders</h3>
                            <p id="total-orders-count" class="text-4xl font-bold text-burnt-orange mt-2">--</p>
                            <p class="text-sm text-stone mt-1">Orders placed to date.</p>
                        </div>
                        
                        <div class="p-4 bg-parchment/50 rounded-lg shadow-inner">
                            <h3 class="text-xl font-medium text-charcoal">Last Order</h3>
                            <p id="last-order-date" class="text-2xl font-bold text-stone mt-2">N/A</p>
                            <p class="text-sm text-burnt-orange mt-1">
                                <a href="#" class="hover:underline">View details</a>
                            </p>
                        </div>

                        <div class="p-4 bg-parchment/50 rounded-lg shadow-inner">
                            <h3 class="text-xl font-medium text-charcoal">Loyalty Tier</h3>
                            <p class="text-2xl font-bold text-stone mt-2">Bronze</p>
                            <p class="text-sm text-burnt-orange mt-1">50 points until Silver.</p>
                        </div>
                    </div>

                    <div class="mt-8">
                        <h3 class="text-2xl font-playfair text-charcoal mb-3">Quick Links</h3>
                        <ul class="list-disc list-inside text-stone space-y-2">
                            <li><a href="/shop/" class="text-burnt-orange hover:text-charcoal transition">Shop All Products</a></li>
                            <li><a href="/scent-quiz/" class="text-burnt-orange hover:text-charcoal transition">Take the Scent Quiz</a></li>
                        </ul>
                    </div>
                </div>

                <div id="tab-orders" class="tab-content hidden">
                    <h2 class="text-3xl font-playfair text-charcoal mb-6 border-b pb-2">Your Order History</h2>
                    <div id="order-history-container">
                        </div>
                </div>

                <div id="tab-settings" class="tab-content hidden">
                    <h2 class="text-3xl font-playfair text-charcoal mb-6 border-b pb-2">Account Settings</h2>
                    <form id="profile-update-form" class="space-y-6">
                        <div class="bg-parchment p-4 rounded-lg">
                            <p class="text-stone italic">Profile update functionality is coming soon. For now, this section serves as a placeholder for managing your personal details, shipping addresses, and communication preferences.</p>
                        </div>
                        
                        <div>
                            <label for="current-email" class="block text-sm font-medium text-stone mb-1">Registered Email Address</label>
                            <input type="email" id="current-email" value="loading..." readonly class="w-full p-3 border border-stone/30 rounded-lg bg-gray-50 text-charcoal">
                        </div>
                        
                        <div>
                            <button type="button" class="px-4 py-2 bg-stone text-parchment font-semibold rounded-lg hover:bg-stone/80 transition duration-300">
                                Change Password
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</main>