---
layout: layout.html
title: Find Your Perfect Scent
---

<header class="relative w-full h-80 bg-cover bg-center" style="background-image: url('/src/candles-header.webp');">
    <div class="absolute inset-0 bg-charcoal/40 flex items-center justify-center">
        <h1 class="font-playfair text-6xl font-extrabold text-parchment drop-shadow-lg">Find Your Perfect Scent</h1>
    </div>
</header>

<main class="container mx-auto p-4 lg:p-8 py-16">
    <div class="max-w-3xl mx-auto bg-parchment p-8 rounded-xl shadow-2xl border border-stone/10">

        <div id="quiz-container">
            <h2 id="quiz-title" class="font-playfair text-4xl font-bold text-charcoal text-center mb-6">Let's Begin</h2>
            <p id="progress-text" class="text-center font-roboto text-sm text-stone mb-8">Step 0 of 3</p>

            <form id="scent-quiz-form-container"> 
                
                <div id="step-0" class="quiz-step">
                    <p class="text-center text-lg text-stone mb-8">Answer a few quick questions to discover the scent family that best matches your personal sanctuary.</p>
                    <button type="button" data-next-step="1" class="w-full py-3 bg-burnt-orange text-parchment font-playfair text-lg font-bold rounded-lg shadow-md hover:bg-opacity-90 transition duration-150 start-quiz-button">
                        Start Quiz
                    </button>
                </div>

                <div id="step-1" class="quiz-step hidden">
                    <h3 class="font-playfair text-2xl font-bold text-charcoal mb-4">1. How do you want to feel right now?</h3>
                    <div class="space-y-3">
                        <label class="block p-3 border border-stone/30 rounded-lg hover:bg-white cursor-pointer"><input type="radio" name="q1" value="calm" class="mr-3 accent-burnt-orange" required> Cozy & Calm (E.g., Sunday morning)</label>
                        <label class="block p-3 border border-stone/30 rounded-lg hover:bg-white cursor-pointer"><input type="radio" name="q1" value="uplifted" class="mr-3 accent-burnt-orange"> Refreshed & Uplifted (E.g., Spring break)</label>
                        <label class="block p-3 border border-stone/30 rounded-lg hover:bg-white cursor-pointer"><input type="radio" name="q1" value="warm" class="mr-3 accent-burnt-orange"> Warm & Inviting (E.g., Dinner party)</label>
                    </div>
                    <button type="button" data-next-step="2" class="mt-6 w-full py-3 bg-burnt-orange text-parchment font-bold rounded-lg transition duration-150 next-step-button">Next &rarr;</button>
                </div>

                <div id="step-2" class="quiz-step hidden">
                    <h3 class="font-playfair text-2xl font-bold text-charcoal mb-4">2. Which environment do you prefer?</h3>
                    <div class="space-y-3">
                        <label class="block p-3 border border-stone/30 rounded-lg hover:bg-white cursor-pointer"><input type="radio" name="q2" value="nature" class="mr-3 accent-burnt-orange" required> A deep forest after the rain</label>
                        <label class="block p-3 border border-stone/30 rounded-lg hover:bg-white cursor-pointer"><input type="radio" name="q2" value="bakery" class="mr-3 accent-burnt-orange"> A gourmet bakery full of fresh pastry</label>
                        <label class="block p-3 border border-stone/30 rounded-lg hover:bg-white cursor-pointer"><input type="radio" name="q2" value="patio" class="mr-3 accent-burnt-orange"> A sun-drenched coastal patio</label>
                    </div>
                    <button type="button" data-next-step="3" class="mt-6 w-full py-3 bg-burnt-orange text-parchment font-bold rounded-lg transition duration-150 next-step-button">Next &rarr;</button>
                </div>

                <div id="step-3" class="quiz-step hidden">
                    <h3 class="font-playfair text-2xl font-bold text-charcoal mb-4">3. What's your ideal dessert?</h3>
                    <div class="space-y-3">
                        <label class="block p-3 border border-stone/30 rounded-lg hover:bg-white cursor-pointer"><input type="radio" name="q3" value="citrus" class="mr-3 accent-burnt-orange" required> Bright, fresh lemon meringue pie</label>
                        <label class="block p-3 border border-stone/30 rounded-lg hover:bg-white cursor-pointer"><input type="radio" name="q3" value="wood" class="mr-3 accent-burnt-orange"> A rich, dark chocolate truffle</label>
                        <label class="block p-3 border border-stone/30 rounded-lg hover:bg-white cursor-pointer"><input type="radio" name="q3" value="spice" class="mr-3 accent-burnt-orange"> Gingerbread cookies with cinnamon frosting</label>
                    </div>
                    <button type="submit" id="submit-quiz-button" class="mt-6 w-full py-3 bg-burnt-orange text-parchment font-playfair text-lg font-bold rounded-lg transition duration-150">
                        Show My Scent
                    </button>
                </div>
            </form>

            <div id="result-step" class="quiz-step hidden text-center">
                <h2 class="font-playfair text-3xl font-bold text-charcoal mb-4">Your Perfect Match:</h2>
                <div id="result-display" class="bg-white p-6 rounded-lg shadow-inner mb-6 space-y-3">
                    <div id="loading-result" class="space-y-3">
                        <p class="font-roboto text-stone text-lg">Analyzing your preferences...</p>
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-burnt-orange mx-auto"></div>
                    </div>
                    <h3 id="result-family-title" class="font-playfair text-4xl font-extrabold text-burnt-orange hidden"></h3>
                    <p id="result-description" class="font-roboto text-lg text-stone hidden"></p>
                </div>
                <a id="result-link" href="/shop/" class="inline-block py-3 px-8 bg-burnt-orange text-parchment font-bold rounded-lg shadow-md hover:bg-amber-700 transition duration-150 hidden">
                    Shop This Scent Family &rarr;
                </a>
            </div>
        </div>
    </div>
</main>

<script type="module">
    // FIX: Corrected import path to include /src/ directory
    import { db, collection, query, where, getDocs } from '/src/firebase-loader.js'; 

    // --- State & DOM ---
    let currentStep = 0;
    const TOTAL_STEPS = 4; // Total number of logical steps (0, 1, 2, 3, 4=Result)
    const QUIZ_QUESTION_COUNT = 3; // The number of questions (1, 2, 3)
    const quizContainer = document.getElementById('quiz-container');
    const quizTitle = document.getElementById('quiz-title');
    const progressText = document.getElementById('progress-text');
    // FIX: Renamed form to match HTML
    const formContainer = document.getElementById('scent-quiz-form-container'); 
    const resultStep = document.getElementById('result-step'); 
    const loadingResult = document.getElementById('loading-result');
    const resultFamilyTitle = document.getElementById('result-family-title');
    const resultDescription = document.getElementById('result-description');
    const resultLink = document.getElementById('result-link');
    
    // Maps quiz answers to weighted scent family preferences
    const scentWeights = {
        'calm': { 'woodsy': 2, 'fresh-clean': 1, 'spicy': 1 },
        'uplifted': { 'citrus': 3, 'floral': 2, 'fresh-clean': 1 },
        'warm': { 'spicy': 3, 'gourmand': 2, 'woodsy': 1 },
        'nature': { 'fresh-clean': 3, 'woodsy': 2, 'green': 1 },
        'bakery': { 'gourmand': 4, 'spicy': 2, 'vanilla': 1 },
        'patio': { 'aquatic': 3, 'citrus': 2, 'floral': 1 },
        'citrus': { 'citrus': 4, 'fruity-sweet': 2, 'fresh-clean': 1 },
        'wood': { 'woodsy': 4, 'spicy': 2, 'leather': 1 },
        'spice': { 'spicy': 4, 'gourmand': 2, 'warm-amber': 1 }
    };

    let answerTally = {};

    // --- Quiz Navigation ---

    /**
     * Hides all steps and shows the current step/result.
     */
    function showStep(stepNumber) {
        // 1. Hide all elements with the class .quiz-step
        document.querySelectorAll('.quiz-step').forEach(step => {
            step.classList.add('hidden');
        });
        
        // 2. Handle result step separately (Step 4)
        if (stepNumber === TOTAL_STEPS) {
            resultStep.classList.remove('hidden');
            formContainer.classList.add('hidden'); // Hide the question container
            quizTitle.textContent = "Your Recommendation";
            progressText.classList.add('hidden'); 
            return;
        }

        // 3. Handle question steps (Step 0 to 3)
        const stepElement = document.getElementById(`step-${stepNumber}`);
        // FIX: The original crash happened because there was no element with ID 'step-4'
        if (stepElement) {
            stepElement.classList.remove('hidden');
        }
        
        // Show the form container if we are in a question step
        formContainer.classList.remove('hidden');
        
        currentStep = stepNumber;
        progressText.classList.remove('hidden');
        
        if (stepNumber === 0) {
            quizTitle.textContent = "Let's Begin";
            progressText.textContent = "Welcome"; 
        } else if (stepNumber > 0 && stepNumber <= QUIZ_QUESTION_COUNT) {
            quizTitle.textContent = "Find Your Perfect Scent";
            progressText.textContent = `Step ${currentStep} of ${QUIZ_QUESTION_COUNT}`;
        }
    }

    /**
     * Collects answers from the current step and moves to the next.
     */
    function handleNextStep(e) {
        // Validation check is ONLY necessary if we are past the welcome screen (currentStep > 0)
        if (currentStep > 0) {
            const currentStepEl = document.getElementById(`step-${currentStep}`);
            const checkedInput = currentStepEl.querySelector('input[type="radio"]:checked');
            
            if (!checkedInput) {
                alert('Please select an option to continue.');
                return;
            }

            // Tally the answer weight for the completed step
            const answerValue = checkedInput.value;
            const weights = scentWeights[answerValue];
            for (const scent in weights) {
                answerTally[scent] = (answerTally[scent] || 0) + weights[scent];
            }
        }

        // Proceed to the next step based on the button's data attribute
        const nextStep = parseInt(e.currentTarget.dataset.nextStep);
        showStep(nextStep);
    }
    
    // --- Result Calculation ---

    /**
     * Determines the top-voted scent family and displays the result.
     */
    async function calculateResult(e) {
        e.preventDefault();
        
        // Final validation for the last question (Step 3)
        const currentStepEl = document.getElementById(`step-3`);
        const checkedInput = currentStepEl.querySelector('input[type="radio"]:checked');
        
        if (!checkedInput) {
            alert('Please select an option to continue.');
            return;
        }

        // Tally the final answer
        const answerValue = checkedInput.value;
        const weights = scentWeights[answerValue];
        for (const scent in weights) {
            answerTally[scent] = (answerTally[scent] || 0) + weights[scent];
        }

        // Show result step and loading state
        showStep(TOTAL_STEPS); 
        
        loadingResult.classList.remove('hidden');
        resultFamilyTitle.classList.add('hidden');
        resultDescription.classList.add('hidden');
        resultLink.classList.add('hidden');

        // 1. Determine the top scent family
        let topScent = null;
        let maxWeight = 0;
        for (const scent in answerTally) {
            if (answerTally[scent] > maxWeight) {
                maxWeight = answerTally[scent];
                topScent = scent;
            }
        }

        if (!topScent) {
            topScent = 'woodsy'; // Default fallback
        }

        // Display results
        const readableScent = topScent.charAt(0).toUpperCase() + topScent.slice(1).replace(/-/g, ' ');
        resultFamilyTitle.textContent = readableScent;
        // The link filters the shop by the determined scent family ID
        resultLink.href = `/shop/?family=${topScent}`; 

        // 2. Final Display (simulating async loading)
        setTimeout(() => {
            resultDescription.textContent = `Based on your answers, the ${readableScent} family, known for its strong connection to nature and comforting notes, is your ideal match. Click below to explore all scents in this family!`;
            loadingResult.classList.add('hidden');
            resultFamilyTitle.classList.remove('hidden');
            resultDescription.classList.remove('hidden');
            resultLink.classList.remove('hidden');
        }, 1000); // 1-second delay for dramatic effect
    }

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        // Initial setup
        showStep(0); 
        
        // Attach listeners for next buttons
        document.querySelectorAll('.next-step-button').forEach(button => {
            button.addEventListener('click', handleNextStep);
        });

        // Attach listener for the start button
        document.querySelector('.start-quiz-button').addEventListener('click', handleNextStep);

        // Attach listener for the final form submission
        formContainer.addEventListener('submit', calculateResult);
    });
</script>