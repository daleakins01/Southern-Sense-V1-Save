---
layout: layout
title: Admin Panel
---

<script type="module">
    import { 
        auth, 
        db, 
        onAuthStateChanged, 
        collection, 
        query, 
        getDocs, 
        where, 
        doc, 
        getDoc, 
        updateDoc,
        deleteDoc, 
        signOut,
        serverTimestamp // CRITICAL FIX: Ensure serverTimestamp is imported here
    } from '/src/firebase-loader.js';
    import { logout } from '/src/auth.js';
    
    // --- State and Handlers ---
    let currentUser = null;
    let isAdmin = false;
    let currentOrders = [];
    let currentProducts = [];
    let currentReviews = [];
    let currentAlerts = [];
    let siteContent = {}; 

    // --- DOM Elements ---
    const adminLoader = document.getElementById('admin-loader');
    const adminContent = document.getElementById('admin-content');
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');

    // Orders Tab Elements
    const ordersTableBody = document.getElementById('orders-table-body');
    const ordersMessage = document.getElementById('orders-message');
    
    // Products Tab Elements
    const productsTableBody = document.getElementById('products-table-body');
    const productsMessage = document.getElementById('products-message');
    const productEditModal = document.getElementById('product-edit-modal');
    const closeModalButton = document.getElementById('close-modal-button');
    const productEditForm = document.getElementById('product-edit-form');
    
    // Reviews Tab Elements
    const reviewsContainer = document.getElementById('reviews-container');
    const reviewsMessage = document.getElementById('reviews-message');
    const pendingReviewsCount = document.getElementById('pending-reviews-count');
    
    // Stock Alerts Tab Elements
    const stockAlertsContainer = document.getElementById('stock-alerts-container');
    const stockAlertsMessage = document.getElementById('stock-alerts-message');
    const totalStockAlertsCount = document.getElementById('total-stock-alerts-count');
    
    // Site Content Tab Elements
    const contentTabsContainer = document.getElementById('content-tabs-container');
    const siteContentForm = document.getElementById('site-content-form');
    const contentSaveMessage = document.getElementById('content-save-message');


    // --- Utility Functions ---
    
    function formatDate(timestamp) {
        if (!timestamp || !timestamp.toDate) return 'N/A';
        return timestamp.toDate().toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'short',
            day: 'numeric'
        });
    }

    function renderStars(rating) {
        let stars = '';
        for (let i = 0; i < 5; i++) {
            stars += `<span class="${i < rating ? 'text-burnt-orange' : 'text-stone/40'} text-xl">&starf;</span>`;
        }
        return stars;
    }

    function getStatusClasses(status) {
        switch (status) {
            case 'Paid':
                return 'bg-green-100 text-green-800';
            case 'Shipped':
                return 'bg-blue-100 text-blue-800';
            case 'Pending':
                return 'bg-yellow-100 text-yellow-800';
            case 'Cancelled':
                return 'bg-red-100 text-red-800';
            default:
                return 'bg-gray-100 text-gray-800';
        }
    }

    // --- Core Admin Logic: Orders Tab ---
    
    async function fetchAllOrders() {
        ordersMessage.textContent = 'Loading all customer orders...';
        ordersMessage.classList.remove('hidden', 'text-red-600');
        ordersTableBody.innerHTML = '';
        currentOrders = [];

        try {
            const ordersRef = collection(db, 'orders');
            // FIX: Using query without orderBy because Firestore Rules only allow ordering by fields with indexes
            const q = query(ordersRef); 
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                ordersMessage.textContent = 'No orders found in the database.';
                ordersMessage.classList.remove('hidden');
                return;
            }

            querySnapshot.forEach(doc => {
                const order = doc.data();
                order.id = doc.id;
                currentOrders.push(order);
            });

            // Sort by date, newest first (client-side sort for performance on small dataset)
            currentOrders.sort((a, b) => b.createdAt?.toDate() - a.createdAt?.toDate());
            
            renderOrdersTable();
            ordersMessage.classList.add('hidden');

        } catch (error) {
            console.error("Error fetching all orders:", error);
            ordersMessage.textContent = 'Error fetching orders. Check console for details.';
            ordersMessage.classList.remove('hidden');
            ordersTableBody.innerHTML = '';
        }
    }
    
    function renderOrdersTable() {
        ordersTableBody.innerHTML = '';
        
        currentOrders.forEach(order => {
            const orderIdDisplay = order.id.slice(-6);
            const statusClasses = getStatusClasses(order.status);
            const formattedDate = formatDate(order.createdAt);
            // Ensure totals.total exists before accessing toFixed
            const total = order.totals?.total ? order.totals.total.toFixed(2) : 'N/A';
            
            const customerName = order.customer?.firstName ? 
                                 `${order.customer.firstName} ${order.customer.lastName}` : 
                                 'Guest Checkout';
            const customerEmail = order.email || order.customer?.email || 'N/A';

            const row = document.createElement('tr');
            row.className = 'hover:bg-parchment/50 transition duration-150';
            row.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-charcoal">
                    <a href="/order-confirmation/?orderId=${order.id}" target="_blank" class="hover:text-burnt-orange transition">...${orderIdDisplay}</a>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-stone">
                    ${formattedDate}
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-charcoal">
                    $${total}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusClasses}">
                        ${order.status}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm text-charcoal">
                    ${customerName}<br>
                    <span class="text-xs text-stone">${customerEmail}</span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                    <button data-id="${order.id}" data-status="${order.status}" class="view-order-details text-burnt-orange hover:text-stone transition duration-150">
                        Details
                    </button>
                </td>
            `;
            ordersTableBody.appendChild(row);
        });
        
        document.querySelectorAll('.view-order-details').forEach(button => {
            button.addEventListener('click', (e) => {
                const orderId = e.target.dataset.id;
                viewOrderDetailsModal(orderId);
            });
        });
        
        const totalOrdersCount = document.getElementById('total-orders-count');
        if(totalOrdersCount) {
            totalOrdersCount.textContent = currentOrders.length;
        }
    }
    
    function viewOrderDetailsModal(orderId) {
        const order = currentOrders.find(o => o.id === orderId);
        if (!order) {
            alert("Order details not found!");
            return;
        }
        
        const details = `
            Order ID: ${order.id}\n
            Date: ${formatDate(order.createdAt)}\n
            Status: ${order.status}\n
            Customer: ${order.customer?.firstName || 'Guest'} ${order.customer?.lastName || ''}\n
            Email: ${order.email}\n
            Total: $${order.totals.total.toFixed(2)}\n
            \n--- Items ---\n
            ${order.items.map(item => `${item.quantity}x ${item.name} ($${parseFloat(item.price).toFixed(2)})`).join('\n')}
            \n--- Shipping ---\n
            ${order.customer?.address || 'N/A'}\n
            ${order.customer?.city || ''}, ${order.customer?.state || ''} ${order.customer?.zip || ''}
        `;
        alert(details); 
    }


    // --- Core Admin Logic: Products Tab ---

    async function fetchAllProducts() {
        productsMessage.textContent = 'Loading product catalog...';
        productsMessage.classList.remove('hidden', 'text-red-600');
        productsTableBody.innerHTML = '';
        currentProducts = [];
        
        try {
            const productsRef = collection(db, 'products');
            // FIX: Ensure products are fetched without unnecessary sorting, will sort client-side
            const q = query(productsRef);
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                productsMessage.textContent = 'No products found in the database.';
                return;
            }

            querySnapshot.forEach(doc => {
                const product = doc.data();
                product.price = parseFloat(product.price); 
                product.id = doc.id; // Ensure ID is attached
                currentProducts.push(product);
            });

            currentProducts.sort((a, b) => a.name.localeCompare(b.name));
            
            renderProductsTable();
            productsMessage.classList.add('hidden'); 

        } catch (error) {
            console.error("Error fetching all products:", error);
            productsMessage.textContent = 'Error fetching products. Check console for details.';
            productsMessage.classList.remove('hidden');
        }
    }

    function renderProductsTable() {
        productsTableBody.innerHTML = '';
        
        currentProducts.forEach(product => {
            const stockColor = product.stock > 10 ? 'text-green-600' : 
                               product.stock > 0 ? 'text-burnt-orange' : 'text-red-600';
            const featuredTag = product.featured ? '<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">Featured</span>' : '';

            const row = document.createElement('tr');
            row.className = 'hover:bg-parchment/50 transition duration-150';
            row.innerHTML = `
                <td class="px-6 py-4 text-sm font-medium text-charcoal">
                    <a href="/product/?id=${product.id}" target="_blank" class="hover:text-burnt-orange transition">${product.name}</a>
                </td>
                <td class="px-6 py-4 text-sm text-stone">${product.scentFamily}</td>
                <td class="px-6 py-4 text-sm font-medium text-charcoal">$${product.price.toFixed(2)}</td>
                <td class="px-6 py-4 text-sm font-medium ${stockColor}">
                    ${product.stock}
                </td>
                <td class="px-6 py-4 text-sm">
                    ${featuredTag}
                </td>
                <td class="px-6 py-4 text-right text-sm font-medium">
                    <button data-id="${product.id}" class="edit-product text-burnt-orange hover:text-stone transition duration-150">
                        Edit
                    </button>
                </td>
            `;
            productsTableBody.appendChild(row);
        });
        
        document.querySelectorAll('.edit-product').forEach(button => {
            button.addEventListener('click', (e) => {
                const productId = e.target.dataset.id;
                openProductEditModal(productId);
            });
        });
        
        const lowStockCount = currentProducts.filter(p => p.stock > 0 && p.stock <= 10).length;
        const lowStockEl = document.getElementById('low-stock-count');
        if(lowStockEl) {
            lowStockEl.textContent = lowStockCount;
        }
    }

    async function openProductEditModal(productId) {
        const product = currentProducts.find(p => p.id === productId);
        if (!product) {
            alert("Product not found!");
            return;
        }

        document.getElementById('edit-product-id').value = productId;
        document.getElementById('edit-product-name').value = product.name;
        document.getElementById('edit-price').value = product.price.toFixed(2);
        document.getElementById('edit-stock').value = product.stock;
        document.getElementById('edit-featured').checked = product.featured;
        document.getElementById('edit-scent-family').value = product.scentFamily;
        document.getElementById('edit-category').value = product.category;
        
        productEditModal.classList.remove('hidden');
    }

    async function handleProductUpdate(e) {
        e.preventDefault();
        
        const productId = document.getElementById('edit-product-id').value;
        const updateButton = e.submitter;
        updateButton.disabled = true;
        updateButton.textContent = 'Saving...';
        
        try {
            const formData = new FormData(productEditForm);
            
            const updateData = {
                name: formData.get('name'),
                price: parseFloat(formData.get('price')).toFixed(2), 
                stock: parseInt(formData.get('stock'), 10),
                scentFamily: formData.get('scentFamily'),
                category: formData.get('category'),
                featured: formData.get('featured') === 'on' 
            };

            const productRef = doc(db, 'products', productId);
            await updateDoc(productRef, updateData);

            alert(`${updateData.name} updated successfully!`);
            productEditModal.classList.add('hidden');
            
            await fetchAllProducts();

        } catch (error) {
            console.error("Error updating product:", error);
            alert("Error updating product. Please check the console.");
        } finally {
            updateButton.disabled = false;
            updateButton.textContent = 'Save Changes';
        }
    }
    
    // --- Core Admin Logic: Reviews Tab ---

    async function fetchAllReviews() {
        reviewsMessage.textContent = 'Loading reviews...';
        reviewsMessage.classList.remove('hidden', 'text-red-600');
        reviewsContainer.innerHTML = '';
        currentReviews = [];

        try {
            const reviewsRef = collection(db, 'reviews');
            const q = query(reviewsRef);
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                reviewsMessage.textContent = 'No reviews found in the database.';
                pendingReviewsCount.textContent = 0;
                return;
            }

            querySnapshot.forEach(doc => {
                const review = doc.data();
                review.id = doc.id;
                currentReviews.push(review);
            });
            
            currentReviews.sort((a, b) => {
                // Prioritize unapproved reviews first
                if (a.approved !== b.approved) {
                    return a.approved ? 1 : -1;
                }
                // Then sort by date, newest first
                const dateA = a.submittedAt?.toDate() || new Date(0); 
                const dateB = b.submittedAt?.toDate() || new Date(0); 
                return dateB - dateA;
            });

            renderReviewsList();
            reviewsMessage.classList.add('hidden'); 

        } catch (error) {
            console.error("Error fetching all reviews:", error);
            reviewsMessage.textContent = 'Error fetching reviews. Check console for details.';
            reviewsMessage.classList.remove('hidden');
        }
    }
    
    function renderReviewsList() {
        reviewsContainer.innerHTML = '';
        const pendingCount = currentReviews.filter(r => r.approved === false).length;
        pendingReviewsCount.textContent = pendingCount;
        
        currentReviews.forEach(review => {
            const isPending = review.approved === false;
            
            const reviewDate = review.submittedAt ? formatDate(review.submittedAt) : 'N/A';
            const productName = review.productName || 'Unknown Product';
            
            const cardClass = isPending ? 'border-burnt-orange border-l-4 bg-parchment/70' : 'border-stone/20 border bg-white';
            const actionButton = isPending 
                ? `<button data-id="${review.id}" class="approve-review px-4 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition">Approve</button>`
                : `<button data-id="${review.id}" class="unapprove-review px-4 py-2 bg-stone text-parchment rounded-lg font-semibold hover:bg-stone/80 transition">Unapprove</button>`;

            const reviewHtml = `
                <div class="p-6 rounded-lg shadow-md ${cardClass} mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <div class="flex items-center space-x-2">
                            <span class="text-lg font-bold text-charcoal">${review.name || 'Anonymous'}</span>
                            <span class="text-sm text-stone">| ${reviewDate}</span>
                            <span class="text-sm text-stone font-semibold">| Product: ${productName}</span>
                        </div>
                        <div class="text-lg">
                            ${renderStars(review.rating)}
                        </div>
                    </div>
                    <p class="text-stone mb-4">${review.text}</p>
                    
                    <div class="flex justify-between items-center border-t pt-4">
                        <div>
                            ${actionButton}
                        </div>
                        <button data-id="${review.id}" class="delete-review text-red-600 hover:text-red-800 transition">Delete Permanently</button>
                    </div>
                </div>
            `;
            reviewsContainer.innerHTML += reviewHtml;
        });
        
        attachReviewListeners();
    }
    
    function attachReviewListeners() {
        document.querySelectorAll('.approve-review').forEach(button => {
            button.addEventListener('click', (e) => updateReviewStatus(e.target.dataset.id, true));
        });
        document.querySelectorAll('.unapprove-review').forEach(button => {
            button.addEventListener('click', (e) => updateReviewStatus(e.target.dataset.id, false));
        });
        document.querySelectorAll('.delete-review').forEach(button => {
            button.addEventListener('click', (e) => deleteReview(e.target.dataset.id));
        });
    }

    async function updateReviewStatus(reviewId, approvedStatus) {
        const reviewRef = doc(db, 'reviews', reviewId);
        
        try {
            const updateFields = { 
                approved: approvedStatus,
                // CRITICAL FIX: Ensure serverTimestamp is called and correctly used here
                moderatedAt: serverTimestamp() 
            };
            
            const reviewDoc = await getDoc(reviewRef);
            let productName = "Unknown Product";
            if(reviewDoc.exists() && reviewDoc.data().productName) {
                 productName = reviewDoc.data().productName;
            }
            
            await updateDoc(reviewRef, updateFields);
            
            const statusText = approvedStatus ? 'Approved' : 'Unapproved';
            alert(`Review for ${productName} successfully ${statusText.toLowerCase()}.`);
            
            await fetchAllReviews();
            
        } catch (error) {
            console.error(`Error updating review status to ${approvedStatus}:`, error);
            alert("Failed to update review status. Check console.");
        }
    }
    
    async function deleteReview(reviewId) {
        if (!confirm("Are you sure you want to permanently delete this review? This action cannot be undone.")) {
            return;
        }
        
        const reviewRef = doc(db, 'reviews', reviewId);
        
        try {
            await deleteDoc(reviewRef);
            alert(`Review ${reviewId.slice(-6)} deleted successfully.`);
            await fetchAllReviews();
        } catch (error) {
            console.error("Error deleting review:", error);
            alert("Failed to delete review. Check console.");
        }
    }
    
    // --- Core Admin Logic: Stock Alerts Tab ---

    async function fetchStockAlerts() {
        stockAlertsMessage.textContent = 'Loading back-in-stock requests...';
        stockAlertsMessage.classList.remove('hidden', 'text-red-600');
        stockAlertsContainer.innerHTML = '';
        currentAlerts = [];

        try {
            const alertsRef = collection(db, 'backInStockRequests');
            const q = query(alertsRef); 
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                stockAlertsMessage.textContent = 'No pending stock alerts found. Good job!';
                totalStockAlertsCount.textContent = 0;
                return;
            }

            querySnapshot.forEach(doc => {
                const alert = doc.data();
                alert.id = doc.id;
                currentAlerts.push(alert);
            });
            
            // Sort by request date, oldest first (client-side sort for smaller dataset)
            currentAlerts.sort((a, b) => a.requestedAt?.toDate() - b.requestedAt?.toDate());

            renderStockAlertsList();
            stockAlertsMessage.classList.add('hidden'); 

        } catch (error) {
            console.error("Error fetching stock alerts:", error);
            stockAlertsMessage.textContent = 'Error fetching stock alerts. Check console for details.';
            stockAlertsMessage.classList.remove('hidden');
        }
    }
    
    function renderStockAlertsList() {
        stockAlertsContainer.innerHTML = '';
        totalStockAlertsCount.textContent = currentAlerts.length;
        
        currentAlerts.forEach(alert => {
            const formattedDate = alert.requestedAt ? formatDate(alert.requestedAt) : 'N/A';

            const alertHtml = `
                <div class="p-4 rounded-lg shadow-md border-l-4 border-burnt-orange bg-parchment/70 mb-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-lg font-playfair text-charcoal font-semibold">${alert.productName}</p>
                            <p class="text-sm text-stone">Requested on: ${formattedDate}</p>
                        </div>
                        <a href="mailto:${alert.email}" class="px-3 py-1 bg-stone text-parchment rounded-full text-sm font-semibold hover:bg-stone/80 transition">
                            Email Customer
                        </a>
                    </div>
                    
                    <p class="text-sm text-charcoal mt-2">
                        Customer Email: <span class="font-medium">${alert.email}</span>
                    </p>
                    
                    <div class="mt-4 pt-3 border-t">
                        <button data-id="${alert.id}" class="resolve-alert px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-semibold hover:bg-green-700 transition">
                            Mark as Resolved (Stock Replenished)
                        </button>
                    </div>
                </div>
            `;
            stockAlertsContainer.innerHTML += alertHtml;
        });
        
        attachAlertListeners();
    }
    
    function attachAlertListeners() {
        document.querySelectorAll('.resolve-alert').forEach(button => {
            button.addEventListener('click', (e) => resolveAlert(e.target.dataset.id));
        });
    }

    async function resolveAlert(alertId) {
        if (!confirm("Are you sure you want to mark this alert as RESOLVED and remove it from the list? Ensure the customer has been notified.")) {
            return;
        }
        
        const alertRef = doc(db, 'backInStockRequests', alertId);
        
        try {
            await deleteDoc(alertRef); 
            
            const product = currentAlerts.find(a => a.id === alertId);
            const productName = product ? product.productName : alertId.slice(-6);

            alert(`Alert for ${productName} resolved and removed.`);
            await fetchStockAlerts();

        } catch (error) {
            console.error("Error resolving alert:", error);
            alert("Failed to resolve alert. Check console.");
        }
    }
    
    // --- Core Admin Logic: Site Content Tab ---
    
    const SITE_CONTENT_DOCS = [
        { id: 'about', name: 'About Us Page' },
        { id: 'candle-care', name: 'Candle Care Page' },
        { id: 'refill-program', name: 'Refill Program Page' },
        { id: 'gifting', name: 'Gifting Page' }, 
        { id: 'subscriptions', name: 'Subscriptions Page' }, 
        { id: 'scent-glossary', name: 'Scent Glossary Page' }, 
        { id: 'scent-guide', name: 'Scent Guide Page' }, 
        { id: 'homepage', name: 'Homepage Content' } 
    ];
    
    async function fetchSiteContent() {
        siteContent = {};
        try {
            const contentRef = collection(db, 'siteContent');
            const querySnapshot = await getDocs(query(contentRef));
            
            querySnapshot.forEach(doc => {
                siteContent[doc.id] = doc.data();
            });
            
            renderContentTabs();
            // Automatically switch to the first content document on load
            if (SITE_CONTENT_DOCS.length > 0) {
                switchContentDocument(SITE_CONTENT_DOCS[0].id);
            }
            
        } catch (error) {
            console.error("Error fetching site content:", error);
            alert("Failed to load site content.");
        }
    }
    
    function renderContentTabs() {
        contentTabsContainer.innerHTML = '';
        SITE_CONTENT_DOCS.forEach(docInfo => {
            const button = document.createElement('button');
            button.className = 'content-tab-button px-4 py-2 mr-2 mb-2 rounded-lg font-medium transition duration-150 ease-in-out bg-stone/20 hover:bg-burnt-orange/30 text-charcoal';
            button.textContent = docInfo.name;
            button.setAttribute('data-content-id', docInfo.id);
            button.addEventListener('click', () => switchContentDocument(docInfo.id));
            contentTabsContainer.appendChild(button);
        });
    }
    
    function switchContentDocument(docId) {
        const contentData = siteContent[docId];
        if (!contentData) {
            siteContentForm.innerHTML = `<p class="text-red-600">Content for "${docId}" not found in Firestore.</p>`;
            return;
        }
        
        // Update button styles
        document.querySelectorAll('.content-tab-button').forEach(button => {
            if (button.getAttribute('data-content-id') === docId) {
                button.classList.add('bg-burnt-orange', 'text-parchment');
                button.classList.remove('bg-stone/20', 'hover:bg-burnt-orange/30', 'text-charcoal');
            } else {
                button.classList.remove('bg-burnt-orange', 'text-parchment');
                button.classList.add('bg-stone/20', 'hover:bg-burnt-orange/30', 'text-charcoal');
            }
        });

        // 1. Clear and setup form fields
        siteContentForm.innerHTML = '';
        siteContentForm.setAttribute('data-content-id', docId);

        // 2. Iterate through contentData keys to build dynamic fields
        for (const key in contentData) {
            // Only allow editing of string fields
            if (typeof contentData[key] !== 'string' && typeof contentData[key] !== 'number' && typeof contentData[key] !== 'boolean') continue;
            
            const labelText = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase()); 

            const fieldGroup = document.createElement('div');
            fieldGroup.className = 'mb-4';
            
            const label = document.createElement('label');
            label.className = 'block text-sm font-medium text-charcoal mb-1';
            label.textContent = labelText;
            label.setAttribute('for', `content-field-${key}`);
            
            let inputElement;
            const content = contentData[key];

            // Use textarea for long content (descriptions, safety warnings, etc.)
            if (key.includes('Content') || key.includes('Intro') || key.includes('Text') || (typeof content === 'string' && content.length > 50) || key.includes('html')) {
                inputElement = document.createElement('textarea');
                inputElement.rows = 5;
                inputElement.placeholder = 'Supports basic HTML tags (p, ul, li, strong, em)';
            } else if (typeof content === 'number') {
                inputElement = document.createElement('input');
                inputElement.type = 'number';
            } else if (typeof content === 'boolean') {
                 // Skip booleans for now as the current form design doesn't support them easily.
                 // A future enhancement would be to add a checkbox interface.
                 continue; 
            } else {
                inputElement = document.createElement('input');
                inputElement.type = 'text';
            }
            
            inputElement.className = 'w-full p-3 border border-stone/30 rounded-lg text-charcoal bg-white';
            inputElement.id = `content-field-${key}`;
            inputElement.name = key;
            inputElement.value = content;

            fieldGroup.appendChild(label);
            fieldGroup.appendChild(inputElement);
            siteContentForm.appendChild(fieldGroup);
        }
        
        // 3. Add Save Button
        siteContentForm.innerHTML += `
            <div class="pt-4 border-t mt-6">
                <button type="submit" id="save-content-button" class="w-full px-4 py-3 bg-burnt-orange text-parchment font-bold rounded-lg hover:bg-burnt-orange/80 transition duration-300">
                    Save Page Content
                </button>
            </div>
        `;
    }

    async function handleSiteContentUpdate(e) {
        e.preventDefault();
        
        const docId = siteContentForm.getAttribute('data-content-id');
        const saveButton = document.getElementById('save-content-button');
        saveButton.disabled = true;
        saveButton.textContent = 'Saving...';
        contentSaveMessage.classList.add('hidden');

        try {
            const formData = new FormData(siteContentForm);
            const updateData = {};
            
            for (const [key, value] of formData.entries()) {
                // Attempt to convert to number if the original value was a number
                const originalValue = siteContent[docId][key];
                if (typeof originalValue === 'number' && !isNaN(parseFloat(value))) {
                     updateData[key] = parseFloat(value);
                } else {
                    updateData[key] = value;
                }
            }

            const contentRef = doc(db, 'siteContent', docId);
            await updateDoc(contentRef, updateData);

            siteContent[docId] = { ...siteContent[docId], ...updateData }; // Update local state
            contentSaveMessage.textContent = `Content for ${docId.replace(/([A-Z])/g, ' $1').toUpperCase()} updated successfully!`;
            contentSaveMessage.classList.remove('hidden');
            
        } catch (error) {
            console.error("Error updating site content:", error);
            contentSaveMessage.textContent = "Error saving content. Check console for details.";
            contentSaveMessage.classList.remove('hidden');
            contentSaveMessage.classList.add('text-red-600');
        } finally {
            saveButton.disabled = false;
            saveButton.textContent = 'Save Page Content';
            setTimeout(() => contentSaveMessage.classList.add('hidden'), 5000);
        }
    }


    // --- Core Initialization ---

    /**
     * Handles tab switching logic.
     */
    function switchTab(targetId) {
        tabContents.forEach(content => content.classList.add('hidden'));
        tabButtons.forEach(button => {
            button.classList.remove('bg-stone', 'text-parchment');
            button.classList.add('text-charcoal', 'hover:bg-parchment/70');
        });

        document.getElementById(targetId).classList.remove('hidden');
        document.querySelector(`.tab-button[data-tab="${targetId}"]`).classList.add('bg-stone', 'text-parchment');
        document.querySelector(`.tab-button[data-tab="${targetId}"]`).classList.remove('text-charcoal', 'hover:bg-parchment/70');

        // Execute function on tab switch
        if (targetId === 'tab-orders') {
            fetchAllOrders();
        } else if (targetId === 'tab-products') {
            fetchAllProducts();
        } else if (targetId === 'tab-reviews') {
            fetchAllReviews();
        } else if (targetId === 'tab-stock-alerts') {
            fetchStockAlerts();
        } else if (targetId === 'tab-content') {
            fetchSiteContent();
        } else if (targetId === 'tab-tools') { 
            console.log("Tools tab opened. Utility scripts are import-firestore.mjs and export-firestore.mjs.");
        }
    }

    /**
     * Initializes the admin page after authentication and admin check.
     */
    async function initializeAdmin(user) {
        currentUser = user;
        
        try {
            const adminDocRef = doc(db, 'admins', user.uid);
            const adminDocSnap = await getDoc(adminDocRef);
            isAdmin = adminDocSnap.exists();
        } catch (error) {
            console.error("Error checking admin status:", error);
            isAdmin = false;
        }

        if (!isAdmin) {
            alert("Access Denied: You must be an administrator to view this page.");
            window.location.href = '/account/'; 
            return;
        }
        
        // Load data promises concurrently but don't await them here.
        // The dashboard elements will show 'Loading...' until the functions complete.
        // We ensure all core functions are called once at start.
        fetchAllOrders();
        fetchAllProducts();
        fetchAllReviews();
        fetchStockAlerts();

        adminLoader.classList.add('hidden');
        adminContent.classList.remove('hidden');

        // Start with the default tab (Dashboard)
        // We will call the dashboard fetch functions explicitly here if required by tab logic,
        // but since they were called above, the data populates asynchronously.
        switchTab('tab-dashboard');
    }

    // --- Event Listeners and Initializers ---

    document.addEventListener('DOMContentLoaded', () => {
        tabButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                const targetId = e.target.getAttribute('data-tab');
                switchTab(targetId);
            });
        });
        
        const logoutButton = document.getElementById('logout-button');
        if (logoutButton) {
            logoutButton.addEventListener('click', (e) => {
                e.preventDefault();
                signOut(auth).then(() => {
                    window.location.href = '/admin-login.html';
                }).catch(error => {
                    console.error("Logout failed:", error);
                    alert("Logout failed. Please try again.");
                });
            });
        }
        
        if(closeModalButton) {
            closeModalButton.addEventListener('click', () => {
                productEditModal.classList.add('hidden');
            });
        }
        
        if(productEditForm) {
            productEditForm.addEventListener('submit', handleProductUpdate);
        }
        
        if(siteContentForm) {
            siteContentForm.addEventListener('submit', handleSiteContentUpdate);
        }

        // Authentication State Listener (Security Guard)
        onAuthStateChanged(auth, (user) => {
            if (user) {
                initializeAdmin(user);
            } else {
                window.location.href = '/admin-login.html';
            }
        });
    });

</script>

<main class="container mx-auto px-4 py-12 min-h-screen">
    <div id="admin-loader" class="flex justify-center items-center h-64">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-stone"></div>
    </div>

    <div id="admin-content" class="hidden">
        <h1 class="text-4xl font-playfair text-charcoal mb-8 border-b pb-4">Southern Sense Admin Panel</h1>

        <div class="flex flex-col lg:flex-row gap-8">
            <div class="lg:w-1/4">
                <nav class="bg-parchment p-4 rounded-lg shadow-md sticky top-6">
                    <p class="text-sm font-bold text-stone uppercase tracking-wider mb-2">Operations</p>
                    <button data-tab="tab-dashboard" class="tab-button w-full text-left p-3 rounded-lg font-medium transition duration-150 ease-in-out bg-stone text-parchment">
                        Dashboard
                    </button>
                    <button data-tab="tab-orders" class="tab-button w-full text-left p-3 mt-2 rounded-lg font-medium transition duration-150 ease-in-out text-charcoal hover:bg-parchment/70">
                        Orders
                    </button>
                    <button data-tab="tab-products" class="tab-button w-full text-left p-3 mt-2 rounded-lg font-medium transition duration-150 ease-in-out text-charcoal hover:bg-parchment/70">
                        Products
                    </button>
                    <button data-tab="tab-reviews" class="tab-button w-full text-left p-3 mt-2 rounded-lg font-medium transition duration-150 ease-in-out text-charcoal hover:bg-parchment/70">
                        Reviews
                    </button>
                    <button data-tab="tab-stock-alerts" class="tab-button w-full text-left p-3 mt-2 rounded-lg font-medium transition duration-150 ease-in-out text-charcoal hover:bg-parchment/70">
                        Stock Alerts
                    </button>
                    
                    <p class="text-sm font-bold text-stone uppercase tracking-wider mt-6 mb-2 border-t pt-4">Configuration</p>
                    <button data-tab="tab-content" class="tab-button w-full text-left p-3 rounded-lg font-medium transition duration-150 ease-in-out text-charcoal hover:bg-parchment/70">
                        Site Content
                    </button>
                    <button data-tab="tab-tools" class="tab-button w-full text-left p-3 mt-2 rounded-lg font-medium transition duration-150 ease-in-out text-charcoal hover:bg-parchment/70">
                        Tools / Utility
                    </button>

                    <button id="logout-button" class="w-full text-left p-3 mt-6 rounded-lg font-medium text-red-600 hover:bg-red-50/50 transition duration-150 ease-in-out">
                        Log Out
                    </button>
                </nav>
            </div>

            <div class="lg:w-3/4">
                
                <div id="tab-dashboard" class="tab-content bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-3xl font-playfair text-charcoal mb-4 border-b pb-2">Admin Dashboard</h2>
                    <p class="text-stone mb-6">Welcome to the control center. Use the sidebar to navigate management tasks.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="p-4 bg-parchment/50 rounded-lg shadow-inner">
                            <h3 class="text-xl font-medium text-charcoal">Total Orders</h3>
                            <p id="total-orders-count" class="text-4xl font-bold text-burnt-orange mt-2">--</p>
                            <p class="text-sm text-stone mt-1">Orders recorded to date.</p>
                        </div>
                        
                        <div class="p-4 bg-parchment/50 rounded-lg shadow-inner">
                            <h3 class="text-xl font-medium text-charcoal">Pending Reviews</h3>
                            <p id="pending-reviews-count" class="text-4xl font-bold text-stone mt-2">--</p>
                            <a data-tab="tab-reviews" class="tab-button text-sm text-burnt-orange hover:underline mt-1 block cursor-pointer">Approve Reviews &rarr;</a>
                        </div>

                        <div class="p-4 bg-parchment/50 rounded-lg shadow-inner">
                            <h3 class="text-xl font-medium text-charcoal">Active Stock Alerts</h3>
                            <p id="total-stock-alerts-count" class="text-4xl font-bold text-stone mt-2">--</p>
                            <a data-tab="tab-stock-alerts" class="tab-button text-sm text-burnt-orange hover:underline mt-1 block cursor-pointer">View Alerts &rarr;</a>
                        </div>
                    </div>

                    <div class="mt-8 p-6 bg-parchment rounded-lg border-l-4 border-burnt-orange">
                        <h3 class="text-xl font-playfair text-charcoal mb-3">System Health Summary:</h3>
                        <p class="text-stone">E-commerce flow **STABLE** (Authenticated checkout fixed). All Admin operational tabs are now **ACTIVE**.</p>
                        <p class="text-sm text-stone mt-2 font-semibold">Admin Panel features are **COMPLETE**.</p>
                    </div>
                </div>

                <div id="tab-orders" class="tab-content hidden bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-3xl font-playfair text-charcoal mb-6 border-b pb-2">Order Management</h2>
                    
                    <p id="orders-message" class="text-stone mb-4"></p>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-stone/30">
                            <thead>
                                <tr class="text-left text-sm font-medium text-charcoal uppercase tracking-wider bg-parchment">
                                    <th class="px-6 py-3">Order #</th>
                                    <th class="px-6 py-3">Date</th>
                                    <th class="px-6 py-3">Total</th>
                                    <th class="px-6 py-3">Status</th>
                                    <th class="px-6 py-3">Customer</th>
                                    <th class="px-6 py-3 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="orders-table-body" class="bg-white divide-y divide-stone/20">
                                </tbody>
                        </table>
                    </div>
                </div>

                <div id="tab-products" class="tab-content hidden bg-white p-6 rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-6 border-b pb-2">
                        <h2 class="text-3xl font-playfair text-charcoal">Product Catalog Management</h2>
                        <button class="px-4 py-2 bg-burnt-orange text-parchment font-semibold rounded-lg hover:bg-burnt-orange/80 transition duration-300">
                            + Add New Product
                        </button>
                    </div>
                    
                    <p id="products-message" class="text-stone mb-4"></p>
                    
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-stone/30">
                            <thead>
                                <tr class="text-left text-sm font-medium text-charcoal uppercase tracking-wider bg-parchment">
                                    <th class="px-6 py-3">Product Name</th>
                                    <th class="px-6 py-3">Scent Family</th>
                                    <th class="px-6 py-3">Price</th>
                                    <th class="px-6 py-3">Stock</th>
                                    <th class="px-6 py-3">Featured</th>
                                    <th class="px-6 py-3 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="products-table-body" class="bg-white divide-y divide-stone/20">
                                </tbody>
                        </table>
                    </div>
                </div>

                <div id="tab-reviews" class="tab-content hidden bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-3xl font-playfair text-charcoal mb-6 border-b pb-2">Review Moderation</h2>
                    <p id="reviews-message" class="text-stone mb-4"></p>
                    <div id="reviews-container">
                        </div>
                </div>
                
                <div id="tab-stock-alerts" class="tab-content hidden bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-3xl font-playfair text-charcoal mb-6 border-b pb-2">Back-in-Stock Requests</h2>
                    <p id="stock-alerts-message" class="text-stone mb-4">Fetching current back-in-stock requests.</p>

                    <div class="mt-4 p-4 bg-gray-50 border rounded-lg border-burnt-orange/50">
                        <h3 class="font-semibold text-charcoal">Action Guide:</h3>
                        <p class="text-sm text-stone">1. Replenish stock for the item listed below in the **Products** tab.</p>
                        <p class="text-sm text-stone">2. Click **Email Customer** to notify them.</p>
                        <p class="text-sm text-stone">3. Click **Mark as Resolved** to clear the alert.</p>
                    </div>

                    <div id="stock-alerts-container" class="mt-6">
                        </div>
                </div>

                <div id="tab-content" class="tab-content hidden bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-3xl font-playfair text-charcoal mb-6 border-b pb-2">Site Content Management (CMS)</h2>
                    
                    <div id="content-tabs-container" class="mb-4 border-b pb-2">
                        </div>
                    
                    <p id="content-save-message" class="hidden px-4 py-2 bg-green-100 text-green-700 rounded-lg mb-4 text-sm">Content saved successfully!</p>

                    <form id="site-content-form" data-content-id="about" class="space-y-4">
                        <p class="text-stone">Loading editable fields...</p>
                        </form>
                </div>

                <div id="tab-tools" class="tab-content hidden bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-3xl font-playfair text-charcoal mb-6 border-b pb-2">Utility & Developer Tools</h2>
                    
                    <div class="mt-4 p-4 bg-gray-50 border rounded-lg border-stone/50">
                        <h3 class="font-semibold text-charcoal text-xl mb-2">Database Backup & Restore</h3>
                        <p class="text-stone mb-3">These tools are for maintaining the Firestore database, typically used by developers or for initial setup.</p>
                        <p class="text-sm text-red-600 font-semibold mb-4">WARNING: Only run these scripts from a secure local environment. They overwrite data.</p>
                        
                        <div class="space-y-3">
                            <p class="text-sm text-charcoal font-medium">1. **Export Database (Backup)**</p>
                            <div class="flex justify-between items-center bg-white p-3 border rounded">
                                <code class="text-sm bg-gray-100 p-1 rounded">node export-firestore.mjs</code>
                                <button onclick="alert('Tool must be executed via local terminal using the specified command. Data integrity is critical.')" class="px-3 py-1 bg-stone text-parchment rounded text-sm hover:bg-stone/80 transition">
                                    Instructions
                                </button>
                            </div>
                            
                            <p class="text-sm text-charcoal font-medium pt-2">2. **Import Database (Restore/Bootstrap)**</p>
                            <div class="flex justify-between items-center bg-white p-3 border rounded">
                                <code class="text-sm bg-gray-100 p-1 rounded">node import-firestore.mjs</code>
                                <button onclick="alert('Tool must be executed via local terminal using the specified command. This will overwrite existing Firestore collections.')" class="px-3 py-1 bg-burnt-orange text-parchment rounded text-sm hover:bg-burnt-orange/80 transition">
                                    Instructions
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="product-edit-modal" class="fixed inset-0 z-50 hidden overflow-y-auto bg-charcoal bg-opacity-75 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-lg mx-4 p-6 relative">
            
            <div class="flex justify-between items-start border-b pb-3 mb-4">
                <h3 class="text-2xl font-playfair text-charcoal">Edit Product Details</h3>
                <button id="close-modal-button" class="text-stone hover:text-charcoal transition text-3xl leading-none">&times;</button>
            </div>

            <form id="product-edit-form" class="space-y-4">
                <input type="hidden" id="edit-product-id" name="id">

                <div>
                    <label for="edit-product-name" class="block text-sm font-medium text-stone mb-1">Product Name</label>
                    <input type="text" id="edit-product-name" name="name" required class="w-full p-2 border border-stone/30 rounded-lg text-charcoal">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="edit-price" class="block text-sm font-medium text-stone mb-1">Price ($)</label>
                        <input type="number" step="0.01" id="edit-price" name="price" required class="w-full p-2 border border-stone/30 rounded-lg text-charcoal">
                    </div>
                    <div>
                        <label for="edit-stock" class="block text-sm font-medium text-stone mb-1">Stock Level</label>
                        <input type="number" id="edit-stock" name="stock" required class="w-full p-2 border border-stone/30 rounded-lg text-charcoal">
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="edit-scent-family" class="block text-sm font-medium text-stone mb-1">Scent Family</label>
                        <input type="text" id="edit-scent-family" name="scentFamily" required class="w-full p-2 border border-stone/30 rounded-lg text-charcoal">
                    </div>
                    <div>
                        <label for="edit-category" class="block text-sm font-medium text-stone mb-1">Category</label>
                        <select id="edit-category" name="category" required class="w-full p-2 border border-stone/30 rounded-lg text-charcoal">
                            <option value="candle">Candle</option>
                            <option value="melt">Wax Melt</option>
                        </select>
                    </div>
                </div>

                <div class="flex items-center pt-2">
                    <input type="checkbox" id="edit-featured" name="featured" class="h-4 w-4 text-burnt-orange border-stone/30 rounded focus:ring-burnt-orange">
                    <label for="edit-featured" class="ml-2 block text-sm font-medium text-charcoal">Featured on Homepage</label>
                </div>

                <div class="pt-4 border-t mt-4">
                    <button type="submit" class="w-full px-4 py-3 bg-burnt-orange text-parchment font-bold rounded-lg hover:bg-burnt-orange/80 transition duration-300">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>
</main>