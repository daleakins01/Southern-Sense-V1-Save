---
layout: layout.html
title: "Shop All"
---

<main class="container mx-auto px-4 py-12">
  <!-- Shop Header -->
  <header class="text-center mb-12">
    <h1 class="font-playfair text-5xl font-bold text-charcoal">Shop All</h1>
    <p class="text-lg text-stone mt-4 max-w-xl mx-auto">
      Browse our full collection of hand-poured soy candles and wax melts.
    </p>
  </header>

  <!-- Filters -->
  <section class="mb-8">
    <div
      class="flex flex-col md:flex-row justify-between items-center gap-4">
      <!-- Category Filter -->
      <div class="flex space-x-2" id="category-filter">
        <button
          class="filter-btn bg-burnt-orange text-white"
          data-filter="all">
          All
        </button>
        <button class="filter-btn" data-filter="candle">Candles</button>
        <button class="filter-btn" data-filter="wax-melt">Wax Melts</button>
      </div>

      <!-- (Future Feature): Scent Family Filter
      <div class="relative">
        <select id="scent-filter" class="form-select appearance-none block w-full md:w-64 px-4 py-2 text-base font-normal text-stone bg-white bg-clip-padding border border-stone/30 rounded-lg transition ease-in-out m-0 focus:text-charcoal focus:bg-white focus:border-burnt-orange focus:outline-none">
          <option value="all">All Scent Families</option>
          <option value="fruity-sweet">Fruity & Sweet</option>
          <option value="earthy-woody">Earthy & Woody</option>
          <option value="fresh-clean">Fresh & Clean</option>
          <option value="floral-romantic">Floral & Romantic</option>
        </select>
      </div>
      -->
    </div>
  </section>

  <!-- Product Grid -->
  <section id="product-grid"
    class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
    <!-- Loading Skeletons -->
    <div class="skeleton-card"></div>
    <div class="skeleton-card"></div>
    <div class="skeleton-card"></div>
    <div class="skeleton-card"></div>
  </section>

  <!-- No Results Message -->
  <p id="no-products-message"
    class="text-center text-xl text-stone italic mt-12 hidden">
    No products found matching these filters.
  </p>
</main>

<style>
  /* Basic styles for filter buttons */
  .filter-btn {
    @apply px-5 py-2 rounded-md font-roboto text-sm font-medium text-stone bg-white border border-stone/30 transition-all duration-200;
  }
  .filter-btn:hover {
    @apply bg-parchment;
  }
  .filter-btn.bg-burnt-orange {
    @apply text-white border-transparent;
  }
  .filter-btn.bg-burnt-orange:hover {
    @apply bg-opacity-90;
  }

  /* Skeleton loading card */
  .skeleton-card {
    @apply bg-white rounded-lg shadow-lg overflow-hidden;
  }
  .skeleton-card::before {
    content: "";
    display: block;
    padding-bottom: 100%; /* Aspect ratio 1:1 for image */
    @apply bg-gray-200 animate-pulse;
  }
  .skeleton-card::after {
    content: "";
    display: block;
    height: 120px; /* Placeholder for text content */
    @apply bg-white p-6;
  }
</style>

<script type="module">
  import {
    db,
    collection,
    getDocs,
    query,
  } from "/src/firebase-loader.js";
  import { getCart, addToCart } from "/src/cart.js";

  const productGrid = document.getElementById("product-grid");
  const noProductsMessage = document.getElementById("no-products-message");
  const categoryFilter = document.getElementById("category-filter");

  let allProducts = []; // To store all products
  let currentFilter = "all"; // To store current filter

  // 1. Fetch all products from Firestore
  async function loadAllProducts() {
    try {
      const q = query(collection(db, "products"));
      // (Pillar 1 Fix): Add sorting
      // const q = query(collection(db, "products"), orderBy("name"));
      const querySnapshot = await getDocs(q);

      allProducts = querySnapshot.docs.map((doc) => ({
        id: doc.id,
        ...doc.data(),
      }));

      if (allProducts.length === 0) {
        productGrid.innerHTML = "";
        noProductsMessage.classList.remove("hidden");
        noProductsMessage.textContent = "No products found in the store.";
      } else {
        renderProducts();
      }
    } catch (error) {
      console.error("Error fetching products:", error);
      productGrid.innerHTML =
        '<p class="text-red-600 col-span-full text-center text-xl">Error loading products. Please try again later.</p>';
    }
  }

  // 2. Render products based on current filter
  function renderProducts() {
    productGrid.innerHTML = ""; // Clear grid
    noProductsMessage.classList.add("hidden");

    const filteredProducts = allProducts.filter((product) => {
      if (currentFilter === "all") return true;
      return product.category === currentFilter;
    });

    if (filteredProducts.length === 0) {
      noProductsMessage.classList.remove("hidden");
    }

    filteredProducts.forEach((product) => {
      const card = createProductCard(product);
      productGrid.appendChild(card);
    });
  }

  // 3. Create a single product card
  function createProductCard(product) {
    const card = document.createElement("div");
    card.className =
      "bg-white rounded-lg shadow-lg overflow-hidden flex flex-col";

    card.innerHTML = `
      <a href="/product.html?id=${
        product.id
      }" class="block h-64 overflow-hidden">
        <img src="/src/${product.imageUrl}" alt="${
      product.name
    }" class="w-full h-full object-cover transform transition-transform duration-300 hover:scale-105">
      </a>
      <div class="p-6 flex flex-col flex-grow">
        <h3 class="font-playfair text-2xl font-semibold text-charcoal">${
          product.name
        }</h3>
        <p class="text-stone mt-2 text-sm flex-grow">${
          product.shortDescription
        }</p>
        <div class="flex justify-between items-center mt-4">
          <span class="text-xl font-light text-burnt-orange">$${
            product.price
          }</span>
          <span class="text-sm uppercase text-stone">${product.category}</span>
        </div>
        <button 
          class="add-to-cart-btn mt-6 w-full bg-burnt-orange text-white font-roboto px-4 py-2 rounded-md shadow-lg hover:bg-opacity-90 transition-all duration-300"
          data-id="${product.id}"
          data-name="${product.name}"
          data-price="${product.price}"
          data-image="${product.imageUrl}"
          data-stock="${product.stock}"
          ${
            product.stock === 0
              ? 'disabled class="mt-6 w-full bg-stone text-white font-roboto px-4 py-2 rounded-md cursor-not-allowed"'
              : ""
          }
        >
          ${product.stock === 0 ? "Out of Stock" : "Add to Cart"}
        </button>
      </div>
    `;
    return card;
  }

  // 4. Handle Filter Clicks
  categoryFilter.addEventListener("click", (e) => {
    if (e.target.tagName === "BUTTON") {
      // Remove active class from all buttons
      categoryFilter.querySelectorAll("button").forEach((btn) => {
        btn.classList.remove("bg-burnt-orange", "text-white");
      });

      // Add active class to clicked button
      e.target.classList.add("bg-burnt-orange", "text-white");

      // Set filter and re-render
      currentFilter = e.target.dataset.filter;
      renderProducts();
    }
  });

  // 5. Handle Add to Cart Clicks (Event Delegation)
  productGrid.addEventListener("click", async (e) => {
    if (e.target.classList.contains("add-to-cart-btn")) {
      const btn = e.target;
      const { id, name, price, image, stock } = btn.dataset;

      if (parseInt(stock, 10) === 0) return; // Should be disabled, but double-check

      btn.disabled = true;
      btn.textContent = "Adding...";

      await addToCart(id, name, price, image, 1, parseInt(stock, 10));

      btn.textContent = "Added!";
      setTimeout(() => {
        btn.disabled = false;
        btn.textContent = "Add to Cart";
      }, 2000);
    }
  });

  // --- INITIALIZE ---
  loadAllProducts();
</script>
