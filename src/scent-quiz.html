---
layout: layout
title: Find Your Perfect Scent
---

{% include "page-header.html" with pageTitle: title, headerImage: '/src/melts-header.webp' %}

<main class="container mx-auto p-4 lg:p-8 py-16">
    <div class="max-w-6xl mx-auto bg-white p-8 lg:p-12 rounded-xl shadow-2xl border border-stone/10">

        <div class="max-w-3xl mx-auto bg-parchment p-8 rounded-xl shadow-2xl border border-stone/10">

            <div id="quiz-container">
                <h2 id="quiz-title" class="font-playfair text-4xl font-bold text-charcoal text-center mb-6">Let's Begin</h2>
                <p id="progress-text" class="text-center font-roboto text-sm text-stone mb-8">Welcome</p>

                <form id="scent-quiz-form-container"> 
                    
                    <div id="step-0" class="quiz-step">
                        <p class="text-center text-lg text-stone mb-8">Answer a few quick questions to discover the scent family that best matches your personal sanctuary.</p>
                        <button type="button" data-next-step="1" class="w-full py-3 bg-burnt-orange text-parchment font-playfair text-lg font-bold rounded-lg shadow-xl hover:bg-opacity-90 transition duration-150 start-quiz-button">
                            Start Quiz
                        </button>
                    </div>

                    <div id="step-1" class="quiz-step hidden">
                        <h3 class="font-playfair text-2xl font-bold text-charcoal mb-4">1. How do you want to feel right now?</h3>
                        <div class="space-y-3">
                            <label class="block p-3 border border-stone/30 rounded-lg hover:bg-white cursor-pointer transition duration-150"><input type="radio" name="q1" value="calm" class="mr-3 accent-burnt-orange" required> Cozy & Calm (E.g., Sunday morning)</label>
                            <label class="block p-3 border border-stone/30 rounded-lg hover:bg-white cursor-pointer transition duration-150"><input type="radio" name="q1" value="uplifted" class="mr-3 accent-burnt-orange"> Refreshed & Uplifted (E.g., Spring break)</label>
                            <label class="block p-3 border border-stone/30 rounded-lg hover:bg-white cursor-pointer transition duration-150"><input type="radio" name="q1" value="warm" class="mr-3 accent-burnt-orange"> Warm & Inviting (E.g., Dinner party)</label>
                        </div>
                        <button type="button" data-next-step="2" class="mt-6 w-full py-3 bg-burnt-orange text-parchment font-bold rounded-lg shadow-xl transition duration-150 next-step-button">Next &rarr;</button>
                    </div>

                    <div id="step-2" class="quiz-step hidden">
                        <h3 class="font-playfair text-2xl font-bold text-charcoal mb-4">2. Which environment do you prefer?</h3>
                        <div class="space-y-3">
                            <label class="block p-3 border border-stone/30 rounded-lg hover:bg-white cursor-pointer transition duration-150"><input type="radio" name="q2" value="nature" class="mr-3 accent-burnt-orange" required> A deep forest after the rain</label>
                            <label class="block p-3 border border-stone/30 rounded-lg hover:bg-white cursor-pointer transition duration-150"><input type="radio" name="q2" value="bakery" class="mr-3 accent-burnt-orange"> A gourmet bakery full of fresh pastry</label>
                            <label class="block p-3 border border-stone/30 rounded-lg hover:bg-white cursor-pointer transition duration-150"><input type="radio" name="q2" value="patio" class="mr-3 accent-burnt-orange"> A sun-drenched coastal patio</label>
                        </div>
                        <button type="button" data-next-step="3" class="mt-6 w-full py-3 bg-burnt-orange text-parchment font-bold rounded-lg shadow-xl transition duration-150 next-step-button">Next &rarr;</button>
                    </div>

                    <div id="step-3" class="quiz-step hidden">
                        <h3 class="font-playfair text-2xl font-bold text-charcoal mb-4">3. What's your ideal dessert?</h3>
                        <div class="space-y-3">
                            <label class="block p-3 border border-stone/30 rounded-lg hover:bg-white cursor-pointer transition duration-150"><input type="radio" name="q3" value="citrus" class="mr-3 accent-burnt-orange" required> Bright, fresh lemon meringue pie</label>
                            <label class="block p-3 border border-stone/30 rounded-lg hover:bg-white cursor-pointer transition duration-150"><input type="radio" name="q3" value="wood" class="mr-3 accent-burnt-orange"> A rich, dark chocolate truffle</label>
                            <label class="block p-3 border border-stone/30 rounded-lg hover:bg-white cursor-pointer transition duration-150"><input type="radio" name="q3" value="spice" class="mr-3 accent-burnt-orange"> Gingerbread cookies with cinnamon frosting</label>
                        </div>
                        <button type="submit" id="submit-quiz-button" class="mt-6 w-full py-3 bg-burnt-orange text-parchment font-playfair text-lg font-bold rounded-lg shadow-xl transition duration-150">
                            Show My Scent
                        </button>
                    </div>
                </form>

                <div id="result-step" class="quiz-step hidden text-center">
                    <h2 class="font-playfair text-3xl font-bold text-charcoal mb-4">Your Perfect Match:</h2>
                    <div id="result-display" class="bg-white p-6 rounded-xl shadow-xl border-4 border-burnt-orange/50 mb-6 space-y-3">
                        <div id="loading-result" class="space-y-3">
                            <p class="font-roboto text-stone text-lg">Analyzing your preferences...</p>
                            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-burnt-orange mx-auto"></div>
                        </div>
                        <h3 id="result-family-title" class="font-playfair text-4xl font-extrabold text-burnt-orange hidden"></h3>
                        <p id="result-description" class="font-roboto text-lg text-stone hidden"></p>
                    </div>
                    <a id="result-link" href="/shop/" class="inline-block py-3 px-8 bg-burnt-orange text-parchment font-bold rounded-lg shadow-xl hover:bg-amber-700 transition duration-150 hidden">
                        View Product Details &rarr;
                    </a>
                </div>
            </div>
        </div>
    </div> </main>

<script type="module">
    // FINAL CODE FIX: Use static string quotes and manually add the version parameter for cache-busting.
    // This resolves the "Unexpected template string" syntax error.
    const version = '?v=1.1.5';
    import { db, collection, query, where, getDocs } from '/src/firebase-loader.js?v=1.1.5'; 

    // --- State & DOM ---
    let currentStep = 0;
    const TOTAL_STEPS = 4; // Total number of logical steps (0, 1, 2, 3, 4=Result)
    const QUIZ_QUESTION_COUNT = 3; // The number of questions (1, 2, 3)
    const quizContainer = document.getElementById('quiz-container');
    const quizTitle = document.getElementById('quiz-title');
    const progressText = document.getElementById('progress-text');
    const formContainer = document.getElementById('scent-quiz-form-container'); 
    const resultStep = document.getElementById('result-step'); 
    const loadingResult = document.getElementById('loading-result');
    const resultFamilyTitle = document.getElementById('result-family-title');
    const resultDescription = document.getElementById('result-description');
    const resultLink = document.getElementById('result-link');
    
    // CRITICAL FIX: Recommended product IDs for direct linking to PDP (All currently have stock: 0)
    const recommendedProducts = {
        'woody-warm': 'WxttS8TrjCpSzmsewwba', // Oak Barrel Candle
        'gourmand-sweet': 'XOCmghULXJoyGAhBGoRu', // Creme & Crumble Candle
        'floral-fresh': 'pz6CWxOG6FUqDBfHv5YW'  // Sweet Magnolia Candle
    };
    
    // CRITICAL FIX: Standardize internal family IDs to match core categories: gourmand-sweet, floral-fresh, woody-warm.
    const scentWeights = {
        'calm': { 'woody-warm': 2, 'floral-fresh': 1, 'gourmand-sweet': 1 }, 
        'uplifted': { 'floral-fresh': 3, 'gourmand-sweet': 1, 'woody-warm': 1 }, 
        'warm': { 'gourmand-sweet': 3, 'woody-warm': 1, 'floral-fresh': 1 }, 
        'nature': { 'woody-warm': 3, 'floral-fresh': 2, 'gourmand-sweet': 1 },
        'bakery': { 'gourmand-sweet': 4, 'floral-fresh': 1, 'woody-warm': 1 }, 
        'patio': { 'floral-fresh': 3, 'gourmand-sweet': 2, 'woody-warm': 1 },
        'citrus': { 'floral-fresh': 4, 'gourmand-sweet': 1, 'woody-warm': 1 }, 
        'wood': { 'woody-warm': 4, 'gourmand-sweet': 2, 'floral-fresh': 1 },
        'spice': { 'gourmand-sweet': 4, 'woody-warm': 2, 'floral-fresh': 1 }
    };

    // CRITICAL FIX: Update display map keys and descriptions for brand alignment.
    const familyDisplayMap = {
        'woody-warm': {
            name: 'Woody & Warm',
            description: 'You prefer rich, sophisticated scents that evoke a cozy library, deep forests, or a warm cashmere sweater. These grounding aromas are perfect for relaxation, elegance, and comfort.'
        },
        'gourmand-sweet': {
            name: 'Gourmand & Sweet',
            description: 'Your ideal match is a comforting, indulgent aroma that recalls delicious baked goods, sweet desserts, and happy memories. These inviting scents create a warm, welcoming, and decadent atmosphere.'
        },
        'floral-fresh': {
            name: 'Floral & Fresh',
            description: 'You are drawn to light, clean, and elegant fragrances. These scents—think sun-drenched porches, crisp ocean air, and delicate magnolia blossoms—are perfect for revitalizing your space with a touch of sophistication.'
        }
    };
    
    let answerTally = {};

    // --- Quiz Navigation ---

    /**
     * Hides all steps and shows the current step/result.
     * @param {number} stepNumber - The step index (0-4).
     */
    function showStep(stepNumber) {
        // 1. Hide all elements with the class .quiz-step
        document.querySelectorAll('.quiz-step').forEach(function(step) { // Use function(step)
            step.classList.add('hidden');
        });
        
        // 2. Handle result step separately (Step 4)
        if (stepNumber === TOTAL_STEPS) {
            resultStep.classList.remove('hidden');
            formContainer.classList.add('hidden'); 
            quizTitle.textContent = "Your Recommendation";
            progressText.classList.add('hidden'); 
            return;
        }

        // 3. Handle question steps (Step 0 to 3)
        const stepElement = document.getElementById(`step-${stepNumber}`);
        if (stepElement) {
            stepElement.classList.remove('hidden');
        }
        
        // Show the form container if we are in a question step (1-3)
        if (stepNumber > 0) {
            formContainer.classList.remove('hidden');
        } else {
            // Step 0 is the welcome screen, the form is not visible yet
            formContainer.classList.add('hidden');
        }
        
        currentStep = stepNumber;
        progressText.classList.remove('hidden');
        
        if (stepNumber === 0) {
            quizTitle.textContent = "Let's Begin";
            progressText.textContent = "Welcome"; 
        } else {
            quizTitle.textContent = "Find Your Perfect Scent";
            progressText.textContent = `Step ${currentStep} of ${QUIZ_QUESTION_COUNT}`;
        }
    }

    /**
     * Collects answers from the current step and moves to the next.
     * @param {Event} e - The click event.
     */
    function handleNextStep(e) {
        // Only validate if we are transitioning from a question step (1-2)
        if (currentStep > 0 && currentStep < QUIZ_QUESTION_COUNT) {
            const currentStepEl = document.getElementById(`step-${currentStep}`);
            const checkedInput = currentStepEl.querySelector('input[type="radio"]:checked');
            
            if (!checkedInput) {
                alert('Please select an option to continue.');
                return;
            }

            // Tally the answer weight for the completed step
            const answerValue = checkedInput.value;
            const weights = scentWeights[answerValue];
            for (const scent in weights) {
                answerTally[scent] = (answerTally[scent] || 0) + weights[scent];
            }
        } else if (currentStep === QUIZ_QUESTION_COUNT) {
            // Do nothing on step 3's next button as it's the final submit.
            return;
        }

        // Proceed to the next step based on the button's data attribute
        const nextStep = parseInt(e.currentTarget.dataset.nextStep);
        showStep(nextStep);
    }
    
    // --- Result Calculation ---

    /**
     * Determines the top-voted scent family and displays the result.
     * @param {Event} e - The form submission event.
     */
    async function calculateResult(e) {
        e.preventDefault();
        
        // Final validation for the last question (Step 3)
        const currentStepEl = document.getElementById(`step-${QUIZ_QUESTION_COUNT}`); // step-3
        const checkedInput = currentStepEl.querySelector('input[type="radio"]:checked');
        
        if (!checkedInput) {
            alert('Please select an option to continue.');
            return;
        }

        // CRITICAL FIX: Tally the final answer here, after validation
        const answerValue = checkedInput.value;
        const weights = scentWeights[answerValue];
        for (const scent in weights) {
            answerTally[scent] = (answerTally[scent] || 0) + weights[scent];
        }

        // Show result step and loading state
        showStep(TOTAL_STEPS); 
        
        loadingResult.classList.remove('hidden');
        resultFamilyTitle.classList.add('hidden');
        resultDescription.classList.add('hidden');
        resultLink.classList.add('hidden');

        // 1. Determine the top scent family ID
        let topScentId = null;
        let maxWeight = 0;
        for (const scent in answerTally) {
            if (answerTally[scent] > maxWeight) {
                maxWeight = answerTally[scent];
                topScentId = scent;
            }
        }

        // Fallback: If no answers were recorded (e.g., test error), default to the first defined family
        if (!topScentId || !familyDisplayMap.hasOwnProperty(topScentId)) {
            topScentId = Object.keys(familyDisplayMap)[0]; 
        }

        const familyData = familyDisplayMap[topScentId];
        const recommendedId = recommendedProducts[topScentId];

        // CRITICAL FIX: The link targets the specific product ID's page
        resultLink.href = `/product/?id=${recommendedId}`; 
        
        // 2. Simulate loading and display results
        setTimeout(function() { // Use explicit function
            loadingResult.classList.add('hidden');
            resultFamilyTitle.textContent = familyData.name;
            resultDescription.textContent = familyData.description + 
                                            " Click below to view your top recommended product. Since stock is currently low, the product page is set up to let you sign up for a **Back-in-Stock Alert!**";
            
            resultFamilyTitle.classList.remove('hidden');
            resultDescription.classList.remove('hidden');
            resultLink.classList.remove('hidden');
        }, 1000); 
    }

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', function() { // Use explicit function
        // Initial setup
        showStep(0); 
        
        // CRITICAL FIX: Add initialization robustness via try/catch
        try {
            // Attach listeners for next buttons
            document.querySelectorAll('.next-step-button').forEach(function(button) { // Use explicit function
                // FIX: Reset the tally on restart (optional but safe)
                // CRITICAL FIX: Use explicit function(e) binding to solve template string syntax error.
                if (button.dataset.nextStep === '1') {
                    button.addEventListener('click', function(e) { answerTally = {}; handleNextStep(e); });
                } else {
                    button.addEventListener('click', handleNextStep);
                }
            });
            
            // Attach listener for the start button
            document.querySelector('.start-quiz-button').addEventListener('click', handleNextStep);

            // Attach listener for the final form submission
            formContainer.addEventListener('submit', calculateResult);
            
        } catch (error) {
             console.error("CRITICAL Scent Quiz Initialization Error:", error);
             // Ensure the welcome step is visible even on error
             var step0 = document.getElementById('step-0'); // Use var for stability
             if(step0) {
                 step0.classList.remove('hidden');
                 quizTitle.textContent = "Error Loading Quiz";
                 progressText.textContent = "Please refresh the page.";
             }
        }
    });

; // DEFENSIVE SEMICOLON: Added to absorb potential file truncation errors.
</script>