---
layout: layout.html
title: Order Confirmed
---

<div class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8 bg-parchment-100 min-h-screen">
    <div id="loading" class="text-center py-16">
        <p class="text-xl font-serif text-charcoal">Loading Order Details...</p>
    </div>

    <div id="order-content" class="hidden">
        <h1 class="text-4xl font-display text-charcoal mb-4 border-b pb-2">Order Confirmation</h1>

        <div id="order-details-summary" class="bg-white p-6 rounded-lg shadow-xl mb-8">
            <h2 class="text-2xl font-display text-stone mb-4">Thank You for Your Purchase!</h2>
            <p class="text-charcoal mb-4">Your order has been placed successfully and is being processed.</p>
            <div class="grid grid-cols-2 gap-4 text-sm">
                <p class="font-bold text-charcoal">Order ID:</p>
                <p id="order-id" class="text-charcoal-600 font-mono break-all"></p>
                
                <p class="font-bold text-charcoal">Order Date:</p>
                <p id="order-date" class="text-charcoal-600"></p>
                
                <p class="font-bold text-charcoal">Shipping To:</p>
                <div class="text-charcoal-600" id="shipping-address"></div>
            </div>
        </div>

        <div id="order-items-list" class="mb-8">
            <h2 class="text-2xl font-display text-charcoal mb-4">Items Ordered</h2>
            <!-- Items will be injected here -->
        </div>

        <div id="order-financial-summary" class="flex justify-end">
            <div class="w-full max-w-sm bg-stone-100 p-6 rounded-lg shadow-inner">
                <div class="flex justify-between text-charcoal mb-2">
                    <span>Subtotal:</span>
                    <span id="subtotal" class="font-semibold"></span>
                </div>
                <div class="flex justify-between text-charcoal mb-2 border-b border-stone-300 pb-2">
                    <span>Shipping (Standard):</span>
                    <span id="shipping-cost" class="font-semibold"></span>
                </div>
                <div class="flex justify-between text-2xl font-bold text-charcoal pt-2">
                    <span>Total Paid:</span>
                    <span id="total"></span>
                </div>
            </div>
        </div>

    </div>

    <div id="order-error" class="hidden text-center py-16">
        <p class="text-xl font-serif text-red-700">Sorry, we couldn't find that order.</p>
        <p class="text-charcoal">Please check your URL or contact support with your Order ID.</p>
    </div>
</div>

<script type="module">
    // Import necessary Firebase functions
    import { db } from '/firebase-loader.js';
    import { doc, getDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

    // --- DOM Elements ---
    const loadingEl = document.getElementById('loading');
    const orderContentEl = document.getElementById('order-content');
    const orderErrorEl = document.getElementById('order-error');
    const itemsListEl = document.getElementById('order-items-list');

    /**
     * Extracts a query parameter from the URL.
     * @param {string} name The name of the parameter.
     * @returns {string | null} The value of the parameter.
     */
    function getQueryParam(name) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(name);
    }

    /**
     * Renders the financial summary and item list for a given order.
     * @param {Object} orderData The order document data from Firestore.
     */
    function renderOrder(orderData) {
        document.getElementById('order-id').textContent = orderData.id;
        document.getElementById('order-date').textContent = new Date(orderData.timestamp).toLocaleDateString();
        
        // Render Shipping Address
        const shippingAddressEl = document.getElementById('shipping-address');
        shippingAddressEl.innerHTML = `
            ${orderData.shippingAddress.name}<br>
            ${orderData.shippingAddress.addressLine1}<br>
            ${orderData.shippingAddress.city}, ${orderData.shippingAddress.state} ${orderData.shippingAddress.zip}<br>
            ${orderData.shippingAddress.country}
        `;

        // Render Item List
        itemsListEl.innerHTML = `
            <div class="grid grid-cols-5 gap-4 py-3 font-bold text-charcoal border-b border-stone-400">
                <span class="col-span-2">Item</span>
                <span class="text-center">Price</span>
                <span class="text-center">Qty</span>
                <span class="text-right">Total</span>
            </div>
        `;

        orderData.items.forEach(item => {
            const itemTotal = (parseFloat(item.price) * item.quantity).toFixed(2);
            itemsListEl.innerHTML += `
                <div class="grid grid-cols-5 gap-4 py-3 border-b border-stone-200 text-charcoal">
                    <div class="col-span-2">
                        <p class="font-semibold">${item.name}</p>
                        <p class="text-sm text-stone-600">${item.id}</p>
                    </div>
                    <span class="text-center">$${parseFloat(item.price).toFixed(2)}</span>
                    <span class="text-center">${item.quantity}</span>
                    <span class="text-right font-semibold">$${itemTotal}</span>
                </div>
            `;
        });

        // Render Financials
        document.getElementById('subtotal').textContent = `$${parseFloat(orderData.subtotal).toFixed(2)}`;
        document.getElementById('shipping-cost').textContent = `$${parseFloat(orderData.shippingCost).toFixed(2)}`;
        document.getElementById('total').textContent = `$${parseFloat(orderData.total).toFixed(2)}`;

        loadingEl.classList.add('hidden');
        orderContentEl.classList.remove('hidden');
    }

    /**
     * Main function to fetch the order from Firestore.
     */
    async function loadOrder() {
        const orderId = getQueryParam('id');
        
        if (!orderId) {
            loadingEl.classList.add('hidden');
            orderErrorEl.classList.remove('hidden');
            return;
        }

        try {
            // Document path: /orders/{orderId}
            const orderRef = doc(db, 'orders', orderId);
            const orderSnap = await getDoc(orderRef);

            if (orderSnap.exists()) {
                const orderData = { id: orderSnap.id, ...orderSnap.data() };
                renderOrder(orderData);
            } else {
                console.error("No order found with ID:", orderId);
                loadingEl.classList.add('hidden');
                orderErrorEl.classList.remove('hidden');
            }
        } catch (error) {
            console.error("Error fetching order:", error);
            // Display generic error message to user
            loadingEl.classList.add('hidden');
            orderErrorEl.classList.remove('hidden');
        }
    }

    // --- CRITICAL RACE CONDITION FIX ---
    // Wait for the custom 'firebase-ready' event before running
    // This ensures 'db' is initialized and available.
    document.addEventListener('firebase-ready', loadOrder);
</script>