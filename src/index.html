---
layout: layout
title: Southern Sense - Hand-Poured Luxury Candles
---

<script type="module">
    // Consolidation: All dependencies for CMS and Featured Products are now here.
    import { 
        db, 
        collection, 
        query, 
        where, 
        getDocs, 
        doc, 
        getDoc,
        limit 
    } from '/src/firebase-loader.js';
    // NOTE: addToCart and updateCartDisplay are now globally available after layout.html loads them.
    
    // --- DOM Elements ---
    const heroTitleEl = document.getElementById('hero-title');
    const heroSubtitleEl = document.getElementById('hero-subtitle');
    const diffWaxTextEl = document.getElementById('diff-wax-text');
    const diffOilsTextEl = document.getElementById('diff-oils-text');
    
    // --- DOM Elements (Products) ---
    const featuredProductsGrid = document.getElementById('featured-products-grid');
    const featuredLoader = document.getElementById('featured-loader');
    const featuredProductTitleEl = document.getElementById('featured-product-title');

    // --- CMS Logic (Consolidated from src/js/index.js) ---

    /**
     * Loads dynamic content for the Hero and Features sections from the 'siteContent/homepage' document.
     * @returns {Promise<string|null>} Returns the featuredProductId from CMS or null.
     */
    async function loadHomepageCMS() {
        let featuredId = null;
        try {
            const docRef = doc(db, "siteContent", "homepage");
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                
                // 1. Hero Section
                // CRITICAL FIX: Ensure the hero title uses the requested text if the CMS field is empty.
                if (heroTitleEl) heroTitleEl.textContent = data.heroTitle || "Handcrafted, Local, Luxury";
                if (heroSubtitleEl) heroSubtitleEl.textContent = data.heroSubtitle || "Experience the warmth and charm of the South with our hand-poured, luxury soy-blend candles, made in the heart of South Carolina.";
                
                // 2. Our Difference Section (CRITICAL FIX: Use homepage fields directly if present)
                if (diffWaxTextEl) diffWaxTextEl.textContent = data.diffWax || "We use a premium coconut-apricot wax blend that ensures a clean, slow, and even burn every time.";
                if (diffOilsTextEl) diffOilsTextEl.textContent = data.diffOils || "Our oils are 100% phthalate-free and safe, providing a rich scent throw without harmful chemicals.";
                
                // 3. Featured Product ID
                featuredId = data.featuredProductId || null;
            } else {
                console.warn("Homepage CMS document not found. Using defaults.");
                // Fallback: Use HTML's initial content if Firestore fails to prevent blank text
            }
        } catch (error) {
            console.error("Error fetching homepage CMS content:", error);
            // Fallback: Use HTML's initial content if network request fails
        }
        return featuredId;
    }


    // --- Product Logic (Optimized) ---
    
    /**
     * Renders a single product card HTML specifically for the homepage layout.
     * @param {Object} product - The product data.
     * @returns {string} The product card HTML string.
     */
    function renderProductCard(product) {
        const isOutOfStock = product.stock <= 0;
        // Note: product.price should already be a float from mapProduct, so we only format here.
        const price = product.price.toFixed(2); 
        const scentFamily = product.scentFamily ? product.scentFamily.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ') : 'Scent';

        // Determine stock display and button text
        let stockHtml = '';
        let buttonText = 'Add to Cart';
        let buttonClasses = 'bg-burnt-orange hover:bg-burnt-orange/80';
        let buttonDisabled = '';
        let buttonClickAction = '';

        if (isOutOfStock) {
            stockHtml = '<p class="text-sm font-semibold text-red-600">SOLD OUT</p>';
            buttonText = 'View Details';
            buttonClasses = 'bg-stone/50 hover:bg-stone/60 cursor-not-allowed';
            buttonDisabled = ''; // Keep button enabled for View Details action
            buttonClickAction = `onclick="window.location.href='/product/?id=${product.id}'"`;
        } else {
            stockHtml = '<p class="text-sm font-semibold text-green-600">In Stock</p>';
            buttonClickAction = ``; // Handled by standard 'add-to-cart-button' class listener
        }

        const actionButtonHtml = `
            <button ${buttonDisabled}
                    data-id="${product.id}" 
                    data-name="${product.name}"
                    data-price="${price}"
                    data-image="${product.imageUrl}"
                    class="add-to-cart-button w-full px-4 py-3 text-parchment font-bold rounded-lg shadow-md transition duration-300 ${buttonClasses}"
                    ${buttonClickAction}>
                ${buttonText}
            </button>
        `;
        
        // CRITICAL FIX (P1): Added alt tag to the dynamically generated image
        return `
            <div class="product-card bg-white rounded-xl shadow-xl overflow-hidden hover:shadow-2xl transition duration-300 transform hover:-translate-y-1">
                <a href="/product/?id=${product.id}" class="block">
                    <img src="/src/${product.imageUrl || 'logo.webp'}" alt="${product.name} luxury candle or wax melt." class="w-full h-72 object-cover">
                </a>
                <div class="p-5">
                    <p class="text-sm font-medium text-stone mb-1">${scentFamily}</p>
                    <h3 class="text-xl font-playfair text-charcoal mb-3 truncate">${product.name}</h3>
                    <div class="flex justify-between items-center mb-4 border-b pb-4">
                        <p class="text-xl font-bold text-burnt-orange">$${price}</p>
                        ${stockHtml}
                    </div>
                    ${actionButtonHtml}
                </div>
            </div>
        `;
    }

    /**
     * Attaches click listeners to all new "Add to Cart" buttons.
     */
    function attachCartListeners() {
        document.querySelectorAll('.add-to-cart-button:not([disabled])').forEach(button => {
            // CRITICAL FIX: Only attach the addToCart logic if the item is *not* out of stock.
            // Out of stock buttons will use the onclick="window.location.href" to view details.
            if (!button.textContent.includes('View Details')) {
                button.addEventListener('click', (e) => {
                    e.preventDefault();
                    const { id, name, price, image } = e.currentTarget.dataset;
                    
                    const product = { id, name, price, imageUrl: image };
                    
                    // Relying on global functions exposed to window by cart.js
                    if (window.addToCart && window.updateCartDisplay) {
                        window.addToCart(product, 1); 
                        window.updateCartDisplay(); 
                        
                        e.currentTarget.textContent = 'Added!';
                        setTimeout(() => {
                            e.currentTarget.textContent = 'Add to Cart';
                        }, 1000);
                    }
                });
            }
        });
    }

    /**
     * Fetches featured products from Firestore and renders them.
     * Prioritizes the product ID specified in the CMS, then defaults to 4 featured products.
     */
    async function fetchFeaturedProducts(featuredId) {
        featuredLoader.classList.remove('hidden');
        featuredProductsGrid.innerHTML = '';
        featuredProductTitleEl.textContent = 'Featured Scents';

        try {
            const productsRef = collection(db, 'products');
            let productsToRender = [];
            
            // Helper function to map and format product data
            const mapProduct = (doc) => {
                const data = doc.data();
                return {
                    id: doc.id,
                    ...data,
                    // CRITICAL FIX: Ensure numerical safety for stock and price string-to-number conversion
                    price: parseFloat(data.price) || 0.00, // Robust price check
                    stock: parseInt(data.stock, 10) || 0, 
                    featured: data.featured === true
                };
            };
            
            // 1. Attempt to fetch the specific featured product (Fix to resolve CMS data mismatch issue)
            if (featuredId) {
                const docSnap = await getDoc(doc(productsRef, featuredId));
                // CRITICAL FIX: Include CMS-featured product regardless of stock
                if (docSnap.exists()) {
                    const productData = mapProduct(docSnap);
                    productsToRender.push(productData);
                }
            }

            // 2. Fallback: Fill remaining spots with other products where featured is true (regardless of stock)
            if (productsToRender.length < 4) {
                // CRITICAL FIX: Simplified query to avoid the composite index requirement (FirebaseError)
                const q = query(productsRef, 
                                where('featured', '==', true), 
                                limit(10) // Fetch up to 10 featured items to ensure we get enough items
                            );
                const querySnapshot = await getDocs(q);
                
                querySnapshot.docs.forEach(doc => {
                    const productData = mapProduct(doc);
                    // Client-side filtering: REMOVE STOCK CHECK to ensure products display. Avoid duplicates, and limit the total count
                    if (!productsToRender.some(p => p.id === productData.id) && 
                        productsToRender.length < 4) {
                        productsToRender.push(productData);
                    }
                });
            }
            
            // 3. Final Fallback: If still empty (e.g., Firestore fetch error or no featured data), show an explicit error.
            if (productsToRender.length === 0) {
                featuredProductsGrid.innerHTML = '<p class="text-lg text-stone col-span-full text-center py-10">We are currently stocking our shelves. Please check back later!</p>';
            } else {
                // Render the first 4 available products, prioritizing stocked items
                productsToRender.sort((a, b) => {
                    // Sort criteria: stocked items first, then by name
                    if (a.stock > 0 && b.stock <= 0) return -1;
                    if (a.stock <= 0 && b.stock > 0) return 1;
                    return a.name.localeCompare(b.name);
                });
                
                productsToRender.slice(0, 4).forEach(data => {
                    featuredProductsGrid.innerHTML += renderProductCard(data);
                });
                attachCartListeners();
            }

        } catch (error) {
            // CRITICAL FIX: Report the specific error but continue. The FirebaseError is fixed by code change.
            console.error("Error fetching featured products:", error);
            featuredProductsGrid.innerHTML = `<p class="text-red-600 col-span-full text-center py-10">Failed to load featured products. Please check the browser console for specific dependency or Firestore errors.</p>`;
        } finally {
            featuredLoader.classList.add('hidden');
        }
    }
    
    /**
     * Main initialization function
     */
    async function initializeHomepage() {
        const featuredId = await loadHomepageCMS();
        await fetchFeaturedProducts(featuredId);
    }

    // --- Initialization Trigger (CRITICAL FIX: Wait for the async module load before initiating homepage logic) ---
    document.addEventListener('DOMContentLoaded', () => {
        function waitForCartReady() {
            if (window.addToCart && window.updateCartDisplay) {
                // Cart functions are ready. Now fetch and render products.
                initializeHomepage();
            } else {
                // If cart hasn't loaded yet (due to async import in layout.html), wait 50ms.
                setTimeout(waitForCartReady, 50);
            }
        }
        waitForCartReady();
    });

; // DEFENSIVE SEMICOLON: Added to absorb potential file truncation errors.
</script>

<main class="min-h-screen">
    
    <div class="relative w-full h-80 bg-cover bg-center" style="background-image: url('/src/candles-header.webp');">
        <div class="absolute inset-0 bg-charcoal/40 flex items-center justify-center">
            <div class="container mx-auto px-4 text-center">
                <h1 id="hero-title" class="text-5xl md:text-6xl font-southern text-burnt-orange font-bold mb-6 drop-shadow-lg">
                    Southern Sense
                </h1>
                <p id="hero-subtitle" class="text-xl text-parchment max-w-2xl mx-auto mb-8 drop-shadow-lg">
                    Experience the warmth and charm of the South with our hand-poured, luxury soy-blend candles, made in the heart of South Carolina.
                </p>
                <a href="/shop/" class="px-10 py-4 bg-burnt-orange text-parchment text-lg font-bold rounded-lg shadow-xl hover:bg-burnt-orange/80 transition duration-300">
                    Shop Our Scents
                </a>
            </div>
        </div>
    </div>
    
    <section class="container mx-auto px-4 py-20">
        <div class="max-w-6xl mx-auto bg-white p-8 lg:p-12 rounded-xl shadow-2xl border border-stone/10">
            <h2 id="featured-product-title" class="text-4xl font-playfair text-charcoal text-center mb-12">Featured Scents</h2>
            
            <div id="featured-loader" class="flex justify-center items-center h-48">
                <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-burnt-orange"></div>
            </div>

            <div id="featured-products-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
            </div>

            <div class="text-center mt-12">
                <a href="/shop/" class="px-8 py-3 border border-stone/30 text-charcoal font-bold rounded-lg hover:bg-parchment/70 transition duration-300">
                    View All Candles & Melts
                </a>
            </div>
        </div>
    </section>

    <section class="bg-stone/10 py-20 border-t border-b border-stone/10">
        <div class="container mx-auto px-4 max-w-6xl">
            <h2 class="text-5xl font-southern text-burnt-orange text-center mb-12">The Southern Sense Promise</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-10 text-center">
                <div class="p-6 bg-white rounded-xl shadow-md hover:shadow-xl hover:-translate-y-1 transition duration-300 border border-stone/10">
                    <img src="/src/finest-wax.webp" alt="Close-up of un-melted coconut apricot wax blocks in a container." class="w-20 h-20 mx-auto mb-4">
                    <h3 class="text-2xl font-playfair text-charcoal mb-2">Finest Wax Blends</h3>
                    <p id="diff-wax-text" class="text-stone">We use a premium coconut-apricot wax blend that ensures a clean, slow, and even burn every time.</p>
                </div>
                <div class="p-6 bg-white rounded-xl shadow-md hover:shadow-xl hover:-translate-y-1 transition duration-300 border border-stone/10">
                    <img src="/src/clean-oils.webp" alt="A collection of small brown bottles containing fragrance oils, sitting by a fireplace." class="w-20 h-20 mx-auto mb-4">
                    <h3 class="text-2xl font-playfair text-charcoal mb-2">Clean Fragrance Oils</h3>
                    <p id="diff-oils-text" class="text-stone">Our oils are 100% phthalate-free and safe, providing a rich scent throw without harmful chemicals.</p>
                </div>
                <div class="p-6 bg-white rounded-xl shadow-md hover:shadow-xl hover:-translate-y-1 transition duration-300 border border-stone/10">
                    <img src="/src/hand-poured-quality.webp" alt="A pair of hands carefully pouring melted wax from a metal pitcher into three black candle tins." class="w-20 h-20 mx-auto mb-4">
                    <h3 class="text-2xl font-playfair text-charcoal mb-2">Hand-Poured Quality</h3>
                    <p class="text-stone">Each candle is hand-poured in small batches in the South, guaranteeing attention to detail and superior quality.</p>
                </div>
            </div>
        </div>
    </section>

    <section class="container mx-auto px-4 py-20 text-center">
        <div class="max-w-6xl mx-auto bg-white p-8 lg:p-12 rounded-xl shadow-2xl border border-stone/10">
            <h2 class="text-4xl font-playfair text-charcoal mb-4">Can't Decide? Try Our Scent Quiz!</h2>
            <p class="text-lg text-stone max-w-xl mx-auto mb-8">Answer a few quick questions and we'll match you with the perfect Southern Sense fragrance for your home and mood.</p>
            <a href="/scent-quiz/" class="px-8 py-3 bg-stone text-parchment font-bold rounded-lg shadow-lg hover:bg-charcoal transition duration-300">
                Take the Quiz Now
            </a>
        </div>
    </section>
</main>