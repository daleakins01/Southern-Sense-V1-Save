---
layout: layout
title: Product Name
---

<script type="module">
    import { 
        db, 
        doc, 
        getDoc, 
        collection, 
        query, 
        where, 
        getDocs, 
        addDoc, 
        serverTimestamp 
    } from '/src/firebase-loader.js';
    

    // --- DOM Elements ---
    const productLoader = document.getElementById('product-loader');
    const productContent = document.getElementById('product-content');
    const productTitle = document.getElementById('product-title');
    const productPrice = document.getElementById('product-price');
    const productShortDescription = document.getElementById('product-short-description');
    const productLongDescription = document.getElementById('product-long-description');
    const productDetailsContainer = document.getElementById('product-details-container');
    const productScentNotes = document.getElementById('product-scent-notes');
    const productStrength = document.getElementById('product-strength');
    const productPairing = document.getElementById('product-pairing');
    const productImageUrl = document.getElementById('product-image-url');
    const quantityInput = document.getElementById('quantity-input');
    const addToCartButton = document.getElementById('add-to-cart-button');
    const stockAlertContainer = document.getElementById('stock-alert-container');
    const reviewSummaryStars = document.getElementById('review-summary-stars');
    const reviewSummaryCount = document.getElementById('review-summary-count');
    const productReviewsContainer = document.getElementById('product-reviews-container');
    const productReviewForm = document.getElementById('product-review-form');
    const reviewFormMessage = document.getElementById('review-form-message');
    const stockQuantityDisplay = document.getElementById('stock-quantity-display');

    let currentProduct = null;
    let reviewsList = [];
    
    // --- Utility Functions ---
    
    /**
     * Helper to get milliseconds from Timestamp object or raw { _seconds, _nanoseconds } object.
     */
    function getTimeInMs(timestamp) {
        if (!timestamp) return 0;
        // Check if it is a native Firebase Timestamp object with .toDate() method
        if (typeof timestamp.toDate === 'function') {
            return timestamp.toDate().getTime();
        }
        // Assume it's a raw object from JSON import: { _seconds, _nanoseconds }
        if (timestamp._seconds) {
            return (timestamp._seconds * 1000) + Math.round(timestamp._nanoseconds / 1000000);
        }
        return 0;
    }

    /**
     * Renders star icons based on a rating value.
     */
    function renderStars(rating, sizeClass = 'text-xl') {
        let stars = '';
        const roundedRating = Math.round(rating);
        for (let i = 0; i < 5; i++) {
            stars += `<span class="${i < roundedRating ? 'text-burnt-orange' : 'text-stone/40'} ${sizeClass}">&starf;</span>`;
        }
        return stars;
    }
    
    /**
     * Formats a Firebase Timestamp or raw object into a readable date string.
     */
    function formatDate(timestamp) {
        const ms = getTimeInMs(timestamp);
        if (ms === 0) return 'N/A';
        return new Date(ms).toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
    }

    /**
     * Fetches a single product from Firestore based on the URL parameter.
     */
    async function fetchProduct() {
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id');

        if (!productId) {
            renderError("No product ID provided in the URL.");
            return;
        }

        try {
            const productRef = doc(db, 'products', productId);
            const docSnap = await getDoc(productRef);

            // CRITICAL FIX: Add check for document existence
            if (!docSnap.exists()) {
                renderError(`Product with ID: ${productId} was not found.`);
                return;
            }

            const product = docSnap.data();
            // CRITICAL FIX: Ensure robust data cleaning on load
            const cleanPrice = parseFloat(product.price) || 0.00;
            const cleanStock = parseInt(product.stock, 10) || 0;
            
            currentProduct = { id: docSnap.id, ...product, price: cleanPrice, stock: cleanStock };
            
            // --- Render Product Data ---
            productTitle.textContent = product.name;
            productPrice.textContent = `$${currentProduct.price.toFixed(2)}`;
            
            productShortDescription.textContent = product.shortDescription;
            productLongDescription.innerHTML = product.longDescription; // Assuming HTML content
            
            // Image (Handle both direct filenames and full URLs)
            productImageUrl.src = product.imageUrl.startsWith('http') 
                                  ? product.imageUrl 
                                  : `/src/${product.imageUrl}`;
            productImageUrl.alt = product.name;

            // Details
            productScentNotes.textContent = product.scentNotes;
            // FIX: Ensure strength is read as a number for rendering stars (assuming 5 is max strength)
            productStrength.innerHTML = renderStars(product.strength || 0, 'text-base');
            productPairing.textContent = product.pairing;
            
            // Stock & Cart Button
            if (currentProduct.stock <= 0) {
                addToCartButton.disabled = true;
                addToCartButton.textContent = 'Out of Stock';
                addToCartButton.classList.add('opacity-50', 'cursor-not-allowed');
                stockQuantityDisplay.textContent = 'Out of Stock';
                stockQuantityDisplay.classList.remove('text-green-600', 'text-burnt-orange');
                stockQuantityDisplay.classList.add('text-red-600');
                stockAlertContainer.classList.remove('hidden');
                
            } else if (currentProduct.stock <= 10) {
                stockQuantityDisplay.textContent = `Only ${currentProduct.stock} left in stock!`;
                stockQuantityDisplay.classList.remove('text-green-600', 'text-red-600');
                stockQuantityDisplay.classList.add('text-burnt-orange');
                addToCartButton.disabled = false;
                stockAlertContainer.classList.add('hidden'); // Ensure hidden if stock is present
            } else {
                stockQuantityDisplay.textContent = 'In Stock';
                stockQuantityDisplay.classList.remove('text-burnt-orange', 'text-red-600');
                stockQuantityDisplay.classList.add('text-green-600');
                addToCartButton.disabled = false;
                stockAlertContainer.classList.add('hidden');
            }

            // --- Load Reviews (Concurrent Fetch) ---
            await fetchReviews(productId);
            
            productLoader.classList.add('hidden');
            productContent.classList.remove('hidden');
            
        } catch (error) {
            console.error("Error fetching product:", error);
            renderError("Failed to load product details.");
        }
    }
    
    /**
     * Renders an error state.
     */
    function renderError(message) {
        productLoader.classList.add('hidden');
        document.getElementById('product-error-message').textContent = message;
        document.getElementById('product-error-section').classList.remove('hidden');
    }


    // --- Reviews Logic ---

    async function fetchReviews(productId) {
        reviewsList = [];
        try {
            const reviewsRef = collection(db, 'reviews');
            // Query for reviews for this product ID and ensure they are approved
            // Firestore Rule: allow read: if resource.data.approved == true || isAdmin();
            const q = query(reviewsRef, 
                            where('productId', '==', productId), 
                            where('approved', '==', true));
                            
            const querySnapshot = await getDocs(q);

            querySnapshot.forEach(doc => {
                reviewsList.push(doc.data());
            });

            renderReviews();

        } catch (error) {
            console.error("Error fetching reviews:", error);
            // Non-critical error, just log and show an empty review section
            productReviewsContainer.innerHTML = '<p class="text-stone">Could not load reviews at this time.</p>';
            reviewSummaryCount.textContent = '0 Reviews';
        }
    }

    function renderReviews() {
        const totalReviews = reviewsList.length;
        
        if (totalReviews === 0) {
            reviewSummaryStars.innerHTML = renderStars(0);
            reviewSummaryCount.textContent = 'No reviews yet.';
            productReviewsContainer.innerHTML = '<p class="text-stone">Be the first to leave a review for this product!</p>';
            return;
        }

        // Calculate average rating
        const totalRating = reviewsList.reduce((sum, review) => sum + (review.rating || 0), 0);
        const averageRating = totalRating / totalReviews;
        
        // Update summary
        reviewSummaryStars.innerHTML = renderStars(averageRating);
        reviewSummaryCount.textContent = `${averageRating.toFixed(1)} (${totalReviews} Reviews)`;

        // Render individual reviews
        let reviewsHtml = '';
        // CRITICAL FIX: Use the new robust getTimeInMs helper for sorting, eliminating the TypeError
        reviewsList.sort((a, b) => getTimeInMs(b.submittedAt) - getTimeInMs(a.submittedAt)); // Newest first

        reviewsList.forEach(review => {
            const reviewDate = review.submittedAt ? formatDate(review.submittedAt) : 'N/A';
            reviewsHtml += `
                <div class="border-b border-stone/10 py-4">
                    <div class="flex items-center justify-between mb-2">
                        <div class="font-bold text-charcoal">${review.name || 'Anonymous Customer'}</div>
                        <div class="text-sm text-stone">${reviewDate}</div>
                    </div>
                    <div class="mb-2">
                        ${renderStars(review.rating, 'text-lg')}
                    </div>
                    <p class="text-stone italic">"${review.text}"</p>
                </div>
            `;
        });
        
        productReviewsContainer.innerHTML = reviewsHtml;
    }
    
    /**
     * Handles the submission of a new review.
     */
    async function handleReviewSubmit(e) {
        e.preventDefault();
        
        const name = document.getElementById('review-name').value.trim();
        const rating = parseInt(document.getElementById('review-rating').value, 10);
        const text = document.getElementById('review-text').value.trim();
        const submitButton = e.submitter;
        
        if (!name || !rating || !text || rating < 1 || rating > 5) {
            reviewFormMessage.textContent = 'Please fill out all fields and select a valid rating.';
            reviewFormMessage.classList.remove('hidden', 'text-green-600');
            reviewFormMessage.classList.add('text-red-600');
            return;
        }
        
        submitButton.disabled = true;
        submitButton.textContent = 'Submitting...';
        reviewFormMessage.classList.add('hidden');
        
        try {
            const reviewData = {
                productId: currentProduct.id,
                productName: currentProduct.name, // CRITICAL FIX: Ensure productName is included for admin context
                name: name,
                rating: rating,
                text: text,
                submittedAt: serverTimestamp(), // CRITICAL FIX: serverTimestamp is now correctly available
                approved: false // Firestore Rule: request.resource.data.approved must be false on create
            };

            await addDoc(collection(db, 'reviews'), reviewData);
            
            reviewFormMessage.textContent = 'Review submitted successfully! It will appear after admin approval.';
            reviewFormMessage.classList.remove('hidden', 'text-red-600');
            reviewFormMessage.classList.add('text-green-600');

            productReviewForm.reset(); // Clear the form
            
        } catch (error) {
            console.error("Error submitting review:", error);
            reviewFormMessage.textContent = 'Failed to submit review. Please try again.';
            reviewFormMessage.classList.remove('hidden', 'text-green-600');
            reviewFormMessage.classList.add('text-red-600');
        } finally {
            submitButton.disabled = false;
            submitButton.textContent = 'Submit Review';
        }
    }
    
    /**
     * Handles back-in-stock request submission.
     */
    async function handleStockAlert(e) {
        e.preventDefault();
        
        const emailInput = document.getElementById('alert-email-input');
        const submitButton = e.submitter;
        const email = emailInput.value.trim();
        
        if (!email || !email.includes('@')) {
            alert("Please enter a valid email address.");
            return;
        }
        
        submitButton.disabled = true;
        submitButton.textContent = 'Requesting...';
        
        try {
            // CRITICAL FIX: Check if alert already exists for this email/product
            const alertsRef = collection(db, 'backInStockRequests');
            const q = query(alertsRef, 
                            where('productId', '==', currentProduct.id), 
                            where('email', '==', email));
            const existingAlerts = await getDocs(q);
            
            if (!existingAlerts.empty) {
                alert("You are already signed up for a stock alert for this product.");
                emailInput.value = '';
                return;
            }
            
            // CRITICAL FIX: Ensure all 5 required fields are present for Firestore rule compliance
            const alertData = {
                productId: currentProduct.id,
                productName: currentProduct.name,
                email: email,
                requestedAt: serverTimestamp(), 
                resolved: false 
            };

            await addDoc(alertsRef, alertData);
            
            alert("Success! We will notify you when this product is back in stock.");
            emailInput.value = '';
            
        } catch (error) {
            console.error("Error submitting stock alert:", error);
            alert("Failed to sign up for stock alert. Please check the console.");
        } finally {
            submitButton.disabled = false;
            submitButton.textContent = 'Notify Me When Available';
        }
    }


    // --- Initialization ---

    document.addEventListener('DOMContentLoaded', () => {
        // Initial data load
        fetchProduct();
        
        // Listeners
        addToCartButton.addEventListener('click', () => {
            if (currentProduct) {
                const quantity = parseInt(quantityInput.value, 10);
                if (quantity > 0) {
                    // CRITICAL FIX: Defensive check to prevent TypeError crash if cart.js failed to load
                    if (window.addToCart && window.updateCartDisplay) {
                        window.addToCart(currentProduct, quantity);
                        window.updateCartDisplay(); // Refresh the cart count in the header
                        // Simple, non-intrusive confirmation
                        addToCartButton.textContent = `Added ${quantity} to Cart!`;
                        setTimeout(() => {
                            addToCartButton.textContent = 'Add to Cart';
                        }, 1500);
                    } else {
                         alert('Initialization Error: Cart functionality not loaded. Please try refreshing the page.');
                    }
                } else {
                    alert('Please enter a quantity greater than zero.');
                }
            }
        });
        
        productReviewForm.addEventListener('submit', handleReviewSubmit);
        
        const stockAlertForm = document.getElementById('stock-alert-form');
        if (stockAlertForm) {
            stockAlertForm.addEventListener('submit', handleStockAlert);
        }
    });

; // DEFENSIVE SEMICOLON: Added to absorb potential file truncation errors.
</script>

<main class="container mx-auto px-4 py-12 min-h-screen">
    <div class="max-w-6xl mx-auto bg-white p-8 lg:p-12 rounded-xl shadow-2xl border border-stone/10">

        <div id="product-loader" class="flex justify-center items-center h-96">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-burnt-orange"></div>
        </div>
        
        <div id="product-error-section" class="hidden text-center max-w-lg mx-auto py-20 bg-parchment rounded-lg shadow-lg">
            <h1 class="text-4xl font-playfair text-red-600 mb-4">Product Not Found</h1>
            <p id="product-error-message" class="text-lg text-stone mb-6">
                The product you are looking for could not be found.
            </p>
            <a href="/shop/" class="px-8 py-3 bg-burnt-orange text-parchment font-bold rounded-lg shadow-lg hover:bg-burnt-orange/80 transition duration-300">
                Return to Shop
            </a>
        </div>

        <div id="product-content" class="hidden">
            <a href="/shop/" class="inline-flex items-center space-x-2 text-burnt-orange font-semibold hover:text-stone transition mb-8">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                <span>Back to Shop</span>
            </a>
            
            <div class="flex flex-col lg:flex-row gap-10">
                
                <div class="lg:w-1/2">
                    <div class="group relative overflow-hidden rounded-xl shadow-xl border border-stone/10"> 
                        <img id="product-image-url" src="" alt="" class="w-full h-auto object-cover transition-transform duration-500 group-hover:scale-105">
                    </div>
                </div>

                <div class="lg:w-1/2">
                    <h1 id="product-title" class="text-4xl font-playfair text-charcoal mb-3">Loading...</h1>
                    
                    <p id="product-price" class="text-3xl font-bold text-burnt-orange mb-4">$--.--</p>
                    
                    <div class="flex items-center space-x-2 mb-6 border-b pb-4">
                        <div id="review-summary-stars" class="flex"></div>
                        <span id="review-summary-count" class="text-sm text-stone">(0 Reviews)</span>
                    </div>

                    <p id="product-short-description" class="text-lg text-stone italic mb-6 bg-parchment p-3 rounded-lg shadow-sm"></p>

                    <div class="prose max-w-none text-charcoal mb-8 bg-parchment p-5 rounded-lg border border-stone/10">
                        <div id="product-long-description"></div>
                    </div>

                    <div class="bg-parchment p-5 rounded-lg mb-8 shadow-inner">
                        <h3 class="text-xl font-playfair text-charcoal mb-3 border-b pb-2">Product Details</h3>
                        <dl class="space-y-2 text-charcoal">
                            <div class="flex justify-between">
                                <dt class="font-medium">Scent Notes:</dt>
                                <dd id="product-scent-notes" class="text-stone"></dd>
                            </div>
                            <div class="flex justify-between">
                                <dt class="font-medium">Scent Strength:</dt>
                                <dd id="product-strength" class="text-stone flex items-center"></dd>
                            </div>
                            <div class="flex justify-between">
                                <dt class="font-medium">Perfect Pairing:</dt>
                                <dd id="product-pairing" class="text-stone"></dd>
                            </div>
                        </dl>
                    </div>
                    
                    <div class="flex items-center space-x-4 mb-4">
                        <input type="number" id="quantity-input" value="1" min="1" class="w-20 p-3 border border-stone/30 rounded-lg text-center text-charcoal focus:border-burnt-orange focus:ring-1 focus:ring-burnt-orange">
                        <button id="add-to-cart-button" class="flex-grow px-6 py-3 bg-burnt-orange text-parchment font-bold rounded-lg shadow-md hover:bg-burnt-orange/80 transition duration-300">
                            Add to Cart
                        </button>
                    </div>
                    
                    <p id="stock-quantity-display" class="text-sm font-semibold mb-6"></p>
                    
                    <div id="stock-alert-container" class="hidden mt-6 p-4 bg-red-50 border border-red-200 rounded-lg">
                        <p class="font-semibold text-red-600 mb-3">This product is currently out of stock.</p>
                        <form id="stock-alert-form" class="flex space-x-2">
                            <input type="email" id="alert-email-input" placeholder="Your Email Address" required class="flex-grow p-2 border border-stone/30 rounded-lg text-charcoal">
                            <button type="submit" class="px-4 py-2 bg-burnt-orange text-parchment font-semibold rounded-lg hover:bg-burnt-orange/80 transition duration-300">
                                Notify Me When Available
                            </button>
                        </form>
                    </div>
                    
                </div>
                
            </div>
            
            <div class="mt-20 border-t pt-10">
                <h2 class="text-3xl font-playfair text-charcoal mb-8">Customer Reviews</h2>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">
                    
                    <div class="lg:col-span-2">
                        <div id="product-reviews-container">
                            <p class="text-stone">Loading reviews...</p>
                        </div>
                    </div>
                    
                    <div class="lg:col-span-1 p-6 bg-parchment rounded-lg shadow-md sticky top-6 self-start">
                        <h3 class="text-2xl font-playfair text-charcoal mb-4">Leave a Review</h3>
                        <form id="product-review-form" class="space-y-4">
                            
                            <div>
                                <label for="review-name" class="block text-sm font-medium text-charcoal mb-1">Your Name</label>
                                <input type="text" id="review-name" required class="w-full p-2 border border-stone/30 rounded-lg text-charcoal">
                            </div>
                            
                            <div>
                                <label for="review-rating" class="block text-sm font-medium text-charcoal mb-1">Rating (1-5 Stars)</label>
                                <select id="review-rating" required class="w-full p-2 border border-stone/30 rounded-lg text-charcoal">
                                    <option value="">Select a rating</option>
                                    <option value="5">5 Stars - Excellent</option>
                                    <option value="4">4 Stars - Very Good</option>
                                    <option value="3">3 Stars - Good</option>
                                    <option value="2">2 Stars - Fair</option>
                                    <option value="1">1 Star - Poor</option>
                                </select>
                            </div>
                            
                            <div>
                                <label for="review-text" class="block text-sm font-medium text-charcoal mb-1">Your Review</label>
                                <textarea id="review-text" rows="4" required class="w-full p-2 border border-stone/30 rounded-lg text-charcoal"></textarea>
                            </div>
                            
                            <p id="review-form-message" class="hidden text-sm font-medium"></p>
                            
                            <button type="submit" class="w-full px-4 py-3 bg-burnt-orange text-parchment font-bold rounded-lg hover:bg-burnt-orange/80 transition duration-300">
                                Submit Review
                            </button>
                            <p class="text-xs text-stone text-center mt-2">All reviews are subject to admin approval.</p>
                        </form>
                    </div>
                </div>
            </div>
            
        </div> </div>
</main>

**Next file to update: `src/contact.html`** (to check for remaining build errors and syntactic conflicts)