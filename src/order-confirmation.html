---
layout: layout
title: Order Confirmed
---

<script type="module">
    import { 
        db, 
        doc, 
        getDoc, 
        auth, 
        onAuthStateChanged,
        Timestamp // CRITICAL FIX: Ensure Timestamp is imported for the formatDate utility
    } from '/src/firebase-loader.js';

    // --- DOM Elements ---
    const confirmationLoader = document.getElementById('confirmation-loader');
    const confirmationContent = document.getElementById('confirmation-content');
    const orderIdDisplay = document.getElementById('order-id-display');
    const orderDateDisplay = document.getElementById('order-date-display');
    const orderTotalDisplay = document.getElementById('order-total-display');
    const shippingNameDisplay = document.getElementById('shipping-name-display');
    const shippingAddressDisplay = document.getElementById('shipping-address-display');
    const itemizedListContainer = document.getElementById('itemized-list-container');
    const subtotalDisplay = document.getElementById('subtotal-display');
    const shippingDisplay = document.getElementById('shipping-display');
    const authMessageContainer = document.getElementById('auth-message-container');
    const errorSection = document.getElementById('error-section');
    const errorMessageEl = document.getElementById('error-message');


    // --- Utility Functions ---
    
    /**
     * Formats a Firebase Timestamp object into a readable date string.
     */
    function formatDate(timestamp) {
        if (!timestamp || !timestamp.toDate) return 'N/A';
        return timestamp.toDate().toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });
    }
    
    /**
     * Renders an error state and message.
     */
    function renderError(message) {
        confirmationLoader.classList.add('hidden');
        confirmationContent.classList.add('hidden');
        errorSection.classList.remove('hidden');
        errorMessageEl.textContent = message;
    }

    // --- Main Logic ---

    /**
     * Fetches and displays the order details based on the URL query parameter.
     */
    async function loadOrderDetails(currentUser) {
        const urlParams = new URLSearchParams(window.location.search);
        const orderId = urlParams.get('orderId');

        if (!orderId) {
            renderError("No Order ID provided in the URL.");
            return;
        }

        confirmationLoader.classList.remove('hidden');
        errorSection.classList.add('hidden');

        try {
            const orderRef = doc(db, 'orders', orderId);
            const docSnap = await getDoc(orderRef);

            if (!docSnap.exists()) {
                renderError(`Order ID: ${orderId} was not found in our records.`);
                return;
            }

            const order = docSnap.data();
            
            // CRITICAL SECURITY CHECK: Ensure the user owns the order, unless it was a guest checkout
            if (order.userId && currentUser && order.userId !== currentUser.uid) {
                // If a userId exists on the order and it doesn't match the current user, deny read access.
                renderError("Access Denied: You do not have permission to view this order.");
                return;
            }
            // If the user is logged out (guest checkout), the read is allowed by Firestore Rules if no 'userId' field exists on the order.

            // --- Render Order Header ---
            orderIdDisplay.textContent = orderId.toUpperCase();
            orderDateDisplay.textContent = formatDate(order.createdAt);
            orderTotalDisplay.textContent = `$${order.totals.total.toFixed(2)}`;
            
            // --- Render Shipping Info ---
            const customer = order.customer || {};
            // FIX: Handle cases where first/last name might be empty strings
            const fullName = `${customer.firstName || ''} ${customer.lastName || ''}`.trim();

            shippingNameDisplay.textContent = fullName || 'Guest Customer';
            shippingAddressDisplay.innerHTML = `
                ${customer.address}<br>
                ${customer.city}, ${customer.state} ${customer.zip}
            `;
            
            // --- Render Itemized List and Subtotals ---
            let itemsHtml = '';
            order.items.forEach(item => {
                const itemTotal = (item.price * item.quantity).toFixed(2);
                itemsHtml += `
                    <div class="flex justify-between py-3 border-b border-stone/10">
                        <div class="flex items-center space-x-3">
                            <img src="${item.imageUrl.startsWith('http') ? item.imageUrl : '/src/' + item.imageUrl}" alt="${item.name}" class="w-12 h-12 object-cover rounded-md">
                            <div>
                                <p class="font-medium text-charcoal">${item.name}</p>
                                <p class="text-sm text-stone">Qty: ${item.quantity} @ $${parseFloat(item.price).toFixed(2)}</p>
                            </div>
                        </div>
                        <span class="font-medium text-charcoal">$${itemTotal}</span>
                    </div>
                `;
            });
            itemizedListContainer.innerHTML = itemsHtml;
            
            subtotalDisplay.textContent = `$${order.totals.subtotal.toFixed(2)}`;
            shippingDisplay.textContent = `$${order.totals.shipping.toFixed(2)}`;
            
            // --- Render Auth Message ---
            if (user) {
                authMessageContainer.innerHTML = `
                    <p class="text-sm text-stone mt-2">
                        This order has been saved to your <a href="/account/" class="text-burnt-orange font-semibold hover:underline">Account History</a>.
                    </p>
                `;
            } else {
                authMessageContainer.innerHTML = `
                    <p class="text-sm text-stone mt-2">
                        To easily track this order, consider <a href="/register/" class="text-burnt-orange font-semibold hover:underline">creating an account</a>.
                    </p>
                `;
            }

            // --- Success: Show content ---
            confirmationLoader.classList.add('hidden');
            confirmationContent.classList.remove('hidden');

        } catch (error) {
            console.error("Error during order lookup:", error);
            renderError("A critical error occurred while fetching your order details.");
        }
    }

    // --- Initialization ---

    document.addEventListener('DOMContentLoaded', () => {
        // Use auth listener to get user state before loading, which is needed for the security check
        onAuthStateChanged(auth, (user) => {
            // Pass the user object (can be null for guest checkout) to the loader
            loadOrderDetails(user); 
        });
    });

</script>

<main class="container mx-auto px-4 py-12 min-h-screen">
    
    <div id="confirmation-loader" class="flex justify-center items-center h-96">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-burnt-orange"></div>
    </div>
    
    <div id="error-section" class="hidden text-center max-w-lg mx-auto py-20 bg-parchment rounded-lg shadow-lg">
        <h1 class="text-4xl font-playfair text-red-600 mb-4">Oops! Order Not Found</h1>
        <p id="error-message" class="text-lg text-stone mb-6">
            The order ID provided could not be matched with any record.
        </p>
        <a href="/shop/" class="px-8 py-3 bg-burnt-orange text-parchment font-bold rounded-lg shadow-lg hover:bg-burnt-orange/80 transition duration-300">
            Return to Shop
        </a>
    </div>

    <div id="confirmation-content" class="hidden max-w-4xl mx-auto">
        
        <div class="text-center pb-8 border-b border-stone/20 mb-8">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-green-600 mx-auto mb-4" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
            </svg>
            <h1 class="text-5xl font-playfair text-charcoal mb-2">Order Confirmed!</h1>
            <p class="text-xl text-stone">Thank you for your purchase from Southern Sense.</p>
            <p class="text-lg text-charcoal font-medium mt-4">Order #<span id="order-id-display">...</span></p>
            <div id="auth-message-container">
                </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="lg:col-span-2">
                <h2 class="text-3xl font-playfair text-charcoal mb-4 border-b pb-2">What You Ordered</h2>
                <div id="itemized-list-container">
                    </div>

                <div class="mt-6 space-y-2 max-w-xs ml-auto">
                    <div class="flex justify-between text-stone">
                        <span>Subtotal:</span>
                        <span id="subtotal-display" class="font-medium"></span>
                    </div>
                    <div class="flex justify-between text-stone">
                        <span>Shipping:</span>
                        <span id="shipping-display" class="font-medium"></span>
                    </div>
                    <div class="flex justify-between text-xl font-bold text-burnt-orange pt-2 border-t">
                        <span>GRAND TOTAL:</span>
                        <span id="order-total-display"></span> 
                    </div>
                </div>
                
                <div class="mt-8 pt-4 border-t border-stone/20">
                    <p class="text-sm text-stone">
                        Questions about your order? Email us at <a href="mailto:support@southernsense.org" class="text-burnt-orange hover:underline">support@southernsense.org</a> and reference your Order #.
                    </p>
                </div>
            </div>

            <div class="lg:col-span-1 p-6 bg-parchment rounded-lg shadow-md border-l-4 border-stone">
                <h2 class="text-3xl font-playfair text-charcoal mb-4 border-b pb-2">Shipping To</h2>
                <p id="shipping-name-display" class="text-lg font-semibold text-charcoal mb-1">
                    Shipping Name
                </p>
                <address id="shipping-address-display" class="text-stone not-italic leading-relaxed">
                    </address>

                <h3 class="text-2xl font-playfair text-charcoal mt-6 mb-2 pt-4 border-t">Estimated Delivery</h3>
                <p class="text-stone">5-7 Business Days (Excludes processing time)</p>
                
                <h3 class="text-2xl font-playfair text-charcoal mt-6 mb-2 pt-4 border-t">Date Placed</h3>
                <p id="order-date-display" class="text-stone"></p>
            </div>
            
        </div>
    </div>
</main>