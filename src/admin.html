<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-M" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard - Southern Sense</title>
    <link rel="stylesheet" href="/output.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Roboto:wght@300;400;500&display=swap"
      rel="stylesheet"
    />
    <!-- 
      NOTE: This is a standalone app. 
      It does NOT use Eleventy layouts.
    -->
  </head>
  <body class="bg-gray-100 font-roboto">
    <!-- Header -->
    <header class="bg-charcoal text-white shadow-lg">
      <nav class="container mx-auto px-4 py-4 flex justify-between items-center">
        <div>
          <h1 class="font-playfair text-2xl font-bold">
            Southern Sense - Admin
          </h1>
          <p class="text-sm text-stone">Welcome, <span id="admin-email">...</span></p>
        </div>
        <button
          id="logout-button"
          class="bg-stone hover:bg-burnt-orange text-white px-4 py-2 rounded-md transition-colors duration-300"
        >
          Sign Out
        </button>
      </nav>
    </header>

    <!-- Loading Spinner (Full Page) -->
    <div id="full-page-spinner" class="fixed inset-0 bg-gray-100 bg-opacity-75 flex justify-center items-center z-50">
      <svg
        class="animate-spin h-10 w-10 text-burnt-orange"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
      >
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path
          class="opacity-75"
          fill="currentColor"
          d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
        ></path>
      </svg>
      <span class="ml-4 text-xl text-charcoal font-playfair">Authenticating...</span>
    </div>

    <!-- Main Content (Hidden until auth) -->
    <main id="admin-content" class="container mx-auto px-4 py-8 hidden">
      <!-- Tabs -->
      <div class="mb-6 border-b border-gray-300">
        <nav class="flex space-x-4" aria-label="Tabs">
          <button
            id="tab-products"
            class="tab-btn active-tab"
            data-tab="products"
          >
            Products
          </button>
          <button id="tab-orders" class="tab-btn" data-tab="orders">
            Orders
          </button>
          <button id="tab-reviews" class="tab-btn" data-tab="reviews">
            Reviews
          </button>
          <button id="tab-content" class="tab-btn" data-tab="content">
            Site Content
          </button>
        </nav>
      </div>

      <!-- Tab Panels -->
      <div>
        <!-- Products Panel -->
        <section id="panel-products" class="tab-panel active-panel">
          <div class="flex justify-between items-center mb-4">
            <h2 class="font-playfair text-3xl text-charcoal">Products</h2>
            <button
              id="show-new-product-form"
              class="bg-burnt-orange text-white px-5 py-2 rounded-md shadow-lg hover:bg-opacity-90"
            >
              Add New Product
            </button>
          </div>
          <!-- Product List -->
          <div class="bg-white shadow-lg rounded-lg overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone uppercase tracking-wider">
                    Product
                  </th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone uppercase tracking-wider">
                    Category
                  </th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone uppercase tracking-wider">
                    Stock
                  </th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone uppercase tracking-wider">
                    Price
                  </th>
                  <th scope="col" class="relative px-6 py-3">
                    <span class="sr-only">Edit</span>
                  </th>
                </tr>
              </thead>
              <tbody id="product-list" class="bg-white divide-y divide-gray-200">
                <!-- Product rows will be injected here -->
                <tr id="product-list-loading">
                  <td colspan="5" class="px-6 py-12 text-center text-stone italic">
                    Loading products...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>

        <!-- Orders Panel -->
        <section id="panel-orders" class="tab-panel">
          <h2 class="font-playfair text-3xl text-charcoal mb-4">Orders</h2>
          <div class="bg-white shadow-lg rounded-lg overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone uppercase tracking-wider">
                    Order ID
                  </th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone uppercase tracking-wider">
                    Date
                  </th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone uppercase tracking-wider">
                    Customer
                  </th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone uppercase tracking-wider">
                    Total
                  </th>
                  <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-stone uppercase tracking-wider">
                    Status
                  </th>
                  <th scope="col" class="relative px-6 py-3">
                    <span class="sr-only">View</span>
                  </th>
                </tr>
              </thead>
              <tbody id="order-list" class="bg-white divide-y divide-gray-200">
                <!-- Order rows will be injected here -->
                <tr id="order-list-loading">
                  <td colspan="6" class="px-6 py-12 text-center text-stone italic">
                    Loading orders...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>

        <!-- Reviews Panel -->
        <section id="panel-reviews" class="tab-panel">
          <h2 class="font-playfair text-3xl text-charcoal mb-4">Reviews</h2>
           <!-- (Pillar 2): Add review management UI -->
          <p class="text-stone italic">Review management UI (Pillar 2) is not yet implemented.</p>
        </section>

        <!-- Site Content Panel -->
        <section id="panel-content" class="tab-panel">
          <h2 class="font-playfair text-3xl text-charcoal mb-4">Site Content</h2>
          <p class="text-stone italic">Site content management (Pillar 2) is not yet implemented.</p>
        </section>
      </div>
    </main>

    <!-- Product Form Modal -->
    <div id="product-form-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex justify-center items-start pt-16 z-40 hidden">
      <div class="bg-white rounded-lg shadow-2xl w-full max-w-3xl max-h-[80vh] overflow-y-auto">
        <form id="product-form" class="p-8">
          <div class="flex justify-between items-center pb-4 border-b">
            <h3 id="product-form-title" class="font-playfair text-2xl text-charcoal">Add New Product</h3>
            <button
              id="close-product-form"
              type="button"
              class="text-stone hover:text-red-600"
            >
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
              </svg>
            </button>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
            <!-- Left Column -->
            <div>
              <input type="hidden" id="product-id" />
              <!-- Product Name -->
              <div>
                <label for="name" class="form-label">Product Name</label>
                <input type="text" id="name" class="form-input" required />
              </div>
              <!-- Category -->
              <div class="mt-4">
                <label for="category" class="form-label">Category</label>
                <select id="category" class="form-input" required>
                  <option value="">Select a category</option>
                  <option value="candle">Candle</option>
                  <option value="wax-melt">Wax Melt</option>
                </select>
              </div>
              <!-- Price -->
              <div class="mt-4">
                <label for="price" class="form-label">Price</label>
                <input type="text" id="price" class="form-input" placeholder="e.g., 20.00" required />
              </div>
              <!-- Stock -->
              <div class="mt-4">
                <label for="stock" class="form-label">Stock Quantity</label>
                <input type="number" id="stock" class="form-input" value="0" min="0" required />
              </div>
              <!-- Image URL -->
              <div class="mt-4">
                <label for="imageUrl" class="form-label">Image URL</label>
                <input type="text" id="imageUrl" class="form-input" placeholder="e.g., aloha-luxe-candle.webp" required />
              </div>
            </div>

            <!-- Right Column -->
            <div>
              <!-- Scent Family -->
              <div>
                <label for="scentFamily" class="form-label">Scent Family</label>
                <select id="scentFamily" class="form-input" required>
                  <option value="">Select a scent family</option>
                  <option value="fruity-sweet">Fruity & Sweet</option>
                  <option value="earthy-woody">Earthy & Woody</option>
                  <option value="fresh-clean">Fresh & Clean</option>
                  <option value="floral-romantic">Floral & Romantic</option>
                </select>
              </div>
              <!-- Scent Notes -->
              <div class="mt-4">
                <label for="scentNotes" class="form-label">Scent Notes</label>
                <input type="text" id="scentNotes" class="form-input" placeholder="e.g., Coconut, Jasmine, Vanilla" required />
              </div>
              <!-- Short Description -->
              <div class="mt-4">
                <label for="shortDescription" class="form-label">Short Description</label>
                <textarea id="shortDescription" rows="3" class="form-input"></textarea>
              </div>
              <!-- Pairing -->
              <div class="mt-4">
                <label for="pairing" class="form-label">Pairs Well With</label>
                <input type="text" id="pairing" class="form-input" />
              </div>
              
            </div>
          </div>

          <!-- Full Width -->
          <div class="mt-6">
            <label for="longDescription" class="form-label">Long Description (HTML)</label>
            <textarea id="longDescription" rows="5" class="form-input" placeholder="<p>Wrap yourself in the comforting scent...</p>"></textarea>
          </div>

          <div class="mt-6 pt-6 border-t flex justify-between items-center">
            <button
              id="delete-product-btn"
              type="button"
              class="bg-red-600 text-white px-5 py-2 rounded-md shadow-lg hover:bg-red-700 hidden"
            >
              Delete Product
            </button>
            <button
              id="save-product-btn"
              type="submit"
              class="bg-green-600 text-white px-6 py-2 rounded-md shadow-lg hover:bg-green-700"
            >
              Save Product
            </button>
          </div>
          <p id="form-error-msg" class="text-red-600 mt-4 text-sm hidden"></p>

        </form>
      </div>
    </div>

    <!-- 
      This is a custom, self-contained app.
      It uses the global output.css but its JS is all inline.
    -->
    <style>
      .tab-btn {
        @apply px-4 py-3 font-medium text-lg text-stone border-b-4 border-transparent hover:text-charcoal;
      }
      .active-tab {
        @apply text-burnt-orange border-burnt-orange;
      }
      .tab-panel {
        display: none;
      }
      .active-panel {
        display: block;
      }
      .form-label {
        @apply block text-sm font-medium text-charcoal mb-1;
      }
      .form-input {
        @apply w-full px-4 py-2 border border-stone/30 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-burnt-orange focus:border-transparent;
      }
    </style>

    <script type="module">
      import {
        auth,
        db,
        signOut,
        onAuthStateChanged,
        doc,
        getDoc,
        collection,
        getDocs,
        addDoc,
        setDoc,
        deleteDoc,
        query,
      } from "/src/firebase-loader.js";

      // --- GLOBAL ELEMENTS ---
      const fullPageSpinner = document.getElementById("full-page-spinner");
      const adminContent = document.getElementById("admin-content");
      const adminEmail = document.getElementById("admin-email");
      const logoutButton = document.getElementById("logout-button");

      // --- TABS ---
      const tabs = document.querySelectorAll(".tab-btn");
      const panels = document.querySelectorAll(".tab-panel");

      // --- PRODUCTS ---
      const productList = document.getElementById("product-list");
      const productListLoading = document.getElementById("product-list-loading");
      const modal = document.getElementById("product-form-modal");
      const form = document.getElementById("product-form");
      const formTitle = document.getElementById("product-form-title");
      const showNewProductForm = document.getElementById("show-new-product-form");
      const closeProductForm = document.getElementById("close-product-form");
      const saveProductBtn = document.getElementById("save-product-btn");
      const deleteProductBtn = document.getElementById("delete-product-btn");
      const formErrorMsg = document.getElementById("form-error-msg");
      const formProductId = document.getElementById("product-id");

      // --- ORDERS ---
      const orderList = document.getElementById("order-list");
      const orderListLoading = document.getElementById("order-list-loading");

      let currentAdminUser = null;

      // --- 1. AUTHENTICATION ---
      onAuthStateChanged(auth, async (user) => {
        if (user) {
          // User is signed in, NOW check if they are an admin
          const adminDocRef = doc(db, "admins", user.uid);
          const adminDocSnap = await getDoc(adminDocRef);

          if (adminDocSnap.exists()) {
            // SUCCESS: User is an admin
            currentAdminUser = user;
            adminEmail.textContent = user.email;
            initializeApp();
          } else {
            // FAILURE: User is authenticated but NOT an admin
            console.warn("User is not an admin. Redirecting.");
            alert("You do not have permission to access this page.");
            window.location.href = "/admin-login.html";
          }
        } else {
          // User is not signed in
          console.log("User not signed in. Redirecting.");
          window.location.href = "/admin-login.html";
        }
      });

      logoutButton.addEventListener("click", () => {
        signOut(auth)
          .then(() => {
            console.log("Admin signed out.");
            window.location.href = "/";
          })
          .catch((error) => {
            console.error("Sign out error", error);
          });
      });

      // --- 2. INITIALIZE APP (after auth) ---
      function initializeApp() {
        fullPageSpinner.style.display = "none";
        adminContent.style.display = "block";
        
        loadProducts();
        loadOrders();
        
        setupTabs();
        setupModalEvents();
        setupFormEvents();
      }
      
      // --- 3. TABS ---
      function setupTabs() {
        tabs.forEach(tab => {
          tab.addEventListener('click', () => {
            // Deactivate all
            tabs.forEach(t => t.classList.remove('active-tab'));
            panels.forEach(p => p.classList.remove('active-panel'));
            
            // Activate clicked
            tab.classList.add('active-tab');
            document.getElementById(`panel-${tab.dataset.tab}`).classList.add('active-panel');
          });
        });
      }

      // --- 4. PRODUCTS ---
      async function loadProducts() {
        try {
          const q = query(collection(db, "products"));
          // (Pillar 1 Fix): Add sorting
          // const q = query(collection(db, "products"), orderBy("name"));
          const querySnapshot = await getDocs(q);

          productList.innerHTML = ""; // Clear list
          if (querySnapshot.empty) {
            productList.innerHTML = `<tr><td colspan="5" class="px-6 py-12 text-center text-stone italic">No products found. Add one to get started!</td></tr>`;
            return;
          }

          querySnapshot.forEach(doc => {
            const product = { id: doc.id, ...doc.data() };
            const row = document.createElement("tr");
            row.innerHTML = `
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                  <div class="flex-shrink-0 h-10 w-10">
                    <img class="h-10 w-10 rounded-md object-cover" src="/src/${product.imageUrl}" alt="${product.name}">
                  </div>
                  <div class="ml-4">
                    <div class="text-sm font-medium text-charcoal">${product.name}</div>
                    <div class="text-sm text-stone">${product.id}</div>
                  </div>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800 capitalize">
                  ${product.category}
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class="text-sm text-charcoal">${product.stock}</span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class="text-sm text-charcoal">$${product.price}</span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <button class="edit-product-btn text-burnt-orange hover:text-opacity-80" data-id="${product.id}">Edit</button>
              </td>
            `;
            productList.appendChild(row);
          });

        } catch (error) {
          console.error("Error loading products:", error);
          productList.innerHTML = `<tr><td colspan="5" class="px-6 py-12 text-center text-red-600">Error loading products.</td></tr>`;
        }
      }
      
      // --- 5. ORDERS ---
      async function loadOrders() {
        try {
          const q = query(collection(db, "orders"));
          // (Pillar 1 Fix): Add sorting
          // const q = query(collection(db, "orders"), orderBy("createdAt", "desc"));
          const querySnapshot = await getDocs(q);

          orderList.innerHTML = ""; // Clear list
          if (querySnapshot.empty) {
            orderList.innerHTML = `<tr><td colspan="6" class="px-6 py-12 text-center text-stone italic">No orders found.</td></tr>`;
            return;
          }

          querySnapshot.forEach(doc => {
            const order = { id: doc.id, ...doc.data() };
            const orderDate = new Date(order.createdAt.seconds * 1000).toLocaleDateString();
            
            const row = document.createElement("tr");
            row.innerHTML = `
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-charcoal">${order.id.substring(0,8)}...</div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-stone">${orderDate}</div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-charcoal">${order.customerInfo.name}</div>
                <div class="text-sm text-stone">${order.customerInfo.email}</div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-charcoal">$${order.totalAmount}</div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${
                  order.status === 'shipped' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'
                } capitalize">
                  ${order.status}
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <button class="view-order-btn text-burnt-orange hover:text-opacity-80" data-id="${order.id}">View</button>
              </td>
            `;
            orderList.appendChild(row);
          });

        } catch (error) {
          console.error("Error loading orders:", error);
          orderList.innerHTML = `<tr><td colspan="6" class="px-6 py-12 text-center text-red-600">Error loading orders.</td></tr>`;
        }
      }

      // --- 6. MODAL & FORM ---
      function setupModalEvents() {
        // Show "Add New"
        showNewProductForm.addEventListener('click', () => {
          form.reset();
          formTitle.textContent = "Add New Product";
          formProductId.value = "";
          deleteProductBtn.classList.add("hidden");
          modal.classList.remove("hidden");
        });

        // Close
        closeProductForm.addEventListener('click', () => {
          modal.classList.add("hidden");
        });
        
        // Edit
        productList.addEventListener('click', async (e) => {
          if (e.target.classList.contains('edit-product-btn')) {
            const id = e.target.dataset.id;
            await openEditForm(id);
          }
        });
      }
      
      async function openEditForm(id) {
        try {
          const docRef = doc(db, "products", id);
          const docSnap = await getDoc(docRef);
          
          if (!docSnap.exists()) {
            alert("Product not found!");
            return;
          }
          
          const product = docSnap.data();
          
          // Populate form
          formTitle.textContent = "Edit Product";
          formProductId.value = id;
          document.getElementById('name').value = product.name;
          document.getElementById('category').value = product.category;
          document.getElementById('price').value = product.price;
          document.getElementById('stock').value = product.stock;
          document.getElementById('imageUrl').value = product.imageUrl;
          document.getElementById('scentFamily').value = product.scentFamily;
          document.getElementById('scentNotes').value = product.scentNotes;
          document.getElementById('shortDescription').value = product.shortDescription;
          document.getElementById('pairing').value = product.pairing;
          document.getElementById('longDescription').value = product.longDescription;
          
          deleteProductBtn.classList.remove("hidden");
          modal.classList.remove("hidden");
          
        } catch (error) {
          console.error("Error fetching product for edit:", error);
          alert("Error loading product details.");
        }
      }
      
      function setupFormEvents() {
        form.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const id = formProductId.value;
          const productData = {
            name: document.getElementById('name').value,
            category: document.getElementById('category').value,
            price: document.getElementById('price').value,
            stock: parseInt(document.getElementById('stock').value, 10),
            imageUrl: document.getElementById('imageUrl').value,
            scentFamily: document.getElementById('scentFamily').value,
            scentNotes: document.getElementById('scentNotes').value,
            shortDescription: document.getElementById('shortDescription').value,
            pairing: document.getElementById('pairing').value,
            longDescription: document.getElementById('longDescription').value,
            // (Future Feature): Add 'featured' checkbox
          };

          // Basic validation
          if (!productData.name || !productData.category || !productData.price) {
            formErrorMsg.textContent = "Please fill out all required fields.";
            formErrorMsg.classList.remove("hidden");
            return;
          }
          formErrorMsg.classList.add("hidden");

          saveProductBtn.disabled = true;
          saveProductBtn.textContent = "Saving...";

          try {
            if (id) {
              // Update existing product
              const docRef = doc(db, "products", id);
              await setDoc(docRef, productData, { merge: true });
              console.log("Product updated:", id);
            } else {
              // Add new product
              const docRef = await addDoc(collection(db, "products"), productData);
              console.log("Product added:", docRef.id);
            }
            
            modal.classList.add("hidden");
            loadProducts(); // Refresh list

          } catch (error) {
            console.error("Error saving product:", error);
            formErrorMsg.textContent = "Error saving product. Check console.";
            formErrorMsg.classList.remove("hidden");
          } finally {
            saveProductBtn.disabled = false;
            saveProductBtn.textContent = "Save Product";
          }
        });

        // Delete button
        deleteProductBtn.addEventListener('click', async () => {
          const id = formProductId.value;
          if (!id) return;
          
          // (Pillar 1 Fix): Use a custom modal, not confirm()
          if (!confirm(`Are you sure you want to delete this product? This cannot be undone.`)) {
            return;
          }
          
          deleteProductBtn.disabled = true;
          deleteProductBtn.textContent = "Deleting...";

          try {
            await deleteDoc(doc(db, "products", id));
            console.log("Product deleted:", id);
            modal.classList.add("hidden");
            loadProducts(); // Refresh list
          } catch (error) {
            console.error("Error deleting product:", error);
            formErrorMsg.textContent = "Error deleting product. Check console.";
            formErrorMsg.classList.remove("hidden");
          } finally {
            deleteProductBtn.disabled = false;
            deleteProductBtn.textContent = "Delete Product";
          }
        });
      }

    </script>
  </body>
</html>
