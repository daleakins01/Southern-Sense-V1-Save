---
layout: layout
title: Shop All Candles & Melts
---

{% include "page-header.html" with pageTitle: title %}

<main class="container mx-auto px-4 py-12 min-h-screen">
    
    <div class="max-w-6xl mx-auto bg-white p-8 lg:p-12 rounded-xl shadow-2xl border border-stone/10">

        <header class="max-w-4xl mx-auto text-center mb-12">
            <p class="text-sm font-semibold uppercase tracking-wider text-burnt-orange mb-3">Shop Our Collection</p>
            <h1 id="shop-heading" class="text-5xl font-playfair text-charcoal mb-4">
                All Products
            </h1>
            <p id="shop-intro" class="text-lg text-stone leading-relaxed">
                </p>
            <div id="filter-message" class="text-center text-sm font-medium text-stone mt-4">
            </div>
        </header>

        <div class="flex flex-col lg:flex-row gap-8">
            
            <aside class="lg:w-1/4 sticky top-24 bg-parchment p-6 rounded-lg shadow-md border border-stone/10 h-min">
                <h3 class="text-xl font-playfair text-charcoal mb-4 border-b pb-2">Refine Your Scents</h3>
                
                <form id="product-filter-form" class="space-y-6">
                    
                    <div>
                        <label for="category-filter" class="block text-sm font-medium text-charcoal mb-2">Product Type</label>
                        <select id="category-filter" name="category" class="w-full p-2 border border-stone/30 rounded-lg text-charcoal bg-white">
                            <option value="">All Types</option>
                            </select>
                    </div>

                    <div>
                        <label for="family-filter" class="block text-sm font-medium text-charcoal mb-2">Scent Family</label>
                        <select id="family-filter" name="family" class="w-full p-2 border border-stone/30 rounded-lg text-charcoal bg-white">
                            <option value="">All Families</option>
                            </select>
                    </div>

                    <button type="submit" class="w-full px-4 py-2 bg-stone text-parchment font-bold rounded-lg hover:bg-charcoal transition duration-300">
                        Apply Filters
                    </button>
                    <button type="button" id="clear-filters-button" class="w-full px-4 py-2 border border-stone/30 text-charcoal font-medium rounded-lg hover:bg-parchment/70 transition duration-300">
                        Clear Filters
                    </button>

                </form>
            </aside>

            <div class="lg:w-3/4">
                <div id="shop-loader" class="flex justify-center items-center h-48">
                    <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-burnt-orange"></div>
                </div>

                <div id="product-grid" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-8">
                </div>
            </div>

        </div>

    </div>
</main>

<script type="module">
    import { 
        db, 
        collection, 
        query, 
        where, 
        getDocs, 
        orderBy 
    } from '/src/firebase-loader.js';

    // --- DOM Elements ---
    const shopHeading = document.getElementById('shop-heading');
    const shopIntro = document.getElementById('shop-intro');
    const productGrid = document.getElementById('product-grid');
    const shopLoader = document.getElementById('shop-loader');
    const filterMessage = document.getElementById('filter-message');
    const filterForm = document.getElementById('product-filter-form');
    const categoryFilterSelect = document.getElementById('category-filter');
    const familyFilterSelect = document.getElementById('family-filter');
    const clearFiltersButton = document.getElementById('clear-filters-button');

    // --- State ---
    let allProducts = [];
    
    // --- Utility Functions ---

    /**
     * Extracts all filters from the URL query parameters.
     * @returns {Object} The filters (family and category).
     */
    function getFiltersFromUrl() {
        const params = new URLSearchParams(window.location.search);
        return {
            family: params.get('family'),
            category: params.get('category')
        };
    }

    /**
     * Capitalizes the first letter of each word in a string (for display).
     * @param {string} str - The input string (e.g., "fruity-sweet").
     * @returns {string} The formatted string (e.g., "Fruity Sweet").
     */
    function formatText(str) {
        if (!str) return '';
        // Handle cases like "wax-melt" or "fruity-sweet"
        return str
            .toLowerCase()
            .split(/[-\s]+/)
            .map(word => word.charAt(0).toUpperCase() + word.slice(1))
            .join(' ');
    }

    /**
     * Renders a single product card HTML.
     */
    function renderProductCard(product) {
        const isOutOfStock = product.stock <= 0;
        const price = product.price.toFixed(2); 
        
        const stockStatusHtml = isOutOfStock
            ? `<p class="text-sm font-semibold text-red-600">SOLD OUT</p>`
            : `<p class="text-sm font-semibold text-charcoal">In Stock</p>`;
            
        const actionButtonHtml = isOutOfStock
            ? `<a href="/product/?id=${product.id}" class="w-full px-4 py-2 bg-stone/50 text-parchment font-bold rounded-lg text-center cursor-not-allowed">View Details</a>`
            : `<button data-id="${product.id}" 
                      data-name="${product.name}"
                      data-price="${price}"
                      data-image="${product.imageUrl}"
                      class="add-to-cart-button w-full px-4 py-2 bg-burnt-orange text-parchment font-bold rounded-lg hover:bg-burnt-orange/80 transition duration-300">
                Add to Cart
              </button>`;
        
        return `
            <div class="product-card bg-white rounded-lg shadow-xl overflow-hidden hover:shadow-2xl transition duration-300 transform hover:-translate-y-1">
                <a href="/product/?id=${product.id}" class="block relative">
                    <img src="/src/${product.imageUrl || 'logo.webp'}" alt="${product.name}" class="w-full h-72 object-cover">
                    ${product.featured ? '<span class="absolute top-3 left-3 px-3 py-1 text-xs bg-burnt-orange text-parchment rounded-full font-bold shadow-md">FEATURED</span>' : ''}
                </a>
                <div class="p-5">
                    <h3 class="text-xl font-playfair text-charcoal mb-1">${product.name}</h3>
                    <p class="text-sm text-stone mb-3">${formatText(product.scentFamily)} | ${formatText(product.category)}</p>
                    <div class="flex justify-between items-center mb-4">
                        <p class="text-lg font-bold text-burnt-orange">$${price}</p>
                        ${stockStatusHtml}
                    </div>
                    ${actionButtonHtml}
                </div>
            </div>
        `;
    }

    // --- Filter Setup Logic ---

    /**
     * Populates the filter dropdowns based on all available product data.
     */
    function setupFilters(currentFilters) {
        const uniqueFamilies = new Set();
        const uniqueCategories = new Set();

        allProducts.forEach(p => {
            if (p.scentFamily) uniqueFamilies.add(p.scentFamily.toLowerCase());
            if (p.category) uniqueCategories.add(p.category.toLowerCase());
        });

        // Populate Category Filter
        categoryFilterSelect.innerHTML = '<option value="">All Types</option>';
        [...uniqueCategories].sort().forEach(cat => {
            const selected = cat === currentFilters.category ? 'selected' : '';
            categoryFilterSelect.innerHTML += `<option value="${cat}" ${selected}>${formatText(cat)}</option>`;
        });

        // Populate Family Filter
        familyFilterSelect.innerHTML = '<option value="">All Families</option>';
        [...uniqueFamilies].sort().forEach(family => {
            const selected = family === currentFilters.family ? 'selected' : '';
            familyFilterSelect.innerHTML += `<option value="${family}" ${selected}>${formatText(family)}</option>`;
        });
    }

    /**
     * Attaches click listeners to all new "Add to Cart" buttons.
     */
    function attachCartListeners() {
        document.querySelectorAll('.add-to-cart-button').forEach(button => {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                const { id, name, price, image } = e.currentTarget.dataset;
                
                const product = { id: id, name: name, price: price, imageUrl: image };
                
                // Use global window functions exposed by cart.js
                window.addToCart(product, 1); 
                window.updateCartDisplay(); 
                
                e.currentTarget.textContent = 'Added!';
                setTimeout(() => {
                    e.currentTarget.textContent = 'Add to Cart';
                }, 1000);
            });
        });
    }

    /**
     * Filters the global product list and renders the grid.
     */
    function renderProductGrid(filters) {
        let filteredProducts = allProducts;
        let displayedCount = 0;

        // 1. Apply Filters
        if (filters.family) {
            filteredProducts = filteredProducts.filter(p => p.scentFamily && p.scentFamily.toLowerCase() === filters.family.toLowerCase());
        }
        if (filters.category) {
            filteredProducts = filteredProducts.filter(p => p.category && p.category.toLowerCase() === filters.category.toLowerCase());
        }

        // 2. Update Header Text
        const activeFilterNames = [
            filters.category ? formatText(filters.category) : null,
            filters.family ? formatText(filters.family) : null
        ].filter(n => n).join(' & ');
        
        shopHeading.textContent = activeFilterNames || 'All Products';
        shopIntro.textContent = activeFilterNames 
            ? `Showing products filtered by: ${activeFilterNames}`
            : `Explore our entire collection of hand-poured candles and luxurious wax melts.`;

        productGrid.innerHTML = '';
        
        if (filteredProducts.length === 0) {
            productGrid.innerHTML = `<p class="text-lg text-stone col-span-full text-center py-10">No products found matching your criteria. <a href="/shop/" class="text-burnt-orange hover:underline">Clear Filters</a></p>`;
            filterMessage.textContent = `0 products found.`;
            return;
        }

        // 3. Sort & Render
        filteredProducts.sort((a, b) => {
            if (a.featured && !b.featured) return -1;
            if (!a.featured && b.featured) return 1;
            if (a.stock > 0 && b.stock <= 0) return -1;
            if (a.stock <= 0 && b.stock > 0) return 1;
            return a.name.localeCompare(b.name);
        });

        filteredProducts.forEach(product => {
            productGrid.innerHTML += renderProductCard(product);
            displayedCount++;
        });

        filterMessage.textContent = `${displayedCount} ${activeFilterNames || 'Total'} products found.`;

        attachCartListeners();
    }

    // --- Initialization & Event Listeners ---

    async function initializeShop() {
        shopLoader.classList.remove('hidden');
        productGrid.innerHTML = '';
        
        const currentFilters = getFiltersFromUrl();

        try {
            const productsRef = collection(db, 'products');
            const q = query(productsRef); 
            const querySnapshot = await getDocs(q);

            if (querySnapshot.empty) {
                shopIntro.textContent = "We're currently stocking our shelves. Please check back soon!";
                shopLoader.classList.add('hidden');
                return;
            }

            allProducts = querySnapshot.docs.map(doc => {
                const data = doc.data();
                return {
                    id: doc.id,
                    ...data,
                    price: parseFloat(data.price) || 0.00, 
                    stock: parseInt(data.stock, 10) || 0, 
                    featured: data.featured === true 
                };
            });

            setupFilters(currentFilters);
            renderProductGrid(currentFilters);

        } catch (error) {
            console.error("CRITICAL ERROR: Error fetching products:", error);
            shopIntro.innerHTML = `<p class="text-red-600 font-bold">Error loading products. Please check the browser console for specific dependency or Firestore errors.</p>`;
        } finally {
            shopLoader.classList.add('hidden');
        }
    }
    
    // Event Listeners
    document.addEventListener('DOMContentLoaded', () => {
        initializeShop();
        
        // Handle filter form submission
        filterForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const category = categoryFilterSelect.value;
            const family = familyFilterSelect.value;
            
            // Build new URL
            const newParams = new URLSearchParams();
            if (category) newParams.set('category', category);
            if (family) newParams.set('family', family);
            
            // Navigate to new URL to reload with filters
            window.location.href = `/shop/?${newParams.toString()}`;
        });
        
        // Handle Clear Filters button
        clearFiltersButton.addEventListener('click', () => {
            window.location.href = '/shop/';
        });
    });
</script>