---
layout: layout.html
title: Admin Panel
---

<div class="container mx-auto p-4 lg:p-8">
    
    <div id="loading-spinner" class="text-center py-20">
        <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-burnt-orange mx-auto"></div>
        <p class="mt-4 text-lg font-roboto text-stone">Verifying Admin Privileges...</p>
    </div>

    <div id="access-denied" class="hidden text-center py-20 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative max-w-lg mx-auto" role="alert">
        <strong class="font-bold block">Access Denied</strong>
        <span class="block sm:inline">You must be logged in as an administrator to view this page.</span>
        <a href="/admin-login/" class="block mt-4 text-sm underline text-red-700 hover:text-red-900">Go to Admin Login</a>
    </div>

    <div id="admin-panel" class="hidden">
        <h1 class="font-playfair text-4xl font-extrabold text-charcoal mb-6 border-b pb-2">Admin Dashboard</h1>

        <nav class="flex space-x-2 border-b border-stone/20 mb-6">
            <button class="tab-button py-2 px-4 font-roboto font-semibold text-charcoal border-b-2 border-transparent hover:border-burnt-orange transition-colors duration-150" 
                    data-target="products-section" id="products-tab">Products</button>
            <button class="tab-button py-2 px-4 font-roboto font-semibold text-charcoal border-b-2 border-transparent hover:border-burnt-orange transition-colors duration-150" 
                    data-target="orders-section" id="orders-tab">Orders</button>
            <button class="tab-button py-2 px-4 font-roboto font-semibold text-charcoal border-b-2 border-transparent hover:border-burnt-orange transition-colors duration-150" 
                    data-target="reviews-section" id="reviews-tab">Reviews</button>
            <button class="tab-button py-2 px-4 font-roboto font-semibold text-charcoal border-b-2 border-transparent hover:border-burnt-orange transition-colors duration-150" 
                    data-target="site-content-section" id="site-content-tab">Site Content</button>
            <button class="tab-button py-2 px-4 font-roboto font-semibold text-charcoal border-b-2 border-transparent hover:border-burnt-orange transition-colors duration-150" 
                    data-target="stock-alerts-section" id="stock-alerts-tab">Stock Alerts</button>
        </nav>

        <div id="tab-content">
            
            <div id="products-section" class="tab-content-item space-y-6">
                <h2 class="font-playfair text-3xl font-bold text-charcoal">Product Management</h2>
                <p>... Product management UI elements and JS logic here ...</p>
            </div>

            <div id="orders-section" class="tab-content-item hidden space-y-6">
                <h2 class="font-playfair text-3xl font-bold text-charcoal">Order Management</h2>
                <p>... Order management UI elements and JS logic here ...</p>
            </div>

            <div id="reviews-section" class="tab-content-item hidden space-y-6">
                <h2 class="font-playfair text-3xl font-bold text-charcoal">Review Moderation</h2>
                <p>... Review moderation UI elements and JS logic here ...</p>
            </div>

            <div id="site-content-section" class="tab-content-item hidden space-y-6">
                <h2 class="font-playfair text-3xl font-bold text-charcoal">Site Content Editor</h2>
                <p>... Site Content editor UI elements and JS logic here ...</p>
            </div>

            <div id="stock-alerts-section" class="tab-content-item hidden space-y-6">
                <h2 class="font-playfair text-3xl font-bold text-charcoal">Back-in-Stock Requests</h2>
                <div id="stock-alerts-status" class="p-4 bg-yellow-100 text-yellow-800 rounded-lg font-roboto">Loading requests...</div>
                
                <div id="stock-alerts-list" class="space-y-4">
                    </div>
                
                <p id="no-stock-alerts" class="hidden font-roboto text-stone italic">No unresolved stock requests at this time. All caught up!</p>
            </div>

        </div> </div> </div>

<script type="module">
    // --- Firebase Imports ---
    import { db, auth } from '/firebase-loader.js';
    import { 
        getAuth, 
        onAuthStateChanged 
    } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
    import { 
        doc, 
        getDoc, 
        collection, 
        query, 
        where, 
        getDocs, 
        orderBy,
        updateDoc, // NEW for updating 'resolved' status
        serverTimestamp 
    } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

    // --- DOM Elements ---
    const loadingSpinner = document.getElementById('loading-spinner');
    const accessDenied = document.getElementById('access-denied');
    const adminPanel = document.getElementById('admin-panel');
    const stockAlertsList = document.getElementById('stock-alerts-list');
    const stockAlertsStatus = document.getElementById('stock-alerts-status');
    const noStockAlerts = document.getElementById('no-stock-alerts');

    // --- Admin Check ---
    
    /**
     * Checks if the currently authenticated user is listed in the /admins collection.
     * @param {string} uid - The user's UID.
     * @returns {Promise<boolean>} True if the user is an admin.
     */
    async function isAdminUser(uid) {
        if (!uid) return false;
        try {
            const adminRef = doc(db, 'admins', uid);
            const docSnap = await getDoc(adminRef);
            return docSnap.exists();
        } catch (e) {
            console.error("Error checking admin status:", e);
            return false;
        }
    }

    /**
     * Handles the display of the Admin Panel based on user authentication and admin status.
     */
    function setupAuthObserver() {
        onAuthStateChanged(getAuth(), async (user) => {
            if (user) {
                const isAdmin = await isAdminUser(user.uid);
                if (isAdmin) {
                    loadingSpinner.classList.add('hidden');
                    adminPanel.classList.remove('hidden');
                    initializeAdminPanel(); // Initialize all panel functions
                } else {
                    loadingSpinner.classList.add('hidden');
                    accessDenied.classList.remove('hidden');
                }
            } else {
                loadingSpinner.classList.add('hidden');
                accessDenied.classList.remove('hidden');
            }
        });
    }

    // --- Tab Navigation Logic (Updated) ---
    
    /**
     * Initializes the tabbed navigation functionality.
     */
    function initializeTabs() {
        const tabs = document.querySelectorAll('.tab-button');
        const contents = document.querySelectorAll('.tab-content-item');
        
        // Default to showing the Products tab and setting it active
        const defaultTab = document.getElementById('products-tab');
        defaultTab.classList.add('active-tab'); 
        defaultTab.classList.remove('border-transparent');
        defaultTab.classList.add('border-burnt-orange');
        
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const targetId = tab.getAttribute('data-target');
                
                // Deactivate all tabs and hide all content
                tabs.forEach(t => {
                    t.classList.remove('active-tab', 'border-burnt-orange');
                    t.classList.add('border-transparent');
                });
                contents.forEach(c => c.classList.add('hidden'));
                
                // Activate the clicked tab and show its content
                tab.classList.add('active-tab', 'border-burnt-orange');
                tab.classList.remove('border-transparent');
                document.getElementById(targetId).classList.remove('hidden');
                
                // Special: If Stock Alerts tab is clicked, refresh its content
                if (targetId === 'stock-alerts-section') {
                    loadStockAlerts();
                }
            });
        });
    }
    
    // --- STOCK ALERTS LOGIC (NEW) ---

    /**
     * Updates a stock request to resolved: true.
     * @param {string} requestId - The Firestore document ID of the request.
     */
    async function resolveStockRequest(requestId) {
        try {
            const requestRef = doc(db, 'backInStockRequests', requestId);
            
            // Update the document to mark it as resolved
            await updateDoc(requestRef, {
                resolved: true,
                resolvedAt: serverTimestamp() // Record the time it was resolved
            });
            
            // Reload the list to remove the resolved item
            loadStockAlerts();
        } catch (error) {
            console.error("Error resolving stock request:", error);
            stockAlertsStatus.textContent = `Error resolving request: ${error.message}`;
            stockAlertsStatus.className = 'p-4 bg-red-100 text-red-800 rounded-lg font-roboto';
        }
    }

    /**
     * Renders the list of unresolved back-in-stock requests.
     * @param {Array<Object>} requests - Array of stock request objects.
     */
    function renderStockAlerts(requests) {
        stockAlertsList.innerHTML = '';
        
        if (requests.length === 0) {
            noStockAlerts.classList.remove('hidden');
            stockAlertsStatus.classList.add('hidden');
            return;
        }

        noStockAlerts.classList.add('hidden');
        stockAlertsStatus.classList.add('hidden');
        
        requests.forEach(request => {
            const date = request.requestedAt ? new Date(request.requestedAt.seconds * 1000).toLocaleDateString() : 'Unknown Date';
            
            const alertHtml = `
                <div class="flex flex-col md:flex-row items-start md:items-center justify-between p-4 bg-parchment rounded-lg shadow-sm border border-burnt-orange/30">
                    <div class="mb-2 md:mb-0">
                        <p class="font-playfair text-lg font-semibold text-charcoal">
                            Product: <a href="/product/?id=${request.productId}" target="_blank" class="text-burnt-orange hover:underline">${request.productName}</a>
                        </p>
                        <p class="font-roboto text-sm text-stone">
                            Email: <span class="text-charcoal font-medium">${request.email}</span>
                            | Requested: ${date}
                        </p>
                    </div>
                    <button data-id="${request.id}" class="resolve-stock-button flex-shrink-0 py-2 px-4 bg-stone text-parchment font-roboto text-sm rounded-lg hover:bg-burnt-orange hover:text-parchment transition duration-150">
                        Mark as Notified / Resolved
                    </button>
                </div>
            `;
            stockAlertsList.insertAdjacentHTML('beforeend', alertHtml);
        });

        // Attach event listeners to the new buttons
        document.querySelectorAll('.resolve-stock-button').forEach(button => {
            button.addEventListener('click', (e) => {
                const requestId = e.target.getAttribute('data-id');
                if (confirm(`Mark request for "${requestId}" as resolved?`)) {
                    resolveStockRequest(requestId);
                }
            });
        });
    }

    /**
     * Fetches all UNRESOLVED back-in-stock requests from Firestore.
     */
    async function loadStockAlerts() {
        stockAlertsStatus.textContent = 'Loading requests...';
        stockAlertsStatus.className = 'p-4 bg-yellow-100 text-yellow-800 rounded-lg font-roboto';
        stockAlertsStatus.classList.remove('hidden');
        noStockAlerts.classList.add('hidden');
        stockAlertsList.innerHTML = ''; // Clear previous list

        try {
            const requestsCol = collection(db, 'backInStockRequests');
            const q = query(
                requestsCol,
                where('resolved', '==', false), // Only fetch unresolved requests
                orderBy('requestedAt', 'asc')   // Show oldest first
            );
            
            const querySnapshot = await getDocs(q);
            const requests = [];
            
            querySnapshot.forEach((doc) => {
                const data = doc.data();
                data.id = doc.id; // Include the document ID for resolution
                requests.push(data);
            });

            renderStockAlerts(requests);

        } catch (error) {
            console.error("Error loading stock alerts:", error);
            stockAlertsStatus.textContent = `Error loading stock alerts: ${error.message}`;
            stockAlertsStatus.className = 'p-4 bg-red-100 text-red-800 rounded-lg font-roboto';
            stockAlertsStatus.classList.remove('hidden');
        }
    }
    
    // --- Placeholder Functions (To be implemented later) ---
    
    /**
     * Main initializer for all admin panel features.
     */
    function initializeAdminPanel() {
        initializeTabs();
        // Since Products is the default tab, we load its content here (or stub it).
        // loadProducts(); 
        
        // NOTE: The other tabs (Products, Orders, Reviews, Site Content) 
        // need their loading functions implemented, but for now we only need 
        // the Auth check and the new Stock Alerts logic to be complete.

        // Placeholder functions for completeness, assuming they load their respective sections
        // function loadProducts() { console.log("Loading Products..."); }
        // function loadOrders() { console.log("Loading Orders..."); }
        // function loadReviews() { console.log("Loading Reviews..."); }
        // function loadSiteContent() { console.log("Loading Site Content..."); }
    }


    // --- Main Initialization ---
    
    // FIX (Race Condition): Wait for firebase-loader.js to dispatch its signal
    document.addEventListener('firebase-ready', setupAuthObserver);

</script>