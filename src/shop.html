---
layout: layout.html
title: Shop All Candles
---

<div class="container mx-auto p-4 lg:p-8 py-16">
    
    <div class="text-center pt-10 pb-12">
        <h1 id="shop-title" class="font-playfair text-5xl font-extrabold text-charcoal mb-4">Our Full Collection</h1>
        <p class="font-roboto text-xl text-stone max-w-3xl mx-auto">
            Browse our entire collection of hand-poured candles and wax melts, crafted with southern elegance.
        </p>
    </div>
    
    <div id="loading-spinner" class="text-center py-20">
        <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-burnt-orange mx-auto"></div>
        <p class="mt-4 text-lg font-roboto text-stone" id="loading-status-message">Loading products...</p>
    </div>

    <div id="no-results" class="hidden text-center py-20 bg-parchment border border-stone/20 text-charcoal px-4 py-3 rounded relative max-w-lg mx-auto" role="alert">
        <strong class="font-bold block text-2xl mb-2">No Products Found</strong>
        <p class="sm:inline" id="no-results-text">We couldn't find any products matching your selection. Try a different filter!</p>
        <a href="/shop/" class="block mt-4 text-sm underline text-burnt-orange hover:text-burnt-orange/80">View All Products</a>
    </div>

    <div id="product-grid" class="hidden grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8">
        </div>
</div>

<script type="module">
    // --- Firebase Imports ---
    import { db } from '/firebase-loader.js';
    import { 
        collection, 
        getDocs, 
        query, 
        orderBy, 
        where 
    } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

    // --- DOM Elements ---
    const loadingSpinner = document.getElementById('loading-spinner');
    const productGrid = document.getElementById('product-grid');
    const noResults = document.getElementById('no-results');
    const shopTitle = document.getElementById('shop-title');
    const loadingMessage = document.getElementById('loading-status-message');

    function getUrlParameters() {
        const params = new URLSearchParams(window.location.search);
        return {
            family: params.get('family')
        };
    }

    function formatScentFamilyName(slug) {
        if (!slug) return '';
        return slug.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
    }

    function renderProductCard(product) {
        // ... (render logic remains the same) ...
        const isOutOfStock = product.stock <= 0;
        const stockBadge = isOutOfStock 
            ? `<div class="absolute top-4 left-4 bg-stone text-parchment px-3 py-1 text-xs font-bold rounded-full shadow-md">Sold Out</div>`
            : '';
        const linkClass = isOutOfStock 
            ? 'opacity-60' 
            : 'hover:shadow-xl hover:scale-[1.02] transition duration-300';
            
        return `
            <a href="/product/?id=${product.id}" class="block bg-parchment rounded-lg shadow-md overflow-hidden ${linkClass}">
                <div class="relative">
                    <img src="/${product.imageUrl}" alt="${product.name}" class="w-full h-48 object-cover">
                    ${stockBadge}
                </div>
                <div class="p-4 space-y-1">
                    <h3 class="font-playfair text-xl font-bold text-charcoal">${product.name}</h3>
                    <p class="font-roboto text-sm text-stone">${product.shortDescription}</p>
                    <p class="font-roboto text-lg font-semibold text-burnt-orange">$${product.price}</p>
                </div>
            </a>
        `;
    }

    /**
     * Fetches and renders products based on URL filters.
     */
    async function loadProducts() {
        loadingSpinner.classList.remove('hidden');
        productGrid.classList.add('hidden');
        noResults.classList.add('hidden');
        loadingMessage.textContent = "Loading products...";
        
        const params = getUrlParameters();

        try {
            const productsCol = collection(db, 'products');
            let q = query(productsCol, orderBy('name', 'asc'));

            // === FILTER LOGIC ===
            if (params.family) {
                q = query(q, where('scentFamily', '==', params.family));
                shopTitle.textContent = `${formatScentFamilyName(params.family)} Collection`;
                shopTitle.classList.add('text-burnt-orange', 'border-b-4', 'border-burnt-orange/50', 'inline-block', 'px-4', 'pb-1');
            } else {
                shopTitle.textContent = 'Our Full Collection';
                shopTitle.classList.remove('text-burnt-orange', 'border-b-4', 'border-burnt-orange/50', 'inline-block', 'px-4', 'pb-1');
            }
            
            // --- CRITICAL DEBUG POINT ---
            loadingMessage.textContent = "Querying database...";
            console.log("DEBUG: Attempting Firestore query for /products...");
            
            const querySnapshot = await getDocs(q);
            
            console.log(`DEBUG: Query successful. Found ${querySnapshot.size} documents.`);
            loadingMessage.textContent = `Found ${querySnapshot.size} products. Rendering...`;

            const products = [];
            querySnapshot.forEach(doc => {
                const productData = doc.data();
                // Ensure price is converted to a string format for safe display
                productData.price = parseFloat(productData.price).toFixed(2);
                productData.id = doc.id;
                products.push(productData);
            });

            // --- END CRITICAL DEBUG POINT ---

            loadingSpinner.classList.add('hidden');
            
            if (products.length > 0) {
                productGrid.innerHTML = products.map(renderProductCard).join('');
                productGrid.classList.remove('hidden');
            } else {
                if (params.family) {
                    document.getElementById('no-results-text').textContent = `We couldn't find any products in the "${formatScentFamilyName(params.family)}" family. Try a different one!`;
                }
                noResults.classList.remove('hidden');
            }

        } catch (error) {
            // --- CRITICAL ERROR LOGGING ---
            console.error("CRITICAL ERROR: Failed to load products from Firestore.", error);
            loadingMessage.textContent = `ERROR: Data retrieval failed. Check console.`;
            loadingSpinner.classList.remove('hidden'); // Keep spinner/message visible for debug
            // Ensure content remains hidden
        }
    }

    // --- Main Initialization ---
    
    // CRITICAL: We need to ensure the DB object is fully initialized before use.
    document.addEventListener('firebase-ready', loadProducts);

</script>